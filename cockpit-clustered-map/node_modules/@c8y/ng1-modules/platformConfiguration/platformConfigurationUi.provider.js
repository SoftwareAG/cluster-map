"use strict";!function(){function e(e,t,i){s.$inject=["$q","c8yBase","c8ySettings","c8yPermissions","gettextCatalog"];var n={path:"configuration",icon:"sliders",view:{template:"<c8y-platform-configuration-form></c8y-platform-configuration-form>"},requiresAnyRole:["ROLE_OPTION_MANAGEMENT_READ"],showIf:["c8yTenant",function(e){return e.isCurrentUserTopTenant()}]},l="configuration",m=[{title:i("Applications"),id:"applicationsOptions",items:["default.tenant.applications"]},{title:i("Passwords"),id:"passwordsOptions",items:["system.password.enforce.strength","system.password.limit.validity","system.password.history.size","system.password.green.min-length"]},{title:i("Two-factor authentication"),id:"twoFactorAuthenticationOptions",items:["two-factor-authentication.token.sms.template"]},{title:i("Support link"),id:"supportLinkOptions",items:["system.support.url"]},{title:i("Password reset"),id:"passwordResetOptions",items:["passwordReset.sendNotificationToUnknownEmails","passwordReset.token.email.template","passwordReset.user.not.found.email.template","passwordReset.email.subject","passwordReset.success.email.template","passwordReset.invite.template"]},{title:i("Support user"),id:"supportUserOptions",items:["system.support-user.enabled","system.support-user.validity-limit"]},{title:i("Email server"),id:"emailServerOptions",items:["ui.email.protocolAndEncryption","email.host","email.port","email.username","credentials.email.password","email.from"]},{title:i("Data export"),id:"dataExportOptions",items:["export.data.mail.subject","export.data.mail.text","export.data.mail.text.userunauthorized"]},{title:i("Storage limit"),id:"storageLimitOptions",items:["storageLimit.warning.email.subject","storageLimit.warning.email.template","storageLimit.process.email.subject","storageLimit.process.email.template"]},{title:i("Suspending tenants"),id:"suspendingTenantsOptions",items:["tenantSuspend.mail.sendtosuspended","tenantSuspend.mail.additional.address","tenantSuspend.mail.subject","tenantSuspend.mail.text"]}];return{$get:s,init:function(){a(),t.addNavigation({name:i("Configuration"),parent:i("Settings"),path:n.path,icon:n.icon,showIfPermissions:{anyRole:n.requiresAnyRole},showIf:n.showIf})},hookViews:a};function a(){e.when("/".concat(n.path),n.view)}function s(s,e,r,t,i){return{getSchema:n,getForm:function(t){var i=t?[]:m;return _.forEach(m,function(e){_.includes(t,e.id)&&i.push(e)}),s.when(_.map(i,a))},getSchemaFormOptions:function(){return t.hasAnyRole(["ROLE_OPTION_MANAGEMENT_ADMIN"]).then(function(e){return{formDefaults:{readonly:!e}}})},getConfiguration:function(){return s.all({options:r.listAll({category:l}),schema:n()}).then(function(e){var t=e.options,s=e.schema,n=_.transform(t,function(e,t){var i=t.key;e[i]=r.parseOptionRawValue(t.value);var n=e[i],a=_.get(s,["properties",i,"type"]);"string"===a&&_.isFunction(_.get(n,"toString"))&&(e[i]=n.toString())},{});return _.forEach(s.properties,function(e,t){var i=e.convertValueOnLoad;i&&(n[t]=i(n[t],n))}),n})},saveConfiguration:function(t,i){return n().then(function(e){return function(e,s,t){var n=_.cloneDeep(e);return _.forEach(t.properties,function(e,t){var i=e.convertValueOnSave;i&&(n[t]=i(n[t],n))}),_.forEach(t.properties,function(e,t){e.skipOnSave&&_.unset(n,t)}),_(n).map(function(e,t){var i,n=_.get(s,[t]),a=e;return _.isEqual(n,a)||(i={key:t,oldValue:n,newValue:a}),i}).filter().value()}(t,i,e)}).then(o)}};function n(){return s.when({type:"object",properties:{"system.password.enforce.strength":{title:i.getString('Enforce "green" passwords for all users'),type:"boolean"},"system.password.limit.validity":{title:i.getString("Password validity limit (days)"),description:i.getString("Leave empty to use value from tenant options"),type:"number",minimum:0,maximum:999999},"system.password.history.size":{title:i.getString("Password history size"),type:"number",minimum:0,"x-schema-form":{placeholder:"".concat(i.getString("e.g.")," 10")}},"system.password.green.min-length":{title:i.getString('Minimal length of "green" password'),description:i.getString("Leave empty to skip this constraint"),type:"number",minimum:8,maximum:32},"default.tenant.applications":{title:i.getString("Default applications for new tenants"),description:i.getString("Comma-separated list of application names"),type:"string","x-schema-form":{placeholder:"".concat(i.getString("e.g.")," administration,devicemanagement,cockpit")}},"ui.email.protocolAndEncryption":{title:i.getString("Protocol and encryption"),type:"string",enum:["SMTP_PLAIN","SMTP_ENCRYPTED","SMTPS_ENCRYPTED"],"x-schema-form":{titleMap:[{value:"SMTP_PLAIN",name:i.getString("SMTP (no encryption)")},{value:"SMTP_ENCRYPTED",name:i.getString("SMTP (STARTTLS)")},{value:"SMTPS_ENCRYPTED",name:i.getString("SMTPS (SSL/TLS)")}]},convertValueOnLoad:function(e,t){var i=t["email.protocol"],n=t["email.connection.encrypted"]||!1;return"smtp"===i?n?"SMTP_ENCRYPTED":"SMTP_PLAIN":"smtps"===i?"SMTPS_ENCRYPTED":void 0},skipOnSave:!0},"email.protocol":{title:i.getString("Protocol"),type:"string",enum:["smtp","smtps"],"x-schema-form":{titleMap:[{value:"smtp",name:"SMTP"},{value:"smtps",name:"SMTPS"}]},convertValueOnSave:function(e,t){var i=t["ui.email.protocolAndEncryption"]||"",n=_.get(i.match(/^(.+?)_(.+?)$/),1);return n?_.toLower(n):n}},"email.connection.encrypted":{title:i.getString("Connection encrypted"),type:"boolean",convertValueOnSave:function(e,t){var i=t["ui.email.protocolAndEncryption"]||"";return"ENCRYPTED"===_.get(i.match(/^(.+?)_(.+?)$/),2)}},"email.host":{title:i.getString("Host"),type:"string","x-schema-form":{placeholder:"".concat(i.getString("e.g.")," localhost")}},"email.port":{title:i.getString("Port"),type:"number",minimum:1,maximum:65535,"x-schema-form":{placeholder:"".concat(i.getString("e.g.")," 25")}},"email.username":{title:i.getString("Username"),type:"string"},"credentials.email.password":{title:i.getString("Password"),type:"string","x-schema-form":{type:"password"}},"email.from":{title:i.getString("Sender address"),type:"string","x-schema-form":{type:"email"}},"passwordReset.sendNotificationToUnknownEmails":{title:i.getString("Send notifications to unknown email addresses"),type:"boolean"},"passwordReset.email.subject":{title:i.getString("Email subject"),description:i.getString("Subject used for all password reset related emails"),type:"string"},"passwordReset.token.email.template":{title:i.getString("Password reset email template (when address is known)"),description:i.getString("Placeholders: {tenant-domain}, {host}, {token}, {email}. Whole link to reset password can be e.g.: {tenant-domain}/apps/devicemanagement/index.html?token={token}&email={email}"),type:"string","x-schema-form":{type:"textarea"}},"passwordReset.user.not.found.email.template":{title:i.getString("Password reset email template (when address is not known)"),type:"string","x-schema-form":{type:"textarea"}},"passwordReset.success.email.template":{title:i.getString("Password change confirmation email template"),description:i.getString("Placeholders: {host}, {tenant-domain}"),type:"string","x-schema-form":{type:"textarea"}},"passwordReset.invite.template":{title:i.getString("Invitation email template"),description:i.getString("Placeholders: {tenant-domain}, {host}, {token}. Whole link to setup password can be e.g.: {tenant-domain}/apps/devicemanagement/index.html?token={token}"),type:"string","x-schema-form":{type:"textarea"}},"export.data.mail.subject":{title:i.getString("Email subject"),description:i.getString("Placeholders: {tenant-domain}, {host}, {binaryId}. Whole link to result file is: {tenant-domain}/inventory/binaries/{binaryId}"),type:"string"},"export.data.mail.text":{title:i.getString("Email template"),description:i.getString("Placeholders: {tenant-domain}, {host}, {binaryId}. Whole link to result file is: {tenant-domain}/inventory/binaries/{binaryId}"),type:"string","x-schema-form":{type:"textarea"}},"export.data.mail.text.userunauthorized":{title:i.getString("User unauthorized error message"),description:i.getString("Placeholders: {user}, {exportApi}"),type:"string"},"two-factor-authentication.token.sms.template":{title:i.getString("Verification token SMS template"),description:i.getString("Placeholder: {token} - created token"),type:"string","x-schema-form":{placeholder:i.getString("e.g.: Verification code: {token}")}},"system.support.url":{title:i.getString("URL"),type:"string",description:i.getString('Possible values: URL string, "false`KEEP_ORIGINAL`" (hides the link), leave empty (uses the default)')},"storageLimit.warning.email.subject":{title:i.getString("Warning email subject"),description:i.getString("Email which will be sent one day before data is deleted"),type:"string"},"storageLimit.warning.email.template":{title:i.getString("Warning email template"),description:i.getString("Email which will be sent one day before data is deleted. Placeholders: {tenant-domain}, {tenant}, {size} - storage usage in %"),type:"string","x-schema-form":{type:"textarea"}},"storageLimit.process.email.subject":{title:i.getString("Limit exceeded email subject"),description:i.getString("Email which will be sent after over-limit data has been deleted"),type:"string"},"storageLimit.process.email.template":{title:i.getString("Limit exceeded email template"),description:i.getString("Email which will be sent after over-limit data has been deleted. Placeholders: {tenant-domain}, {tenant}, {size} - storage usage in %"),type:"string","x-schema-form":{type:"textarea"}},"tenantSuspend.mail.sendtosuspended":{title:i.getString("Send email to suspended tenant's administrator"),type:"boolean"},"tenantSuspend.mail.additional.address":{title:i.getString("Tenant suspended email additional receiver"),type:"string","x-schema-form":{type:"email"}},"tenantSuspend.mail.subject":{title:i.getString("Tenant suspended email subject"),description:i.getString("Placeholder: {tenant} - suspended tenant's ID; {tenant-domain} - tenant's domain"),type:"string"},"tenantSuspend.mail.text":{title:i.getString("Tenant suspended email template"),description:i.getString("Placeholder: {tenant} - suspended tenant's ID; {tenant-domain} - tenant's domain"),type:"string","x-schema-form":{type:"textarea"}},"system.support-user.enabled":{title:i.getString("Activate support user"),description:i.getString('Possible values: "true`KEEP_ORIGINAL`", "false`KEEP_ORIGINAL`", date until user should remain active'),type:"string","x-schema-form":{placeholder:"".concat(i.getString("e.g."),": ").concat(moment().add(1,"day").format(e.dateFullFormat))}},"system.support-user.validity-limit":{title:i.getString("Validity limit"),description:i.getString("Each support user request from subtenant user will prolong support user access by the given number of hours (default: 24 hours)"),type:"number",minimum:0,"x-schema-form":{placeholder:"".concat(i.getString("e.g.")," 24")}}}})}function a(e){var t={type:"section"};return _.assign(t,e),t.items=_.map(t.items,function(e){return{key:[e]}}),t.title=i.getString(t.title),t}function o(e){return _.reduce(e,function(e,t){var i=_.constant(s.when()),n=_.isNull(t.newValue),a=""===t.newValue;return n||a?_.isUndefined(t.oldValue)||(i=r.deleteOption):i=r.updateOption,e.then(_.partial(i,{category:l,key:t.key,value:t.newValue}))},s.when())}}}e.$inject=["c8yViewsProvider","c8yNavigatorProvider","gettext"],angular.module("c8y.platformConfiguration").provider("c8yPlatformConfigurationUi",e)}();