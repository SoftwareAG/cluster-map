<div class="card">
  <div class="card-header">
    <h4 class="card-title" translate>
      <span title="Two-factor authentication">TFA</span> settings
    </h4>
  </div>
  <hr />
  <div class="card-block" ng-show="vm.initialized">
    <form name="vm.tfaSettingsForm" ng-submit="vm.saveSettings(vm.tfaSettingsForm)">
      <div class="form-group">
        <label class="c8y-checkbox" ng-class="{ disabled: vm.isReadOnly('enabled') }">
          <input type="checkbox" ng-model="vm.enabled" ng-disabled="vm.isReadOnly('enabled')" />
          <span></span>
          <span title="{{ 'Allow two-factor authentication' | translate }}" translate
            >Allow two-factor authentication</span
          >
        </label>
      </div>

      <div class="form-group">
        <label class="c8y-radio radio-inline" ng-class="{ disabled: !vm.smsAppAvailable }">
          <input
            type="radio"
            value="SMS"
            ng-model="vm.strategy"
            ng-disabled="!vm.smsAppAvailable"
          />
          <span></span> {{ 'SMS based' | translate }}
          <a
            ng-show="!vm.smsAppAvailable"
            href=""
            class="text-warning"
            popover-trigger="'focus'"
            popover-append-to-body="true"
            popover-placement="right"
            uib-popover-html="vm.smsWarningPopover | translate"
          >
            <i c8y-icon="exclamation-triangle"></i>
        </a>
        </label>
        <label class="c8y-radio radio-inline" ng-class="{ disabled: !vm.oAuthLoginMode() }">
          <input
            type="radio"
            value="TOTP"
            ng-model="vm.strategy"
            ng-disabled="!vm.oAuthLoginMode()"
          />
          <span></span>
          {{ 'Google Authenticator (TOTP)' | translate }}
          <a
            popover-append-to-body="true"
            popover-placement="right"
            uib-popover-html="vm.totpPopover | translate"
          >
            <i c8y-icon="question-circle-o"></i>
          </a>
        </label>
      </div>

      <div class="form-group" ng-if="vm.strategy === 'TOTP'">
        <label
          class="c8y-checkbox"
          ng-class="{ disabled: !vm.enabled || vm.isReadOnly('enforced')}"
        >
          <input
            type="checkbox"
            ng-model="vm.enforced"
            ng-disabled="!vm.enabled || vm.isReadOnly('enforced')"
          />
          <span></span>
          <span translate>Enforce TOTP two-factor authentication on all users</span>
        </label>
      </div>

      <div ng-if="!vm.tenantScopeSettingsEnabled" class="alert alert-info">
        <translate>The following settings are managed on platform level.</translate>
      </div>
      <div class="row" ng-if="vm.strategy === 'SMS'">
        <div class="col-sm-6">
          <div
            class="form-group"
            ng-class="{'has-error': vm.tfaSettingsForm.tokenValidity.$dirty && vm.tfaSettingsForm.tokenValidity.$invalid}"
          >
            <label translate>Limit token validity for</label>
            <div class="input-group">
              <input
                class="form-control text-right"
                name="tokenValidity"
                maxlength="6"
                ng-model="vm.tokenValidity"
                ng-pattern="vm.limitValidityRegex"
                ng-disabled="!vm.tenantScopeSettingsEnabled"
                placeholder="{{ 'e.g.' | translate }} 43200"
                ng-required="vm.tenantScopeSettingsEnabled"
              />
              <span class="input-group-addon" translate>minutes</span>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div
            class="form-group"
            ng-class="{'has-error': vm.tfaSettingsForm.pinValidity.$dirty && vm.tfaSettingsForm.pinValidity.$invalid}"
          >
            <label translate>Limit verification code validity for</label>
            <div class="input-group">
              <input
                class="form-control text-right"
                maxlength="6"
                name="pinValidity"
                ng-model="vm.pinValidity"
                ng-pattern="vm.limitValidityRegex"
                ng-disabled="!vm.tenantScopeSettingsEnabled"
                placeholder="{{ 'e.g.' | translate }} 30"
                ng-required="vm.tenantScopeSettingsEnabled"
              />
              <span class="input-group-addon" translate>minutes</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <button
          title="{{ 'Save TFA settings' | translate }}"
          type="submit"
          class="btn btn-primary"
          ng-disabled="vm.tfaSettingsForm.$invalid || vm.tfaSettingsForm.$pristine"
          translate
        >
          Save TFA settings
        </button>
      </div>
    </form>
  </div>
</div>
