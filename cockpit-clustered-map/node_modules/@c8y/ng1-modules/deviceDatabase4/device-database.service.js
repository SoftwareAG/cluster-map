"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,a=!1,i=void 0;try{for(var u,s=e[Symbol.iterator]();!(r=(u=s.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function asyncGeneratorStep(e,t,n,r,a,i,u){try{var s=e[i](u),o=s.value}catch(e){return void n(e)}s.done?t(o):Promise.resolve(o).then(r,a)}function _asyncToGenerator(s){return function(){var e=this,u=arguments;return new Promise(function(t,n){var r=s.apply(e,u);function a(e){asyncGeneratorStep(r,t,n,a,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,a,i,"throw",e)}a(void 0)})}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(u,o,e,s,c,t,a,r,n,p,i){var l={name:"feature-fieldbus4"},m=e.has("FIELDBUS_UI_VERSION")?e.get("FIELDBUS_UI_VERSION"):4,d="c8y_IsDeviceType",f="c8y_ModbusDeviceType",g="%%",y=s.createEnum(["DISCRETE_IO","REGISTER"]),v=s.createEnum([{name:"FPORT",label:"FPort"},{name:"PAYLOAD",label:"Payload"}]),b=s.dataFilePath("devicetypes"),h={common:{name:null},deviceType:{c8y_Coils:[],c8y_Registers:[]},element:{number:null},discreteIO:{},discreteOutput:{input:!1},discreteInput:{input:!0},register:{multiplier:1,divisor:1,offset:0,decimalPlaces:0,startBit:0,noBits:16,unit:"",signed:!1},canbusRegister:{noBits:64,offset:0},canopenRegister:{},holdingRegister:{input:!1},inputRegister:{input:!0}},T=[],M=[];return{ElementType:y,MessageIdSources:v,metaDefaults:{discreteIO:{enumValues:[{value:0,label:"0"},{value:1,label:"1"}]}},registerFeaturesManifest:function(e){var t=u.resolve(e);T.push(t),t.then(function(e){e&&M.push(e)})},areAnyFeaturesManifestsRegistered:function(){return S().then(function(e){return 0<e.length})},getFeaturesManifestsAsync:S,getFeaturesManifests:function(){return M},getDeviceTypeFeatures:Qe,getElementTypeLabel:function(e,t){var n,r=_.get(e,"meta.type");if(r){var a=_.get(e,"input");if(r===y.DISCRETE_IO)n=p(a?"Discrete input":"Coil (discrete output)");else if(r===y.REGISTER)if(a)n=p("Input register");else{var i=Qe(t);n=_.get(i,"holdingRegisters.elementTypeLabel",p("Holding register"))}}return n},getFieldbusVersion:B,getEmptyDeviceType:function(){var e=h.common,t=h.deviceType;return _.cloneDeep(_objectSpread({},e,t))},getAvailableDeviceTypes:function(e,t){return R.apply(this,arguments)},getDeviceTypeFromDevice:function(e){var t=_.flatten(_.map(M,"deviceFragments")),n=_.head(_.compact(_.at(e,t))),r=_.get(n,"type"),a=r&&r.match(/\/inventory\/managedObjects\/(\d+)/),i=_.nth(a,1);if(i)return I(i);return u.resolve(null)},getFieldbusVersionFromDevice:function(e){var t=_.map(M,"deviceConfiguration.fragment"),n=_.head(_.compact(_.at(e,t)));return _.get(n,"maxFieldbusVersion",4)},getDeviceType:I,save:C,exportDeviceTypeAndSaveAs:function(e){var t="".concat(e.name,".json"),n=JSON.stringify(function(e){return e.c8y_ModbusDeviceTypeInfo=function(e){return _.omit(_objectSpread({},_.get(e,"c8y_ModbusDeviceTypeInfo",{}),{name:e.name,minFieldbusUI:m,fieldbusType:e.fieldbusType}),["id","category","description"])}(e),e.c8y_Coils=_.map(e.c8y_Coils,ae),e.c8y_Registers=_.map(e.c8y_Registers,ae),_.pick(e,["c8y_ModbusDeviceTypeInfo","c8y_Coils","c8y_Registers","c8y_useServerTime","c8y_MessageIdConfiguration"])}(e),null,2),r=new Blob([n],{type:"application/json"});window.saveAs(r,t)},importDeviceTypeWithUI:function(){return n({component:"c8yImportDeviceTypeModal"}).then(C)},getPredefinedDeviceTypeInfos:function(){return ie.apply(this,arguments)},isDeviceTypeSupported:oe,isDeviceTypeSupportedAsync:function(n){return S().then(function(e){return _.map(e,"fieldbusType")}).then(function(e){var t=Xe(n);return _.includes(e,t)})},getPredefinedDeviceType:Ze,downloadPredefinedDeviceTypeAndSaveAs:function(e){return ce.apply(this,arguments)},upgradeDeviceType:E,getElementsWithMeta:function(t){var e=_.get(t,"c8y_Coils",[]),n=_.get(t,"c8y_Registers",[]);return _.union(_.map(e,function(e){return pe(e)}),_.map(n,function(e){return Te(e,t)}))},addDiscreteIOsMeta:function(e){if(e)return e.c8y_Coils=_.map(e.c8y_Coils,pe),e;return},addDiscreteIOMeta:pe,removeDiscreteIOMeta:function(e){var t=e;t.meta&&(t=_.flow([ye,_e,ve,be,he])(t),_.unset(t,"meta"));return t},addRegistersMeta:function(t){if(t)return t.c8y_Registers=_.map(t.c8y_Registers,function(e){return Te(e,t)}),t;return},addRegisterMeta:Te,removeRegisterMeta:function(e){var t=e;e.meta&&(t=_.flow([ke,xe,Ve,Be,Ne,Pe,Fe,$e,Ge,Le])(e),_.unset(t,"meta"));return t},removeAllElements:function(e){e.c8y_Registers=[],e.c8y_Coils=[]},getElementRefId:function(e){var t=_.compact(We(e));return _.head(t)},findElementBestMatchingRefId:function(e,t,n){return _(e).chain().map(function(e){return{score:function(e,t,n){var r=e.meta.type.value===n,a=We(e),i=_.findIndex(a,_.negate(_.isUndefined)),u=_.indexOf(a,t);return r&&0<=u?i-u:void 0}(e,t,n),element:e}}).reject(function(e){return _.isUndefined(e.score)}).orderBy("score").head().get("element").value()},getDiscreteOutputsCategorized:function(e){return _(e.c8y_Coils).reject("input").groupBy(Je).value()},getDiscreteInputsCategorized:function(e){return _(e.c8y_Coils).filter("input").groupBy(Je).value()},getHoldingRegistersCategorized:function(e){return _(e.c8y_Registers).reject("input").groupBy(Je).value()},getInputRegistersCategorized:function(e){return _(e.c8y_Registers).filter("input").groupBy(Je).value()},getEmptyDiscreteOutput:function(){return _.cloneDeep(_objectSpread({},h.common,h.element,h.discreteIO,h.discreteOutput))},getEmptyDiscreteInput:function(){return _.cloneDeep(_objectSpread({},h.common,h.element,h.discreteIO,h.discreteInput))},getEmptyHoldingRegister:function(e){return"canbus"!==e.fieldbusType?"canopen"!==e.fieldbusType?_.cloneDeep(_objectSpread({},h.common,h.element,h.register,h.holdingRegister)):_.cloneDeep(_objectSpread({},h.common,h.canopenRegister)):_.cloneDeep(_objectSpread({},h.common,h.element,h.register,h.canbusRegister,h.holdingRegister))},getEmptyInputRegister:function(){return _.cloneDeep(_objectSpread({},h.common,h.element,h.register,h.inputRegister))},editDiscreteIOWithUI:function(e,t){return n({component:"c8yConfigureDiscreteIOModal",title:ze(e),resolve:_objectSpread({title:function(){return ze(e)}},qe(e,t.c8y_Coils,t))})},editRegisterWithUI:function(e,t){return n({component:"c8yConfigureRegisterModal",resolve:_objectSpread({title:function(){return function(e,t){var n=Qe(t);if(e.input)return e.name?i.getString('Edit input register: "{{name}}"',e):p("New input register");if(e.name)return i.getString(_.get(n,"holdingRegisters.editRegisterModalTitle",p('Edit holding register: "{{name}}"')),e);return _.get(n,"holdingRegisters.newRegisterModalTitle",p("New holding register"))}(e,t)}},qe(e,t.c8y_Registers,t))})},addEmptyEnumValue:function(e){e.meta.enumValues=e.meta.enumValues||[],e.meta.enumValues.push({value:null,label:null})},removeEnumValue:function(e,t){e.meta.enumValues=_.without(e.meta.enumValues,t)},areOverlappingRegisters:function(e,t,n){var r=Ye(e,n),a=Ye(t,n),i=Math.max(r.start,a.start),u=Math.min(r.end,a.end);return i<=u},getValuesRange:Ce,openFieldbusSelector:function(e){return n({component:"c8ySelectFieldbusPropertyModal",resolve:{modalParams:function(){return _.defaults(e,{})}}})},downloadPredefinedDeviceTypeHref:function(e){return Ke.apply(this,arguments)},predefinedDeviceTypeHrefFilename:function(e){return"".concat(e.id,".json")},isFieldbusDevice:function(t){return _.some(M,function(e){return _.some(e.deviceFragments,function(e){return _.has(t,e)})})},isFeatureFieldbus4Available:function(){return t.isAvailable(l)}};function S(){return u.all(T).then(_.compact)}function R(){return(R=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return!0,r={},a={__and:[{__or:[{__has:d},{type:f}]},{fieldbusType:{__in:_.map(M,"fieldbusType")}}]},_.isEmpty(t)||(a.__and=[].concat(_toConsumableArray(a.__and),[t])),i=s.createListMapper(function(e){return E(e)}),e.next=7,c.listQuery(a,r,!0,n).then(i);case 7:return u=e.sent,e.abrupt("return",u);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function I(e){return w.apply(this,arguments)}function w(){return(w=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=s,e.next=3,c.detail(t);case 3:return e.t1=e.sent,n=e.t0.getResData.call(e.t0,e.t1),e.abrupt("return",E(n));case 6:case"end":return e.stop()}},e)}))).apply(this,arguments)}function E(e){return _.flow([D,A,O,x,V])(e)}function D(e){return _.forEach(e.c8y_Coils,function(e){!e.enumValues&&e.statusMapping&&_.isArray(e.statusMapping.enumValues)&&(e.enumValues={0:e.statusMapping.enumValues[0],1:e.statusMapping.enumValues[1]},_.unset(e,"statusMapping.enumValues")),_.isUndefined(e.input)&&(e.input=h.discreteOutput.input)}),e}function A(e){var r=Qe(e);return _.forEach(e.c8y_Registers,function(e){var t=e.input?"inputRegisters":"holdingRegisters",n=_.get(r,t,{});_.get(n,"startBit")&&_.defaults(e,{startBit:h.register.startBit}),_.get(n,"noBits")&&_.defaults(e,{noBits:h.register.noBits}),_.get(n,"options.signed")&&_.defaults(e,{signed:h.register.signed}),!e.unit&&e.measurementMapping&&e.measurementMapping.unit&&(e.unit=e.measurementMapping.unit,_.unset(e,"measurementMapping.unit")),_.isUndefined(e.input)&&(e.input=h.holdingRegister.input)}),e}function O(e){return e.fieldbusType=Xe(e),e}function C(e){return j.apply(this,arguments)}function j(){return(j=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=_.flow([k,x,N,F,$,G,V,U])(t),e.abrupt("return",c.save(n).then(s.getResData).then(function(e){return t.id?e:ne(e).then(function(){return e})}));case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function U(e){return c.addGlobalFlag(e,!0)}function k(e){if(!e.type){var t=Qe(e);e.type=_.get(t,"type",f)}return e}function x(e){return _.set(e,d,{})}function V(e){return _.set(e,"fieldbusVersion",B(e))}function B(t){var e=Qe(t).versions,n=_.findLast(e,function(e){return _.some(e.checks,function(e){return e(t)})});return _.get(n,"number",4)}function N(e){return e.c8y_Coils=_.map(e.c8y_Coils,P),e.c8y_Registers=_.map(e.c8y_Registers,P),e}function P(e){return e.id||(e.id=String(Math.random()).substr(2)),e}function F(e){return e.c8y_Coils=_.orderBy(e.c8y_Coils,["number","input"]),e.c8y_Registers=_.orderBy(e.c8y_Registers,["startBit","number","input","index","subIndex"]),e}function $(e){var t=Qe(e);return!!_.get(t,"configuration.messageIdConfiguration.length")&&(e.c8y_MessageTypes=function(n){return _.reduce(["c8y_Registers","c8y_Coils"],function(e,t){return _.merge(e,function(t,r){var e=_.groupBy(t[r],"messageTypeId"),n=_.mapValues(e,function(e){return _.map(e,function(e){return _.indexOf(t[r],e)})});return _.reduce(n,function(e,t,n){return e[n]={},e[n][r]=t,e},{})}(n,t))},{})}(e)),e}function G(e){var t=function(e){var t=Qe(e).customizeSmartRestTemplates||_.identity,n={requestTemplates:_.flattenDeep([function(e){return{msgId:100,method:"PUT",contentType:"application/vnd.com.nsn.cumulocity.managedObject+json",placeholder:g,resourceUri:"/inventory/managedObjects/".concat(g),templateString:K([{key:"c8y_CoilStatus",value:new te(L(e.c8y_Coils).map(function(e){return{key:e.name,value:g,raw:!0}}).value())}]),values:["UNSIGNED"].concat(_toConsumableArray(L(e.c8y_Coils).map(function(){return"UNSIGNED"}).value()))}}(e),function(e){return{msgId:101,method:"PUT",contentType:"application/vnd.com.nsn.cumulocity.managedObject+json",placeholder:g,resourceUri:"/inventory/managedObjects/".concat(g),templateString:K([{key:"c8y_RegisterStatus",value:new te(L(e.c8y_Registers).map(function(e){return{key:e.name,value:g,raw:!0}}).value())}]),values:["UNSIGNED"].concat(_toConsumableArray(L(e.c8y_Registers).map(function(){return"NUMBER"}).value()))}}(e),[W(102,"EXECUTING"),W(103,"SUCCESSFUL"),W(104,"FAILED")],function(e){return _.flow([H,Q,X])({deviceType:e,msgId:300,templates:[]}).templates}(e)]),responseTemplates:_.flattenDeep([{msgId:200,condition:"$.c8y_SetCoil",pattern:["$.id","$.c8y_SetCoil.address","$.c8y_SetCoil.input","$.c8y_SetCoil.coil","$.c8y_SetCoil.value"]},{msgId:201,condition:"$.c8y_SetRegister",pattern:["$.id","$.c8y_SetRegister.ipAddress","$.c8y_SetRegister.address","$.c8y_SetRegister.input","$.c8y_SetRegister.register","$.c8y_SetRegister.startBit","$.c8y_SetRegister.noBits","$.c8y_SetRegister.value"]},{msgId:202,condition:"$.c8y_ModbusDevice",pattern:["$.id","$.deviceId","$.c8y_ModbusDevice.id","$.c8y_ModbusDevice.address","$.c8y_ModbusDevice.type","$.c8y_ModbusDevice.protocol"]},{msgId:203,condition:"$.c8y_ModbusSource",pattern:["$.id"]}])};return t(n,e)}(e);return _.set(e,"com_cumulocity_model_smartrest_SmartRestTemplate",t)}function L(e){return _(e).filter("statusMapping.status")}function W(e,t){return{msgId:e,method:"PUT",contentType:"application/vnd.com.nsn.cumulocity.operation+json",placeholder:g,resourceUri:"/devicecontrol/operations/".concat(g),templateString:K({status:t}),values:["UNSIGNED"]}}function H(e){var t=e.deviceType,n=e.msgId,r=e.templates,a=_.filter(t.c8y_Coils,"alarmMapping"),i=_.filter(t.c8y_Registers,"alarmMapping"),u=Qe(t),s=u.getCoilSource||z,o=u.getRegisterSource||q,c=n;return _.forEach(a,function(e){r.push(J(c,t,e.alarmMapping,s(e))),e.alarmMapping.raiseAlarmTemplate=c,c+=1}),_.forEach(i,function(e){r.push(J(c,t,e.alarmMapping,o(e))),e.alarmMapping.raiseAlarmTemplate=c,c+=1}),{deviceType:t,templates:r,msgId:c}}function J(e,t,n,r){return{msgId:e,method:"POST",contentType:"application/vnd.com.nsn.cumulocity.alarm+json",accept:"application/vnd.com.nsn.cumulocity.alarm+json",placeholder:g,resourceUri:"/alarm/alarms",templateString:K([{key:"source",value:{id:g}},{key:"type",value:n.type},{key:"status",value:a.status.ACTIVE},{key:"severity",value:n.severity},{key:"time",value:g},{key:"text",value:n.text},{key:r.key,value:r.value}]),values:["UNSIGNED",Y(t)]}}function z(e){return{key:"c8y_ModbusSource",value:{coil:_.pick(e,"input","number")}}}function q(e){return{key:"c8y_ModbusSource",value:{register:_.pick(e,["input","number","startBit","noBits"])}}}function Q(e){var r=e.deviceType,t=e.msgId,a=e.templates,n=_([].concat(_toConsumableArray(r.c8y_Coils),_toConsumableArray(r.c8y_Registers))).filter("measurementMapping").groupBy("measurementMapping.type").value(),i=t;return _.forEach(n,function(e,t){var n=_.map(e,function(e){return _.set(e.measurementMapping,"unit",e.unit||e.measurementMapping.unit)});a.push(function(e,t,n,i){return{msgId:e,method:"POST",contentType:"application/vnd.com.nsn.cumulocity.measurement+json",placeholder:g,resourceUri:"/measurement/measurements",templateString:K(function(){var r=n,a=_defineProperty({source:{id:g},time:g,type:r},r,{});return _.forEach(i,function(e){var t=e.series,n=e.unit;a[r][t]={value:"%n",unit:n}}),a}()),values:["UNSIGNED",Y(t)].concat(_toConsumableArray(_.map(i,function(){return"NUMBER"})))}}(i,r,t,n)),_.forEach(n,function(e){e.sendMeasurementTemplate=i,_.unset(e,"unit")}),i+=1}),{deviceType:r,templates:a,msgId:i}}function X(e){var t=e.deviceType,n=e.msgId,r=e.templates,a=[].concat(_toConsumableArray(t.c8y_Coils),_toConsumableArray(t.c8y_Registers)),i=n;return _.forEach(a,function(e){_.isUndefined(e.eventMapping)||(r.push(function(e,t,n,r){return{msgId:e,method:"POST",contentType:"application/vnd.com.nsn.cumulocity.event+json",placeholder:g,resourceUri:"/event/events",templateString:K([{key:"source",value:{id:g}},{key:"time",value:g},{key:"type",value:r.type},{key:"text",value:r.text},{key:n.name,value:g,raw:!0}]),values:["UNSIGNED",Y(t),"NUMBER"]}}(i,t,e,e.eventMapping)),e.eventMapping.eventTemplate=i,i+=1)}),{deviceType:t,templates:r,msgId:i}}function Y(e){return e.c8y_useServerTime?"NOW":"DATE"}function K(e,t){var n;return e instanceof te?n=Z(e.kvObj):_.isArray(e)?n=Z(e):_.isObjectLike(e)&&(n=angular.toJson(e)),n=n.replace(/"%n"/g,t||g)}function Z(e){var t=_.map(e,ee);return"{".concat(t.join(","),"}")}function ee(e){var t,n=e.key,r=e.value,a=e.raw,i={};return(t=r instanceof te?(i[n]=":::INNER_OBJECT_STRING:::",JSON.stringify(i).replace('":::INNER_OBJECT_STRING:::"',Z(r.kvObj))):a?(i[n]=":::RAW_VALUE:::",JSON.stringify(i).replace('":::RAW_VALUE:::"',r)):(i[n]=r,JSON.stringify(i))).substr(1,t.length-2)}function te(e){this.kvObj=e}function ne(e){return re.apply(this,arguments)}function re(){return(re=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.createIdentity(t,{type:"c8y_SmartRestDeviceIdentifier",externalId:t.name},{silentError:!0});case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),n=u.reject.bind(u,{errorMessage:e.t0.data.message}),e.abrupt("return",c.remove(t).then(n,n));case 10:case"end":return e.stop()}},e,null,[[0,6]])}))).apply(this,arguments)}function ae(e){return e.eventMapping&&(e.eventMapping=_.omit(e.eventMapping,["eventTemplate"])),e.alarmMapping&&(e.alarmMapping=_.omit(e.alarmMapping,["raiseAlarmTemplate"])),e.measurementMapping&&(e.measurementMapping=_.omit(e.measurementMapping,["sendMeasurementTemplate"])),_.omit(e,["id","originalName","originalNumber","originalStartBit","meta"])}function ie(){return(ie=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0,t=tt(),n=t&&_.map(t)){e.next=8;break}return r="".concat(b,"/index.json"),e.t0=s,e.next=6,o.get(r);case 6:e.t1=e.sent,n=e.t0.getResData.call(e.t0,e.t1);case 8:return e.abrupt("return",_.flow([ue,se])(n));case 9:case"end":return e.stop()}var t},e)}))).apply(this,arguments)}function ue(e){return _.filter(e,function(e){return oe(e)})}function se(e){return _.filter(e,function(e){return e.minFieldbusUI<=m})}function oe(e){var t=_.map(M,"fieldbusType"),n=Xe(e);return _.includes(t,n)}function ce(){return(ce=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(t,".json"),r="predefinedDeviceTypesUrl/".concat(n),e.next=4,o.get(r);case 4:a=e.sent,i=JSON.stringify(a.data,null,2),u=a.headers("Content-Type"),s=new Blob([i],{type:u}),window.saveAs(s,n);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function pe(e){return e.meta=e.meta||{},_.flow([le,me,de,fe,ge])(e)}function le(e){return e.meta.type=e.meta.type||y.DISCRETE_IO,e}function me(e){return e.meta.enumType=e.meta.enumType||!!e.enumValues,e.meta.enumValues=e.meta.enumValues||e.enumValues&&_.map(e.enumValues,Re),e}function de(e){var t=_.get(e,"statusMapping.status");return e.meta.showStatus=e.meta.showStatus||"read"===t||"write"===t,e.meta.updateStatus=e.meta.updateStatus||"write"===t,e}function fe(e){var t=_.get(e,"alarmMapping.raiseAlarmTemplate");return e.meta.raiseAlarm=e.meta.raiseAlarm||!_.isUndefined(t),e}function ge(e){var t=_.get(e,"eventMapping.eventTemplate");return e.meta.sendEvent=e.meta.sendEvent||!_.isUndefined(t),e}function ye(e){return e.meta.type=void 0,e}function _e(r){return r.meta.enumType?(r.enumValues={},_.forEach(r.meta.enumValues,function(e){var t=e.value,n=e.label;r.enumValues[t]=n})):r.enumValues=void 0,r}function ve(e){return e.meta.showStatus||e.meta.updateStatus?(e.statusMapping=e.statusMapping||{},e.meta.showStatus&&(e.statusMapping.status="read"),e.meta.updateStatus&&(e.statusMapping.status="write")):e.statusMapping=void 0,e}function be(e){return e.meta.raiseAlarm?(e.alarmMapping=e.alarmMapping||{},e.alarmMapping.raiseAlarmTemplate=null):e.alarmMapping=void 0,e}function he(e){return e.meta.sendEvent?(e.eventMapping=e.eventMapping||{},e.eventMapping.eventTemplate=null):e.eventMapping=void 0,e}function Te(e,t){return e.meta=e.meta||{},_.flow([Me,Se,Ie,we,Ee,De,Ae,function(e){return function(e,t){var n=Qe(t)[e.input?"inputRegisters":"holdingRegisters"],r=_.get(n,"dataType.choices",[]);return e.meta.dataType=e.meta.dataType||_.find(r.values(),{value:e.dataType}),e}(e,t)},function(e){return function(e,t){var n=Qe(t)[e.input?"inputRegisters":"holdingRegisters"],r=_.get(n,"accessType.choices",[]);return e.meta.accessType=e.meta.accessType||_.find(r.values(),{value:e.accessType}),e}(e,t)},Oe])(e)}function Me(e){return e.meta.type=e.meta.type||y.REGISTER,e}function Se(e){return e.meta.enumType=e.meta.enumType||!!e.enumValues,e.meta.enumValues=e.meta.enumValues||e.enumValues&&_.map(e.enumValues,Re),e}function Re(e,t){return{label:e,value:parseFloat(t)}}function Ie(e){var t=_.get(e,"statusMapping.status");return e.meta.showStatus=e.meta.showStatus||"read"===t||"write"===t,e.meta.updateStatus=e.meta.updateStatus||"write"===t,e}function we(e){var t=_.get(e,"measurementMapping.sendMeasurementTemplate");return e.meta.sendMeasurement=e.meta.sendMeasurement||!_.isUndefined(t),e}function Ee(e){var t=_.get(e,"alarmMapping.raiseAlarmTemplate");return e.meta.raiseAlarm=e.meta.raiseAlarm||!_.isUndefined(t),e}function De(e){var t=_.get(e,"eventMapping.eventTemplate");return e.meta.sendEvent=e.meta.sendEvent||!_.isUndefined(t),e}function Ae(e){return e.meta.sendManagedObjectUpdate=e.meta.sendManagedObjectUpdate||!!e.managedObjectMapping,e}function Oe(e){return e.meta.valuesRange=e.meta.valuesRange||Ce(e),e}function Ce(e){var t,n=_.get(e.meta,"dataType",{}),r=_.get(n,"baseValuesRange",{}),a=je([n.divisor,e.divisor,1]),i=je([n.multiplier,e.multiplier,1]),u=je([n.decimalPlaces,e.decimalPlaces,0]),s=je([n.noBits,e.noBits]),o=je([n.signed,e.signed,!1]),c=r.min,p=r.max;return _.isUndefined(u)||null===u||_.isUndefined(i)||_.isUndefined(a)||(t=Ue(i*Math.pow(10,-u)/a)),_.isUndefined(o)||_.isUndefined(s)||_.isUndefined(t)||(_.isUndefined(c)&&(c=Ue((o?-Math.pow(2,s-1):0)*t)),_.isUndefined(p)&&(p=Ue((o?Math.pow(2,s-1)-1:Math.pow(2,s)-1)*t))),{base:{decimalPlaces:_.isNull(u)?void 0:u,step:t,min:c,max:p},custom:{decimalPlaces:_.isNull(u)?void 0:u,step:t,min:Math.max(c,e.min||c),max:Math.min(p,e.max||p)},mask:{min:0,max:Math.pow(2,s)},possiblePrecisionLoss:function(e,t){var n=53<e,r=!_.isUndefined(t)&&10<=function(e){return Math.floor(e)!==e?(_slicedToArray(e.toString().split("."),2)[1]||"").length:0}(t);return n||r}(s,t)}}function je(e){return _.head(_.reject(e,_.isUndefined))}function Ue(e){var t=Math.pow(10,10);return Math.round(e*t)/t}function ke(e){return e.meta.type=void 0,e}function xe(r){return r.meta.enumType?(r.enumValues={},_.forEach(r.meta.enumValues,function(e){var t=e.value,n=e.label;r.enumValues[t]=n})):r.enumValues=void 0,r}function Ve(e){return e.meta.showStatus||e.meta.updateStatus?(e.statusMapping=e.statusMapping||{},e.meta.showStatus&&(e.statusMapping.status="read"),e.meta.updateStatus&&(e.statusMapping.status="write")):e.statusMapping=void 0,e}function Be(e){return e.meta.sendMeasurement?(e.measurementMapping=e.measurementMapping||{},e.measurementMapping.sendMeasurementTemplate=null):e.measurementMapping=void 0,e}function Ne(e){return e.meta.raiseAlarm?(e.alarmMapping=e.alarmMapping||{},e.alarmMapping.raiseAlarmTemplate=null):e.alarmMapping=void 0,e}function Pe(e){return e.meta.sendEvent?(e.eventMapping=e.eventMapping||{},e.eventMapping.eventTemplate=null):e.eventMapping=void 0,e}function Fe(e){return e.meta.sendManagedObjectUpdate?e.managedObjectMapping=e.managedObjectMapping||{}:e.managedObjectMapping=void 0,e}function $e(e){return e.meta.dataType?e.dataType=e.meta.dataType.value:e.dataType=void 0,e}function Ge(e){return e.meta.accessType?e.accessType=e.meta.accessType.value:e.accessType=void 0,e}function Le(e){return e.meta.valuesRange=void 0,e}function We(e){return[function(e){return _.get(e,"id")}(e),function(e){return He(e,["input","number","startBit"])}(e),function(e){return He(e,["input","number"])}(e),function(e){return He(e,["number"])}(e)]}function He(e,t){var n=_.map(t,_.propertyOf(e));if(_.every(n,_.negate(_.isUndefined)))return n.join(",")}function Je(e){return e.category||""}function ze(e){return e.input?e.name?i.getString('Edit discrete input: "{{name}}"',e):p("New discrete input"):e.name?i.getString('Edit coil: "{{name}}"',e):p("New coil")}function qe(e,t,n){return{element:function(){return _.cloneDeep(function(e){if(e)return _objectSpread({},e,{meta:{original:_.cloneDeep(e)}});return}(e))},existingElements:function(){return _.cloneDeep(t)},existingCategories:function(){return _.cloneDeep(function(e){return _([].concat(_toConsumableArray(_.get(e,"c8y_Coils",[])),_toConsumableArray(_.get(e,"c8y_Registers",[])))).filter("category").map("category").uniq().map(function(e){return{name:e}}).value()}(n))},deviceType:function(){return _.cloneDeep(n)},fieldbusType:function(){return Xe(n)},features:function(){return Qe(n)}}}function Qe(e){return _.find(M,{fieldbusType:Xe(e)})||{}}function Xe(e){return e.fieldbusType||"modbus"}function Ye(e,t){var n=e.number,r=e.startBit,a=e.noBits,i=n*_.get(t,"noBits.base",_.get(t,"noBits.max"))+r;return{start:i,end:i+a-1}}function Ke(){return(Ke=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.id||n,e.next=3,Ze(r);case 3:return a=e.sent,e.abrupt("return",(t=a,window.btoa(unescape(encodeURIComponent(JSON.stringify(t,null,2))))));case 5:case"end":return e.stop()}var t},e)}))).apply(this,arguments)}function Ze(e){return et.apply(this,arguments)}function et(){return(et=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r,void 0,n=(tt()||{})[t],a=n&&_.clone(n._item)){e.next=8;break}return i="".concat(b,"/").concat(r,".json"),e.t0=s,e.next=6,o.get(i);case 6:return e.t1=e.sent,e.abrupt("return",e.t0.getResData.call(e.t0,e.t1));case 8:return e.abrupt("return",a);case 9:case"end":return e.stop()}var t,n},e)}))).apply(this,arguments)}function tt(){return _.get(window,"c8y.collections.devicetypes")}}e.$inject=["$q","$http","$injector","c8yBase","c8yInventory","c8yApplication","c8yAlarms","c8yIdentity","c8yModal","gettext","gettextCatalog"],angular.module("c8y.deviceDatabase4").factory("c8yDeviceDatabase",e)}();