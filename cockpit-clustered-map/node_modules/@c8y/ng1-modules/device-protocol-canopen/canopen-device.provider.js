"use strict";function asyncGeneratorStep(e,n,t,a,i,r,s){try{var o=e[r](s),d=o.value}catch(e){return void t(e)}o.done?n(d):Promise.resolve(d).then(a,i)}function _asyncToGenerator(o){return function(){var e=this,s=arguments;return new Promise(function(n,t){var a=o.apply(e,s);function i(e){asyncGeneratorStep(a,n,t,i,r,"next",e)}function r(e){asyncGeneratorStep(a,n,t,i,r,"throw",e)}i(void 0)})}}function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},a=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){e.$inject=["c8yDeviceTypeProtocolBaseProvider","c8yDeviceProtocolUiProvider","c8yViewsProvider","gettext"];var i="c8yCanopenDevice";function e(e,n,t,I){a.$inject=["c8yDeviceDatabase","c8yDeviceControl","c8yModbusDevice","gettextCatalog","c8yInventory","c8yDevices","c8yBase","c8yUser","$q"];var N={label:I("CANopen"),fieldbusType:"canopen",serviceName:i};return e.getDeviceTypeProtocolProvider(N,a);function a(e,p,g,n,t,d,c,i,m){var a=c.createEnum(_.flatten([{name:"BOOLEAN",label:I("Boolean"),value:"boolean",edsValue:1,noBits:1},{name:"SIGNED_8",label:I("Signed (8-bits)"),value:"signed8",edsValue:2,noBits:8,signed:!0},{name:"SIGNED_16",label:I("Signed (16-bits)"),value:"signed16",edsValue:3,noBits:16,signed:!0},{name:"SIGNED_24",label:I("Signed (24-bits)"),value:"signed24",edsValue:16,noBits:24,signed:!0},{name:"SIGNED_32",label:I("Signed (32-bits)"),value:"signed32",edsValue:4,noBits:32,signed:!0},{name:"SIGNED_40",label:I("Signed (40-bits)"),value:"signed40",edsValue:18,noBits:40,signed:!0},{name:"SIGNED_48",label:I("Signed (48-bits)"),value:"signed48",edsValue:19,noBits:48,signed:!0},{name:"SIGNED_56",label:I("Signed (56-bits)"),value:"signed56",edsValue:20,noBits:56,signed:!0},{name:"SIGNED_64",label:I("Signed (64-bits)"),value:"signed64",edsValue:21,noBits:64,signed:!0},{name:"UNSIGNED_8",label:I("Unsigned (8-bits)"),value:"unsigned8",edsValue:5,noBits:8,signed:!1},{name:"UNSIGNED_16",label:I("Unsigned (16-bits)"),value:"unsigned16",edsValue:6,noBits:16,signed:!1},{name:"UNSIGNED_24",label:I("Unsigned (24-bits)"),value:"unsigned24",edsValue:22,noBits:24,signed:!1},{name:"UNSIGNED_32",label:I("Unsigned (32-bits)"),value:"unsigned32",edsValue:7,noBits:32,signed:!1},{name:"UNSIGNED_40",label:I("Unsigned (40-bits)"),value:"unsigned40",edsValue:24,noBits:40,signed:!1},{name:"UNSIGNED_48",label:I("Unsigned (48-bits)"),value:"unsigned48",edsValue:25,noBits:48,signed:!1},{name:"UNSIGNED_56",label:I("Unsigned (56-bits)"),value:"unsigned56",edsValue:26,noBits:56,signed:!1},{name:"UNSIGNED_64",label:I("Unsigned (64-bits)"),value:"unsigned64",edsValue:27,noBits:64,signed:!1},{name:"REAL_32",label:I("Real (32-bits)"),value:"real32",edsValue:8,noBits:32,decimalPlaces:null,baseValuesRange:{min:-3.4*Math.pow(10,38),max:3.4*Math.pow(10,38)}},{name:"REAL_64",label:I("Real (64-bits)"),value:"real64",edsValue:17,noBits:64,decimalPlaces:null,baseValuesRange:{min:-Number.MAX_VALUE,max:Number.MAX_VALUE}}])),r=c.createEnum([{name:"READ_ONLY",label:I("Read-only"),value:"ro"},{name:"WRITE_ONLY",label:I("Write-only"),value:"wo"},{name:"READ_WRITE",label:I("Read-write"),value:"rw"},{name:"READ_WRITE_ON_PROCESS_INPUT",label:I("Read-write on process input"),value:"rwr"},{name:"READ_WRITE_ON_PROCESS_OUTPUT",label:I("Read-write on process output"),value:"rww"},{name:"CONSTANT",label:I("Constant"),value:"const"}]),s=_objectSpread({},N,{type:"c8y_CANopenDeviceType",deviceType:!0,discreteOutputs:!1,discreteInputs:!1,holdingRegisters:{sectionTitle:I("Variables"),noRegistersDefinedMessage:I("No variables defined."),elementTypeLabel:I("Variable"),newRegisterModalTitle:I("New variable"),editRegisterModalTitle:I('Edit variable: "{{name}}"'),addRegisterButtonLabel:I("Add variable"),unit:!0,validation:{invalidName:I("Name must be unique among variables."),invalidMeasurement:I("Selected measurement type and series are already used by another variable.")},index:{min:0,max:Math.pow(2,16)-1},subIndex:{min:0,max:Math.pow(2,8)-1},dataType:{choices:a},accessType:{choices:r},functionalities:{showStatus:{showIf:function(e){return _.includes([r.READ_ONLY,r.READ_WRITE,r.READ_WRITE_ON_PROCESS_INPUT,r.READ_WRITE_ON_PROCESS_OUTPUT,r.CONSTANT],_.get(e.meta,"accessType"))}},updateStatus:{showIf:function(e){return _.includes([r.READ_WRITE,r.READ_WRITE_ON_PROCESS_INPUT,r.READ_WRITE_ON_PROCESS_OUTPUT,r.WRITE_ONLY],_.get(e.meta,"accessType"))}},sendMeasurement:{showIf:o},raiseAlarm:{showIf:o,mask:!0},sendEvent:{showIf:o}}},inputRegisters:!1,options:{serverTime:!0},deviceFragments:["c8y_CANopenDevice"],deviceConfiguration:{fragment:"c8y_CANopenConfiguration",icon:"sitemap"},getRegisterSource:function(e){return{key:"c8y_CANopenSource",value:{index:e.index,subIndex:e.subIndex}}},customizeSmartRestTemplates:function(e){return R(e.responseTemplates,{msgId:201,condition:"$.c8y_SetRegister",pattern:["$.id","$.c8y_SetRegister.nodeId","$.c8y_SetRegister.index","$.c8y_SetRegister.subIndex","$.c8y_SetRegister.dataType","$.c8y_SetRegister.value"]}),R(e.responseTemplates,{msgId:202,condition:"$.c8y_CANopenAddDevice",pattern:["$.id","$.deviceId","$.c8y_CANopenAddDevice.id","$.c8y_CANopenAddDevice.nodeId","$.c8y_CANopenAddDevice.type"]}),R(e.responseTemplates,{msgId:204,condition:"$.c8y_CANopenRemoveDevice",pattern:["$.id","$.deviceId","$.c8y_CANopenDevice.nodeId"]}),e}});function o(e){return _.includes([r.READ_ONLY,r.READ_WRITE,r.READ_WRITE_ON_PROCESS_INPUT,r.READ_WRITE_ON_PROCESS_OUTPUT],_.get(e.meta,"accessType"))}return{registerFeaturesManifest:function(){e.registerFeaturesManifest(u().then(function(e){return e&&s}))},isAvailable:u,create:function(e,n){return l.apply(this,arguments)},updateElement:function(e,n,t){return y.apply(this,arguments)},onRemove:function(e,n){var t=n.id,a=n.name,i=n.nodeId;return p.create({deviceId:e.id,description:'Removed child device "'.concat(a,'" (ID: ').concat(t,")."),c8y_CANopenRemoveDevice:{id:t,name:a,nodeId:i}})}};function u(){return e.isFeatureFieldbus4Available()}function l(){return(l=_asyncToGenerator(regeneratorRuntime.mark(function e(i,r){var s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v(i,r);case 2:return s=e.sent,e.t0=c,e.next=6,d.createConfirm(s);case 6:return e.t1=e.sent,o=e.t0.getResData.call(e.t0,e.t1),e.next=10,d.addChildDevice(i,o);case 10:return o.owner=i.owner,e.next=13,d.save(o);case 13:return e.abrupt("return",p.create((n=i,t=r.deviceType,a=o,{deviceId:n.id,description:'Added child device "'.concat(a.name,'" (ID: ').concat(a.id,")."),c8y_CANopenAddDevice:{id:a.id,name:a.name,type:"/inventory/managedObjects/".concat(t.id),nodeId:a.c8y_CANopenDevice.nodeId}})));case 14:case"end":return e.stop()}var n,t,a},e)}))).apply(this,arguments)}function v(e,n){return b.apply(this,arguments)}function b(){return(b=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.current();case 2:return a=e.sent,e.abrupt("return",{name:t.name,type:t.deviceType.name,c8y_CANopenDevice:{type:"/inventory/managedObjects/".concat(t.deviceType.id),nodeId:t.nodeId},c8y_SupportedOperations:["c8y_Command"],owner:a.id});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function y(){return(y=_asyncToGenerator(regeneratorRuntime.mark(function e(o,d,c){var u,l,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(g.canUpdateElement(o,d)){e.next=2;break}return e.abrupt("return",m.reject());case 2:return void 0,t=(n={device:o,register:d,valueMap:c}).device,a=n.register,i=n.valueMap,r=i.label||i.value,s=!i.label&&a.unit?" ".concat(a.unit):"",u={deviceId:t.id,description:'Change value of "'.concat(a.name,'" to ').concat(r).concat(s,"."),c8y_SetRegister:{nodeId:t.c8y_CANopenDevice.nodeId,index:a.index,subIndex:a.subIndex,dataType:a.dataType,value:i.value}},d.changePending=!0,l=g.getAlertMessagesFns(d,c),e.next=7,g.sendOperationAndGetResult(u,l);case 7:return(v=e.sent).status===p.status.SUCCESSFUL?(_.set(o,["c8y_RegisterStatus",d.name],c.value),d.changePending=!1):v.status===p.status.FAILED&&(d.changePending=!1),e.abrupt("return",v);case 10:case"end":return e.stop()}var n,t,a,i,r,s},e)}))).apply(this,arguments)}function R(e,n){var t=_.findIndex(e,{msgId:n.msgId});-1<t?e[t]=n:e.push(n)}}}angular.module("c8y.canopen").provider(i,e)}();