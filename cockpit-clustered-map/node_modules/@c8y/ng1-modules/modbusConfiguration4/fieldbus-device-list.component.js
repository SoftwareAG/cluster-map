"use strict";function asyncGeneratorStep(e,n,t,i,r,o,a){try{var c=e[o](a),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(i,r)}function _asyncToGenerator(c){return function(){var e=this,a=arguments;return new Promise(function(n,t){var i=c.apply(e,a);function r(e){asyncGeneratorStep(i,n,t,r,o,"next",e)}function o(e){asyncGeneratorStep(i,n,t,r,o,"throw",e)}r(void 0)})}}!function(){function e(r,i,n,o,a,c,s,d,u,l,t){var e,m=this,v=u.snmpVersions,f=u.snmpAuthPrivProtocols,p=u.snmpAuthProtocols,D=u.snmpSecurityLevels;function y(){return(y=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=m.mode,i=m.device,n.adding=!0,n.protocol=t,e.prev=3,$())return e.next=7,u.update(i,n);e.next=7;break;case 7:g(),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),b(n);case 13:r.$apply();case 14:case"end":return e.stop()}},e,null,[[3,10]])}))).apply(this,arguments)}function g(){m.expandedId="",m.reloadDevices(),n.success(t("Child device changes saved."))}function b(e){e.adding=!1,n.danger(t("Failed to change child device."))}function N(){return(N=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=m.mode,t=m.device,(i=m.newDevice).adding=!0,i.protocol=n,e.prev=3,S())return e.next=7,o.create(t,i);e.next=9;break;case 7:e.next=32;break;case 9:if(h())return e.next=12,a.create(t,i);e.next=14;break;case 12:e.next=32;break;case 14:if(A())return e.next=17,c.create(t,i);e.next=19;break;case 17:e.next=32;break;case 19:if(T())return e.next=22,s.create(t,i);e.next=24;break;case 22:e.next=32;break;case 24:if(V())return e.next=27,d.create(t,i);e.next=29;break;case 27:e.next=32;break;case 29:if($())return e.next=32,u.create(t,i);e.next=32;break;case 32:E(),e.next=38;break;case 35:e.prev=35,e.t0=e.catch(3),I();case 38:r.$apply();case 39:case"end":return e.stop()}},e,null,[[3,35]])}))).apply(this,arguments)}function E(){x(),m.reloadDevices(),n.success(t("New child device added."))}function I(){m.newDevice.adding=!1,n.danger(t("Failed to add new child device."))}function x(){m.expandedId="",_.unset(m,"newDevice"),m[e].$setPristine(),document.getElementsByName("vm.".concat(e))[0].reset()}function S(){return"modbus"===m.tab}function h(){return"canbus"===m.tab}function A(){return"opcua"===m.tab}function T(){return"profibus"===m.tab}function V(){return"canopen"===m.tab}function $(){return"snmp"===m.tab}_.assign(m,{$onInit:function(){e="new".concat(m.mode,"DeviceForm"),m.expandedId=""},shouldShowSection:function(){var e=m.device,n=m.mode,t=!1;S()?"TCP"===n?t=l.supportsOperation(e,"c8y_ModbusDevice"):"RTU"===n&&(t=l.supportsOperation(e,"c8y_ModbusDevice")&&e.c8y_SerialConfiguration):h()&&"CAN"===n?t=l.supportsOperation(e,"c8y_CanDevice"):T()&&"Profibus"===n?t=l.supportsOperation(e,"c8y_ProfibusDevice"):V()&&"CANopen"===n&&(t=l.supportsOperation(e,"c8y_CANopenAddDevice"));return t},isModbusTab:S,isCanBusTab:h,isOPCUATab:A,isProfibusTab:T,isCanOpenTab:V,isSNMPTab:$,invalid:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"new".concat(m.mode,"DeviceForm");return function(e){var n=m.mode,t=m.fieldErrors;if("TCP"===n||"RTU"===n){var i=m[e],r=i.address;if(r){var o=r.$modelValue;if("TCP"===n){var a=i.ipAddress,c=a.$modelValue;_.isUndefined(o)||r.$setValidity(t.ADDRESS_INVALID,function(e){return e<=247||255===e}(o));var s=o&&c&&_.some(m.devices,{address:o,ipAddress:c,protocol:"TCP"});r.$setValidity(t.ADDRESSES_IN_USE,!s),a.$setValidity(t.ADDRESSES_IN_USE,!s)}else if("RTU"===n){var d=o&&_.some(m.devices,{address:o,protocol:"RTU"});r.$setValidity(t.ADDRESS_IN_USE,!d)}}}else if("CANopen"===n){var u=m[e],l=u.nodeId;if(l){var v=l.$modelValue;if(v){var f=function(e){return 1<=e&&e<=127}(v),p=function(n){return m.devices.find(function(e){return!(!e||!e.nodeId)&&e.nodeId===n})}(v);f?p?(l.$setValidity(t.NODE_OUT_OF_RANGE,!0),l.$setValidity(t.NODE_IN_USE,!1)):(l.$setValidity(t.NODE_OUT_OF_RANGE,!0),l.$setValidity(t.NODE_IN_USE,!0)):(l.$setValidity(t.NODE_OUT_OF_RANGE,!1),l.$setValidity(t.NODE_IN_USE,!0))}}}else"SNMP"===n&&function(e){var n,t=m[e];e&&(n=function(e){return _.toNumber(e.replace("form",""))}(e)),function(e,n){var t=m.fieldErrors;if(e.snmpVersionEngineId){var i=e.snmpVersionEngineId,r=i.$modelValue;r&&i.$setValidity(t.ENGINEID_IN_USE,!function(n,t){return t?_.some(m.devices,function(e){return(_.toNumber(e.id)!==t||n!==e.auth.engineId)&&e.engineId===n}):_.some(m.devices,function(e){return e.auth.engineId===n})}(r,n))}}(t,n),function(e,n){var t=m.fieldErrors,i=e.ipAddress,r=i.$modelValue;i.$setValidity(t.ADDRESS_IN_USE,!function(n,t){return t?_.some(m.devices,function(e){return(_.toNumber(e.id)!==t||n!==e.ipAddress)&&e.ipAddress===n}):_.some(m.devices,{ipAddress:n})}(r,n))}(t,n),function(e){var n=m.fieldErrors,t=e.port,i=t.$modelValue;t.$setValidity(n.PORT_INVALID,!_.isNaN(_.toNumber(i)))}(t)}(e)}(n),i.invalid(m,n,e)},getFieldValidationHints:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"new".concat(m.mode,"DeviceForm"),t=_.get(m,"".concat(n,".").concat(e));if(t)return i.validationHints(t,m.fieldErrorsToMessages);return""},isFormInvalid:function(){return _.get(m,"".concat(e,".$invalid"))||_.get(m,"newDevice.adding")},startAddingNewDevice:function(){m.newDevice={name:null,deviceType:null,address:null},$()&&(m.newDevice=_.extend(m.newDevice,{version:null,port:null,auth:{}}),m.toggle("newDevice"))},addNewDevice:function(){return N.apply(this,arguments)},clearNewDevice:x,filterByMode:function(){if(S())return function(e){var n=_.get(e,"protocol");return n===m.mode};if(V())return function(e){return e.nodeId};return function(){return!0}},snmpVersions:v,snmpAuthPrivProtocols:f,snmpAuthProtocols:p,snmpSecurityLevels:D,updateDevice:function(e){return y.apply(this,arguments)},startEditDevice:function(e){var n=_.cloneDeep(e);if(n.adding=!1,!_.isUndefined(n.deviceType)){var t=m.deviceConfigurationOptions;n.deviceType=_.find(t.types,function(e){return e.name===n.deviceType})}return n},isEditFormInvalid:function(e,n){return _.get(m,"".concat(e,".$invalid"))||_.get(n,"adding")},toggle:function(e){m.expandedId===e?m.expandedId="":m.expandedId=e},clearEditDevice:function(){m.expandedId=""},getSnmpVersionLabel:function(e){var n=_.find(v,{value:e});return _.get(n,"label")},getFormName:function(e){if(e){var n=e.id;return"vm.form".concat(_.toString(n))}return"vm.form"},getDeviceFormName:function(e){return"form".concat(e.id)},expandedId:void 0})}e.$inject=["$rootScope","c8yBase","c8yAlert","c8yModbusDevice","c8yCanbusDevice","c8yOPCUADevice","c8yProfibusDevice","c8yCanopenDevice","c8ySNMPDevice","c8yDevices","gettext"],angular.module("c8y.modbusConfiguration4").component("c8yFieldbusDeviceList",{templateUrl:":::PLUGIN_PATH:::/fieldbus-device-list.html",bindings:{tab:"@",mode:"@",fieldErrors:"<",fieldErrorsToMessages:"<",deviceConfigurationOptions:"<",device:"<",devices:"<",reloadDevices:"<",onClickDelete:"<",navigateToDetail:"<"},controllerAs:"vm",controller:e})}();