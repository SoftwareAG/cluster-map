"use strict";!function(){function e(n,t,e,i,o,a,r,c,s,u,l){var f,g,d="exportForm",p={required:s("This field is required."),maxlength:s("Up to 120 characters allowed.")},h=!0,m=!0,x=!1,v=!1;function y(e){n.config=i.create(e),n.filters=i.getFilters(n.config,f&&!g),n.apis=i.getApis(n.config),function(e){i.getSmartRuleDefaults(e).then(function(e){n.smartRuleDefaults=e})}(e),f?g?(delete n.config.id,n.isNew=!0,b(u.getString("Duplicate of {{config}}",{config:n.config.name}))):b(s("Export details")):(n.isNew=!0,b(s("Create configuration"))),n.$watch("apis",function(e,t){_.isEqual(e,t)||n[d].$setDirty()},!0)}function S(){return n.config.apiList=[],n.config.queryParameters={},_.forEach(n.filters,function(e){e.onSave(n.config)}),_.forEach(n.apis,function(e){e.onSave(n.config)}),i.save(n.config)}function b(e){a.changeTitle({title:e})}function w(){return!_.some(n.apis,"enabled")}function C(){x=!0,l.convertToSchedules(f).then(function(){E(!0)}).catch(function(){E(!1)})}function E(e){x=!1,e?(m=!(h=!(v=!1)),r.success(s("Migration successful."))):r.danger(s("Migration failed. Please try again."))}_.assign(n,{invalid:o.invalid.bind(o,n,d),validationHints:function(e){return o.validationHints(n[d][e],p)},saveStay:function(){return S().then(function(e){t.path("/export/".concat(e.id))}).then(function(){r.success(s("Configuration saved."))})},saveClose:function(){return S().then(function(){t.path("/export")})},cancel:function(){t.path("/export")},onSelectionChanged:function(e){e.enabled=!0},smartRulesFilter:{ruleTemplateName:"sendExportViaEmail"},reloadSmartRulesList:function(){n.$broadcast("smartRulesListReload")},shouldShowSchedules:function(){return h},migrate:C,onRules:function(e){e&&Array.isArray(e)&&e.length?(v=!(h=!1),c({title:s("Migrate export schedules"),body:u.getString("Export schedules based on smart rules are deprecated and need to be migrated, but all the settings will be preserved. Do you want to proceed?"),status:"danger",labels:{ok:s("Migrate now"),cancel:s("Migrate later")}}).then(C)):m=!1},shouldShowSmartRules:function(){return m},isMigratingWarning:function(){return v&&!x},isMigratingInProgress:function(){return x},disableEditAndCreate:!0}),f=e.exportId,g=!!e.clone,f="new"===f?void 0:f,n.exportTypes=i.getFileTypes(),n.config=i.create(),n.isNoApiChecked=w,f?i.detail(f).then(y):y()}e.$inject=["$scope","$location","$routeParams","exportConfig","c8yBase","c8yTitle","c8yAlert","c8yModal","gettext","gettextCatalog","exportService"],angular.module("c8y.cockpit.export").controller("exportConfigDetailCtrl",e)}();