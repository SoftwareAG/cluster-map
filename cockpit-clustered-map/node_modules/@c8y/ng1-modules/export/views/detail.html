<div ng-controller="exportConfigDetailCtrl">
  <c8y-breadcrumbs-set>
    <c8y-breadcrumbs-item
      path="#export"
      label="{{ 'Exports' | translate }}"
      icon="c8y-report"
    ></c8y-breadcrumbs-item>
  </c8y-breadcrumbs-set>
  <form name="exportForm" novalidate>
    <div class="row exportReport">
      <div class="col-md-10 col-lg-9 col-sm-12">
        <div class="card m-b-72">
          <div class="card-block overflow-visible">
            <div class="form-group" ng-class="{'has-error': invalid('name')}">
              <label>{{ 'Name' | translate }}</label>
              <input
                type="text"
                name="name"
                class="form-control"
                ng-model="config.name"
                ng-maxlength="120"
                uib-tooltip="{{ validationHints('name') | translate }}"
                tooltip-trigger="focus"
                placeholder="{{ 'e.g. My export' | translate }}"
                required
              />
            </div>

            <div class="form-group" ng-class="{'has-error': invalid('exportType')}">
              <label>{{ 'File type' | translate }} *</label>
              <div>
                <label ng-repeat="option in exportTypes" class="fileType c8y-radio radio-inline">
                  <input
                    type="radio"
                    ng-value="option.type"
                    ng-model="config.exportType"
                  /><span></span>
                  <span
                    class="fa"
                    ng-class="{'fa-file-text-o': option.type === 'csv', 'fa-file-excel-o': option.type === 'vnd.ms-excel'}"
                  ></span>
                  {{ option.name | translate }}
                </label>
              </div>
            </div>

            <div class="p-b-16" ng-if="shouldShowSmartRules()">
              <div class="legend form-block">
                {{ 'Scheduled exports' | translate }}&nbsp;<span translate>(deprecated)</span>
              </div>

              <div ng-if="config.id" style="position:relative;">
                <div class="alert alert-warning" ng-if="isMigratingWarning()">
                  <p><strong translate>This component is deprecated.</strong></p>
                  <p class="p-b-8" translate>
                    It is not possible to add new schedules, or edit the existing ones. Please
                    migrate to the new component.
                  </p>
                  <button
                    class="btn btn-default btn-xs"
                    title="{{ 'Migrate' | translate }}"
                    ng-click="migrate()"
                    translate
                  >
                    Migrate
                  </button>
                </div>
                <div class="spinner-panel-wrapper" ng-if="isMigratingInProgress()">
                  <div class="flex-row flex-center">
                    <div
                      style=" display:inline-block; position: relative; width: 60px; height: 20px; margin-left: 8px; margin-top: -20px;"
                    >
                      <div class="spinner">
                        <div class="rect1"></div>
                        <div class="rect2"></div>
                        <div class="rect3"></div>
                        <div class="rect4"></div>
                        <div class="rect5"></div>
                      </div>
                    </div>
                    <span translate>Migratingâ€¦ </span>
                  </div>
                </div>
                <smart-rules-list
                  mo="config.id"
                  filter="smartRulesFilter"
                  disable-edit-and-create="disableEditAndCreate"
                  on-rules="(onRules)"
                >
                </smart-rules-list>
              </div>
            </div>

            <div class="p-b-16" ng-if="shouldShowSchedules()">
              <div class="legend form-block">
                {{ 'Scheduled exports' | translate }}
              </div>

              <div class="alert alert-info" ng-if="!config.id" translate>
                You can add schedules once you saved export configuration.
              </div>

              <div ng-if="config.id">
                <c8y-export-schedules export-id="{{ config.id }}"></c8y-export-schedules>
              </div>
            </div>

            <div class="query-parameters">
              <div class="legend form-block">{{ 'Filters' | translate }}</div>
              <table class="table filterList table-striped">
                <thead>
                  <tr>
                    <th style="width: 40px;"></th>
                    <th translate style="width: 25%;">Name</th>
                    <th translate>Value</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    ng-repeat="filter in filters"
                    ng-include="':::PLUGIN_PATH:::/views/filter.html'"
                    style="vertical-align: middle;"
                  ></tr>
                </tbody>
              </table>
            </div>

            <div class="legend form-block">{{ 'Fields' | translate }}</div>
            <p class="text-muted m-b-8">
              <i c8y-icon="info-circle text-info"></i>
              <em translate
                >You will receive a CSV/Excel file for each selected type of data via email.</em
              >
            </p>
            <div ng-if="isNoApiChecked()" class="alert alert-warning">
              <span translate>Select at least one data type for export.</span>
            </div>

            <div class="apiList">
              <div class="row" ng-repeat="api in apis">
                <div class="col-sm-12">
                  <hr />
                </div>
                <div class="col-sm-3">
                  <div class="flex-row">
                    <label class="c8y-switch">
                      <input
                        type="checkbox"
                        ng-model="api.enabled"
                        ng-change="api.toggle(api, api.enabled);"
                        ng-required="isNoApiChecked()"
                      />
                      <span></span>
                    </label>
                    <h4 style="margin: 0 5px;" ng-class="{'text-muted': !api.enabled}">
                      <i c8y-icon="{{ api.icon }}" class="status"></i>
                    </h4>
                    <p style="line-height: 1;" ng-class="{'text-muted': !api.enabled}">
                      {{ api.label | translate }}
                    </p>
                  </div>
                </div>

                <div class="apiListDetails col-sm-9" ng-show="api.enabled">
                  <div ng-include="':::PLUGIN_PATH:::/views/properties.html'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row p-b-16">
      <c8y-ui-button-footer changed="exportForm.$dirty">
        <div class="col-md-10 col-lg-9 col-sm-12 text-center">
          <button
            class="btn btn-default"
            ng-click="cancel()"
            title="{{ 'Cancel' | translate }}"
            translate
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            ng-click="saveStay()"
            ng-disabled="exportForm.$invalid || exportForm.$pristine"
            title="{{ 'Save' | translate }}"
            translate
          >
            Save
          </button>
          <button
            type="button"
            class="btn btn-primary"
            ng-click="saveClose()"
            ng-disabled="exportForm.$invalid || exportForm.$pristine"
            title="{{ 'Save and close' | translate }}"
            translate
          >
            Save and close
          </button>
        </div>
      </c8y-ui-button-footer>
    </div>
  </form>
</div>
