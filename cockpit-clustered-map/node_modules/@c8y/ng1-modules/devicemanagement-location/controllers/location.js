"use strict";!function(){function e(t,n,e,a,i,o,l,c){var d,r,s="c8y_Position",u="com_nsn_startups_vendme_fragments_GPSCoordinates",g={},f={focus:!0,draggable:!0},m={lat:0,lng:0,zoom:11};function v(e){d=e,t.location=A(e)||{};var n=t.location;b(t.location),r=_.clone(n),function(e){return!(!e.lat||!e.lng)}(n)&&p(n)}function b(e){var n=_.get(e,"lat"),t=_.get(e,"lng"),a=_.get(e,"alt");_.set(e,"lat",_.toNumber(n)),_.set(e,"lng",_.toNumber(t)),_.isUndefined(a)||_.set(e,"alt",_.toNumber(a))}function h(e){if(e){var n={lat:Number(e.lat),lng:Number(e.lon),zoom:17};p(n),C(n),D(n)}}function $(){i.detailCached(function(){var e=_.get(t,"child.config.device");return e&&(f.draggable=!1),_.get(e,"id",n.deviceId)}()).then(function(e){return _.cloneDeep(e.data)}).then(v)}function p(e){_.assign(f,{lat:parseFloat(e.lat),lng:parseFloat(e.lng)}),D(g.main=f)}function C(e){_.assign(t.location,{lat:parseFloat(e.lat),lng:function(e){var n=e%360;return n<-180?360+n:180<n?n-360:n}(parseFloat(e.lng))})}function y(e){return i.isVendme(e)?u:s}function A(e){return e[y(e)]}function D(e){var n=e||f;_.assign(t.center,n)}_.assign(t,{settings:{},markers:g,mapDefaults:{scrollWheelZoom:!1},centerMap:D,center:m,pattern:{latitude:/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/,longitude:/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/,altitude:/^[-+]?(0|([1-9]\d*))(\.\d+)?$/},events:{markers:["dragend"]},gotoAddress:function(e){a.geoCode(e).then(function(e){return 0===e.data.length&&l.warning(c("Address could not be found.")),e.data[0]||null}).then(h)},cancel:function(){t.noeditable=!t.noeditable,_.isEqual(t.location,r)||(t.location=_.clone(r))},save:function(){t.noeditable=!t.noeditable;var e={id:d.id},n=_.clone(A(d));delete n.address,e[y(d)]=n,b(e[y(d)]),i.save(e).then(function(){l.success(c("Location saved."))}).then($)},realtimeChannel:"/managedobjects/".concat(void 0!==n.deviceId?n.deviceId:"*"),invalid:angular.bind(e,e.invalid,t),id:t.$id}),t.$on("leafletDirectiveMarker.dragend",function(e,n){C(n.model)}),t.$watch("child.config.device",$),o.addListener(t.$id,t.realtimeChannel,"".concat(t.$id,"-subscribed"),function(){$()}),o.addListener(t.$id,t.realtimeChannel,"CREATE",function(e,n){v(n)}),o.addListener(t.$id,t.realtimeChannel,"UPDATE",function(e,n){v(n)}),$()}e.$inject=["$scope","$routeParams","c8yBase","c8yGeo","c8yDevices","c8yRealtime","c8yAlert","gettext"],angular.module("c8y.parts.location").controller("locationCtrl",e)}();