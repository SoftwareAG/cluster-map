<div class="row">
  <div
    class="form-group"
    ng-hide="hideUsername"
    ng-class="{'has-error': invalid('username'), 'col-sm-12': hideActive, 'col-sm-8': !hideActive}"
  >
    <label>{{ 'Username (e.g. email)' | translate }}</label>
    <input
      class="form-control"
      name="username"
      ng-model="user.userName"
      ng-pattern="userNamePattern"
      ng-maxlength="254"
      ng-trim="false"
      placeholder="{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}"
      required
      ng-disabled="user.id || disabledEdit"
      uib-tooltip="{{ getErrorFeedback('username') | translate }}"
      tooltip-append-to-body="true"
      c8y-autocomplete="off"
    />
  </div>

  <div class="form-group col-sm-4" ng-hide="hideActive">
    <label>{{ 'Status' | translate }}</label>
    <div>
      <button
        type="button"
        class="btn btn-default"
        ng-model="user.enabled"
        uib-btn-checkbox="user.enabled"
        ng-disabled="disabledEdit"
      >
        <i c8y-icon="minus-circle" class="text-danger" ng-hide="user.enabled"></i>
        <i c8y-icon="check-circle" class="text-success" ng-show="user.enabled"></i>
        <span title="{{ 'Enabled' | translate }}" ng-show="user.enabled">{{
          'Enabled' | translate
        }}</span>
        <span title="{{ 'Disabled' | translate }}" ng-hide="user.enabled">{{
          'Disabled' | translate
        }}</span>
      </button>
    </div>
  </div>
</div>

<div class="row">
  <div
    class="form-group"
    ng-class="{'has-error': invalid('displayName'), 'col-sm-12': hideActive, 'col-sm-8': !hideActive}"
  >
    <label>{{ 'Login alias' | translate }}</label>
    <input
      class="form-control"
      name="displayName"
      ng-model="user.displayName"
      ng-pattern="loginAliasPattern"
      ng-maxlength="254"
      ng-trim="false"
      placeholder="{{ 'e.g. joe.doe`LOCALIZE`' | translate }}"
      ng-disabled="disabledEdit"
      uib-tooltip="{{ getErrorFeedback('displayName') | translate }}"
      tooltip-append-to-body="true"
      c8y-autocomplete="off"
    />
  </div>
</div>

<div class="form-group" ng-class="{'has-error': invalid('email')}" ng-hide="hideEmail">
  <label>{{ 'Email' | translate }} <span ng-show="user.sendPasswordResetEmail"></span></label>
  <input
    type="email"
    name="email"
    class="form-control"
    ng-model="user.email"
    ng-maxlength="254"
    uib-tooltip="{{ getErrorFeedback('email') | translate }}"
    c8y-autocomplete="off"
    ng-disabled="disabledEdit"
    placeholder="{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}"
    ng-required="user.sendPasswordResetEmail"
  />
  <span class="text-danger" ng-show="emailWarning">{{
    'Note that email is required to reset password.' | translate
  }}</span>
</div>

<div class="row" style="margin-left:-15px;margin-right:-15px">
  <div
    class="col-sm-6 form-group"
    ng-class="{'has-error': invalid('firstName')}"
    ng-hide="hideFirstName"
  >
    <label>{{ 'First name' | translate }}</label>
    <input
      class="form-control"
      name="firstName"
      ng-model="user.firstName"
      ng-maxlength="50"
      uib-tooltip="{{ getErrorFeedback('firstName') | translate }}"
      c8y-autocomplete="off"
      ng-disabled="disabledEdit"
    />
  </div>

  <div
    class="col-sm-6 form-group"
    ng-class="{'has-error': invalid('lastName')}"
    ng-hide="hideLastName"
  >
    <label>{{ 'Last name' | translate }}</label>
    <input
      class="form-control"
      name="lastName"
      ng-model="user.lastName"
      ng-maxlength="50"
      uib-tooltip="{{ getErrorFeedback('lastName') | translate }}"
      c8y-autocomplete="off"
      ng-disabled="disabledEdit"
    />
  </div>
</div>

<div class="form-group" ng-hide="hideTelephone">
  <label
    >{{ 'Telephone' | translate }} <span ng-if="user.twoFactorAuthenticationEnabled"></span
  ></label>
  <input
    class="form-control"
    name="phone"
    ng-model="user.phone"
    c8y-autocomplete="off"
    ng-maxlength="254"
    maxlength="254"
    ng-required="user.twoFactorAuthenticationEnabled"
    ng-disabled="disabledEdit"
    uib-tooltip="{{ getPhoneTooltip() | translate }}"
    placeholder="{{ 'e.g. +49 9 876 543 210`LOCALIZE`' | translate }}"
    c8y-phone-number
  />
</div>

<div class="row">
  <div class="form-group col-sm-6" ng-if="!hideOwner">
    <label>{{ 'Owner' | translate }}</label>
    <input
      class="form-control"
      ng-show="disabledEdit || ownerEditDisabled"
      ng-value="user.owner"
      disabled
    />

    <div
      class="form-control"
      ng-hide="disabledEdit || ownerEditDisabled"
      style="padding:0"
      is-open="vm.isParentDropDownOpen"
      on-toggle="vm.onToggleDropdown(open)"
      uib-dropdown
      dropdown-append-to-body="true"
    >
      <button
        type="button"
        style="background:transparent;box-shadow:none;width:100%;text-align:left"
        class="btn dropdown-toggle"
        uib-dropdown-toggle
      >
        <span class="flex-row">
          <span title="{{ user.owner }}" ng-if="user.owner" class="text-truncate">{{
            user.owner
          }}</span>
          <span title="{{ 'Select owner' | translate }}…" ng-if="!user.owner" class="text-muted"
            >{{ 'Select owner' | translate }}…</span
          >
          <span class="caret" style="margin-left:auto;"></span>
        </span>
      </button>

      <div
        class="dropdown-menu "
        ng-click="$event.stopPropagation();"
        uib-dropdown-menu
        style="margin-top:-32px"
      >
        <span ng-if="vm.isParentDropDownOpen" ng-init="vm.currentOwner=user.owner"></span>
        <div
          style="padding-top: 10px; padding-bottom:34px; position:relative; background-color: white;"
        >
          <c8y-ui-user-picker
            ng-if="vm.ownerDropDownInitialized"
            include-root="true"
            default-user="vm.defaultOwner"
            root-users="vm.rootOwner"
            hidden-users="user"
            ng-model="vm.currentOwner"
          >
          </c8y-ui-user-picker>

          <button
            title="{{ 'Done' | translate }}"
            style="position:absolute;bottom:0;right:0;left:0"
            type="button"
            ng-click="setOwner(vm.currentOwner)"
            class="btn btn-primary btn-block"
            translate
          >
            Done
          </button>
          <ng-form name="vm.ownerHiddenForm"></ng-form>
        </div>
      </div>
    </div>
  </div>

  <div class="form-group col-sm-6" ng-hide="hideDelegate">
    <label>{{ 'Delegated by' | translate }}</label>
    <div class="form-control-static">
      <ng-form name="delegationHiddenForm"></ng-form>
      <button
        ng-show="user.delegatedBy"
        type="button"
        class="btn btn-clean"
        ng-click="undelegate()"
        ng-disabled="disabledEdit"
        uib-tooltip="{{ 'Undelegate' | translate }}"
      >
        <i c8y-icon="times"></i>
      </button>
      <a ng-show="user.delegatedBy" ng-href="#/users/{{ user.delegatedBy }}">
        {{ user.delegatedBy }}
      </a>

      <button
        ng-hide="user.delegatedBy"
        type="button"
        class="btn btn-clean"
        ng-click="delegateTo()"
        ng-disabled="disabledEdit"
        uib-tooltip="{{ 'Delegate' | translate }}"
      >
        <i c8y-icon="universal-access"></i>
      </button>
      <span ng-hide="user.delegatedBy" translate>
        No delegation
      </span>
    </div>
  </div>
</div>

<div
  ng-repeat="(key, val) in getUserCustomProperties(user)"
  class="form-group"
  ng-hide="hideCustomProperties"
>
  <label>{{ humanize(key) }}</label>
  <input class="form-control" ng-model="val" disabled c8y-autocomplete="off" />
</div>

<div class="form-group" ng-if="!hideLanguage" style="position: relative; z-index: 1000;">
  <label>{{ 'Language' | translate }}</label>
  <ui-select ng-model="user.language">
    <ui-select-match placeholder="{{ 'Select language' | translate }}">{{
      $select.selected.name
    }}</ui-select-match>
    <ui-select-choices repeat="lang in languages | filter: $select.search | orderBy:'name'">
      <div ng-bind="lang.name"></div>
    </ui-select-choices>
  </ui-select>
</div>

<c8y-measurement-unit-preference ng-if="unitsConversionActive" user="user">
</c8y-measurement-unit-preference>

<div class="form-group" ng-hide="(!tfaAvailable && hideTfaOption) && hidePasswordReset">
  <label>{{ 'Login options' | translate }}</label>
  <div ng-if="tfaAvailable && !hideTfaOption">
    <label
      title="{{ 'Two-factor authentication' | translate }}"
      class="c8y-checkbox"
      ng-class="{ disabled: vm.twoFactorAuthenticationCheckboxDisabled() }"
    >
      <input
        type="checkbox"
        ng-model="user.twoFactorAuthenticationEnabled"
        ng-disabled="vm.twoFactorAuthenticationCheckboxDisabled()"
      />
      <span></span>
      <span translate>
        Two-factor authentication
      </span>
      <small title="{{ vm.tfaStrategy || 'SMS' }}" class="text-muted"
        >({{ vm.tfaStrategy || 'SMS' }})</small
      >
      <a
        href=""
        ng-show="vm.tfaStrategy === 'SMS' && notCurrentUser"
        popover-trigger="'focus'"
        uib-popover="{{
          'When enabled, a verification code sent by SMS is required to complete authentication'
            | translate
        }}"
        ><i c8y-icon="question-circle-o"></i
      ></a>
      <a
        href=""
        ng-show="vm.tfaStrategy === 'SMS' && !notCurrentUser"
        popover-trigger="'focus'"
        uib-popover="{{
          'Authentication by SMS - cannot be changed for your own user.' | translate
        }}"
        ><i c8y-icon="question-circle-o"></i
      ></a>
      <a
        href=""
        ng-show="vm.tfaStrategy === 'TOTP' && user.twoFactorAuthenticationEnabled"
        popover-trigger="'focus'"
        uib-popover="{{
          'TOTP secret activated. It can be revoked using the button below.' | translate
        }}"
        ><i c8y-icon="question-circle-o"></i
      ></a>
      <a
        href=""
        ng-show="vm.tfaStrategy === 'TOTP' && !user.twoFactorAuthenticationEnabled"
        popover-trigger="'focus'"
        uib-popover="{{
          'TOTP secret not activated. It can only be activated by the user.' | translate
        }}"
        ><i c8y-icon="question-circle-o"></i
      ></a>
      <a
        ng-show="vm.messagingWarningVisible()"
        class="text-warning"
        popover-append-to-body="true"
        popover-placement="right"
        uib-popover-html="smsWarningPopover | translate"
      >
        <i c8y-icon="exclamation-triangle"></i>
      </a>
    </label>
  </div>

  <div ng-hide="hidePasswordReset || disabledEdit">
    <label
      title="{{ 'User must reset password on next login' | translate }}"
      class="c8y-checkbox"
      ng-class="{ disabled: !notCurrentUser || user.sendPasswordResetEmail }"
    >
      <input
        type="checkbox"
        ng-model="user.shouldResetPassword"
        ng-disabled="!notCurrentUser || user.sendPasswordResetEmail"
      />
      <span></span>
      <span>{{ 'User must reset password on next login' | translate }}</span>
    </label>
  </div>

  <div ng-hide="hidePasswordReset || disabledEdit">
    <label
      title="{{ 'Send password reset link as email' | translate }}"
      class="c8y-checkbox"
      ng-class="{ disabled: user.id || user.shouldResetPassword }"
    >
      <input
        type="checkbox"
        ng-model="user.sendPasswordResetEmail"
        ng-disabled="user.id || user.shouldResetPassword"
      />
      <span></span>
      <span>{{ 'Send password reset link as email' | translate }}</span>
    </label>
  </div>
</div>

<div class="form-group">
  <button
    type="button"
    class="btn btn-default"
    ng-show="!disabledEdit && changePasswordBtn && !hideChangePassword && !user.sendPasswordResetEmail"
    ng-click="resetPasswords(user)"
  >
    <span title="{{ 'Change password' | translate }}" ng-show="!password.showPassword">{{
      'Change password' | translate
    }}</span>
    <span title="{{ 'Cancel password change' | translate }}" ng-show="password.showPassword">{{
      'Cancel password change' | translate
    }}</span>
  </button>

  <c8y-user-totp-revoke
    ng-if="vm.tfaStrategy === 'TOTP' && user.twoFactorAuthenticationEnabled"
    [user]="user"
    (revoke)="user.twoFactorAuthenticationEnabled = false"
  >
  </c8y-user-totp-revoke>
</div>

<div class="row" ng-if="!disabledEdit && password.showPassword && !user.sendPasswordResetEmail">
  <div class="col-xs-6">
    <div class="form-group" ng-class="{'has-error': invalid('password')}">
      <label>{{ 'Password' | translate }}</label>
      <input
        type="password"
        name="password"
        class="form-control"
        ng-model="user.password"
        placeholder="{{ 'e.g. my_password' | translate }}"
        required
        ng-pattern="passwordRegex"
        uib-tooltip="{{ getErrorFeedback('password') | translate }}"
        ng-change="changePasswordConfirm()"
        c8y-autocomplete="off"
      />
    </div>

    <div class="form-group" ng-class="{'has-error': isInvalidConfirmPassword()}">
      <label>{{ 'Confirm password' | translate }}</label>
      <input
        type="password"
        name="confirmPassword"
        class="form-control"
        ng-model="$parent.confirmPassword"
        placeholder="{{ 'e.g. my_password' | translate }}"
        required
        uib-tooltip="{{ getErrorFeedback('confirmPassword') }}"
        ng-change="changePasswordConfirm()"
        c8y-autocomplete="off"
      />
    </div>
  </div>

  <div ng-show="user.password.length >= 8">
    <div class="col-xs-6" ng-show="passwordStrengthEnforced" style="padding-left: 0;">
      <c8y-password-strength-checklist password="user.password"></c8y-password-strength-checklist>
    </div>
    <div class="col-xs-12">
      <div c8y-password-strength user="user" password="user.password"></div>
    </div>
  </div>
</div>
