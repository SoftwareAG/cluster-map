"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(r,s,t,c,l,n,e,o,f,i,y){return d.$inject=["options","$uibModalInstance"],{askForPassword:function(){try{return r.get("c8yPasswordConfirm").confirmPassword().toPromise()}catch(e){return s.resolve(!0)}},warnIfPasswordExpiresSoon:function(){var e="passwordExpirationAlertsDisplayed";function u(e,t){return!e||moment(e).isBefore(moment(t))}return s.all({user:l.current(),expirationAlertsDisplayedPreference:n.get(e),validityLimitInDays:o.detailValue({category:"password",key:"limit.validity"},0)}).then(function(e){var t=e.user,n=e.expirationAlertsDisplayedPreference,r=e.validityLimitInDays,o=n||{LESS_THAN_WEEK:null,LESS_THAN_DAY:null};if(0!==r){var i=moment(t.lastPasswordChange).add(r,"days"),a=moment.duration(i.diff(moment())).asDays(),s=!1;a<=1&&u(o.LESS_THAN_DAY,t.lastPasswordChange)?(s=!0,o.LESS_THAN_DAY=moment().format(c.dateFullFormat)):a<=7&&u(o.LESS_THAN_WEEK,t.lastPasswordChange)&&(s=!0,o.LESS_THAN_WEEK=moment().format(c.dateFullFormat)),s&&f.warning(y.getString("Your password will expire {{expirationTime | relativeDate}}. Consider changing password now.",{expirationTime:i}))}return o}).then(_.partial(n.set,e))},createUserFlatTree:function(e){return m(a(e))},buildUserTree:a,flattenTree:m,search:function(e,t){var n=["userName","lastName","firstName","email","phone"],r=_.constant(!0),o=_.constant(!0);if(e){var i=new RegExp(e,"i");r=function(t){return _.some(n,function(e){return i.test(t[e])})}}if(t&&t.length){var a=_.reduce(t,function(e,t){return e[t.id]=!0,e},{});o=function(e){return _.some(e.groups.references,function(e){return a[_.get(e,"group.id")]})}}return function(e){return r(e)&&o(e)}},selectUserDialog:function(e){return t.open({templateUrl:":::PLUGIN_PATH:::/ui/user/selectUser.modal.html",controllerAs:"vm",controller:d,resolve:{options:_.constant(e)}}).result},userHierarchyActive:_.once(function(){return e.listByUser().then(function(e){return!!_.find(e,{key:"c8y-feature-user-hierarchy"})})}),hideUsers:function(e,t){var n=_(_.isArray(t)?t:[t]).map(u(e)).value(),r=function(){var t=_.keyBy(n,"id");return _.filter(e,function(e){return t[e.owner]&&!t[e.id]})};for(;r().length;)n=_.union(n,r());return _.uniq(n)},mapToUsersInMemory:u,canUserManageTenant:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.user,n=e.tenant,o=e.mustBeTopTenant,i=r.get("c8yPermissions"),a=r.get("c8yTenant");return s.all({user:t||l.current(),tenant:n||a.current()}).then(function(e){var t=a.isTopTenant(e.tenant.name),n=_.get(e.tenant,"allowCreateTenants"),r=i.hasRole(e.user,"ROLE_TENANT_MANAGEMENT_READ");return r&&(o?t:t||n)})}};function a(t){var e=function(e){var t=_.keyBy(e,"id");return _.reject(e,function(e){return e.owner&&!t[e.owner]&&delete e.owner,e.owner})}(t),n=_.keyBy(t,"id");return _.forEach(t,function(e){e._owns=_.filter(t,{owner:e.id}),e._owner=_.get(n,e.owner)}),e}function u(n){return function(e){var t;return"string"==typeof e&&(t=e),"object"===_typeof(e)&&(t=e.userName),_.find(n,{userName:t})}}function m(e,t,n){var r=n||[],o=_.sortBy(e,["id","lastName"]),i=t||0;return _.reduce(o,function(e,t){return t._depth=i,e.push(t),m(t._owns,i+1,e)},r)}function d(e,t){_.assign(this,{textOk:i("Select"),textCancel:i("Cancel")},e,t)}}e.$inject=["$injector","$q","$uibModal","c8yBase","c8yUser","c8yUserPreferences","c8yApplication","c8ySettings","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.ui").factory("c8yUserUtil",e)}();