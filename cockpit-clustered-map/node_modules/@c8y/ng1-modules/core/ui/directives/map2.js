"use strict";!function(){function e(k,P,T,e,t,n,$,C,b,A,M,R,a,S,w,D,E,B){return r.$inject=["$scope","$element"],{restrict:"EA",templateUrl:":::PLUGIN_PATH:::/ui/views/map2.html",scope:{multipleDevices:"&",realtime:"&",cssClass:"@",deviceId:"&",config:"&",markerTemplate:"&",controlButtons:"&",noDataFetch:"&",map:"=?",c8yLegend:"&"},link:function(e){e.$on("dashboard-change",function(){e.map&&e.map.leafletMap&&e.map.leafletMap.invalidateSize()})},controller:r};function r(o,e){var n,t={padding:[50,50]},i=[],c={mapCustomBaseLayers:b.getPluginService("mapCustomBaseLayers"),ecbPositionSelector:b.getPluginService("ecbPositionSelector"),mapMarkerClusterer:b.getPluginService("mapMarkerClusterer")};o.map=this,e.addClass(o.cssClass);var s=L.map(e.find(".c8y-map-internal").get(0)).fitBounds(L.latLngBounds(L.latLng(14,-130.3),L.latLng(53.9,112.3)));o.map.leafletMap=s,o.map.event=o.$new(!0),o.map.markers=i;var a=L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0});a.addTo(s),c.mapMarkerClusterer&&c.mapMarkerClusterer.applyClustering({mapInternalScope:o}),o.map.tracker=new M.Tracker(o),o.tracker=o.map.tracker,o.tracker.onPaths(function(e,t){n&&s.removeLayer(n);(n=e).addTo(s),t&&m(n.getBounds())}),o.$on("$destroy",function(){o.cleanRealtime&&o.cleanRealtime()});var r=L.Control.extend({options:{position:"topright"},onAdd:function(){var e=L.DomUtil.create("div");return angular.element(e).html('\n            <c8y-realtime-switch\n               ng-if="!realtime()"\n               get-state="state()"\n               on-start="startRt()"\n               on-stop="stopRt()"\n             ></c8y-realtime-switch>\n             <c8y-refresh-btn></c8y-refresh-btn>\n          '),P(e)(o),e}}),l=L.Control.extend({options:{position:"bottomright"},onAdd:function(){var e=L.DomUtil.create("div");return angular.element(e).html("<div c8y-map-legend></div>"),P(e)(o),e}}),u=L.control.layers({OSM:a});function d(){var e=o.deviceId();return(e?function(n){var e;if(_.isArray(n))e=f(n);else{var a=[];e=$.detail(n).then(b.getResData).then(function(e){a.push(e);var t=k.when([]);return o.multipleDevices()&&(t=k.all([$.childDevices(n),$.childAssets(n)]).then(_.flattenDeep)),t}).then(function(e){a=_.union(a,e);var t=_(a).filter(function(e){return!A.isGroup(e)}).map("id").value();return _.isEmpty(t)?(p(),k.when(new L.featureGroup)):f(t)})}return e}(e):f()).then(function(e){o.tracker.getActiveDeviceIds().length||m(e.getBounds())})}function m(e){e&&e.isValid()&&s.fitBounds(e,t)}function p(){o.devices=[],_.forEach(i,function(e){s.removeLayer(e)}),i.length=0}function f(t){if(o.noDataFetch())return k.reject();var e;if(delete o.filterIds,c.ecbPositionSelector)e=c.ecbPositionSelector.getPositionedDevicesByEvents();else if(t&&t.length){var n=_.uniq(t),a={};a.ids=n.join(","),a.pageSize=n.length,o.filterIds=n,e=$.list(a),y()}else{var r={__or:[{__and:[{__has:"".concat(R.c8y_Position,".lat")},{__has:"".concat(R.c8y_Position,".lng")}]},{__and:[{__has:"".concat(R.v4e_Position,".lat")},{__has:"".concat(R.v4e_Position,".lng")}]}]};e=$.listQuery(r),y()}return e.then(function(e){var t=e.statistics;if(1<t.totalPages){var n=D.getString("The map widget displays up to {{count}} devices.",{count:t.pageSize});E.info(n)}return e}).then(function(e){return _(e).filter(function(e){var t=R.getLocationFragment(e);return!(!t||180<Math.abs(t.lng)||90<Math.abs(t.lat))||(console.warn("Device ".concat(e.name," has an invalid position!")),!1)}).reduce(function(e,t){return e[t.id]=t,e},{})}).then(function(e){p(),o.devices=e;var t=_.map(e,function(e){var t=g(e),n=R.getLocationFragment(e),a=L.marker(L.latLng(n.lat,n.lng),{icon:t}).addTo(s);return v(e,a).then(function(){a.on("click",function(){return v(e,a)}),a.id=e.id,i.push(a)})});return k.all(t).then(function(){return new L.featureGroup(i)})}).then(function(e){return o.map.event.$broadcast("refresh",t),e})}function g(e){var t=e.c8y_ActiveAlarmsStatus||{},n=_.find(["critical","major","minor","warning"],function(e){return t[e]})||"normal";return L.divIcon({className:"".concat(n,"-marker-icon"),iconSize:[25,41],iconAnchor:[12.5,41]})}function v(e,n){return function(i){var e={fragmentType:"c8y_Position",dateFrom:"1970-01-01",dateTo:moment().add(1,"days").format("YYYY-MM-DD"),pageSize:1,source:i.id};return S.list(e).then(function(e){var t=e.length?e[0].time:void 0;o.markerTemplate()||(o.markerTemplate=h);var n=T("absoluteDate")(t),a='\n              <div\n                c8y-map-marker\n                i-mo="devices['.concat(i.id,']"\n                i-template="markerTemplate()"\n                i-tracker="tracker"\n                last-updated="\'').concat(n,"'\"\n              ></div>\n            "),r=angular.element(a);return P(r)(o),r.get(0)})}(e).then(function(e){var t=n.getPopup()||L.popup({minWidth:120});n.bindPopup(t,{offset:L.point(0,-20)}),t.setContent(e)})}function h(){return"<div ng-include=\"'".concat(B,"'\"></div>")}function y(){var e=o.realtimeChannel,t="/managedobjects/*",n=o.filterIds,a=o.deviceId();if(a&&!n&&(n=[a]),n&&(t="/managedobjects/".concat(n.join(","))),e){if(e===t)return;o.cleanRealtime()}e=t,o.realtimeChannel=e,C.addListener.bind(C,o.$id,e)("UPDATE",function(e,t){var n=R.getLocationFragment(t);if(n){var a=_.find(i,{id:t.id});if(a){a.setLatLng(L.latLng(n.lat,n.lng)),a.setIcon(g(t));var r=a.getPopup();r&&r._isOpen&&v(t,a)}o.devices&&o.devices[t.id]&&(o.devices[t.id]=t),o.map.event.$broadcast("realtime",t)}}),o.cleanRealtime=function(){C.removeSubscriber(o.$id,e)},o.map.state=function(){return C.getStatus(o.$id,e)},o.map.startRt=function(){o.noDataFetch()||(C.start(o.$id,e),o.tracker.state||o.tracker.start())},o.map.stopRt=function(){C.stop(o.$id,e),o.tracker.state&&o.tracker.stop()},_.assign(o,{state:o.map.state,startRt:o.map.startRt,stopRt:o.map.stopRt}),o.realtime()&&o.startRt()}(function(a,r){var e=w.getBaseLayers(o.map),t=w.getOverlays(o.map),n=k.reject();c.mapCustomBaseLayers&&(n=c.mapCustomBaseLayers.create({google:!0,here:!0,bing:!0,googleSatellite:!0,hereSatellite:!0,bingSatellite:!0}));k.any(_.values(e).concat(n,_.values(t))).then(function(e){_.isEmpty(e)||a.addTo(r)}),_.forEach(e,function(e,t){e.then(function(e){a.addBaseLayer(e,t)})}),n.then(function(e){_.forEach(e,function(e){a.addBaseLayer(e.layer,e.name)})}),w.getUserOverlayPreferences().then(function(n){_.forEach(t,function(e,t){e.then(function(e){a.addOverlay(e,t),n[t]&&r.addLayer(e)})})})})(o.map.layersControl=u,s),s.on("overlayadd",function(e){w.setUserOverlayPreference(e,!0)}),s.on("overlayremove",function(e){w.setUserOverlayPreference(e,!1)}),o.controlButtons()&&s.addControl(new r),o.c8yLegend()&&s.addControl(new l),o.paging={refresh:!0},o.refresh=d,y(),o.$watch("deviceId()",d),o.$watch("noDataFetch()",function(e){e?o.stopRt():o.startRt()})}}function t(n,e,a){return{restrict:"EA",scope:{iMo:"&",iTemplate:"&",iTracker:"&",lastUpdated:"="},link:function(t,e){_.assign(t,{mo:t.iMo(),tracker:_.defaults(t.iTracker(),{__gps:!1,__gsm:!1}),onTrackingChange:function(e){t.tracker.__gps||t.tracker.__gsm?t.tracker.activate(e,{gps:t.tracker.__gps,gsm:t.tracker.__gsm}):t.tracker.deactivate(e)}}),t.showTrackingOptions=!1,a.gsmTrackingAvailable(t.mo).then(function(e){t.showTrackingOptions=e}),e.html(t.iTemplate()),n(e.contents())(t)}}}t.$inject=["$compile","c8yApplication","c8yCombain"],e.$inject=["$q","$compile","$filter","$http","$timeout","$injector","c8yInventory","c8yRealtime","c8yBase","c8yGroups","c8yTracker","c8yGeo","c8yApplication","c8yEvents","c8yMapConfig","gettextCatalog","c8yAlert","MARKER_TEMPLATE"],angular.module("c8y.ui").constant("MARKER_TEMPLATE",":::PLUGIN_PATH:::/ui/views/map2-markerTemplate.html").directive("c8yMapInternal",e).directive("c8yMapMarker",t).directive("c8yMapLegend",function(){return{restrict:"EA",templateUrl:":::PLUGIN_PATH:::/ui/views/map2-legend.html"}})}();