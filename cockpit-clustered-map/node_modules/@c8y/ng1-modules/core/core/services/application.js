"use strict";function _objectSpread(n){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?Object(arguments[t]):{},r=Object.keys(e);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.forEach(function(t){_defineProperty(n,t,e[t])})}return n}function _defineProperty(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}!function(){function t(c,u,e,o,p,t,s,l,n,f,r,g,h,d,i){var m,a=i("humanizeAppName"),v="application/",y="".concat(v,"applications"),S={headers:f.contentHeaders("application",!0)},E=this,A={HOSTED:"cloud",EXTERNAL:"external-link-square",SMARTAPP:"puzzle-piece",MICROSERVICE:"microchip",APAMA_CEP_RULE:"file-code-o"},P=["HOSTED","EXTERNAL","REPOSITORY"],O=["HOSTED","EXTERNAL","REPOSITORY"],b={HOSTED:d("Hosted application"),REPOSITORY:d("Repository"),EXTERNAL:d("External application"),MICROSERVICE:d("Microservice"),APAMA_CEP_RULE:d("Apama CEP rule")},x=f.createEnum([{name:"UP",label:d("Up"),value:"Up",icon:"check-circle text-success"},{name:"DOWN",label:d("Down"),value:"Down",icon:"warning status critical"},{name:"UNHEALTHY",label:d("Unhealthy"),value:"Unhealth",icon:"exclamation-circle status major"},{name:"UNHEALTHY",label:d("Unhealthy"),value:"Unhealthy",icon:"exclamation-circle status major"}]),D=1e3;try{m=n.get("gettextCatalog")}catch(t){m={getString:_.identity}}function R(c,o){return r.current().then(function(t){var n=t.tenant,e=f.pageSizeFilter(o),r={params:e},i="".concat(f.url(c),"/").concat(n),a=f.cleanListCallback("applications",angular.bind(E,R,c),e);return u.get(i,r).then(a).then(nt).then(w)})}function C(t){var n=t.desired,e=t.active;return{active:e,unhealthy:function(t,n){return _.isNumber(n)?t-n:t}(n,e),desired:n}}function T(c,o){return r.current().then(function(t){var n=c||t,e=f.pageSizeFilter(o),r={params:_.defaults(e,{noPaging:!0,dropOverwrittenApps:!0})},i=f.url("".concat(v,"applicationsByUser/").concat(encodeURIComponent(n.id))),a=f.cleanListCallback("applications",angular.bind(E,T,n),e);return u.get(i,r).then(a).then(nt).then(w)})}function w(t){var n=_.sortBy(t,[function(t){return a(t)}]);return _.assign(n,_.pick(t,["statistics","paging"])),n}function j(t){return R("".concat(v,"applicationsByTenant"),t)}function M(t){var n=f.url("".concat(y,"/").concat(t.contextPath,"/manifest")),e={params:f.pageSizeNoTotalFilter()};return u.get(n,e).then(function(t){return _.map(t.data.imports,U)})}function L(t){var n=L.cache,e=t.id||t,r=f.url("".concat(y,"/").concat(e,"/binaries/plugins")),i={params:f.pageSizeNoTotalFilter()};function a(){delete n[e]}return n[e]||(n[e]=s(_.noop,2e3).then(function(){return u.get(r,i).then(f.getResData).finally(a)})),n[e]}function U(t){return{id:t.id,contextPath:t.rootContextPath,directoryName:t.directoryName,manifest:t}}function k(t){var n=t.id||t;return f.url("".concat(y,"/").concat(n))}function N(t){var n=k(t);return u.get(n)}function I(n,t){var e=k(n),r=function(t){var n=_.cloneDeep(t);return delete n.type,n}(n),i=_.defaults(t||{},S),a=u.put(e,r,i).finally(function(){p.localStorage.setItem("refresh",n.contextPath)});return a.then(function(t){c.$emit("c8yApplication:update",{app:n,res:t})}),a}function B(n,t){var e=f.url(y),r=_.defaults(t||{},S),i=u.post(e,n,r);return i.then(function(t){c.$emit("c8yApplication:create",{app:n,res:t})}),i}function H(t,n){return t.id?I(t,n):B(t,n)}function F(r,i,t,n){var e=_.cloneDeep(r),a=t||0,c=n||o.defer();return e.name=0===a?r.name:[r.name,a].join("-"),e.key=0===a?r.key:[r.key,a].join("-"),e.contextPath=0===a?r.contextPath:[r.contextPath,a].join("-"),H(e,{silentError:!0}).then(function(t){c.resolve(f.getResData(t))},function(t){if(409===t.status&&a<10)F(r,i,a+1,c);else{var n=_.get(t,"data.message")||_.get(t,"data.details.exceptionMessage"),e=n&&m.getString(n)||d("Could not create application.");c.reject({errorMessage:e,errorDetails:t})}}),c.promise}function $(r){var t=N(r).then(f.getResData);return o.all({appDetails:t,appPlugins:t.then(L).then(z),appManifest:t.then(q),appIndex:t.then(V)}).then(function(t){t.appDetails;var n=t.appPlugins,e=t.appManifest,r=t.appIndex,i=function(n,t){return _(t.imports).map(function(t){return _.find(n,{pluginName:t})}).compact().concat(n).uniq().value()}(n,e);return o.all({newAppManifest:function(t,n){var e=_.cloneDeep(n);return e.imports=_.map(t,"pluginName"),e}(i,e),newAppIndex:function(t,n,e){var r=e;return r=function(t,n,e){var r=e,i=_(n).map(function(t){var n=_.get(t,"pluginPackage.css",[]);return!!(n=n.length?n:_.get(t,"pluginPackage.less",[])).length&&"".concat(t.pluginName,"/style.css")}).filter(_.identity).value(),a=_.flattenDeep(["\x3c!--MODULES_CSS--\x3e",_.map(i.slice(0,1),function(t){return'<link rel="stylesheet" href="'.concat(t,'"></link>')}),"\x3c!--/MODULES_CSS--\x3e"]).join("\n"),c=_.flattenDeep(["\x3c!--MODULES_CSS_DEFER--\x3e","<script>",["[",'"'.concat(i.slice(1).join('", "'),'"'),"].forEach(function(f){loadCSS(f)})"].join(""),"<\/script>","\x3c!--/MODULES_CSS_DEFER--\x3e"]).join("\n");return r=(r=r.replace(new RegExp("\x3c!--MODULES_CSS--\x3e(.|\\n|\\r)*\x3c!--\\/MODULES_CSS--\x3e","gm"),a)).replace(new RegExp("\x3c!--MODULES_CSS_DEFER--\x3e(.|\\n|\\r)*\x3c!--\\/MODULES_CSS_DEFER--\x3e","gm"),c)}(0,n,r),r=function(t,n,e){var r=_.flattenDeep(["\x3c!--MODULES_JS--\x3e",_(n).map(function(t){var n=_.get(t,"pluginPackage.js",[]);return!!n.length&&"".concat(t.pluginName,"/main.js")}).filter(_.identity).map(function(t){return'<script defer src="'.concat(t,'"><\/script>')}).value(),"\x3c!--/MODULES_JS--\x3e"]).join("\n");return e.replace(new RegExp("\x3c!--MODULES_JS--\x3e(.|\\n|\\r)*\x3c!--\\/MODULES_JS--\x3e","gm"),r)}(0,n,r),r=function(t,n,e){var r=['C8Y_NG_MODULES=["',_.uniq(_.flattenDeep(_.map(n,function(t){return _.get(t,"pluginPackage.ngModules",[])}))).join('","'),'"];'].join("");return e.replace(new RegExp("C8Y_NG_MODULES=\\[(.|\\n|\\r)*?\\];","gm"),r)}(0,n,r)}(0,i,r)})}).then(function(t){var n=t.newAppManifest,e=t.newAppIndex;return K(r,[{path:"cumulocity.json",file:new Blob([JSON.stringify(n)],{type:"application/json"})},{path:"index.html",file:new Blob([e],{type:"text/html"})}])})}function z(t){var n=[],e=_.sortBy(t,function(t){return-1*_.get(t,"pluginPackage.priority",0)});return _.forEach(e,function(t){!function e(t,r,i){var n=Y(r,_.get(t,"pluginPackage.contextPath"));if(n)return;var a=_.get(t,"pluginPackage.imports",[]);_.forEach(a,function(t){var n=Y(i,t);n?e(n,r,i):l.error("Plugin with context path ".concat(t," is missing."))});r.push(t)}(t,n,e)}),n}function Y(t,n){var e=function(t){var n=t;(function(t){return/^core\//.test(t)||/^administration\//.test(t)||/^devicemanagement\//.test(t)||/^cockpit\//.test(t)||/^platformadmin\//.test(t)||/^fieldbus4\//.test(t)||/^fieldbus3\//.test(t)||/^fieldbus2\//.test(t)||/^fieldbus\//.test(t)||/^demoboard\//.test(t)||/^vendme_plugins\//.test(t)})(n)&&(n=n.replace(/\//g,"_"));return n}(n);return _.find(t,function(t){return t&&t.pluginPackage&&t.pluginPackage.contextPath===e})}function q(t){var n="".concat(J(t),"/cumulocity.json");return u.get(n).then(f.getResData)}function V(t){var n="".concat(J(t),"/index.html");return u.get(n).then(f.getResData)}function J(t){return f.url("apps/".concat(t.contextPath))}function K(t,n){var e="".concat(k(t),"/binaries/files"),r=new FormData;return _.forEach(n,function(t){r.append(t.path,new File([t.file],t.path))}),u.post(e,r,{transformRequest:_.identity,headers:{"Content-Type":void 0}})}function W(){var t=p.location.pathname.match(/\/apps\/(public\/){0,1}(.+?)(\/|\?|#|$)/);return t&&t[2]}function X(){var t=p.location.pathname.match(/\/apps\/(public\/([^/]+)|([^/]+))/);return t&&-1!==t[1].indexOf("public")}function G(){var e=W(),r=!!X();function n(t){var n="MARKET"===t.availability;return t.contextPath===e&&(!r||n)}return T(null,{dropOverwrittenApps:!1}).then(function(t){return _.find(t,n)})}function Q(n){return g.list({type:"c8y_SmartAppApplication"}).then(function(t){return _.find(t,{appId:n.id})||null})}function Z(t){var n;return(t?o.resolve(t):G()).then(function(t){return n=t}).then(Q).then(function(t){return n.config=t,n})}function tt(t){return _(t).uniq("id").filter(function(t){var n=t.manifest,e=!1;return n&&(e=n.noAppSwitcher),!e&&_.includes(["HOSTED","EXTERNAL"],t.type)}).value()}function nt(t){var n=_.reject(t,function(t){return"management"===t.name&&"management"===t.owner.tenant.id});return _.assign(n,_.pick(t,_.filter(_.keys(t),function(t){return _.isNaN(_.toNumber(t))}))),n}function et(t,n){var e=_.isString(n)?function(n){return function(t){return t.name===n||t.contextPath===n}}(n):n;return _.some(t,e)}function rt(t){return"HOSTED"===t.type||"REPOSITORY"===t.type}function it(){if(it.cache)return it.cache;function n(t){return{url:t,noAppKey:!0}}return u(n([f.url(y),(X()?"public/":"")+W(),"manifest"].join("/"))).then(function(t){return u(n([f.url(y),t.data.application.id].join("/")))}).then(f.getResData).then(function(t){return it.cache=o.when(t)})}return d("Administration"),d("Cockpit"),d("Device management"),d("Fieldbus4"),L.cache={},f.getFlag("test")&&(it.cache=o.when({name:"app",manifest:{}})),{list:j,listByUser:T,listByTenant:j,listByOwner:function(t){return R("".concat(v,"applicationsByOwner"),t)},listPlugins:function(){var t=f.url("".concat(v,"plugins")),n={params:{pageSize:D}};return u.get(t,n).then(function(t){return _.uniqBy(t.data.plugins,"id")})},listPluginsByTenant:function(){return j().then(function(t){var n=_.uniqBy(t,"id"),e=[];return _.forEach(n,function(t){rt(t)&&e.push(M(t))}),o.all(e).then(_.flattenDeep).then(function(t){return _.uniqBy(t,"id")})})},listPluginsByApplication:M,listPluginsByPaasApp:L,listByVisibleLinks:function(){return T().then(tt).then(function(t){return o.when(t)})},listApplications:function t(n){var e=f.url("".concat(y)),r={params:f.pageSizeFilter(n)},i=f.cleanListCallback("applications",t,n);return u.get(e,r).then(i).then(w)},getApplicationMO:function(t){var n="c8y_Application_".concat(t);return g.list({type:n}).then(function(t){return _.head(t)})},getApplicationMOs:function(){return g.listQuery({type:"c8y_Application_*"},{},!0)},getInstanceCounts:C,getSubscriptionsList:function(t){var n=_.get(t,"c8y_Subscriptions");return _.reduce(n,function(t,n,e){var r=_.get(n,"details"),i=_.get(n,"status"),a=C(r);return t.concat(_objectSpread({},a,{tenantName:e,status:i}))},[])},getApplicationStatusForTenant:function(t,n){return _.get(t,["c8y_Subscriptions",n])},status:x,isAvailable:function(n){return T().then(function(t){return et(t,n)})},areAllAvailable:function(t){return T().then(function(n){return _.every(t,function(t){return et(n,t)})})},isAnyAvailable:function(t){return T().then(function(n){return _.some(t,function(t){return et(n,t)})})},detail:N,update:I,create:B,remove:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=k(e),r=Z(_.isObjectLike(e)?e:{id:e}).then(function(t){return!_.get(t,"config.id")||g.remove(t.config)}),i=u.delete(n,{params:t}),a=o.all({cfg:r,res:i});return a.then(function(t){var n=t.res;c.$emit("c8yApplication:delete",{app:e,res:n})}),a},save:H,trySave:F,clone:function(t,n){var e="".concat(k(t),"/clone");return u.post(e).then(f.getResData).then(function(t){return _.isObjectLike(n)?(_.assign(t,n),F(t).then(f.getResData)):t})},getHref:function(t){return rt(t)?function(t){var n=e.port();return n=80===n||443===n?"":":".concat(n),"".concat(e.protocol(),"://").concat(e.host()).concat(n,"/apps/").concat(t.public?"public/":"").concat(t.contextPath)}(t):t.externalUrl},isHosted:function(t){return"HOSTED"===t.type},isApamaCepRule:function(t){return"APAMA_CEP_RULE"===_.get(t,"type")},isMicroserviceWithManifest:function(n){return g.list({type:"c8y_microservice_manifest_".concat(n.id)}).then(function(t){return"MICROSERVICE"===n.type&&0<t.length})},canOpenInBrowser:function(t){return(_.isObjectLike(t)?o.resolve(t):N(t).then(f.getResData)).then(function(t){var n=!t.name.match(/feature-/),e=_.includes(P,t.type);return n&&e})},canAddPlugin:function(t){return console.warning("This method is now deprecated. Consider using Web SDK to customize and extend applications."),(_.isObjectLike(t)?o.resolve(t):N(t).then(function(t){return t.data})).then(function(t){return!_.isEmpty(t.manifest)&&_.includes(O,_.get(t,"type"))})},icon:function(t){var n=_.isString(t)?t:t.type;return t.manifest&&"MICROSERVICE"!==n&&(n="SMARTAPP"),A[n]},typeLabel:function(t){var n=_.isString(t)?t:t.type;return b[n]},getCurrent:G,getConfig:Z,pollRefreshMessages:function(){t(function(){!function(t){p.localStorage.getItem("refresh")===W()&&(p.localStorage.setItem("refresh",void 0),t||p.location.reload())}()},1e3,0,!1)},getCurrentContextPath:W,updateManifest:function(t,e){return N(t).then(function(t){var n=t.data;return n.manifest=e,n}).then(I)},listArchives:function(t,n){var e="".concat(k(t),"/binaries"),r={params:f.pageSizeNoTotalFilter(n),silentError:!0};return u.get(e,r).then(f.getResData)},uploadArchive:function(t,n){var e="".concat(k(t),"/binaries");return h.upload({url:e,method:"POST",headers:{Content:"multipart/form-data",Accept:"application/json"},file:n,fileName:function(t){return t.replace(/\s+/g,"_")}(n.name)})},deleteArchive:function(t,n){var e=n.id||n,r=[k(t),"binaries",e].join("/");return u.delete(r)},setActiveArchive:function(t,n){return H({id:t.id,activeVersionId:n.id})},addPaasAppPlugin:function(t,n){console.warning("This method is now deprecated. Consider using Web SDK to customize and extend applications.");var e=function(t){var n=t.name.split(".");return n.pop(),n.join(".")}(n),r="".concat(k(t),"/binaries/plugins/").concat(e),i=h.upload({url:r,method:"POST",headers:{Content:"multipart/form-data",Accept:"application/json"},file:n}),a=i.then(_.partial($,t));return a.progress=i.progress,a},removePaasAppPlugin:function(t,n){console.warning("This method is now deprecated. Consider using Web SDK to customize and extend applications.");var e=n.pluginName||n,r="".concat(k(t),"/binaries/plugins/").concat(e);return u.delete(r).then(_.partial($,t))},uploadPaasAppFiles:K,getPaasAppManifest:q,refreshPaasApp:$,refreshHostedApp:function(t){var n="".concat(k(t),"/refresh");return u.post(n)},isPaasApp:function(t){return q(t).then(function(t){return t._webpaas},function(){return!1})},convertType:function(t){var n=_.cloneDeep(t);return void 0===n.type||(n.type=function(t){return"HOSTED"===t.type&&t.resourcesUrl&&"/"!==t.resourcesUrl.charAt(0)}(n)?"REPOSITORY":n.type),n},revertType:function(t){var n=_.cloneDeep(t);return"HOSTED"===n.type&&(n.resourcesUrl="/"),"REPOSITORY"===n.type&&(n.type="HOSTED"),n},parseAppName:function(t){return t&&"devicemanagement"===t.toLowerCase()?"Device management":t||"Cumulocity"},currentAppCached:it,sortApps:w,isAppOnTheList:et}}t.$inject=["$rootScope","$http","$location","$q","$window","$interval","$timeout","$log","$injector","c8yBase","c8yUser","c8yInventory","$upload","gettext","$filter"],angular.module("c8y.core").factory("c8yApplication",t)}();