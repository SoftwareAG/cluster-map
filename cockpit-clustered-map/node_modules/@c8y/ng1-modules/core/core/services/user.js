"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,n){if(e){if("string"==typeof e)return _arrayLikeToArray(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,n):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}!function(){function e(c,f,t,l,s,e){var n="user/{tenant}/users",d="user/currentUser",r=null,h={headers:l.contentHeaders("user",!0)},u={headers:l.contentHeaders("user",!0)},o="two-factor-authentication",i={category:o,key:"enforced"};function p(e){var n=_.cloneDeep(e);return n.id&&delete n.userName,delete n.id,delete n.self,delete n.effectiveRoles,n}function g(e){var n=e.id||e;return a().then(function(e){return"".concat(e,"/").concat(encodeURIComponent(n))})}function a(){return y().then(function(e){return l.url(function(e,n){return e.replace(/\{tenant\}/g,n)}(n,e.tenant))})}function y(e){var n=d,t=_.cloneDeep(u);return e&&(r=null),r&&!_.isFunction(r.then)?f.when(r):r=r||c.get(l.url(n),t).then(function(e){return(r=e.data).tenant=function(e){var n=e.match(/\/user\/([\w-]+)\//);if(n.length<2)throw new Error("Cannot find tenant on user self URL");return n[1]}(r.self),r},function(){return r=null,f.reject()})}function v(e){var n=l.pageSizeFilter(e),t={params:n},r=l.cleanListCallback("users",v,n);return a().then(function(e){return c.get(e,t).then(r)})}function m(e,n){var t={silentError:n};return g(e).then(function(e){return c.get(e,t)})}function b(){var e=l.url(d),n=_.cloneDeep(u);return c.get(e,n)}function w(r,u){var o=u,i=p(r),n=_.cloneDeep(h),a=o?f.when(l.url(d)):g(r);return a.then(function(e){return c.put(e,i,n)}).then(function(e){var n=f.resolve(e),t=e.data;return!_.isUndefined(i.password)&&o&&(i.id=t.id,n=n.then(function(){return f.when(function(n){S(n).then(function(e){e&&s.updatePassword(function(e){return e.password||s.getPassword()}(n))})}(i))})),_.isUndefined(r.owner)||r.owner===t.owner||(n=n.then(null===r.owner?function(){return function(e){return g(e).then(function(e){return c.delete("".concat(e,"/owner"))}).then(function(){return m(e)})}(t)}:function(){return function(e,n){var t={owner:e.owner},r={"Content-Type":l.mimeType("userOwnerReference")};return n.then(function(e){return"".concat(e,"/owner")}).then(function(e){return c.put(e,t,{headers:r})})}(r,a)})),_.isUndefined(r.delegatedBy)||r.delegatedBy===t.delegatedBy||(n=n.then(null===r.delegatedBy?function(){return function(e){return g(e).then(function(e){return c.delete("".concat(e,"/delegatedby"))}).then(function(){return m(e)})}(t)}:function(){return function(e,n){var t={delegatedBy:e.delegatedBy},r={"Content-Type":l.mimeType("userDelegatedByReference")};return n.then(function(e){return"".concat(e,"/delegatedby")}).then(function(e){return c.put(e,t,{headers:r})})}(r,a)})),n=n.then(function(){return u?b():m(r)})}).then(function(e){return t.$emit("c8yUser:update",{user:e.data,res:e}),e})}function A(e,n){return e.id?w(e,n):function(e){var n=p(e),t=_.cloneDeep(h);return a().then(function(e){return c.post(e,n,t)})}(e)}function S(e){var n=e.id||e;return y().then(function(e){return f.when(e.id===n)})}function T(e){return _.get(e,"groups.references",[]).map(function(e){return e.group})}function U(e){var n=s.headers();return e&&(n.Authorization="Basic ".concat(e)),_.assign(n,l.contentHeaders("user",!0))}function k(){return f.when(!0)}function O(e){return function(e){var n=e||{};return(n.user?f.resolve(n.user):y()).then(function(e){return f.all([j(),function(t){return P().then(function(e){var n=[];return e&&(n=e.split(",")),_.some(n,function(e){return e===t.tenant})})}(e),function(e){return I().then(function(n){return _.some(T(e),function(e){return e.name===n})})}(e)]).then(function(e){return _.some(e)})})}({user:e})}function P(){return P._calling||(P._calling=e.getSystemOptionValue(i)).finally(function(){P._calling=void 0}),P._calling}function j(){return j.calling||(j.calling=e.detailValue(i)).finally(function(){j.calling=void 0}),j.calling}function I(){return I._calling||(I._calling=e.getSystemOptionValue({category:o,key:"enforced.group"})).finally(function(){I._calling=void 0}),I._calling}function C(e){return"".concat(e,"/roles/inventory")}return t.$on("authStateChange",function(e,n){n.hasAuth||(r=null)}),{current:y,getCurrentUser:function(){return r},checkIfCurrent:S,listAll:function(e){var o=[];return v(_objectSpread({pageSize:l.MAX_PAGESIZE},e)).then(function e(n){o.push.apply(o,_toConsumableArray(n));var t=n.statistics.pageSize,r=n.paging.next,u=n.length>=t;return r&&u?n.paging.next().then(e):f.resolve(o)})},list:v,detail:m,detailCurrent:b,remove:function(e){return g(e).then(function(e){return c.delete(e)})},enable:function(e){return A({id:e.id||e,enabled:!0})},disable:function(e){return A({id:e.id||e,enabled:!1})},save:A,saveCurrent:function(e){return A(e,!0)},savePhoneNumber:function(e,n){var t=l.url("user/currentUserPhone"),r={headers:U(s.encodeToken(e.name,e.password,e.tenant)),method:"PUT",url:t,data:{phone:n},silentError:!0};return c(r)},groups:T,isDeviceUser:function(e){return e.id.match(/^device_/)},isServiceUser:function(e){var n;return(e.id||e).match(/^service_/)&&(n=!0),n},hasRole:function(e,n){var t=function(e,n){var t=!1,r=_.get(e,"roles.references");return r&&_.forEach(r,function(e){e.role.id===n&&(t=!0)}),t}(e,n);return t||(t=function(e,n){var t=!1,r=_.get(e,"groups.references");return r&&_.forEach(r,function(e){_.forEach(e.group.roles.references,function(e){e.role.id===n&&(t=!0)})}),t}(e,n)),t},getDevicePermissions:function(e,n){var t={params:l.pageSizeFilter({moId:n})};return g(e).then(function(e){return c.get("".concat(e,"/devicePermissions"),t)})},login:function(e,n,t,r){var u=s.encodeToken(n,t,e);return s.setAuthToken(u).then(function(){return s.saveAuthToken(r)})},logout:function(){return s.logout()},isAdmin:function(e){return _.some(e.groups.references,function(e){return"admins"===e.group.name})},isCurrentPassword:function(e){return s.getPassword()===e},isTfaAvailable:k,isTfaActive:function(t){return _.isUndefined(t.id)?k():f.when(t).then(function(e){var n=e.twoFactorAuthenticationEnabled;return O(t).then(function(e){return e&&(n=!0),n})})},isTfaReadonly:O,getTfaStrategy:function(){return e.detailValue({category:o,key:"strategy"},"SMS")},getHeaders:U,activateSupportUser:function(){var e=l.url("tenant/support-user/enable");return c.put(e)},deactivateSupportUser:function(){var e=l.url("tenant/support-user/disable");return c.put(e)},delegateTo:function(e){var n={id:e.id};return y().then(function(e){return n.delegatedBy=e.id,w(n)})},listInventoryRoles:function(e){return(e?f.resolve(e):y()).then(g).then(C).then(function(e){return c.get(e)})},assignInventoryRoles:function(e,n,t){var r=e?f.resolve(e):y(),u={managedObject:n,roles:_.map(t,function(e){return _.pick(e,"id")})};return r.then(g).then(C).then(function(e){return c.post(e,u)})},updateInventoryRoles:function(e,n,t){var r=e?f.resolve(e):y(),u={roles:_.map(t,function(e){return _.pick(e,"id")})};return r.then(g).then(C).then(function(e){return c.put("".concat(e,"/").concat(n),u)})},removeInventoryRoles:function(e,n){return(e?f.resolve(e):y()).then(g).then(C).then(function(e){return c.delete("".concat(e,"/").concat(n))})}}}e.$inject=["$http","$q","$rootScope","c8yBase","c8yAuth","c8ySettings"],angular.module("c8y.core").factory("c8yUser",e)}();