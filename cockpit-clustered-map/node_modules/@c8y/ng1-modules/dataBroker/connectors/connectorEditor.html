<c8y-ui-title-set>
  <h1 class="title text-truncate" style="display: block;">
    <span ng-if="vm.connector.name">{{ vm.connector.name }}</span>
    <span ng-if="!vm.connector.name" translate>New data connector</span>
  </h1>
</c8y-ui-title-set>

<c8y-breadcrumbs-set>
  <c8y-breadcrumbs-item
    path="#/connectors/"
    label="{{ 'Data connectors' | translate }}"
    icon="c8y-connector-out"
  ></c8y-breadcrumbs-item>
</c8y-breadcrumbs-set>

<form name="vm.connectorForm" novalidate>
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-block">
          <div class="form-group">
            <label for="connectorName" translate>
              Title
            </label>
            <input
              id="connectorName"
              name="connectorName"
              type="text"
              class="form-control"
              ng-model="vm.connector.name"
              placeholder="{{ 'e.g. My connector' | translate }}"
              required
            />
            <c8y-error-feedback field="vm.connectorForm.connectorName"> </c8y-error-feedback>
          </div>

          <div class="form-group">
            <label for="instanceUrl" translate>
              Target URL for data connector
            </label>
            <input
              id="instanceUrl"
              name="instanceUrl"
              type="url"
              class="form-control"
              ng-model="vm.connector.instanceUrl"
              ng-if="!vm.connector.id"
              placeholder="{{ 'e.g. https://target-tenant.com' | translate }}"
              required
            />
            <input
              name="instanceUrl"
              type="text"
              class="form-control"
              ng-model="vm.connector.instanceUrl"
              ng-if="vm.connector.id"
              disabled
            />
            <c8y-error-feedback field="vm.connectorForm.instanceUrl">
              <span ng-message="url" translate>
                Valid URL required.
              </span>
            </c8y-error-feedback>
          </div>

          <div class="form-group">
            <label for="description" translate>
              Description
            </label>
            <textarea
              id="description"
              name="description"
              class="form-control"
              style="height:100px;"
              ng-maxlength="1000"
              ng-model="vm.connector.description"
              placeholder="{{ 'e.g. Forwarding measurements' | translate }}"
            >
            </textarea>
            <c8y-error-feedback field="vm.connectorForm.description"> </c8y-error-feedback>
          </div>
        </div>
        <fieldset style="margin-top: -20px;">
          <div class="legend form-block center" translate>
            Data filters
          </div>
          <div class="card-block">
            <div class="card" ng-if="vm.connector.filters.length === 0">
              <div class="c8y-empty-state text-left">
                <h1 c8y-icon="c8y-connector-out" class="c8y-icon-duocolor"></h1>
                <p translate>
                  <strong>No data filters defined.</strong><br />Data filters define the set of data
                  to be forwarded. You must set at least one filter.
                </p>
              </div>
            </div>

            <uib-accordion close-others="false">
              <div
                uib-accordion-group
                ng-repeat="filter in vm.connector.filters"
                template-url=":::PLUGIN_PATH:::/connectors/connectorFilterAccordionGroup.html"
                class="panel-default"
                is-open="filter.isOpen"
              >
                <uib-accordion-heading>
                  <div ng-if="filter.selectedGroupOrDevice.name" class="col-xs-4">
                    <div class="text-truncate">
                      {{ filter.selectedGroupOrDevice.name }}
                    </div>
                  </div>
                  <div ng-if="!filter.selectedGroupOrDevice.name" class="col-xs-4" translate>
                    All objects
                  </div>

                  <div class="col-xs-6">
                    <div
                      class="text-muted text-truncate"
                      title="{{ vm.getFilterFragmentsSummary(filter) }}"
                    >
                      <i c8y-icon="filter"></i>
                      <span ng-bind="vm.getFilterFragmentsSummary(filter)"></span>
                    </div>
                  </div>

                  <div class="col-xs-2 text-right">
                    <button
                      type="button"
                      class="showOnHover btn-clean text-danger"
                      style="font-size: 18px; line-height: .5;"
                      ng-click="vm.removeFilter(filter)"
                      title="{{ 'Remove' | translate }}"
                    >
                      <i c8y-icon="minus-circle"></i>
                    </button>
                    <button
                      type="button"
                      title="{{ 'Expand' | translate }}"
                      class="collapse-btn"
                      style="height:auto;"
                    >
                      <i c8y-icon="chevron-down"></i>
                    </button>
                  </div>
                </uib-accordion-heading>

                <div class="row">
                  <div class="col-md-2 text-right">
                    <label translate>
                      Group or device
                    </label>
                  </div>
                  <div class="col-md-10">
                    <c8y-device-selector-combo
                      selected-child-device="filter.selectedGroupOrDevice"
                      groups-selectable="true"
                      empty-selection-available="true"
                      empty-selection-icon="'object-group'"
                      empty-selection-label="'All objects' | translate"
                    >
                    </c8y-device-selector-combo>
                    <div
                      class="alert alert-warning"
                      ng-if="!filter.selectedGroupOrDevice"
                      translate
                    >
                      Note: Selecting "All objects" option will synchronize all types of objects,
                      including internal and technical ones (not exclusively groups and devices).
                      This may cause issues on the target tenant.
                    </div>
                  </div>
                </div>
                <hr />

                <div class="row">
                  <div class="col-md-2 text-right">
                    <label translate>
                      API
                    </label>
                    <p class="text-muted small" translate>
                      Select at least one
                    </p>
                  </div>
                  <div class="col-md-10">
                    <div class="flex-row">
                      <span class="flex-auto" ng-repeat="api in vm.apis" ng-if="!api.hidden">
                        <div class="text-center">
                          <i c8y-icon="{{ api.icon }}"></i><br />
                          <span
                            title="{{ api.label | translate }}"
                            ng-bind="api.label | translate"
                          ></span>
                          <label class="c8y-checkbox">
                            <input type="checkbox" ng-model="filter.apis[api.value]" />
                            <span></span>
                          </label>
                        </div>
                      </span>
                    </div>
                  </div>
                </div>
                <hr />

                <div class="row fragments">
                  <div class="col-md-2 text-right">
                    <label translate>
                      Fragments to filter
                    </label>
                  </div>
                  <div class="col-md-10">
                    <div class="row" ng-repeat="fragmentToFilter in filter.fragmentsToFilter">
                      <ng-form name="fragmentToFilterForm">
                        <div class="col-xs-12">
                          <div class="form-group">
                            <label class="visible-sm visible-xs" translate>Fragment</label>
                            <div class="input-group typeahead">
                              <input
                                name="fragment"
                                type="text"
                                class="form-control"
                                ng-model="fragmentToFilter.fragment"
                                placeholder="{{ 'e.g. c8y_FragmentToFilter' | translate }}"
                                uib-typeahead="suggestedFragment as suggestedFragment for suggestedFragment in vm.getSuggestedFragments(filter) | filter:$viewValue"
                                typeahead-show-hint="true"
                                typeahead-min-length="0"
                                c8y-check-dirty="fragmentToFilter.fragment"
                              />
                              <div class="input-group-btn" style="min-width: 83px;">
                                <button
                                  class="btn btn-link"
                                  ng-disabled="filter.fragmentsToFilter.length === 1 && !fragmentToFilter.fragment"
                                  ng-click="vm.removeFragment(filter, 'fragmentsToFilter', fragmentToFilter)"
                                  uib-tooltip="{{ 'Remove' | translate }}"
                                  tooltip-append-to-body="true"
                                >
                                  <i c8y-icon="minus-circle" class="text-danger"></i>
                                </button>
                                <button
                                  class="btn btn-link"
                                  ng-if="$last"
                                  ng-click="vm.addFragment(filter, 'fragmentsToFilter')"
                                  uib-tooltip="{{ 'Add' | translate }}"
                                  tooltip-append-to-body="true"
                                >
                                  <i c8y-icon="plus-circle"></i>
                                </button>
                              </div>
                            </div>
                            <c8y-error-feedback field="fragmentToFilterForm.fragment">
                            </c8y-error-feedback>
                          </div>
                        </div>
                      </ng-form>
                    </div>
                  </div>
                </div>
                <hr />

                <div class="row fragments">
                  <div class="col-md-2 text-right">
                    <label translate>
                      Fragments to copy
                    </label>
                  </div>
                  <div class="col-md-10">
                    <div class="form-group">
                      <label class="c8y-checkbox">
                        <input type="checkbox" ng-model="filter.copyAllFragments" />
                        <span></span>
                        <span translate>Copy all fragments</span>
                      </label>
                    </div>
                    <div ng-repeat="fragmentToCopy in filter.fragmentsToCopy" class="row">
                      <ng-form name="fragmentToCopyForm">
                        <div class="col-xs-12">
                          <div class="form-group">
                            <label class="visible-sm visible-xs" translate>Fragment</label>
                            <div class="input-group typeahead">
                              <input
                                name="fragment"
                                type="text"
                                class="form-control"
                                ng-model="fragmentToCopy.fragment"
                                placeholder="{{ 'e.g. c8y_FragmentToCopy' | translate }}"
                                uib-typeahead="suggestedFragment as suggestedFragment for suggestedFragment in vm.getSuggestedFragments(filter) | filter:$viewValue"
                                typeahead-show-hint="true"
                                typeahead-min-length="0"
                                ng-disabled="filter.copyAllFragments"
                                c8y-check-dirty="fragmentToFilter.fragment"
                              />
                              <div class="input-group-btn" style="min-width: 83px;">
                                <button
                                  class="btn btn-link"
                                  ng-disabled="filter.copyAllFragments || filter.fragmentsToCopy.length === 1 && !fragmentToCopy.fragment"
                                  ng-click="vm.removeFragment(filter, 'fragmentsToCopy', fragmentToCopy)"
                                  uib-tooltip="{{ 'Remove' | translate }}"
                                  tooltip-append-to-body="true"
                                >
                                  <i c8y-icon="minus-circle" class="text-danger"></i>
                                </button>

                                <button
                                  class="btn btn-link hidden-xs hidden-sm"
                                  ng-if="$last"
                                  ng-disabled="filter.copyAllFragments"
                                  ng-click="vm.addFragment(filter, 'fragmentsToCopy')"
                                  uib-tooltip="{{ 'Add' | translate }}"
                                  tooltip-append-to-body="true"
                                >
                                  <i c8y-icon="plus-circle"></i>
                                </button>
                              </div>
                            </div>
                            <c8y-error-feedback field="fragmentToCopyForm.fragment">
                            </c8y-error-feedback>
                          </div>
                        </div>
                      </ng-form>
                    </div>
                  </div>
                </div>
                <hr />

                <div class="row">
                  <div class="col-md-2 text-right">
                    <label translate>
                      Type filter
                    </label>
                  </div>
                  <div class="col-md-10">
                    <div class="form-group">
                      <input
                        name="typeFilter"
                        type="text"
                        class="form-control"
                        ng-model="filter.typeFilter"
                        placeholder="{{ 'e.g. c8y_Linux' | translate }}"
                      />
                      <c8y-error-feedback field="filterForm.typeFilter"> </c8y-error-feedback>
                    </div>
                  </div>
                </div>
              </div>
            </uib-accordion>

            <a
              title="{{ 'Add filter' | translate }}"
              href=""
              class="btn-add-block"
              style="margin: 10px 15px; max-width: 100%; width:auto;"
              ng-click="vm.addFilter()"
            >
              <i c8y-icon="plus-square"></i>
              <translate>Add filter</translate>
            </a>
          </div>
        </fieldset>

        <div class="card-block bg-gray-lighter" ng-if="vm.connector.code">
          <div class="form-group">
            <label translate>
              Security code
            </label>
            <span class="input-group" c8y-copy-to-clipboard>
              <input
                c8y-copy-to-clipboard-input
                type="text"
                class="form-control"
                ng-model="vm.connector.code"
                readonly
              />
              <span class="input-group-btn">
                <button
                  title="{{ 'Copy' | translate }}"
                  c8y-copy-to-clipboard-button
                  class="btn btn-default"
                >
                  <i c8y-icon="copy"></i>
                </button>
              </span>
            </span>
          </div>
          <div class="text-info">
            <i c8y-icon="info-circle"></i>
            <span translate
              >Security code will be requested on the target tenant to establish connection.</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center page-footer">
    <c8y-ui-button-footer changed="vm.connectorForm.$dirty">
      <div class="row">
        <div class="col-md-8">
          <button
            title="{{ 'Cancel' | translate }}"
            class="btn btn-default"
            ng-if="!vm.connector.id"
            ng-click="vm.cancel()"
            translate
          >
            Cancel
          </button>
          <button
            title="{{ 'Remove' | translate }}"
            class="btn btn-danger"
            ng-if="vm.connector.id"
            ng-click="vm.remove()"
            translate
          >
            Remove
          </button>
          <button
            title="{{ 'Save' | translate }}"
            class="btn btn-primary"
            type="button"
            ng-disabled="!vm.canSave()"
            ng-click="vm.save()"
            translate
          >
            Save
          </button>
        </div>
      </div>
    </c8y-ui-button-footer>
  </div>
</form>
