"use strict";!function(){function e(e,t,n){var o=this,a=[],i=2,r={dateFrom:void 0,dateTo:void 0,timelines:[]},m=_.throttle(function(e,t,n){_.assign(o.timeline,{dateFrom:_.clone(e),dateTo:_.clone(t),timelines:n})},300);function l(){e.$broadcast("c8yTimelinesChart::render")}function s(e,t){if(function(e,t){return _.isUndefined(e)&&!_.isUndefined(t)}(e,t))return!0;if(function(e,t){return _.isUndefined(e)&&_.isUndefined(t)}(e,t))return!1;var n=moment(t).diff(e,"seconds")<i;return!o.realtime&&!n}function d(){var e={dateFrom:moment(o.dateFrom).format(t.dateFullFormat),dateTo:moment(o.dateTo).format(t.dateFullFormat),withTotalPages:!0,pageSize:1e3};return n.fetchTimelinesForAlarmsEvents(a,e).then(function(e){m(o.dateFrom,o.dateTo,e)})}function c(e,t){var n=_.findIndex(o.timeline.timelines,{alarmsEventsConfig:t}),a=o.timeline.timelines[n].events,i=_.findIndex(a,{id:e.id});-1===i?a.push(e):a[i]=e}_.assign(o,{$onChanges:function(e){var t=!1;e.alarmsEventsConfigs&&(a=_.cloneDeep(o.alarmsEventsConfigs));e.dateFrom&&(t=s(o.timeline.dateFrom,e.dateFrom.currentValue),o.timeline.dateFrom=_.clone(e.dateFrom.currentValue));e.dateTo&&(t=s(o.timeline.dateTo,e.dateTo.currentValue),o.timeline.dateTo=_.clone(e.dateTo.currentValue));e.chartBox&&(o.timeline.chartBox=_.clone(e.chartBox.currentValue));e.realtime&&!1===_.get(e,"realtime.previousValue")&&(t=!0);t?d():l()},$doCheck:function(){var e=!1;_.isEqual(a,o.alarmsEventsConfigs)||(a=_.cloneDeep(o.alarmsEventsConfigs),e=!0);moment(o.timeline.dateFrom).isSame(o.dateFrom)||(e=s(o.timeline.dateFrom,o.dateFrom),o.timeline.dateFrom=_.clone(o.dateFrom));moment(o.timeline.dateTo).isSame(o.dateTo)||(e=s(o.timeline.dateTo,o.dateTo),o.timeline.dateTo=_.clone(o.dateTo));_.isEqual(o.dateFrom,o.dateTo)&&(e=!1);e?d():l()},onRealtimeAlarm:function(e){_.forEach(a,function(t){n.alarmMatchesConfig(e,t)&&n.transformAlarmToTimelineEvent(e).then(function(e){return c(e,t)})})},onRealtimeEvent:function(e){_.forEach(a,function(t){n.eventMatchesConfig(e,t)&&n.transformEventToTimelineEvent(e).then(function(e){return c(e,t)})})},timeline:r})}e.$inject=["$scope","c8yBase","c8yAlarmsEventsTimelinesChartService"],angular.module("c8y.alarmsEventsExplorer").component("c8yAlarmsEventsTimelinesChart",{bindings:{alarmsEventsConfigs:"<",dateFrom:"<",dateTo:"<",realtime:"<",chartBox:"<",onRealtimeAlarm:"=?",onRealtimeEvent:"=?",onUpdateDates:"&",onSizeChanged:"&"},templateUrl:":::PLUGIN_PATH:::/alarmsEventsTimelinesChart/alarmsEventsTimelinesChart.html",controller:e,controllerAs:"vm"})}();