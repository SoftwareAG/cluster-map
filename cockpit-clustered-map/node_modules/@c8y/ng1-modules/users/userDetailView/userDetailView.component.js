"use strict";!function(){function e(i,e,n,u,o,a,c,t,r,l,E,s,f,g){var h=this;_.assign(h,{cancel:l.gotoList});var d,R,w,A,m,p=e.userId,N=["business"];function U(){p?o.detail(p).then(function(e){return e.data}).then(v):(v({enabled:i.isNew=!0}),G(g("New user")))}function v(e){R=e.email,e.devicePermissions=e.devicePermissions||{},i.user=e,i._groups=y(e),i.password.showPassword=i.isNew,i.hasExternalOrigin=l.hasExternalOrigin(e),i.hasExternalOrigin&&c.warning(l.EXTERNAL_ORIGIN_TEXT),i.isNew&&(_.forEach(i.groups,function(e){_.includes(N,e.name)&&(i._groups[e.id]=!0)}),A&&c.warning(l.LOCAL_USER_TEXT))}function y(e){return _.reduce(_.get(e,"groups.references"),function(e,n){return e[n.group.id]=!0,e},{})}function T(e){i.groups=e}function L(e){i.currentUser=e,w=e}function O(e){e?M(i.user):U()}function M(n){i.saving=!0;var e=l.gotoList,t=!(n.id&&!n.groups),r=_(i._groups).map(function(e,n){return e&&parseInt(n,10)}).filter().value(),s=t?_.partialRight(a.updateGroups,r):_.identity;try{o.current().then(function(e){return _.isEqual(e.userName,n.userName)}).then(function(e){return f.isActivatedFor("units-conversion")&&(e&&function(e){var n=_.get(e,"measurementUnit.value");E.set("unit",n)}(n),_.unset(n,"measurementUnit")),e}).then(function(e){return o.save(_.omit(n,"measurementUnit"),e)}).then(u.getResData).then(s).then(function(){return c.success(g("User saved."))}).then(e).finally(function(){i.saving=!1})}catch(e){c.danger(e.message),i.saving=!1}}function G(e){e&&t.changeTitle({title:e})}function I(e){return o.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||o.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")}function P(e){return _.get(i.user,"owner")&&d&&!d[e.id]}i.checkPassword=function(e){i.isNew||!i.password.showPassword&&!function(e){return e.email!==R}(e)?M(i.user):r.askForPassword().then(O)},i.$watch("user.userName",G),i.$watch("user.owner",function(e){e?o.detail(e).then(u.getResData).then(function(e){d=y(e),_.forEach(i._groups,function(e,n){i._groups[n]=e&&d[n]})}):d=null}),i.canEditUser=function(e,n){return!(!e||!n)&&(!n.id||(e.id!==n.id?o.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||o.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE"):o.hasRole(e,"ROLE_USER_MANAGEMENT_OWN_ADMIN")))},i.canEditUserGroups=I,i.canActivateUser=function(e,n){return!(!e||!n)&&e.id!==n.id},i.forms={},i.password={},i.saving=!1,i.showAcl=function(){var e=_.get(i.user,"devicePermissions"),n=_.keys(e);return u.getFlag("deprecated")||n.length},i.cannotSelectGlobalRole=function(e){return I(w)&&_.get(i.user,"owner")&&P(e)},i.restrictedByOwner=P,i.$on("$destroy",function(){c.remove({text:l.EXTERNAL_ORIGIN_TEXT,type:"warning"}),c.remove({text:l.LOCAL_USER_TEXT,type:"warning"})}),a.list(m).then(T).then(s.isSsoEnabled).then(function(e){A=e}).then(U),o.current().then(L),l.userHierarchyActive().then(function(e){h.FEATURE_USER_HIERARCHY=e})}e.$inject=["$scope","$routeParams","$window","c8yBase","c8yUser","c8yUserGroup","c8yAlert","c8yTitle","c8yUserUtil","c8yUsersUi","c8yUserPreferences","c8yLoginOptions","c8yBeta","gettext"],angular.module("c8y.users").component("c8yUserDetailView",{templateUrl:":::PLUGIN_PATH:::/userDetailView/userDetailView.html",controller:e,controllerAs:"vm"})}();