"use strict";!function(){function e(e,n,r,L){l.$inject=["$q","$routeParams"],d.$inject=["$q","$location","$uibModal","$window","gettextCatalog","c8yAlert","c8yModal","c8yUser","c8yRoles","c8yUserRolesUi","c8yUserInventoryRoles","c8yUserUtil","c8yPermissions","c8yLoginOptions","passwordStrengthCheckerFactory"];var t="c8y-user",o=["ROLE_USER_MANAGEMENT_READ","ROLE_USER_MANAGEMENT_ADMIN","ROLE_USER_MANAGEMENT_CREATE"],O=c(),P=c("/new"),$=c("/:userId"),a={template:"<c8y-user-list-view></c8y-user-list-view>"},i={priority:1e3,icon:t,name:L("Profile / Global roles"),template:'<c8y-user-detail-view user-id="$resolve.userId"></c8y-user-detail-view>',resolve:{userId:["$route",function(e){return e.current.params.userId}]}},s={priority:-1e3,icon:"c8y-modules",name:L("Application access"),template:'<c8y-user-application-access user="$resolve.user"></c8y-user-application-access>',resolve:{user:["$route","c8yUser","c8yBase",function(e,r,t){return r.detail(e.current.params.userId).then(t.getResData).then(function(n){return n.owner?r.detail(n.owner).then(t.getResData).then(function(e){return n._owner=e,n}):n})}]}},u={data:l};return{initUi:function(){e.addNavigation({parent:{name:L("Accounts"),icon:"c8y-accounts"},name:L("Users"),path:c().replace(/^\//,""),icon:t,priority:5e3,routerLinkExact:!1,showIfPermissions:{anyRole:o}}),n.when(O,a),n.when(P,i),n.when($,i),n.when($,s),r.addTitle($,u)},$get:d};function c(e){return"/users".concat(e||"")}function l(e,n){return e.when({title:n.userId})}function d(i,n,r,e,s,t,u,c,o,a,l,d,f,p,g){var v,y=g();return c.current().then(function(e){v=e.id}),{ROUTE_NEW_USER:P,fullName:function(e){return"".concat(e.firstName||""," ").concat(e.lastName||"")},toggleExpanded:function(e){var r=!e._expanded;(e._expanded=r)||!function n(e){_.forEach(e,function(e){e._expanded=r,n(e._owns)})}(e._owns);return e},createUserFlatTree:d.createUserFlatTree,visibleInList:function(e){return!_.get(e,"owner")||_.get(e,"_owner._expanded")},expandAll:function(e){_.forEach(e,function(e){e._expanded=!0})},collapseAll:function(e){_.forEach(e,function(e){delete e._expanded})},detailLink:h,editUser:function(e){n.path(h(e))},search:d.search,changeUser:function(e,n){var r={changeGlobalRoles:m,copyInventoryRoles:E,enable:w,disable:A,remove:R,delegate:U,removeDelegate:I},t="string"==typeof n?n:_.get(n,"name");return _.get(r,t,i.reject)(e,_.get(n,"data"))},getPasswordStrength:y.getStrengthForColor,getPasswordColor:y.getHexColorForColor,getPasswordIcon:y.getIconForColor,isTfaAvailable:c.isTfaAvailable,gotoList:function(){n.path(O)},userHierarchyActive:d.userHierarchyActive,hasAppManagement:function(e){return f.hasAnyRole(["ROLE_APPLICATION_MANAGEMENT_READ","ROLE_APPLICATION_MANAGEMENT_ADMIN"],e)},isUndeletable:function(e){return v?M(e)||f.hasRole(e,"ROLE_TENANT_ADMIN"):void 0},isCurrent:M,hasExternalOrigin:function(e){return e.customProperties&&"OAUTH2"===e.customProperties.userOrigin},EXTERNAL_ORIGIN_TEXT:L("You cannot edit the user since it is managed via your authorization server."),LOCAL_USER_TEXT:L("You are about to create a local user which will not be able to log in via single sign-on.")};function h(e){return $.replace(/:userId/,e.id)}function m(e,n){var r=_.map(n.roles,"id");return o.global.updateGroups(e,r)}function E(o){return i.all({copy:a.copyFromUserDialog(o),assignedRoles:c.listInventoryRoles(o)}).then(function(e){var n="replace"===e.copy.process,r=e.copy.roles,t=_.keyBy(e.assignedRoles.data.inventoryAssignments,"managedObject");return l.copyUserRoles(r,t,o,n)})}function A(e){return c.disable(e)}function w(e){return c.enable(e)}function R(e){var t=e._owns,o=function n(e){return _(e._owns).map(function(e){return _.union(n(e),[e])}).flattenDeep().value()}(e),n=!!o.length,a=function(r){return function(e){var n=_.pick(e,["id"]);return n.owner=r,n}};return(n?r.open({component:"c8yUserRemoveChildrenModal",resolve:{user:_.constant(e)}}).result.then(function(e){var n;if(e.remove&&(n=function e(){var n=o.shift();return n&&c.remove(n).then(e)}()),!_.isUndefined(e.owner)){var r=_.map(t,a(e.owner));n=i.all(_.map(r,function(e){return c.save(e)}))}return n}):u({title:L("Delete user"),body:s.getString('You are about to delete user "{{userName}}". Do you want to proceed?',e),labels:{ok:L("Delete")},status:"danger"})).then(_.partial(c.remove,e)).then(_.partial(N,e)).then(_.constant({removeUser:!n,refresh:n}))}function N(e){return t.success(s.getString('User "{{userName}}" deleted.',e))}function U(e){return c.delegateTo(e).then(_.partial(T,e))}function T(e){return t.success(s.getString('You delegated to user "{{userName}}".',e))}function I(e){var n={id:e.id,delegatedBy:null};return c.save(n).then(_.partial(b,e))}function b(e){return t.success(s.getString('You removed delegation from user "{{userName}}".',e))}function M(e){return v&&v===e.id}}}e.$inject=["c8yNavigatorProvider","c8yViewsProvider","c8yTitleProvider","gettext"],angular.module("c8y.users").provider("c8yUsersUi",e)}();