"use strict";!function(){function e(i,n,u,t,e){var o,a=this;function l(e){return o=e?[]:a.users,a.users=[],u.list(function(){var e=_.get(a.filters,"text"),n=_.map(_.get(a.filters,"globalRoles"),"id"),t=n.length?n.join(","):void 0;return{withSubusersCount:!0,username:e,groups:t,withApps:!1,withGroups:!1,withRoles:!1}}()).then(r)}function r(e){s(e),a.users.paging=e.paging}function s(e){var n=a.users,t=n.paging,s=u.getTfaStrategy();_.forEach(e,function(r){var e=_.find(o,{id:r.id});r.twoFactorAuthenticationEnabled||i.all({enforced:u.isTfaActive(r),strategy:s}).then(function(e){var n=e.enforced,t=e.strategy;"SMS"!==t&&t||n&&(r.twoFactorAuthenticationEnabled=n)}),e&&(r._expanded=e._expanded),_.some(n,{id:r.id})||(n=n.concat([r]))}),n.paging=t,a.users=n}function c(e){a.globalRoles=e}function f(e){return e._globalRoles=_.map(_.get(e,"groups.references"),function(e){return _.find(a.globalRoles,{id:e.group.id})}),e}function d(){u.current().then(function(e){a.canAddUser=u.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||a.FEATURE_USER_HIERARCHY&&u.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")})}function g(e){return o=a.users,u.list({owner:e.id,withSubusersCount:!0}).then(s)}function h(e,n){var t,r=n||{};if(r.removeUser){var s=_.get(e,"_owner.id");a.users=_.map(_.reject(a.users,{id:e.id}),function(e){return s&&s===e.id?angular.copy(e):e})}return r.refresh||r.removeUser||(t=u.list({username:e.id,withSubusersCount:!0}).then(_.first).then(function(t){var r=t.id,e=_.map(a.users,function(e){var n=r===e.id;return n&&(t._expanded=e._expanded),n?f(t):e});_.assign(e,_.pick(a.users,["statistics","paging"])),a.users=e})),r.refresh&&(t=l()),t}_.assign(a,{ROUTE_NEW_USER:t.ROUTE_NEW_USER,$onInit:function(){i.all([l(),e.global.list({pageSize:1e4}).then(c)]).then(function(){return _.forEach(a.users,f)}),t.userHierarchyActive().then(function(e){a.FEATURE_USER_HIERARCHY=e}).then(d)},loadMore:function(){a.users.paging.next().then(r)},loadUsers:l,loadSubusers:g,changeUser:function(e,n){return t.changeUser(e,n).then(_.partial(h,e))},showExpandCollapse:function(){return a.FEATURE_USER_HIERARCHY&&_.some(a.users,function(e){return 0<e.subusersCount||_.get(e,"_owns.length")})},collapseAll:function(){t.collapseAll(a.users)},expandAll:function(){t.expandAll(a.users),i.all(_.map(a.users,function(e){return e.subusersCount>e._owns.length?g(e).then(function(){return!0}):i.resolve(!1)})).then(function(e){_.some(e)&&n(a.expandAll)})},filters:{},applyFilters:function(){l(!0)},clearFilters:function(){a.filters={},l(!0)},isAnyFilterSelected:function(){return _.some(a.filters,_.identity)},refresh:function(){return l(!0)}})}e.$inject=["$q","$timeout","c8yUser","c8yUsersUi","c8yRoles"],angular.module("c8y.users").component("c8yUserListView",{templateUrl:":::PLUGIN_PATH:::/userListView/userListView.html",controller:e,controllerAs:"vm"})}();