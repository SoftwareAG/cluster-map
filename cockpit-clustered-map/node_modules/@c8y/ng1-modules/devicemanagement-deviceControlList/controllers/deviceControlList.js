"use strict";!function(){function n(i,a,t,r,o,c,u,l,n,e,d,s,p,f,g,h,v){var m,I,y=this,C={},O={},b=!0;function k(){return A().then(_.partialRight(D,!0)).then(function(){return w()})}function A(n){var e=function(n){var e=o.timeOrderFilter(n||{});return _.assign(e,a),e.revert=!0,e}(n);return c.list(e)}function D(n,e){return i.operations&&!e||(i.operations=[],C={},O={}),i.paging=n.paging,r.all(_.map(n,S))}function w(n){var e=function(n){var e=_.defaults(n||{},{pageSize:1e3,withDeleted:!0});return _.assign(e,a),e.status=u.getMappedSingleOpStatus(e.status),e}(n);return u.list(e).then(function(n){return r.all(_.map(n,L))})}function S(e){var t=r.when();return z(e)?C[e.id]?t:function(n){return r.when(n.deviceName||f.detail(n.deviceId).then(o.getResData).then(_.partial(_.pick,"name")))}(e).then(function(n){return e.deviceName=n,C[e.id]=e,C[e.id].bulkOperationId&&!a.deviceId&&o.checkIfModulesExist(["c8y.deviceBulkControl"])?t=function(n,e){O[n]&&(E(O[n],[e]),M(e));return $(n).then(L)}(C[e.id].bulkOperationId,e):i.operations.push(C[e.id]),t}):t}function $(n){return u.detail(n).then(o.getResData)}function L(n){var e=r.when();return z(n)?O[n.id]?e:function(n){return c.list({bulkOperationId:n.id})}(O[n.id]=n).then(_.partial(E,n)).then(function(){i.operations.push(n)}):e}function E(e,n){_.forEach(n,function(n){C[n.id]=n,e.operations=e.operations||[],e.operations.push(C[n.id])})}function T(n){var e=[];return c.listPaged(n).then(function(){return e},_.noop,function(n){e=e.concat(n)})}function P(){i.refreshLoading=!0,i.realtimeAnimation=!1,k().finally(function(){i.refreshLoading=!1,i.realtimeAnimation=!0})}function U(){n({templateUrl:":::PLUGIN_PATH:::/views/cancelAllModal.html",title:h("Confirm cancelling all pending operations"),body:h("Do you really want to cancel all pending operations?")}).then(_.partial(T,{status:c.status.PENDING,deviceId:a.deviceId})).then(x)}function x(n){var e=h("Cancelling pending operations"),t=n.map(function(n){return _.partial(c.cancel,n)});t.length?l.run(t,e).result.finally(P):s.warning(h("There are no pending operations"))}function B(){d.addAction({text:h("Cancel all pending operations"),action:function(){U()}})}function N(n){var e=o.getId(n);R(i.operations,n),n.bulkOperationId&&R(O[n.bulkOperationId].operations,n),delete C[e]}function R(n,e){var t=o.getId(e);_.remove(n,function(n){return n.id.toString()===t.toString()})}function M(n){n.bulkOperationId&&$(n.bulkOperationId).then(G)}function G(n){O[n.id]=_.assign(O[n.id],n)}function z(n){var e=!n.groupId||!m||_.includes(m,n.groupId)&&_.some(i.operations,{bulkOperationId:n.id}),t=!(a.status&&a.status!==n.status&&!u.doesMatchSingleOpStatus(n,a.status));return e&&t}i.singleOperations=C,i.bulkOperations=O,i.statusClass=function(n){return c.getStyle(n).cls},i.statusIcon=function(n){return c.getStyle(n).icon},i.loadNext=function(n){i.paging.loading=!0,(n?A({pageSize:n}):i.paging.next().then(D)).finally(function(){i.paging.loading=!1})},i.getStandardKeys=c.getStandardKeys,i.refresh=P,i.changeFilter=function(n){var e=(n||"").toUpperCase();t.search("status",e||null)},i.btnActive=function(n){return a.status===n},i.cancel=c.cancel,i.cancelAllPending=U,i.realtimeAnimation=!1,i.realtimeChannel="/operations/".concat(void 0!==a.deviceId?a.deviceId:"*"),y.realtimeChannel=i.realtimeChannel,i.getDisplayOptions=function(){return{showDetails:!1,showDeviceLink:!a.deviceId,showGroupLink:!a.deviceId,showEditable:!0}},i.isSingleOperation=function(n){return!_.isUndefined(n.deviceId)},i.isBulkOperation=function(n){return!_.isUndefined(n.groupId)},i.sortOperationsListByTime=function(n){return moment(n.creationTime||n.startDate).toDate()},y.subTitle=function(){var n=_.get(i,"operations.length");return _.isUndefined(n)?"":v.getPlural(n,"1 loaded","{{$count}} loaded",{})},y.showTitle=function(){return!a.deviceId},y.realtimeSubscriberId=i.$id,p.addListener(i.$id,i.realtimeChannel,"".concat(i.$id,"-subscribed"),function(){i.realtimeAnimation=!1,k(),B()}),p.addListener(i.$id,i.realtimeChannel,"CREATE",function(n,e){i.realtimeAnimation=!0,S(e)}),p.addListener(i.$id,i.realtimeChannel,"UPDATE",function(n,e){C[e.id]?z(e)?function(n){C[n.id]=_.assign(C[n.id],n),M(n)}(e):N(e):S(e)}),p.addListener(i.$id,i.realtimeChannel,"DELETE",function(n,e){N(e)}),(I=r.when(),a.deviceId&&(I=g.directParentAssets(a.deviceId).then(function(n){return _.map(n,"id")}).then(function(n){m=n})),I).then(A).then(D).then(function(){return w()}),B(),b&&p.switchRealtime(i.$id,i.realtimeChannel)}n.$inject=["$scope","$routeParams","$location","$q","c8yBase","c8yDeviceControl","c8yDeviceBulkControl","c8yBatchOp","c8yModal","c8yTitle","c8yActions","c8yAlert","c8yRealtime","c8yDevices","c8yInventory","gettext","gettextCatalog"],angular.module("c8y.parts.deviceControlList").controller("deviceControlCtrl",n)}();