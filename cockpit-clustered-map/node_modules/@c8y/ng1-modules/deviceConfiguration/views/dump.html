<div ng-controller="deviceConfigurationDumpCtrl">
  <div
    class="card"
    ng-show="supportsOperation('c8y_UploadConfigFile') || supportsOperation('c8y_DownloadConfigFile')"
  >
    <div class="card-header-actions no-scroll">
      <div class="card-icon">
        <i c8y-icon="gears"></i>
      </div>
      <div class="card-title">
        <span>{{ 'Configuration snapshot' | translate }}</span>
      </div>
      <div class="header-actions">
        <button
          title="{{ 'Get new snapshot from device' | translate }}"
          type="button"
          class="btn btn-link"
          ng-show="supportsOperation('c8y_UploadConfigFile')"
          ng-disabled="retrievingConfiguration"
          ng-click="retrieveConfiguration()"
        >
          <i
            class="fa"
            ng-class="{'fa-spin fa-circle-o-notch': retrievingConfiguration, 'fa-download': !retrievingConfiguration }"
          ></i>
          {{ 'Get new snapshot from device' | translate }}
        </button>
      </div>
    </div>

    <div class="card-block">
      <div class="legend form-block">{{ 'Current snapshot' | translate }}</div>
      <div class="alert alert-warning" ng-show="configInfoAvailable && !deviceConfigId" translate>
        No snapshot assigned to this device. Get current snapshot from device or put new one from
        repository.
      </div>

      <div
        class="alert alert-warning"
        ng-show="configInfoAvailable && deviceConfigId && !configFromRepository"
        translate
      >
        The snapshot with the ID {{ deviceConfigId }} is assigned to the device but the
        configuration can't be found in the repository.
      </div>
      <div class="form-group" ng-show="deviceConfigDateUpdate">
        <label class="small" translate>Snapshot assigned on</label>
        <p>{{ deviceConfigDateUpdate | absoluteDate }}</p>
      </div>

      <div class="form-group" ng-show="configFromRepository">
        <label translate>Name</label>
        <p>{{ configFromRepository.name }}</p>
      </div>

      <div class="form-group" ng-show="configFromRepository">
        <label translate>Description</label>
        <p>{{ configFromRepository.description }}</p>
      </div>

      <div class="form-group" ng-show="configFromRepository">
        <label translate>Configuration snapshot file</label>
        <div>
          <c8y-binary-input
            initial-url="configFromRepository.url"
            editable="false"
          ></c8y-binary-input>
          <small>
            <a
              title="{{ 'Open in repository' | translate }}"
              ng-href="#/configuration?id={{ configFromRepository.id }}"
              translate
              >Open in repository</a
            >
          </small>
        </div>
      </div>
    </div>
    <div class="bg-gray-white">
      <div class="card-block overflow-visible">
        <div class="legend form-block">{{ 'Apply new snapshot' | translate }}</div>
        <form role="form" name="newCfgForm">
          <div class="form-group">
            <label>{{ 'Select configuration repository entry to be used' | translate }}</label>
            <div>
              <ui-select
                class="snapshotsSelect form-control"
                style="width:98%"
                ng-model="newConfiguration.selected"
              >
                <ui-select-match
                  placeholder="{{ 'Select configuration' | translate }}…"
                  title="{{ $select.selected.name }} &ndash; {{ $select.selected.description }}"
                >
                  {{ $select.selected.name }} &ndash; {{ $select.selected.description }}
                </ui-select-match>
                <ui-select-choices
                  group-by="configurationType"
                  repeat="cfg in configurations track by $index"
                  refresh="loadConfigurationRepositoryItems($select.search)"
                  refresh-delay="300"
                >
                  <span title="{{ cfg.name }} &ndash; {{ cfg.description }}">
                    {{ cfg.name }} &ndash; {{ cfg.description }}
                  </span>
                </ui-select-choices>
              </ui-select>
            </div>
            <a
              title="{{ 'Add configuration snapshot' | translate }}"
              ng-href="#/configuration?add=1&type={{ device.type }}"
              class="btn btn-link"
              ><i c8y-icon="plus"></i> <span translate>Add configuration snapshot</span></a
            >
          </div>
          <button
            title="{{ 'Send new snapshot to device' | translate }}"
            type="button"
            class="btn btn-primary"
            ng-click="applyConfiguration(newConfiguration.selected)"
            ng-disabled="!newConfiguration.selected || applyingConfiguration"
          >
            <i c8y-icon="upload"></i>
            <span ng-hide="applyingConfiguration">{{
              'Send new snapshot to device' | translate
            }}</span>
            <span
              title="{{ 'Sending new snapshot to device' | translate }}…"
              ng-show="applyingConfiguration"
              >{{ 'Sending new snapshot to device' | translate }}…</span
            >
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
