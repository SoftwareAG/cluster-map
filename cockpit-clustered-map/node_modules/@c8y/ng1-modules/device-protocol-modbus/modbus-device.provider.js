"use strict";function asyncGeneratorStep(e,t,n,r,a,i,s){try{var o=e[i](s),u=o.value}catch(e){return void n(e)}o.done?t(u):Promise.resolve(u).then(r,a)}function _asyncToGenerator(o){return function(){var e=this,s=arguments;return new Promise(function(t,n){var r=o.apply(e,s);function a(e){asyncGeneratorStep(r,t,n,a,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,a,i,"throw",e)}a(void 0)})}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){e.$inject=["c8yDeviceTypeProtocolBaseProvider","c8yDeviceProtocolUiProvider","c8yViewsProvider","gettext"];var a="c8yModbusDevice";function e(e,t,n,x){r.$inject=["c8yDeviceDatabase","c8yDeviceControl","gettextCatalog","c8yInventory","c8yDevices","c8yAlert","c8yBase","c8yUser","$q"];var E={label:x("Modbus"),fieldbusType:"modbus",serviceName:a};return e.getDeviceTypeProtocolProvider(E,r);function r(u,c,d,e,l,i,p,a,v){var t,n=u.ElementType,f=n.DISCRETE_IO,m=n.REGISTER,r=(_defineProperty(t={},f.value,"c8y_CoilStatus"),_defineProperty(t,m.value,"c8y_RegisterStatus"),t),s=_objectSpread({},E,{discreteOutputs:{functionalities:{showStatus:!0,updateStatus:!0}},discreteInputs:{functionalities:{showStatus:!0,updateStatus:!0}},holdingRegisters:{number:!0,startBit:{max:15},noBits:{max:64,base:16},multiplier:{min:1,step:1},divisor:!0,decimalPlaces:!0,unit:!0,options:{signed:!0,enumType:!0,littleEndian:!0},functionalities:{showStatus:!0,updateStatus:!0,sendMeasurement:!0,raiseAlarm:!0,sendEvent:!0}},inputRegisters:{number:!0,startBit:{max:15},noBits:{max:64,base:16},multiplier:{min:1,step:1},divisor:!0,decimalPlaces:!0,unit:!0,options:{signed:!0,enumType:!0,littleEndian:!0},functionalities:{showStatus:!0,updateStatus:!0,sendMeasurement:!0,raiseAlarm:!0,sendEvent:!0}},options:{serverTime:!0},deviceFragments:["c8y_ModbusDevice"],deviceConfiguration:{fragment:"c8y_ModbusConfiguration",icon:"microchip"},versions:[{number:5,checks:[function(e){return _.some(e.c8y_Registers,function(e){return 16<e.noBits})},function(e){return _.some(e.c8y_Registers,function(e){return!_.isUndefined(e.littleEndian)})}]}]});return{registerFeaturesManifest:function(){u.registerFeaturesManifest(o().then(function(e){return e&&s}))},isAvailable:o,create:function(e,t){return y.apply(this,arguments)},canUpdateElement:R,isElementChangePending:function(e){return e.changePending},getCurrentElementValue:h,getCurrentElementValueFormatted:function(e,t){var n=h(e,t);t.meta.enumType&&(n=t.meta.enumValues[n].label);return n},updateElement:function(e,t,n){return S.apply(this,arguments)},getAlertMessagesFns:D,sendOperationAndGetResult:P};function o(){return u.isFeatureFieldbus4Available()}function y(){return(y=_asyncToGenerator(regeneratorRuntime.mark(function e(a,i){var s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g(a,i);case 2:return s=e.sent,e.t0=p,e.next=6,l.createConfirm(s);case 6:return e.t1=e.sent,o=e.t0.getResData.call(e.t0,e.t1),e.next=10,l.addChildDevice(a,o);case 10:return o.owner=a.owner,e.next=13,l.save(o);case 13:return e.abrupt("return",c.create((t=a,n=i.deviceType,r=o,{deviceId:t.id,description:'Added new child device to "'.concat(t.name,'" (ID: ').concat(t.id,")."),c8y_ModbusDevice:{id:r.id,name:r.name,address:r.c8y_ModbusDevice.address,ipAddress:r.c8y_ModbusDevice.ipAddress,type:"/inventory/managedObjects/".concat(n.id),protocol:r.c8y_ModbusDevice.protocol}})));case 14:case"end":return e.stop()}var t,n,r},e)}))).apply(this,arguments)}function g(e,t){return b.apply(this,arguments)}function b(){return(b=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.current();case 2:return r=e.sent,e.abrupt("return",{name:n.name,type:n.deviceType.name,c8y_ModbusDevice:{address:n.address,ipAddress:n.ipAddress,type:"/inventory/managedObjects/".concat(n.deviceType.id),protocol:n.protocol},owner:r.id});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function h(e,t){var n=r[t.meta.type.value];return e&&e[n]&&parseFloat(e[n][t.name])}function S(){return(S=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r){var a,i,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(R(t,n))return e.next=3,u.getDeviceTypeFromDevice(t);e.next=12;break;case 3:return a=e.sent,i=w(t,a,n,r),n.changePending=!0,s=D(n,r),e.next=9,P(i,s);case 9:return(o=e.sent).status===c.status.SUCCESSFUL?(F(t,n,r),n.changePending=!1):o.status===c.status.FAILED&&(n.changePending=!1),e.abrupt("return",o);case 12:return e.abrupt("return",v.reject());case 13:case"end":return e.stop()}},e)}))).apply(this,arguments)}function R(e,t){var n=t.statusMapping;return!e.c8y_ModbusReadOnlyDevice&&n&&"write"===n.status}function w(e,t,n,r){var a=n.meta.type;return a===f?function(e,t,n){return{deviceId:e.id,description:'Change status of "'.concat(t.name,'" to "').concat(n.label,'".'),c8y_SetCoil:{address:e.c8y_ModbusDevice.address,input:t.input,coil:t.number,value:n.value}}}(e,n,r):a===m?function(e,t,n,r){var a=r.label||r.value,i=!r.label&&n.unit?" ".concat(n.unit):"",s={deviceId:e.id,description:'Change value of "'.concat(n.name,'" to ').concat(a).concat(i,"."),c8y_SetRegister:{}};"opcua"===t.fieldbusType?s.c8y_SetRegister={address:e.c8y_OPCUADevice.browsePath,register:n.browsePath,value:r.value}:s.c8y_SetRegister={ipAddress:_.get(e,"c8y_ModbusDevice.ipAddress",""),address:e.c8y_ModbusDevice.address,input:n.input,register:n.number,startBit:n.startBit,noBits:n.noBits,value:r.value};return s}(e,t,n,r):void 0}function D(e,t){var n,r,a,i,s=e.meta.type,o={name:e.name};s===f?(o.label=t.label,n=x("Status of {{name}} will be changed to {{label}}"),r=x("Status of {{name}} has been changed to {{label}}"),a=x("Failed to change status of {{name}} to {{label}}"),i=x('Failed to change status of {{name}} to {{label}} due to: "{{operation.failureReason | translate}}".')):s===m&&(o.value=t.label||t.value,o.unit=!t.label&&e.unit?" ".concat(e.unit):"",n=x("Value of {{name}} will be changed to {{value}}{{unit}}"),r=x("Value of {{name}} has been changed to {{value}}{{unit}}"),a=x("Failed to change value of {{name}} to {{value}}{{unit}}"),i=x('Failed to change value of {{name}} to {{value}}{{unit}} due to: "{{operation.failureReason | translate}}".'));var u=function(t){return function(e){return d.getString(t,_objectSpread({},o,{operation:e}))}};return{onCreated:u(n),onSuccess:u(r),onFailure:u(a),onFailureWithReason:u(i)}}function P(e,t){return C.apply(this,arguments)}function C(){return(C=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.createWithNotifications(t);case 2:return(r=e.sent).created.then(function(){n.onCreated?i.success(n.onCreated(t)):i.success(d.getString('"{{description | translate}}" will be executed.',t))}),e.next=6,r.completed;case 6:return(a=e.sent).status===c.status.SUCCESSFUL?n.onSuccess?i.success(n.onSuccess(t)):i.success(d.getString('"{{description | translate}}" completed.',t)):a.status===c.status.FAILED&&(a.failureReason?n.onFailureWithReason?i.danger(n.onFailureWithReason(a)):i.danger(d.getString('"{{description | translate}}" failed due to: "{{failureReason | translate}}".',a)):n.onFailure?i.danger(n.onFailure(t)):i.danger(d.getString('"{{description | translate}}" failed.',t))),e.abrupt("return",a);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function F(e,t,n){var r=t.meta.type;r===f?_.set(e,["c8y_CoilStatus",t.name],n.value):r===m&&_.set(e,["c8y_RegisterStatus",t.name],n.value)}}}angular.module("c8y.modbus").provider(a,e)}();