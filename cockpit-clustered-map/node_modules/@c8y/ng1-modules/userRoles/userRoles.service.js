"use strict";!function(){function e(u,s,e){return{getAssetTree:function(){return e.listAll({fragmentType:"c8y_IsDeviceGroup",withParents:!0,pageSize:1e4}).then(n)},flatTree:function t(e,n,r){var o=n||0;var u=r||[];if(15<o)throw new Error("Exceeded maximum level of nesting");return _.reduce(e,function(e,n){var r=_.clone(n);return r._depth=o,e.push(r),t(n._subGroups,o+1,e)},u)},copyUserRoles:function(e,a,i,n){var r,t=u.when();r=n?(t=u.all(_.map(a,function(e){return s.removeInventoryRoles(i,e.id)})),function(){return u.all(_.map(e,function(e){var n=_.map(e.roles,function(e){return{id:e.id}});return s.assignInventoryRoles(i,e.managedObject,n)}))}):function(){return u.all(_.map(e,function(e){var n=e.managedObject,r=_.find(a,{managedObject:n}),t=_.get(r,"roles"),o=_.get(r,"id"),u=_(_.union(e.roles,t)).uniqBy("id").map(function(e){return{id:e.id}}).value();return o?s.updateInventoryRoles(i,o,u):s.assignInventoryRoles(i,n,u)}))};return t.then(r)},onSaveInventoryRoles:function(n,r){var e=_.filter(r,"isModified").map(function(e){return function(e,n,r){var t,o=(r[n.managedObject]||{}).id;o?t=n.roles.length?s.updateInventoryRoles(e,o,n.roles):s.removeInventoryRoles(e,o):n.roles.length&&(t=s.assignInventoryRoles(e,n.managedObject,n.roles));return t||u.when()}(n,e,r)});return u.all(e)}};function n(e){var n=_.filter(e,{type:"c8y_DeviceSubgroup"}),r=_.union(_.filter(e,{type:"c8y_DeviceGroup"}),function(r,e){var t=[];return _.forEach(e,function(n){var e=_.get(n,"assetParents.references");_.forEach(e,function(e){_.some(r,{id:_.get(e,"managedObject.id")})&&t.push(n)})}),_.differenceWith(e,t,_.isEqual)}(e,n));return _(r).sortBy("name").map(_.partial(a,e)).value()}function a(t,o){var e=_(o.childAssets.references).map("managedObject").map("id").value();if(!o._subGroups){var n=_.reduce(e,function(e,n){var r=_.find(t,{id:n});return function(e,n){e._parentGroups=e._parentGroups||[],n&&(n._parentGroups=n._parentGroups||[],n._parentGroups=n._parentGroups.concat(e._parentGroups).concat(e))}(o,r),r&&e.push(a(t,r)),e},[]);o._subGroups=_.sortBy(n,"name")}return o}}e.$inject=["$q","c8yUser","c8yInventory"],angular.module("c8y.userRoles").factory("c8yUserInventoryRoles",e)}();