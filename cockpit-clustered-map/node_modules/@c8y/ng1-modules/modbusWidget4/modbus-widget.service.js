"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function asyncGeneratorStep(e,t,n,r,a,i,o){try{var u=e[i](o),c=u.value}catch(e){return void n(e)}u.done?t(c):Promise.resolve(c).then(r,a)}function _asyncToGenerator(u){return function(){var e=this,o=arguments;return new Promise(function(t,n){var r=u.apply(e,o);function a(e){asyncGeneratorStep(r,t,n,a,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,a,i,"throw",e)}a(void 0)})}}!function(){function e(p,e,t,y,g,u){var a=e.MODBUS_DEVICE_FRAGMENT,i=e.PROFIBUS_DEVICE_FRAGMENT;return{getConfigModel:function(e){return n.apply(this,arguments)},updateConfigModel:function(e,t){_.set(e,"categoriesConfig",_.map(t,function(e){return{name:e.name,label:e.label,elements:_.compact(_.map(e.elements,function(e){return e.show?_.pick(e,["refId","label","type"]):void 0}))}})),_.unset(e,"coils"),_.unset(e,"registers")},getWidgetModel:function(e){return d.apply(this,arguments)},isAtLeastOneElementSelected:function(e){return _.some(e,function(e){return _.some(e.elements,"show")})},isDiscreteIOSelectedInConfig:window.c8y_testing&&m,isRegisterSelectedInConfig:window.c8y_testing&&f};function n(){return(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=_.get(t,"device"))return e.next=4,T(n);e.next=6;break;case 4:return r=e.sent,e.abrupt("return",o({fieldbusDevice:r,widgetConfig:t}));case 6:return e.abrupt("return",p.resolve([]));case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(e){return r.apply(this,arguments)}function r(){return(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.fieldbusDevice,r=t.widgetConfig,e.next=3,C(n);case 3:if(a=e.sent,i=h({fieldbusDevice:n,deviceType:a}),_.isEmpty(i))return e.abrupt("return",[]);e.next=7;break;case 7:return o=_.groupBy(i,E),e.abrupt("return",_(r).chain().get("categoriesConfig",[]).map(function(e){var t=_.get(o,e.name);_.defaults(e,{label:e.name||u("Uncategorized")});var n=_.flow([c,s])({categoryConfigElements:e.elements,deviceType:a,elements:i,categoryElements:t,widgetConfig:r}).categoryConfigElements;return e.elements=n,e}).thru(function(e){return I({categoriesConfig:e,categories:o,deviceType:a,widgetConfig:r})}).value());case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function c(e){var t=e.categoryConfigElements,a=e.deviceType,i=e.elements,n=e.categoryElements,r=e.widgetConfig;return{categoryConfigElements:_.map(t,function(e){var t=e.refId,n=e.type,r=g.findElementBestMatchingRefId(i,t,n);if(r)return _.defaults(e,{name:r.name,type:r.meta.type.value,typeLabel:g.getElementTypeLabel(r,a),show:!0,label:r.name})}),deviceType:a,elements:i,categoryElements:n,widgetConfig:r}}function s(e){var t=e.categoryConfigElements,n=e.deviceType,r=e.elements,a=e.categoryElements,i=e.widgetConfig;return{categoryConfigElements:[].concat(_toConsumableArray(t),_toConsumableArray(_(a).filter(function(e){return!_.find(t,{refId:g.getElementRefId(e)})}).map(function(e){return{refId:g.getElementRefId(e),label:e.name,show:l(e,i),name:e.name,type:e.meta.type.value,typeLabel:g.getElementTypeLabel(e,n)}}).value())),deviceType:n,elements:r,categoryElements:a,widgetConfig:i}}function l(e,t){return function(e){return e.meta.type===g.ElementType.REGISTER}(e)?f(e,t):m(e,t)}function f(e,t){var n=e.id,r=e.input,a=e.number,i=e.startBit,o=t.registers;return _.includes(o,n)||_.includes(o,[r,a,i].join(","))||_.includes(o,a)||!!_.find(o,{number:a,startBit:i})}function m(e,t){var n=e.id,r=e.input,a=e.number,i=t.coils;return _.includes(i,n)||_.includes(i,[r,a].join(","))||_.includes(i,a)}function d(){return(d=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i,o,u,c,s,l,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=_.get(t,"device.id"),r=y.detailRealtime(n),a=r.then(C),i=b(n,t).then(function(e){return _.get(t,"categoriesConfig",e)}),e.next=6,p.all({fieldbusDevice:r,deviceType:a,categoriesConfig:i});case 6:return o=e.sent,u=o.fieldbusDevice,c=o.deviceType,s=o.categoriesConfig,l=h({fieldbusDevice:u,deviceType:c}),f=_.map(s,function(e){return _.defaults(_objectSpread({},e,{elements:_(e.elements).map(function(e){var t=g.findElementBestMatchingRefId(l,e.refId,e.type);return t?_.defaults(_objectSpread({},e,t),{label:t.name,show:!0}):e}).filter("show").value()}),{label:e.name})}),e.abrupt("return",{device:u,categories:f});case 13:case"end":return e.stop()}},e)}))).apply(this,arguments)}function b(e,t){return v.apply(this,arguments)}function v(){return(v=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,T(t);case 2:return r=e.sent,e.next=5,C(r);case 5:return a=e.sent,i=h({fieldbusDevice:r,deviceType:a}),o=_.groupBy(i,E),e.abrupt("return",I({categoriesConfig:[],categories:o,deviceType:a,widgetConfig:n}));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function h(e){var t=e.fieldbusDevice,n=e.deviceType,r=g.getElementsWithMeta(n);return _.has(t,a)||_.has(t,i)?r:_.filter(r,w)}function w(e){return e.meta.type===g.ElementType.REGISTER&&!e.input}function T(e){return g.isFieldbusDevice(e)?p.resolve(e):y.detail(t.getId(e)).then(t.getResData)}function C(e){return g.getDeviceTypeFromDevice(e)}function E(e){return _.get(e,"category","")}function I(e){var n=e.categoriesConfig,t=e.categories,r=e.deviceType,a=e.widgetConfig;return[].concat(_toConsumableArray(n),_toConsumableArray(_(t).pickBy(function(e,t){return!_.find(n,{name:t})}).map(function(e,t){return{name:t,label:t||u("Uncategorized"),elements:_.map(e,function(e){return{refId:g.getElementRefId(e),label:e.name,show:l(e,a),name:e.name,type:e.meta.type.value,typeLabel:g.getElementTypeLabel(e,r)}})}}).value()))}}e.$inject=["$q","fieldbusConstants","c8yBase","c8yDevices","c8yDeviceDatabase","gettext"],angular.module("c8y.modbusWidget4").factory("modbusWidgetSvc",e)}();