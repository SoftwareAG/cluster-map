"use strict";!function(){function n(r,n,e,t,o,i,a,c,l,u,s,d,f,g){var p,m,b,y,v=g("humanizeAppName"),h=this,N={html_title:C,favicon:function(n){h.favicon=n?n.fileSrc:"",p&&p.document.querySelector("link[rel=icon]")&&(p.document.querySelector("link[rel=icon]").href=n?n.fileSrc:"")},"navigator-font-family":function(n){A("navigator-font-family",a.getFontFamilyCssVar(n))},appLogo:function(n){return A("navigator-platform-logo",n?"url(".concat(n.fileSrc,")"):"")},"brand-logo-img":function(n){return A("brand-logo-img",n?"url(".concat(n.fileSrc,")"):"")},"__import-font":function(n){var t=document.createElement("style");t.innerText="@import url('".concat(n,"')"),w().contentDocument.head.appendChild(t),p&&p.document.head.appendChild(t)}},I=!!window.MSInputMethodContext&&!!document.documentMode;function w(){return document.querySelector("#previewBrowser")}function C(n){var t=n||_.get(h,"branding.c8y_less_variables.html_title")||s.appOption("globalTitle");h.title="".concat(t," - ").concat(w().appTitle),p&&(p.document.title="".concat(t," - ").concat(p.appTitle))}function B(){h.isLoading||_.forOwn(h.branding.c8y_less_variables,function(n,t){N[t]?N[t](n):A(t,n)})}function A(n,t){S(n,t,w().contentDocument.documentElement),p&&S(n,t,p.document.documentElement)}function S(n,t,e){var i=a.keyToCssVar(n);e.style.setProperty("--".concat(i),_.isNumber(t)?"".concat(t,"px"):t)}function R(){return i.state().then(T)}function T(n){var t=h.state;h.state=n,t&&t.RUNNING&&!n.RUNNING&&l.success(u("Branded applications creation process completed.")),t&&t.WAITING&&n.RUNNING&&l.success(u("Branded applications creation process started.")),(n.RUNNING||n.WAITING)&&e(R,2e3)}_.assign(h,{$onInit:function(){c&&R();return h.isLoading=!0,n.all({schema:o.getSchema(),form:o.getForm(),options:o.getSchemaFormOptions(),branding:o.getBranding(),app:d.getCurrent()}).then(function(n){var t=n.schema,e=n.form,i=n.options,o=n.branding,a=n.app;_.defaults(o,{c8y_less_variables:{}}),b=_.cloneDeep(o),_.assign(h,{schema:t,form:e,options:i,branding:o}),y=a,w().src=d.getHref(y),w().onload=function(){w().appTitle=w().contentDocument.title,C(),B()},r.$watchCollection("vm.branding.c8y_less_variables",B)}).finally(function(){h.isLoading=!1})},canSave:function(){return!(_.get(r,"platformConfigurationForm1.$invalid")||_.get(r,"platformConfigurationForm2.$invalid"))},save:function(){var e=[],i=o.BINARY_VARS;return h.branding.binary_ref={},_.each(i,function(t){if(h.branding.c8y_less_variables[t]){var n=o.saveBinary(t,h.branding.c8y_less_variables[t],b.binary_ref,b.c8y_less_variables[t]).then(function(n){h.branding.binary_ref[t]=_.pick(n,["id","name"])});e.push(n)}}),n.all(e).then(function(){return h.branding.c8y_less_variables=_.omitBy(h.branding.c8y_less_variables,function(n,t){return""===_.trim(n)||_.includes(i,t)}),o.saveConfiguration(h.branding,b.id).then(_.partial(_.unary(l.success),u("Branding saved.")))}).then(t.reload)},generate:i.wizardGenerate,preview:function(){p=window.open(d.getHref(y),"_blank"),function t(){clearInterval(m);m=setInterval(function(){if(p.C8Y_APP){var n=p.C8Y_APP.name;p.appTitle=v(n),clearInterval(m),B(),p.onunload=function(){return t()}}},50)}()},blocked:function(){var n=h.state;return!_.get(h,"branding.id")||_.get(n,"RUNNING")||_.get(n,"WAITING")},title:window.document.title,favicon:"favicon.ico",useMicroservice:c,applyConfiguration:function(){a.removeLegacyBrandedApplications().then(function(){return f({status:"info",title:u("Apply branding configuration"),body:u("You are about to apply the branding configuration, making it visible to all subtenants. Do you want to proceed?"),labels:{ok:u("Apply")}})}).then(function(){a.deploy(h.branding.c8y_less_variables).then(function(){return l.success(u("Branding configuration applied."))},function(n){return l.danger(n)})})},showPreview:!I,resetConfiguration:function(){f({status:"info",title:u("Reset branding configuration"),body:u("You are about to reset the applied branding configuration.\n        If you have any extra customization options set, they will be reset as well.\n        The default branding will be shown to all subtenants. Do you want to proceed?"),labels:{ok:u("Reset")}}).then(function(){a.reset().then(function(){return l.success(u("Branding configuration has been reset."))},function(n){return l.danger(n)})})}})}n.$inject=["$scope","$q","$timeout","$route","c8yBrandingConfigurationUi","c8yBrandingConfiguration","c8yBrandingDeploy","USE_BRANDING_MICROSERVICE","c8yAlert","gettext","c8yBase","c8yApplication","c8yModal","$filter"],angular.module("c8y.custom-branding").component("c8yBrandingConfigurationForm",{templateUrl:":::PLUGIN_PATH:::/customBranding/brandingConfigurationForm.html",controller:n,controllerAs:"vm"})}();