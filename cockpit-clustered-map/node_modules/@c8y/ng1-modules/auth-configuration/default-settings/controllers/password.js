"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},o=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){function e(u,i,n,e,t,o,r,a,c,l,s,f){var p,g="password",y="limit.validity",d="strength.validity",h="enforce.strength",v=c.loginOptions.BASIC.value.toUpperCase(),O=c.loginOptions.OAUTH2_INTERNAL.value.toUpperCase(),m=c.loginOptions.OAUTH2.value.toUpperCase(),T="SSO_REDIRECT",b={userManagementSource:"INTERNAL",grantType:"PASSWORD",providerName:"Cumulocity",visibleOnLoginPage:!0,type:v},L=!1;function M(){return c.list({silentError:!0}).then(n.getResData).then(S).catch(S)}function S(e){var n=e.loginOptions;p=void 0===n?[]:n;var t,o=N(),i=p.find(function(e){var n=e.type,t=e.grantType;return n===m&&"AUTHORIZATION_CODE"===t}),r=w();t=!i||o||r?o?o.type:r?r.type:b.type:T,u.loginModeType=t,u.enforceLoginMode=!(!o||r),u.noOAuth=!i,C()}function A(){var e=[];if(u.loginModeChanged){var n=u.loginModeType,t=!!w(),o=!!N();n===O?(u.enforceLoginMode||t?u.enforceLoginMode&&t&&e.push(R):e.push(function(){return E(v)}),o||e.push(function(){return E(O)})):n===v?(t||e.push(function(){return E(v)}),o&&e.push(I)):n===T&&(t&&e.push(R),o&&e.push(I)),e.push(C)}return e.reduce(function(e,n){return e.then(n)},i.resolve())}function C(){u.savedloginModeType=u.loginModeType}function w(){return p.find(function(e){return e.type===v})}function N(){return p.find(function(e){return e.type===O})}function E(e){return c.save(_objectSpread({},b,{type:e}))}function I(){var e=N();return e?c.remove(e):i.when()}function R(){var e=w();return e?c.remove(e):i.when()}function P(e){var n=e.key.replace(/\./g,"_"),t=JSON.parse(e.value);u[n]=e,u[n].value=t}function j(e){return t.detail({category:g,key:e}).then(n.getResData).catch(function(){return null})}function D(e){return t.getSystemOption({category:g,key:e}).then(n.getResData).catch(function(){return null})}function U(e){L||j(y).then(P),j(d).then(P),D(h).then(H),o.success(a("Login settings saved.")),e.$setPristine(),M()}function k(e){u.limit_validity.value=parseInt(e,10)}function H(e){P(_.assign({},e,{key:"system.".concat(e.key)}))}e.changeTitle({title:a("Authentication")}),i.all({systemLimitKeyOption:D("limit.validity"),tenantLimitKeyOption:j(y)}).then(function(e){var n=e.systemLimitKeyOption,t=e.tenantLimitKeyOption;if(null!==t&&P(t),null!==n){var o;H(n);try{o=JSON.parse(n.value)}catch(e){}_.isUndefined(o)||0===o||(L=!0,u.validityLimitEnforced=L,u.limit_validity={value:o})}}),D(h).then(H),j(d).then(P),M(),u.loginModeChanged=!1,u.onLoginModeChange=function(){u.loginModeChanged=!0,"OAUTH2_INTERNAL"!==u.loginModeType&&(u.enforceLoginMode=!1)},u.update=function(e){return r.isCurrentUserTopTenant().then(function(e){return e&&u.enforceLoginMode?l({title:a("Enforce OAuth Internal"),body:a("You are about to enforce OAuth Internal as login mode for the management tenant. This can prevent users from accessing the tenant who don't use a HTTPS connection (but use, for example, SSH tunnelling). Do you want to proceed?"),labels:{ok:a("Confirm")},status:"danger"}):i.resolve()}).then(C).then(function(){return i.all([L?i.when():t.updateOption(u.limit_validity),t.updateOption(u.strength_validity)])}).then(A).then(function(){return u.loginModeChanged?l({title:a("Logout required"),body:a("You must log out in order to apply your changes"),status:"warning",labels:{ok:a("Log out"),cancel:null}}).then(s.logout).then(function(e){e&&e.url?f.location.href=e.url:f.location.reload()}).catch(function(){return U(e)}):U(e)}).catch(function(e){o.danger(n.getResErrorMessage(e))})},u.validateDays=function(e){var n=e;_.isNaN(_.toNumber(n))||parseInt(n,10)<0?k(n=n.slice(0,-1)):k(n);n.length||k(0)},u.validityLimitEnforced=L}e.$inject=["$scope","$q","c8yBase","c8yTitle","c8ySettings","c8yAlert","c8yTenant","gettext","c8yLoginOptions","c8yModal","c8yAuth","$window"],angular.module("c8y.authenticationConfiguration").controller("passwordCtrl",e)}();