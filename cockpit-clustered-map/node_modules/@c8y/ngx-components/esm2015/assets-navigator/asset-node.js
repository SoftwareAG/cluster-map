import * as tslib_1 from "tslib";
import { gettext, NavigatorNode, DeviceStatusComponent } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { Subject } from 'rxjs';
import { LoadMoreNode } from './load-more-node';
import { GroupFragment } from './group-fragment.model';
var Action;
(function (Action) {
    Action[Action["FETCH"] = 0] = "FETCH";
    Action[Action["NEXT"] = 1] = "NEXT";
    Action[Action["REFRESH"] = 2] = "REFRESH";
})(Action || (Action = {}));
export class AssetNode extends NavigatorNode {
    constructor(service, config = {}) {
        super(config);
        this.service = service;
        this.root = this.root || false;
        this.mo = this.mo || {};
        this.path = this.root ? 'group' : (this.isDevice ? `device/${this.mo.id}` : `group/${this.mo.id}`);
        this.draggable = !this.service.moduleConfig.disableDragAndDrop && !this.root;
        this.droppable = !this.service.moduleConfig.disableDragAndDrop && !this.isDevice;
        this.routerLinkExact = this.root;
        this.updateIcon(false);
        this.onUpdateSubscription = this.service
            .onUpdate(this)
            .subscribe(({ data, method }) => this.refresh(data, method));
    }
    get label() {
        return (this.root && gettext('Groups')) || this.mo.name || '--';
    }
    get hasChildren() {
        return this.root || this.service.groups.isGroup(this.mo);
    }
    get iconComponent() {
        return this.isDevice ? DeviceStatusComponent : undefined;
    }
    get isDevice() {
        return !!(this.mo.c8y_IsDevice || get(this.mo, 'deviceParents.references.length'));
    }
    openOnStart(url) {
        const urlRegex = /^\/group\//;
        if (this.root) {
            if (this.service.moduleConfig.openOnStart || urlRegex.test(url)) {
                return true;
            }
        }
        const matches = url.match(/\/(group)\/(\d+)/);
        let isMatch = false;
        if (matches) {
            const id = matches[2];
            isMatch = [].concat(get(this.mo, 'childAssets.references', [])).some(({ managedObject }) => managedObject.id === id);
            return isMatch;
        }
        return false;
    }
    refresh(mo = {}, method = 'GET') {
        if (mo.id === this.mo.id) {
            this.mo = mo;
        }
        else if (method === 'DELETE') {
            this.parents.forEach((node) => node.refresh());
            return;
        }
        if (this.events) {
            this.events.next(Action.REFRESH);
        }
    }
    click(options = {}) {
        if (this.isDevice) {
            this.service.preferBreadcrumb(this.parents);
            return;
        }
        if (!this.events) {
            this.hookEvents();
        }
        this.updateIcon(options.open);
        if (options.open) {
            this.events.next(Action.FETCH);
        }
    }
    addManagedObject(mo) {
        const { childAdditions } = this.mo;
        if (!this.isChildAddition(childAdditions, mo)) {
            this.add(this.service.createChildNode(mo));
        }
    }
    isChildAddition(childAdditions, mo) {
        return (childAdditions &&
            childAdditions.references.some(({ managedObject: { id } }) => id === mo.id));
    }
    destroy() {
        this.onUpdateSubscription.unsubscribe();
    }
    get canDrop() {
        const nodeToMove = this.service.draggedData;
        if (nodeToMove) {
            const shouldGetChildOfItsOwn = !!nodeToMove.find((child) => child === this);
            const isAlreadyChild = this.children
                .some((child) => child.mo && child.mo.id === nodeToMove.mo.id);
            const preventMove = this === nodeToMove || shouldGetChildOfItsOwn || isAlreadyChild;
            return this.droppable && !preventMove;
        }
        return this.droppable;
    }
    dragStart($event) {
        super.dragStart($event);
        this.service.draggedData = this;
        this.service.rootNode.droppable = !this.isDevice;
    }
    dragEnd($event) {
        super.dragEnd($event);
    }
    drop($event) {
        const _super = Object.create(null, {
            drop: { get: () => super.drop }
        });
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            _super.drop.call(this, $event);
            const nodeToMove = this.service.draggedData;
            if (this.canDrop) {
                yield this.moveNode(nodeToMove);
            }
            else {
                this.draggedHover = false;
                this.service.draggedData = undefined;
            }
        });
    }
    fetch() {
        return this.root ? this.service.getRootNodes() : this.service.getGroupItems(this.mo.id);
    }
    moveNode(nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const isCopy = yield this.showDropConfirm(nodeToMove);
                yield this.verifyNodeAccess(nodeToMove);
                yield this.addMovedNode(nodeToMove);
                if (!isCopy) {
                    yield this.removeMovedNode(nodeToMove);
                }
                this.expand();
            }
            catch (ex) {
                if (ex) {
                    this.service.alert.addServerFailure(ex);
                }
            }
            finally {
                this.draggedHover = false;
                this.service.draggedData = undefined;
            }
        });
    }
    showDropConfirm(nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.confirm.title = gettext('Move');
            this.confirm.message = gettext('Do you want to move the group?');
            const buttons = [{
                    label: gettext('Cancel'),
                    action: () => Promise.reject()
                }, {
                    label: gettext('Move'),
                    status: 'default',
                    action: () => Promise.resolve(false)
                }];
            if (nodeToMove.isDevice) {
                this.confirm.title = gettext('Move or add');
                this.confirm.message = gettext('Do you want to move or add the device?');
                buttons.push({
                    label: gettext('Add'),
                    status: 'primary',
                    action: () => Promise.resolve(true)
                });
            }
            return this.confirm.show(buttons);
        });
    }
    verifyNodeAccess(nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.service.inventory.update({ id: nodeToMove.mo.id });
        });
    }
    addMovedNode(nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let mo;
            if (this.root) {
                const { data } = yield this.service.inventory.update({ id: nodeToMove.mo.id, type: GroupFragment.groupType });
                mo = data;
            }
            else {
                const { data } = yield this.service.inventory.childAssetsAdd(nodeToMove.mo, this.mo);
                mo = data;
            }
            this.addManagedObject(mo);
        });
    }
    removeMovedNode(nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            for (const parent of nodeToMove.parents) {
                if (parent.mo && parent.mo.type === GroupFragment.dynamicGroupType) {
                    break; // smart groups don't need to be changed
                }
                if (parent.root) {
                    yield this.service.inventory.update({ id: nodeToMove.mo.id, type: GroupFragment.subGroupType });
                }
                else {
                    yield this.service.inventory.childAssetsRemove(nodeToMove.mo, parent.mo);
                }
                parent.remove(nodeToMove);
            }
        });
    }
    hookEvents() {
        this.events = new Subject();
        this.events.subscribe((evt) => {
            if (!this.loading) {
                this.handleEvent(evt);
            }
        });
    }
    handleEvent(evt) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (!this.children.length && evt === Action.FETCH) {
                this.loading = true;
                this.addNodes(yield this.fetch());
                this.loading = false;
            }
            else if (evt === Action.NEXT) {
                this.loadMoreNode.loading = true;
                this.addNodes(yield this.paging.next());
                this.loadMoreNode.loading = false;
            }
            else if (evt === Action.REFRESH) {
                this.loading = false;
                this.paging = undefined;
                this.loadMoreNode = undefined;
                this.empty();
                this.events.next(Action.FETCH);
            }
        });
    }
    addNodes(res) {
        if (res.paging) {
            const { pageSize, currentPage, totalPages } = this.paging = res.paging;
            if (currentPage === 1) {
                this.empty();
            }
            const itemsCount = res.data.length;
            const moreItemsAvailable = totalPages ? (currentPage < totalPages) : (itemsCount === pageSize);
            this.toggleLoadMore(moreItemsAvailable);
        }
        (res.data || res).map((mo) => this.addManagedObject(mo));
    }
    updateIcon(open) {
        this.icon = this.service.groups.icon(
        // if it's root we are going to pass a fake mo to get the same icon as groups
        this.root ? { type: GroupFragment.groupType } : this.mo, open);
    }
    toggleLoadMore(show) {
        if (!this.loadMoreNode && show) {
            this.loadMoreNode = new LoadMoreNode();
            this.add(this.loadMoreNode);
            this.loadMoreNode.click = () => this.events.next(Action.NEXT);
        }
        if (this.loadMoreNode) {
            this.loadMoreNode.hidden = !show;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtbm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvYXNzZXRzLW5hdmlnYXRvci8iLCJzb3VyY2VzIjpbImFzc2V0LW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBZ0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFFLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFFN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV2RCxJQUFLLE1BSUo7QUFKRCxXQUFLLE1BQU07SUFDVCxxQ0FBSyxDQUFBO0lBQ0wsbUNBQUksQ0FBQTtJQUNKLHlDQUFPLENBQUE7QUFDVCxDQUFDLEVBSkksTUFBTSxLQUFOLE1BQU0sUUFJVjtBQUVELE1BQU0sT0FBTyxTQUFVLFNBQVEsYUFBYTtJQXlCMUMsWUFDWSxPQUF5QixFQUNuQyxNQUFNLEdBQUcsRUFBRTtRQUVYLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUhKLFlBQU8sR0FBUCxPQUFPLENBQWtCO1FBSW5DLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxLQUFLLENBQUM7UUFDL0IsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsSUFB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SUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSTtRQUNsQyw2RUFBNkU7UUFDN0UsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUN2RCxJQUFJLENBQ0wsQ0FBQztJQUNKLENBQUM7SUFFTyxjQUFjLENBQUMsSUFBYTtRQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMvRDtRQUVELElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQztTQUNsQztJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhZ2luZyB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IENsaWNrT3B0aW9ucywgZ2V0dGV4dCwgTmF2aWdhdG9yTm9kZSwgRGV2aWNlU3RhdHVzQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBc3NldE5vZGVNbywgQXNzZXROb2RlU2VydmljZSB9IGZyb20gJy4vYXNzZXQtbm9kZS5zZXJ2aWNlJztcbmltcG9ydCB7IExvYWRNb3JlTm9kZSB9IGZyb20gJy4vbG9hZC1tb3JlLW5vZGUnO1xuaW1wb3J0IHsgR3JvdXBGcmFnbWVudCB9IGZyb20gJy4vZ3JvdXAtZnJhZ21lbnQubW9kZWwnO1xuXG5lbnVtIEFjdGlvbiB7XG4gIEZFVENILFxuICBORVhULFxuICBSRUZSRVNIXG59XG5cbmV4cG9ydCBjbGFzcyBBc3NldE5vZGUgZXh0ZW5kcyBOYXZpZ2F0b3JOb2RlIHtcbiAgcm9vdDogYm9vbGVhbjtcbiAgbW86IGFueTtcblxuICBnZXQgbGFiZWwoKSB7XG4gICAgcmV0dXJuICh0aGlzLnJvb3QgJiYgZ2V0dGV4dCgnR3JvdXBzJykpIHx8IHRoaXMubW8ubmFtZSB8fCAnLS0nO1xuICB9XG5cbiAgZ2V0IGhhc0NoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLnJvb3QgfHwgdGhpcy5zZXJ2aWNlLmdyb3Vwcy5pc0dyb3VwKHRoaXMubW8pO1xuICB9XG5cbiAgZ2V0IGljb25Db21wb25lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNEZXZpY2UgPyBEZXZpY2VTdGF0dXNDb21wb25lbnQgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBnZXQgaXNEZXZpY2UoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMubW8uYzh5X0lzRGV2aWNlIHx8IGdldCh0aGlzLm1vLCAnZGV2aWNlUGFyZW50cy5yZWZlcmVuY2VzLmxlbmd0aCcpKTtcbiAgfVxuXG4gIHByaXZhdGUgZXZlbnRzOiBTdWJqZWN0PEFjdGlvbj47XG4gIHByaXZhdGUgcGFnaW5nOiBQYWdpbmc8QXNzZXROb2RlTW8+O1xuICBwcml2YXRlIGxvYWRNb3JlTm9kZTogTG9hZE1vcmVOb2RlO1xuICBwcml2YXRlIG9uVXBkYXRlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHNlcnZpY2U6IEFzc2V0Tm9kZVNlcnZpY2UsXG4gICAgY29uZmlnID0ge31cbiAgKSB7XG4gICAgc3VwZXIoY29uZmlnKTtcbiAgICB0aGlzLnJvb3QgPSB0aGlzLnJvb3QgfHwgZmFsc2U7XG4gICAgdGhpcy5tbyA9IHRoaXMubW8gfHwge307XG4gICAgdGhpcy5wYXRoID0gdGhpcy5yb290ID8gJ2dyb3VwJyA6ICh0aGlzLmlzRGV2aWNlID8gYGRldmljZS8ke3RoaXMubW8uaWR9YCA6IGBncm91cC8ke3RoaXMubW8uaWR9YCk7XG4gICAgdGhpcy5kcmFnZ2FibGUgPSAhdGhpcy5zZXJ2aWNlLm1vZHVsZUNvbmZpZy5kaXNhYmxlRHJhZ0FuZERyb3AgJiYgIXRoaXMucm9vdDtcbiAgICB0aGlzLmRyb3BwYWJsZSA9ICF0aGlzLnNlcnZpY2UubW9kdWxlQ29uZmlnLmRpc2FibGVEcmFnQW5kRHJvcCAmJiAhdGhpcy5pc0RldmljZTtcbiAgICB0aGlzLnJvdXRlckxpbmtFeGFjdCA9IHRoaXMucm9vdDtcbiAgICB0aGlzLnVwZGF0ZUljb24oZmFsc2UpO1xuICAgIHRoaXMub25VcGRhdGVTdWJzY3JpcHRpb24gPSB0aGlzLnNlcnZpY2VcbiAgICAgIC5vblVwZGF0ZSh0aGlzKVxuICAgICAgLnN1YnNjcmliZSgoeyBkYXRhLCBtZXRob2QgfSkgPT4gdGhpcy5yZWZyZXNoKGRhdGEsIG1ldGhvZCkpO1xuICB9XG5cbiAgb3Blbk9uU3RhcnQodXJsKSB7XG4gICAgY29uc3QgdXJsUmVnZXggPSAvXlxcL2dyb3VwXFwvLztcbiAgICBpZiAodGhpcy5yb290KSB7XG4gICAgICBpZiAodGhpcy5zZXJ2aWNlLm1vZHVsZUNvbmZpZy5vcGVuT25TdGFydCB8fCB1cmxSZWdleC50ZXN0KHVybCkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IG1hdGNoZXMgPSB1cmwubWF0Y2goL1xcLyhncm91cClcXC8oXFxkKykvKTtcbiAgICBsZXQgaXNNYXRjaCA9IGZhbHNlO1xuICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICBjb25zdCBpZCA9IG1hdGNoZXNbMl07XG4gICAgICBpc01hdGNoID0gW10uY29uY2F0KFxuICAgICAgICBnZXQodGhpcy5tbywgJ2NoaWxkQXNzZXRzLnJlZmVyZW5jZXMnLCBbXSksXG4gICAgICApLnNvbWUoKHsgbWFuYWdlZE9iamVjdCB9KSA9PiBtYW5hZ2VkT2JqZWN0LmlkID09PSBpZCk7XG4gICAgICByZXR1cm4gaXNNYXRjaDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmVmcmVzaChtbzogYW55ID0ge30sIG1ldGhvZCA9ICdHRVQnKSB7XG4gICAgaWYgKG1vLmlkID09PSB0aGlzLm1vLmlkKSB7XG4gICAgICB0aGlzLm1vID0gbW87XG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdERUxFVEUnKSB7XG4gICAgICB0aGlzLnBhcmVudHMuZm9yRWFjaCgobm9kZTogQXNzZXROb2RlKSA9PiBub2RlLnJlZnJlc2goKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLmV2ZW50cykge1xuICAgICAgdGhpcy5ldmVudHMubmV4dChBY3Rpb24uUkVGUkVTSCk7XG4gICAgfVxuICB9XG5cbiAgY2xpY2sob3B0aW9uczogQ2xpY2tPcHRpb25zID0ge30pIHtcbiAgICBpZiAodGhpcy5pc0RldmljZSkge1xuICAgICAgdGhpcy5zZXJ2aWNlLnByZWZlckJyZWFkY3J1bWIodGhpcy5wYXJlbnRzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmV2ZW50cykge1xuICAgICAgdGhpcy5ob29rRXZlbnRzKCk7XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGVJY29uKG9wdGlvbnMub3Blbik7XG4gICAgaWYgKG9wdGlvbnMub3Blbikge1xuICAgICAgdGhpcy5ldmVudHMubmV4dChBY3Rpb24uRkVUQ0gpO1xuICAgIH1cbiAgfVxuXG4gIGFkZE1hbmFnZWRPYmplY3QobW8pIHtcbiAgICBjb25zdCB7IGNoaWxkQWRkaXRpb25zIH0gPSB0aGlzLm1vO1xuICAgIGlmICghdGhpcy5pc0NoaWxkQWRkaXRpb24oY2hpbGRBZGRpdGlvbnMsIG1vKSkge1xuICAgICAgdGhpcy5hZGQodGhpcy5zZXJ2aWNlLmNyZWF0ZUNoaWxkTm9kZShtbykpO1xuICAgIH1cbiAgfVxuXG4gIGlzQ2hpbGRBZGRpdGlvbihjaGlsZEFkZGl0aW9ucywgbW8pIHtcbiAgICByZXR1cm4gKFxuICAgICAgY2hpbGRBZGRpdGlvbnMgJiZcbiAgICAgIGNoaWxkQWRkaXRpb25zLnJlZmVyZW5jZXMuc29tZSgoeyBtYW5hZ2VkT2JqZWN0OiB7IGlkIH0gfSkgPT4gaWQgPT09IG1vLmlkKVxuICAgICk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMub25VcGRhdGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIGdldCBjYW5Ecm9wKCkge1xuICAgIGNvbnN0IG5vZGVUb01vdmUgPSB0aGlzLnNlcnZpY2UuZHJhZ2dlZERhdGE7XG4gICAgaWYgKG5vZGVUb01vdmUpIHtcbiAgICAgIGNvbnN0IHNob3VsZEdldENoaWxkT2ZJdHNPd24gPSAhIW5vZGVUb01vdmUuZmluZCgoY2hpbGQpID0+IGNoaWxkID09PSB0aGlzKTtcbiAgICAgIGNvbnN0IGlzQWxyZWFkeUNoaWxkID0gKHRoaXMuY2hpbGRyZW4gYXMgQXNzZXROb2RlW10pXG4gICAgICAgIC5zb21lKChjaGlsZCkgPT4gY2hpbGQubW8gJiYgY2hpbGQubW8uaWQgPT09IG5vZGVUb01vdmUubW8uaWQpO1xuICAgICAgY29uc3QgcHJldmVudE1vdmUgPSB0aGlzID09PSBub2RlVG9Nb3ZlIHx8IHNob3VsZEdldENoaWxkT2ZJdHNPd24gfHwgaXNBbHJlYWR5Q2hpbGQ7XG4gICAgICByZXR1cm4gdGhpcy5kcm9wcGFibGUgJiYgIXByZXZlbnRNb3ZlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5kcm9wcGFibGU7XG4gIH1cblxuICBkcmFnU3RhcnQoJGV2ZW50KSB7XG4gICAgc3VwZXIuZHJhZ1N0YXJ0KCRldmVudCk7XG4gICAgdGhpcy5zZXJ2aWNlLmRyYWdnZWREYXRhID0gdGhpcztcbiAgICB0aGlzLnNlcnZpY2Uucm9vdE5vZGUuZHJvcHBhYmxlID0gIXRoaXMuaXNEZXZpY2U7XG4gIH1cblxuICBkcmFnRW5kKCRldmVudCkge1xuICAgIHN1cGVyLmRyYWdFbmQoJGV2ZW50KTtcbiAgfVxuXG4gIGFzeW5jIGRyb3AoJGV2ZW50KSB7XG4gICAgc3VwZXIuZHJvcCgkZXZlbnQpO1xuICAgIGNvbnN0IG5vZGVUb01vdmUgPSB0aGlzLnNlcnZpY2UuZHJhZ2dlZERhdGE7XG4gICAgaWYgKHRoaXMuY2FuRHJvcCkge1xuICAgICAgYXdhaXQgdGhpcy5tb3ZlTm9kZShub2RlVG9Nb3ZlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kcmFnZ2VkSG92ZXIgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2VydmljZS5kcmFnZ2VkRGF0YSA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgZmV0Y2goKSB7XG4gICAgcmV0dXJuIHRoaXMucm9vdCA/IHRoaXMuc2VydmljZS5nZXRSb290Tm9kZXMoKSA6IHRoaXMuc2VydmljZS5nZXRHcm91cEl0ZW1zKHRoaXMubW8uaWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBtb3ZlTm9kZShub2RlVG9Nb3ZlOiBBc3NldE5vZGUpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaXNDb3B5ID0gYXdhaXQgdGhpcy5zaG93RHJvcENvbmZpcm0obm9kZVRvTW92ZSk7XG4gICAgICBhd2FpdCB0aGlzLnZlcmlmeU5vZGVBY2Nlc3Mobm9kZVRvTW92ZSk7XG4gICAgICBhd2FpdCB0aGlzLmFkZE1vdmVkTm9kZShub2RlVG9Nb3ZlKTtcbiAgICAgIGlmICghaXNDb3B5KSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVtb3ZlTW92ZWROb2RlKG5vZGVUb01vdmUpO1xuICAgICAgfVxuICAgICAgdGhpcy5leHBhbmQoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgaWYgKGV4KSB7XG4gICAgICAgIHRoaXMuc2VydmljZS5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5kcmFnZ2VkSG92ZXIgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2VydmljZS5kcmFnZ2VkRGF0YSA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3dEcm9wQ29uZmlybShub2RlVG9Nb3ZlOiBBc3NldE5vZGUpIHtcbiAgICB0aGlzLmNvbmZpcm0udGl0bGUgPSBnZXR0ZXh0KCdNb3ZlJyk7XG4gICAgdGhpcy5jb25maXJtLm1lc3NhZ2UgPSBnZXR0ZXh0KCdEbyB5b3Ugd2FudCB0byBtb3ZlIHRoZSBncm91cD8nKTtcbiAgICBjb25zdCBidXR0b25zOiBhbnkgPSBbe1xuICAgICAgbGFiZWw6IGdldHRleHQoJ0NhbmNlbCcpLFxuICAgICAgYWN0aW9uOiAoKSA9PiBQcm9taXNlLnJlamVjdCgpXG4gICAgfSwge1xuICAgICAgbGFiZWw6IGdldHRleHQoJ01vdmUnKSxcbiAgICAgIHN0YXR1czogJ2RlZmF1bHQnLFxuICAgICAgYWN0aW9uOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoZmFsc2UpXG4gICAgfV07XG4gICAgaWYgKG5vZGVUb01vdmUuaXNEZXZpY2UpIHtcbiAgICAgIHRoaXMuY29uZmlybS50aXRsZSA9IGdldHRleHQoJ01vdmUgb3IgYWRkJyk7XG4gICAgICB0aGlzLmNvbmZpcm0ubWVzc2FnZSA9IGdldHRleHQoJ0RvIHlvdSB3YW50IHRvIG1vdmUgb3IgYWRkIHRoZSBkZXZpY2U/Jyk7XG4gICAgICBidXR0b25zLnB1c2goe1xuICAgICAgICBsYWJlbDogZ2V0dGV4dCgnQWRkJyksXG4gICAgICAgIHN0YXR1czogJ3ByaW1hcnknLFxuICAgICAgICBhY3Rpb246ICgpID0+IFByb21pc2UucmVzb2x2ZSh0cnVlKVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNvbmZpcm0uc2hvdyhidXR0b25zKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdmVyaWZ5Tm9kZUFjY2Vzcyhub2RlVG9Nb3ZlOiBBc3NldE5vZGUpIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmludmVudG9yeS51cGRhdGUoeyBpZDogbm9kZVRvTW92ZS5tby5pZCB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYWRkTW92ZWROb2RlKG5vZGVUb01vdmU6IEFzc2V0Tm9kZSkge1xuICAgIGxldCBtbztcbiAgICBpZiAodGhpcy5yb290KSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuc2VydmljZS5pbnZlbnRvcnkudXBkYXRlKHsgaWQ6IG5vZGVUb01vdmUubW8uaWQsIHR5cGU6IEdyb3VwRnJhZ21lbnQuZ3JvdXBUeXBlIH0pO1xuICAgICAgbW8gPSBkYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuc2VydmljZS5pbnZlbnRvcnkuY2hpbGRBc3NldHNBZGQobm9kZVRvTW92ZS5tbywgdGhpcy5tbyk7XG4gICAgICBtbyA9IGRhdGE7XG4gICAgfVxuICAgIHRoaXMuYWRkTWFuYWdlZE9iamVjdChtbyk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlbW92ZU1vdmVkTm9kZShub2RlVG9Nb3ZlOiBBc3NldE5vZGUpIHtcbiAgICBmb3IgKGNvbnN0IHBhcmVudCBvZiBub2RlVG9Nb3ZlLnBhcmVudHMgYXMgQXNzZXROb2RlW10pIHtcbiAgICAgIGlmIChwYXJlbnQubW8gJiYgcGFyZW50Lm1vLnR5cGUgPT09IEdyb3VwRnJhZ21lbnQuZHluYW1pY0dyb3VwVHlwZSkge1xuICAgICAgICBicmVhazsgLy8gc21hcnQgZ3JvdXBzIGRvbid0IG5lZWQgdG8gYmUgY2hhbmdlZFxuICAgICAgfVxuICAgICAgaWYgKHBhcmVudC5yb290KSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2VydmljZS5pbnZlbnRvcnkudXBkYXRlKHsgaWQ6IG5vZGVUb01vdmUubW8uaWQsIHR5cGU6IEdyb3VwRnJhZ21lbnQuc3ViR3JvdXBUeXBlIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zZXJ2aWNlLmludmVudG9yeS5jaGlsZEFzc2V0c1JlbW92ZShub2RlVG9Nb3ZlLm1vLCBwYXJlbnQubW8pO1xuICAgICAgfVxuICAgICAgcGFyZW50LnJlbW92ZShub2RlVG9Nb3ZlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhvb2tFdmVudHMoKSB7XG4gICAgdGhpcy5ldmVudHMgPSBuZXcgU3ViamVjdCgpO1xuICAgIHRoaXMuZXZlbnRzLnN1YnNjcmliZSgoZXZ0KSA9PiB7XG4gICAgICBpZiAoIXRoaXMubG9hZGluZykge1xuICAgICAgICB0aGlzLmhhbmRsZUV2ZW50KGV2dCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGhhbmRsZUV2ZW50KGV2dDogQWN0aW9uKSB7XG4gICAgaWYgKCF0aGlzLmNoaWxkcmVuLmxlbmd0aCAmJiBldnQgPT09IEFjdGlvbi5GRVRDSCkge1xuICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgIHRoaXMuYWRkTm9kZXMoYXdhaXQgdGhpcy5mZXRjaCgpKTtcbiAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoZXZ0ID09PSBBY3Rpb24uTkVYVCkge1xuICAgICAgdGhpcy5sb2FkTW9yZU5vZGUubG9hZGluZyA9IHRydWU7XG4gICAgICB0aGlzLmFkZE5vZGVzKGF3YWl0IHRoaXMucGFnaW5nLm5leHQoKSk7XG4gICAgICB0aGlzLmxvYWRNb3JlTm9kZS5sb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChldnQgPT09IEFjdGlvbi5SRUZSRVNIKSB7XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMucGFnaW5nID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5sb2FkTW9yZU5vZGUgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmVtcHR5KCk7XG4gICAgICB0aGlzLmV2ZW50cy5uZXh0KEFjdGlvbi5GRVRDSCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGROb2RlcyhyZXMpIHtcbiAgICBpZiAocmVzLnBhZ2luZykge1xuICAgICAgY29uc3QgeyBwYWdlU2l6ZSwgY3VycmVudFBhZ2UsIHRvdGFsUGFnZXMgfSA9IHRoaXMucGFnaW5nID0gcmVzLnBhZ2luZztcbiAgICAgIGlmIChjdXJyZW50UGFnZSA9PT0gMSkge1xuICAgICAgICB0aGlzLmVtcHR5KCk7XG4gICAgICB9XG4gICAgICBjb25zdCBpdGVtc0NvdW50ID0gcmVzLmRhdGEubGVuZ3RoO1xuICAgICAgY29uc3QgbW9yZUl0ZW1zQXZhaWxhYmxlID0gdG90YWxQYWdlcyA/IChjdXJyZW50UGFnZSA8IHRvdGFsUGFnZXMpIDogKGl0ZW1zQ291bnQgPT09IHBhZ2VTaXplKTtcbiAgICAgIHRoaXMudG9nZ2xlTG9hZE1vcmUobW9yZUl0ZW1zQXZhaWxhYmxlKTtcbiAgICB9XG4gICAgKHJlcy5kYXRhIHx8IHJlcykubWFwKChtbykgPT4gdGhpcy5hZGRNYW5hZ2VkT2JqZWN0KG1vKSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUljb24ob3Blbikge1xuICAgIHRoaXMuaWNvbiA9IHRoaXMuc2VydmljZS5ncm91cHMuaWNvbihcbiAgICAgIC8vIGlmIGl0J3Mgcm9vdCB3ZSBhcmUgZ29pbmcgdG8gcGFzcyBhIGZha2UgbW8gdG8gZ2V0IHRoZSBzYW1lIGljb24gYXMgZ3JvdXBzXG4gICAgICB0aGlzLnJvb3QgPyB7IHR5cGU6IEdyb3VwRnJhZ21lbnQuZ3JvdXBUeXBlIH0gOiB0aGlzLm1vLFxuICAgICAgb3BlblxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHRvZ2dsZUxvYWRNb3JlKHNob3c6IGJvb2xlYW4pIHtcbiAgICBpZiAoIXRoaXMubG9hZE1vcmVOb2RlICYmIHNob3cpIHtcbiAgICAgIHRoaXMubG9hZE1vcmVOb2RlID0gbmV3IExvYWRNb3JlTm9kZSgpO1xuICAgICAgdGhpcy5hZGQodGhpcy5sb2FkTW9yZU5vZGUpO1xuICAgICAgdGhpcy5sb2FkTW9yZU5vZGUuY2xpY2sgPSAoKSA9PiB0aGlzLmV2ZW50cy5uZXh0KEFjdGlvbi5ORVhUKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5sb2FkTW9yZU5vZGUpIHtcbiAgICAgIHRoaXMubG9hZE1vcmVOb2RlLmhpZGRlbiA9ICFzaG93O1xuICAgIH1cbiAgfVxufVxuIl19