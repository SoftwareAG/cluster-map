import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
let AlertService = class AlertService extends StateService {
    /**
     * A service which allows to display alerts.
     */
    constructor() {
        super(...arguments);
        this.state$ = new BehaviorSubject([]);
        this.MAX_ALERTS = 3;
        this.ALERT_TIMEOUT = 3000;
    }
    /**
     * Returns all alerts.
     * @readonly
     */
    get state() {
        return this.state$.value;
    }
    /**
     * Adds a new alert to the current state.
     */
    add(alert) {
        this.addAlert(alert);
    }
    /**
     * Adds a alert by text.
     */
    addByText(type, txt, detailedData) {
        this.addAlert({ text: txt, type, detailedData });
    }
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    list() {
        return this.state;
    }
    /**
     * Remove an alert from the current state.
     */
    remove(alert) {
        this.changeAlerts(this.state.filter((item) => !this.areSame(alert, item)));
    }
    /**
     * Removes last danger alert. Replacement for silentError.
     *
     * @example
     * ```typescript
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alarmService.removeLastDanger();
     *  }
     * ```
     */
    removeLastDanger() {
        const firstDangerAlarm = this.state.reverse().find(({ type }) => type === 'danger');
        this.changeAlerts(this.state.filter((alarm) => alarm !== firstDangerAlarm));
    }
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    saveSuccess(savedObject) {
        return () => {
            const text = `${savedObject} saved successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    createSuccess(createdObject) {
        return () => {
            const text = `${createdObject} created successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Clears all alerts.
     */
    clearAll() {
        this.changeAlerts([]);
    }
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    success(text, detailedData) {
        this.addByText('success', text, detailedData);
    }
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    danger(text, detailedData) {
        this.addByText('danger', text, detailedData);
    }
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    info(text, detailedData) {
        this.addByText('info', text, detailedData);
    }
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    warning(text, detailedData) {
        this.addByText('warning', text, detailedData);
    }
    addServerFailure(error, type = 'danger') {
        const { data, res } = error;
        let text = data && data.message ? data.message : null;
        let detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        const hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url,
            };
        }
        this.addAlert({
            type,
            text,
            detailedData
        });
    }
    areSame(alert1, alert2) {
        return alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            alert1.detailedData === alert2.detailedData &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail;
    }
    changeAlerts(newAlerts) {
        this.state$.next(newAlerts);
    }
    addAlert(alert) {
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        const alertAlreadyAdded = this.state
            .find((item) => this.areSame(alert, item));
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts([...this.state, alert]);
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    }
    hideAutomaticallyIfNeeded(alert) {
        const isSuccess = alert.type === 'success';
        const noDetails = !alert.detailedData;
        let alertTimeout = (isSuccess && noDetails) ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(() => this.remove(alert), alertTimeout);
        }
    }
    removeOldestIfMax() {
        if (this.state.length > this.MAX_ALERTS) {
            const [, ...firstRemoved] = this.state;
            this.changeAlerts(firstRemoved);
        }
    }
};
AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
AlertService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root',
    })
], AlertService);
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDOztBQUcxQzs7R0FFRztBQUlILElBQWEsWUFBWSxHQUF6QixNQUFhLFlBQWEsU0FBUSxZQUFZO0lBTjlDOztPQUVHO0lBQ0g7O1FBWUUsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRWxDLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFDZixrQkFBYSxHQUFHLElBQUksQ0FBQztLQWdNOUI7SUExTUM7OztPQUdHO0lBQ0gsSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUMzQixDQUFDO0lBTUQ7O09BRUc7SUFDSCxHQUFHLENBQUMsS0FBWTtRQUNkLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLElBQWUsRUFBRSxHQUFXLEVBQUUsWUFBcUI7UUFDM0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUk7UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQVk7UUFDakIsSUFBSSxD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IEFsZXJ0IH0gZnJvbSAnLi9hbGVydC5tb2RlbCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9zdGF0ZS1zZXJ2aWNlLmFic3RyYWN0JztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuXG50eXBlIGFsZXJ0VHlwZSA9ICAnc3VjY2VzcycgfCAnd2FybmluZycgfCAnZGFuZ2VyJyB8ICdpbmZvJyB8ICdzeXN0ZW0nO1xuLyoqXG4gKiBBIHNlcnZpY2Ugd2hpY2ggYWxsb3dzIHRvIGRpc3BsYXkgYWxlcnRzLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgQWxlcnRTZXJ2aWNlIGV4dGVuZHMgU3RhdGVTZXJ2aWNlIHtcblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cbiAgc3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxBbGVydFtdPihbXSk7XG5cbiAgcHJpdmF0ZSBNQVhfQUxFUlRTID0gMztcbiAgcHJpdmF0ZSBBTEVSVF9USU1FT1VUID0gMzAwMDtcblxuICAvKipcbiAgICogQWRkcyBhIG5ldyBhbGVydCB0byB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIGFkZChhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmFkZEFsZXJ0KGFsZXJ0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgYWxlcnQgYnkgdGV4dC5cbiAgICovXG4gIGFkZEJ5VGV4dCh0eXBlOiBhbGVydFR5cGUsIHR4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmFkZEFsZXJ0KHsgdGV4dDogdHh0LCB0eXBlLCBkZXRhaWxlZERhdGEgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYWxlcnRTZXJ2aWNlLmFsZXJ0cyBpbnN0ZWFkLlxuICAgKi9cbiAgbGlzdCgpOiBBbGVydFtdIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYW4gYWxlcnQgZnJvbSB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIHJlbW92ZShhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcigoaXRlbSkgPT4gIXRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGxhc3QgZGFuZ2VyIGFsZXJ0LiBSZXBsYWNlbWVudCBmb3Igc2lsZW50RXJyb3IuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogIHRyeSB7XG4gICAqICAgIC8vIHNvbWV0aGluZyB0aGF0IG1pZ2h0IHRocm93IGEgZGFuZ2VyIHNlcnZlciBtc2dcbiAgICogIH0gY2F0Y2ggKGV4KSB7XG4gICAqICAgdGhpcy5hbGFybVNlcnZpY2UucmVtb3ZlTGFzdERhbmdlcigpO1xuICAgKiAgfVxuICAgKiBgYGBcbiAgICovXG4gIHJlbW92ZUxhc3REYW5nZXIoKSB7XG4gICAgY29uc3QgZmlyc3REYW5nZXJBbGFybSA9IHRoaXMuc3RhdGUucmV2ZXJzZSgpLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSAnZGFuZ2VyJyk7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHModGhpcy5zdGF0ZS5maWx0ZXIoKGFsYXJtKSA9PiBhbGFybSAhPT0gZmlyc3REYW5nZXJBbGFybSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBzYXZlIHN1Y2Nlc3NmdWwgYWxlcnQuXG4gICAqIEBwYXJhbSBzYXZlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBzYXZlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIHNhdmVTdWNjZXNzKHNhdmVkT2JqZWN0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGAke3NhdmVkT2JqZWN0fSBzYXZlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBjcmVhdGUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIGNyZWF0ZWRPYmplY3QgVGhlIG9iamVjdCB3aGljaCB3YXMgY3JlYXRlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIGNyZWF0ZVN1Y2Nlc3MoY3JlYXRlZE9iamVjdCkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7Y3JlYXRlZE9iamVjdH0gY3JlYXRlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFycyBhbGwgYWxlcnRzLlxuICAgKi9cbiAgY2xlYXJBbGwoKSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoW10pO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgc3VjY2VzcyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgc3VjY2VzcyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIHN1Y2Nlc3ModGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBkYW5nZXIgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIGRhbmdlciB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGRhbmdlcih0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdkYW5nZXInLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgaW5mbyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgaW5mbyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGluZm8odGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnaW5mbycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSB3YXJuaW5nIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSB3YXJuaW5nIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgd2FybmluZyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCd3YXJuaW5nJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIGFkZFNlcnZlckZhaWx1cmUoZXJyb3I6IGFueSwgdHlwZTogYWxlcnRUeXBlID0gJ2RhbmdlcicpIHtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gZXJyb3I7XG4gICAgbGV0IHRleHQgPSBkYXRhICYmIGRhdGEubWVzc2FnZSA/IGRhdGEubWVzc2FnZSA6IG51bGw7XG4gICAgbGV0IGRldGFpbGVkRGF0YTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhLmV4Y2VwdGlvbk1lc3NhZ2U7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBoYXNSZWxldmFudE1lc3NhZ2UgPSAhISh0ZXh0IHx8IGRldGFpbGVkRGF0YSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gZ2V0dGV4dCgnQSBzZXJ2ZXIgZXJyb3Igb2NjdXJyZWQuJyk7XG4gICAgfVxuICAgIGlmICghaGFzUmVsZXZhbnRNZXNzYWdlKSB7XG4gICAgICBkZXRhaWxlZERhdGEgPSB7XG4gICAgICAgIHN0YXR1czogcmVzLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogcmVzLnN0YXR1c1RleHQsXG4gICAgICAgIHVybDogcmVzLnVybCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5hZGRBbGVydCh7XG4gICAgICB0eXBlLFxuICAgICAgdGV4dCxcbiAgICAgIGRldGFpbGVkRGF0YVxuICAgIH0pO1xuICB9XG5cbiAgYXJlU2FtZShhbGVydDE6IEFsZXJ0LCBhbGVydDI6IEFsZXJ0KSB7XG4gICAgcmV0dXJuIGFsZXJ0MS50ZXh0ID09PSBhbGVydDIudGV4dCAmJlxuICAgICAgYWxlcnQxLnR5cGUgPT09IGFsZXJ0Mi50eXBlICYmXG4gICAgICBhbGVydDEuZGV0YWlsZWREYXRhID09PSBhbGVydDIuZGV0YWlsZWREYXRhICYmXG4gICAgICBhbGVydDEub25DbG9zZSA9PT0gYWxlcnQyLm9uQ2xvc2UgJiZcbiAgICAgIGFsZXJ0MS5vbkRldGFpbCA9PT0gYWxlcnQyLm9uRGV0YWlsO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFuZ2VBbGVydHMobmV3QWxlcnRzOiBBbGVydFtdKSB7XG4gICAgdGhpcy5zdGF0ZSQubmV4dChuZXdBbGVydHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRBbGVydChhbGVydDogQWxlcnQpOiB2b2lkIHtcbiAgICBpZiAoIWFsZXJ0LnRleHQgJiYgIWFsZXJ0LnR5cGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGFkZCBlbXB0eSBhbGVydCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGFsZXJ0QWxyZWFkeUFkZGVkID0gdGhpcy5zdGF0ZVxuICAgICAgICAuZmluZCgoaXRlbSkgPT4gdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSk7XG4gICAgaWYgKGFsZXJ0QWxyZWFkeUFkZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoWy4uLnRoaXMuc3RhdGUsIGFsZXJ0XSk7XG4gICAgdGhpcy5oaWRlQXV0b21hdGljYWxseUlmTmVlZGVkKGFsZXJ0KTtcbiAgICB0aGlzLnJlbW92ZU9sZGVzdElmTWF4KCk7XG4gIH1cblxuICBwcml2YXRlIGhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgY29uc3QgaXNTdWNjZXNzID0gYWxlcnQudHlwZSA9PT0gJ3N1Y2Nlc3MnO1xuICAgIGNvbnN0IG5vRGV0YWlscyA9ICFhbGVydC5kZXRhaWxlZERhdGE7XG4gICAgbGV0IGFsZXJ0VGltZW91dCA9IChpc1N1Y2Nlc3MgJiYgbm9EZXRhaWxzKSA/IHRoaXMuQUxFUlRfVElNRU9VVCA6IDA7XG4gICAgaWYgKHR5cGVvZiBhbGVydC50aW1lb3V0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgYWxlcnRUaW1lb3V0ID0gYWxlcnQudGltZW91dDtcbiAgICB9XG4gICAgaWYgKGFsZXJ0VGltZW91dCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlbW92ZShhbGVydCksIGFsZXJ0VGltZW91dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVPbGRlc3RJZk1heCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiB0aGlzLk1BWF9BTEVSVFMpIHtcbiAgICAgIGNvbnN0IFssIC4uLmZpcnN0UmVtb3ZlZF0gPSB0aGlzLnN0YXRlO1xuICAgICAgdGhpcy5jaGFuZ2VBbGVydHMoZmlyc3RSZW1vdmVkKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==