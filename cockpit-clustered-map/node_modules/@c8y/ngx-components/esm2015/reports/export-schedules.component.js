import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { ActionType } from './export-schedules.interface';
import { ReportsService } from './reports.service';
import { BsModalService, BsModalRef, ModalOptions } from 'ngx-bootstrap/modal';
import { ScheduleModalComponent } from './schedule-modal.component';
import { ConfirmModalComponent, Status, gettext } from '@c8y/ngx-components';
import { cloneDeep } from 'lodash-es';
import { CronService } from './cron.service';
import { TranslateService } from '@ngx-translate/core';
import { UserService } from '@c8y/client';
let ExportSchedulesComponent = class ExportSchedulesComponent {
    constructor(reportsService, bsModalService, cronService, translateService, userService) {
        this.reportsService = reportsService;
        this.bsModalService = bsModalService;
        this.cronService = cronService;
        this.translateService = translateService;
        this.userService = userService;
        this.scheduleList = [];
        this.initialSchedule = {
            timestamp: null,
            emailConfig: {
                to: [],
                cc: [],
                bcc: [],
                replyTo: '',
                text: this.translateService.instant(gettext('File with exported data can be downloaded from {tenant-domain}/inventory/binaries/{binaryId}.')),
                subject: ''
            },
            cronConfig: {
                minute: '0',
                hour: '0',
                day: '1',
                month: '1',
                weekday: '?'
            }
        };
        this.listClass = 'interact-list';
        this.sortReverse = false;
        this.isOpen = {};
        this.isEditMenuOpen = false;
        this.currentUserEmail = '';
        this.loadingStatus = {
            inProgress: false,
            done: false,
            error: false
        };
    }
    set exportId(exportId) {
        this._exportId = exportId;
    }
    ngOnInit() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.getScheduleList(true);
            const currentUserEmail = yield this.getCurrentUserEmail();
            this.initialSchedule.emailConfig.to = currentUserEmail;
            this.exp = yield this.reportsService.getExport(this._exportId);
            this.initialSchedule.emailConfig.subject = this.translateService.instant(gettext('Export of "{{expName}}"'), { expName: this.exp.name });
        });
    }
    getCurrentUserEmail() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.userService.current();
            return data && data.email ? [data.email] : [];
        });
    }
    getScheduleList(withProgress) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (withProgress) {
                this.loadingStatus.inProgress = true;
            }
            this.scheduleList = yield this.reportsService.getScheduleList(this._exportId);
            if (withProgress) {
                this.loadingStatus.inProgress = false;
            }
        });
    }
    addSchedule() {
        this.openAddEditModal(this._exportId, this.initialSchedule, ActionType.CREATE);
    }
    editSchedule(schedule, event) {
        event.preventDefault();
        this.openAddEditModal(this._exportId, schedule, ActionType.EDIT);
    }
    duplicateSchedule(schedule, event) {
        event.preventDefault();
        this.openAddEditModal(this._exportId, schedule, ActionType.DUPLICATE);
    }
    openAddEditModal(exportId, schedule, actionType) {
        const payload = { actionType, exportId, schedule: cloneDeep(schedule) };
        const modalOptions = { class: 'modal-sm', initialState: payload };
        this.modalRef = this.bsModalService.show(ScheduleModalComponent, modalOptions);
        this.modalRef.content.emitter.subscribe((load) => this.getMessageFromModal(load));
    }
    getMessageFromModal(payload) {
        if (payload.success) {
            // refresh schedule list
            this.getScheduleList(false);
        }
    }
    removeSchedule(schedule, event) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            event.preventDefault();
            const subject = schedule.emailConfig.subject;
            const payload = {
                status: Status.DANGER,
                title: gettext('Delete schedule'),
                labels: { ok: gettext('Delete') },
                body: this.translateService.instant(gettext('You are about to delete the schedule "{{subject}}". Do you want to proceed?'), { subject })
            };
            const modalOptions = { initialState: payload };
            this.modalRef = this.bsModalService.show(ConfirmModalComponent, modalOptions);
            const confirm = yield this.modalRef.content.result;
            if (confirm) {
                const success = yield this.reportsService.deleteSchedule(schedule, this._exportId);
                if (success) {
                    // refresh schedule list
                    this.getScheduleList(false);
                }
            }
        });
    }
};
ExportSchedulesComponent.ctorParameters = () => [
    { type: ReportsService },
    { type: BsModalService },
    { type: CronService },
    { type: TranslateService },
    { type: UserService }
];
tslib_1.__decorate([
    Input()
], ExportSchedulesComponent.prototype, "exportId", null);
ExportSchedulesComponent = tslib_1.__decorate([
    Component({
        selector: 'export-schedules',
        template: "<div>\n  <div *ngIf=\"loadingStatus.inProgress\" class=\"flex-row\">\n    <div style=\"position: relative; min-height: 40px;min-width: 55px;\">\n      <div class=\"spinner\">\n        <div class=\"rect1\"></div>\n        <div class=\"rect2\"></div>\n        <div class=\"rect3\"></div>\n        <div class=\"rect4\"></div>\n        <div class=\"rect5\"></div>\n      </div>\n    </div>\n    <span translate>Retrieving schedules\u2026</span>\n  </div>\n\n  <div *ngIf=\"!loadingStatus.inProgress && loadingStatus.done && loadingStatus.error\">\n    <div class=\"alert alert-warning\" translate>\n      Could not load schedules list.\n    </div>\n  </div>\n\n  <div *ngIf=\"!loadingStatus.inProgress && !loadingStatus.done && !loadingStatus.error\">\n    <div class=\"c8y-empty-state text-center\" *ngIf=\"!scheduleList.length\">\n      <h1 c8yIcon=\"c8y-report\" class=\"c8y-icon-duocolor\"></h1>\n      <h3 translate>No export schedules defined.</h3>\n    </div>\n\n    <div class=\"list-group\" *ngIf=\"scheduleList.length\">\n      <div\n        class=\"list-group-item flex-row pointer\"\n        *ngFor=\"let schedule of scheduleList\"\n        (click)=\"editSchedule(schedule, $event)\"\n      >\n        <div class=\"list-item-actions\" (click)=\"$event.stopPropagation()\">\n          <div class=\"settings dropdown\" dropdown>\n            <button\n              class=\"dropdown-toggle c8y-dropdown\"\n              dropdownToggle\n              aria-haspopup=\"true\"\n              aria-expanded=\"false\"\n              title=\"{{ 'Actions' | translate }}\"\n            >\n              <i [c8yIcon]=\"'ellipsis-v'\"></i>\n            </button>\n            <ul class=\"dropdown-menu dropdown-menu-right\" *dropdownMenu>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Edit schedule' | translate }}\"\n                  (click)=\"editSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'pencil'\"></i> {{ 'Edit' | translate }}\n                </a>\n              </li>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Duplicate schedule' | translate }}\"\n                  (click)=\"duplicateSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'copy'\"></i> {{ 'Duplicate' | translate }}\n                </a>\n              </li>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Delete schedule' | translate }}\"\n                  (click)=\"removeSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'trash'\"></i> {{ 'Delete' | translate }}\n                </a>\n              </li>\n            </ul>\n          </div>\n        </div>\n        <div class=\"list-item-icon\">\n          <i c8yIcon=\"c8y-report\" class=\"c8y-icon-duocolor\"></i>\n        </div>\n        <div class=\"list-item-body flex-row\">\n          <div class=\"col-sm-6\">\n            <div class=\"text-truncate\" title=\"{{ schedule.emailConfig.subject }}\">\n              {{ schedule.emailConfig.subject }}\n            </div>\n          </div>\n          <div class=\"col-sm-6\">\n            <div class=\"flex-row\" style=\"align-items: baseline;\">\n              <i c8yIcon=\"calendar\" class=\"text-muted m-r-4\"></i>\n              <small class=\"smart-rule-information text-muted\">\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 2\" translate>\n                  Hourly: {{ schedule.cronConfig.minute | number: '2.0-0' }} minute(s) past the\n                  hour.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 3\" translate>\n                  Daily: at {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 4\" translate>\n                  Weekly: {{ cronService.getWeekDayName(schedule.cronConfig) }}, at\n                  {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 5\" translate>\n                  Monthly: {{ cronService.getMonthDayName(schedule.cronConfig) }} day of the month,\n                  at {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 6\" translate>\n                  Yearly: {{ cronService.getMonthName(schedule.cronConfig) }},\n                  {{ cronService.getMonthDayName(schedule.cronConfig) }} day of the month, at\n                  {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n              </small>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <button\n    type=\"button\"\n    class=\"btn-add-block m-t-16\"\n    title=\"{{ 'Add schedule' | translate }}\"\n    (click)=\"addSchedule()\"\n  >\n    <i [c8yIcon]=\"'plus-square'\"></i> {{ 'Add schedule' | translate }}\n  </button>\n</div>\n"
    })
], ExportSchedulesComponent);
export { ExportSchedulesComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LXNjaGVkdWxlcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3JlcG9ydHMvIiwic291cmNlcyI6WyJleHBvcnQtc2NoZWR1bGVzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFvQyxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM1RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDL0UsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM3RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBTTFDLElBQWEsd0JBQXdCLEdBQXJDLE1BQWEsd0JBQXdCO0lBdUNuQyxZQUNVLGNBQThCLEVBQzlCLGNBQThCLEVBQy9CLFdBQXdCLEVBQ3ZCLGdCQUFrQyxFQUNsQyxXQUF3QjtRQUp4QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQy9CLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3ZCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUF2Q2xD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IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFeHBvcnQsIFNjaGVkdWxlLCBFbWl0dGVyUGF5bG9hZCwgQWN0aW9uVHlwZSB9IGZyb20gJy4vZXhwb3J0LXNjaGVkdWxlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUmVwb3J0c1NlcnZpY2UgfSBmcm9tICcuL3JlcG9ydHMuc2VydmljZSc7XG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSwgQnNNb2RhbFJlZiwgTW9kYWxPcHRpb25zIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBTY2hlZHVsZU1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9zY2hlZHVsZS1tb2RhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29uZmlybU1vZGFsQ29tcG9uZW50LCBTdGF0dXMsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBDcm9uU2VydmljZSB9IGZyb20gJy4vY3Jvbi5zZXJ2aWNlJztcbmltcG9ydCB7IElkUmVmZXJlbmNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgVXNlclNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2V4cG9ydC1zY2hlZHVsZXMnLFxuICB0ZW1wbGF0ZVVybDogJy4vZXhwb3J0LXNjaGVkdWxlcy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgRXhwb3J0U2NoZWR1bGVzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgc2V0IGV4cG9ydElkKGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIHRoaXMuX2V4cG9ydElkID0gZXhwb3J0SWQ7XG4gIH1cbiAgZXhwOiBFeHBvcnQ7XG4gIHNjaGVkdWxlTGlzdDogU2NoZWR1bGVbXSA9IFtdO1xuICBpbml0aWFsU2NoZWR1bGU6IFNjaGVkdWxlID0ge1xuICAgIHRpbWVzdGFtcDogbnVsbCxcbiAgICBlbWFpbENvbmZpZzoge1xuICAgICAgdG86IFtdLFxuICAgICAgY2M6IFtdLFxuICAgICAgYmNjOiBbXSxcbiAgICAgIHJlcGx5VG86ICcnLFxuICAgICAgdGV4dDogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgJ0ZpbGUgd2l0aCBleHBvcnRlZCBkYXRhIGNhbiBiZSBkb3dubG9hZGVkIGZyb20ge3RlbmFudC1kb21haW59L2ludmVudG9yeS9iaW5hcmllcy97YmluYXJ5SWR9LidcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHN1YmplY3Q6ICcnXG4gICAgfSxcbiAgICBjcm9uQ29uZmlnOiB7XG4gICAgICBtaW51dGU6ICcwJyxcbiAgICAgIGhvdXI6ICcwJyxcbiAgICAgIGRheTogJzEnLFxuICAgICAgbW9udGg6ICcxJyxcbiAgICAgIHdlZWtkYXk6ICc/J1xuICAgIH1cbiAgfTtcbiAgbGlzdENsYXNzOiBzdHJpbmcgPSAnaW50ZXJhY3QtbGlzdCc7XG4gIGxvYWRpbmdTdGF0dXM6IGFueTtcbiAgc29ydFR5cGU6IHN0cmluZztcbiAgc29ydFJldmVyc2U6IGJvb2xlYW4gPSBmYWxzZTtcbiAgaXNPcGVuOiBhbnkgPSB7fTtcbiAgaXNGbGlwcGVkOiBib29sZWFuO1xuICBpc0VkaXRNZW51T3BlbjogYm9vbGVhbiA9IGZhbHNlO1xuICBtb2RhbFJlZjogQnNNb2RhbFJlZjtcbiAgY3VycmVudFVzZXJFbWFpbDogc3RyaW5nID0gJyc7XG4gIHByaXZhdGUgX2V4cG9ydElkOiBJZFJlZmVyZW5jZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlcG9ydHNTZXJ2aWNlOiBSZXBvcnRzU2VydmljZSxcbiAgICBwcml2YXRlIGJzTW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcbiAgICBwdWJsaWMgY3JvblNlcnZpY2U6IENyb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIHVzZXJTZXJ2aWNlOiBVc2VyU2VydmljZVxuICApIHtcbiAgICB0aGlzLmxvYWRpbmdTdGF0dXMgPSB7XG4gICAgICBpblByb2dyZXNzOiBmYWxzZSxcbiAgICAgIGRvbmU6IGZhbHNlLFxuICAgICAgZXJyb3I6IGZhbHNlXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZ2V0U2NoZWR1bGVMaXN0KHRydWUpO1xuICAgIGNvbnN0IGN1cnJlbnRVc2VyRW1haWwgPSBhd2FpdCB0aGlzLmdldEN1cnJlbnRVc2VyRW1haWwoKTtcbiAgICB0aGlzLmluaXRpYWxTY2hlZHVsZS5lbWFpbENvbmZpZy50byA9IGN1cnJlbnRVc2VyRW1haWw7XG4gICAgdGhpcy5leHAgPSBhd2FpdCB0aGlzLnJlcG9ydHNTZXJ2aWNlLmdldEV4cG9ydCh0aGlzLl9leHBvcnRJZCk7XG4gICAgdGhpcy5pbml0aWFsU2NoZWR1bGUuZW1haWxDb25maWcuc3ViamVjdCA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgZ2V0dGV4dCgnRXhwb3J0IG9mIFwie3tleHBOYW1lfX1cIicpLFxuICAgICAgeyBleHBOYW1lOiB0aGlzLmV4cC5uYW1lIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q3VycmVudFVzZXJFbWFpbCgpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMudXNlclNlcnZpY2UuY3VycmVudCgpO1xuICAgIHJldHVybiBkYXRhICYmIGRhdGEuZW1haWwgPyBbZGF0YS5lbWFpbF0gOiBbXTtcbiAgfVxuXG4gIGFzeW5jIGdldFNjaGVkdWxlTGlzdCh3aXRoUHJvZ3Jlc3M6IGJvb2xlYW4pIHtcbiAgICBpZiAod2l0aFByb2dyZXNzKSB7XG4gICAgICB0aGlzLmxvYWRpbmdTdGF0dXMuaW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuc2NoZWR1bGVMaXN0ID0gYXdhaXQgdGhpcy5yZXBvcnRzU2VydmljZS5nZXRTY2hlZHVsZUxpc3QodGhpcy5fZXhwb3J0SWQpO1xuICAgIGlmICh3aXRoUHJvZ3Jlc3MpIHtcbiAgICAgIHRoaXMubG9hZGluZ1N0YXR1cy5pblByb2dyZXNzID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYWRkU2NoZWR1bGUoKSB7XG4gICAgdGhpcy5vcGVuQWRkRWRpdE1vZGFsKHRoaXMuX2V4cG9ydElkLCB0aGlzLmluaXRpYWxTY2hlZHVsZSwgQWN0aW9uVHlwZS5DUkVBVEUpO1xuICB9XG5cbiAgZWRpdFNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5vcGVuQWRkRWRpdE1vZGFsKHRoaXMuX2V4cG9ydElkLCBzY2hlZHVsZSwgQWN0aW9uVHlwZS5FRElUKTtcbiAgfVxuXG4gIGR1cGxpY2F0ZVNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5vcGVuQWRkRWRpdE1vZGFsKHRoaXMuX2V4cG9ydElkLCBzY2hlZHVsZSwgQWN0aW9uVHlwZS5EVVBMSUNBVEUpO1xuICB9XG5cbiAgb3BlbkFkZEVkaXRNb2RhbChleHBvcnRJZDogSWRSZWZlcmVuY2UsIHNjaGVkdWxlOiBTY2hlZHVsZSwgYWN0aW9uVHlwZTogQWN0aW9uVHlwZSkge1xuICAgIGNvbnN0IHBheWxvYWQgPSB7IGFjdGlvblR5cGUsIGV4cG9ydElkLCBzY2hlZHVsZTogY2xvbmVEZWVwKHNjaGVkdWxlKSB9O1xuICAgIGNvbnN0IG1vZGFsT3B0aW9ucyA9IHsgY2xhc3M6ICdtb2RhbC1zbScsIGluaXRpYWxTdGF0ZTogcGF5bG9hZCB9IGFzIE1vZGFsT3B0aW9ucztcbiAgICB0aGlzLm1vZGFsUmVmID0gdGhpcy5ic01vZGFsU2VydmljZS5zaG93KFNjaGVkdWxlTW9kYWxDb21wb25lbnQsIG1vZGFsT3B0aW9ucyk7XG4gICAgdGhpcy5tb2RhbFJlZi5jb250ZW50LmVtaXR0ZXIuc3Vic2NyaWJlKChsb2FkOiBFbWl0dGVyUGF5bG9hZCkgPT5cbiAgICAgIHRoaXMuZ2V0TWVzc2FnZUZyb21Nb2RhbChsb2FkKVxuICAgICk7XG4gIH1cblxuICBnZXRNZXNzYWdlRnJvbU1vZGFsKHBheWxvYWQ6IEVtaXR0ZXJQYXlsb2FkKSB7XG4gICAgaWYgKHBheWxvYWQuc3VjY2Vzcykge1xuICAgICAgLy8gcmVmcmVzaCBzY2hlZHVsZSBsaXN0XG4gICAgICB0aGlzLmdldFNjaGVkdWxlTGlzdChmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlU2NoZWR1bGUoc2NoZWR1bGU6IFNjaGVkdWxlLCBldmVudDogYW55KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCBzdWJqZWN0ID0gc2NoZWR1bGUuZW1haWxDb25maWcuc3ViamVjdDtcbiAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgc3RhdHVzOiBTdGF0dXMuREFOR0VSLFxuICAgICAgdGl0bGU6IGdldHRleHQoJ0RlbGV0ZSBzY2hlZHVsZScpLFxuICAgICAgbGFiZWxzOiB7IG9rOiBnZXR0ZXh0KCdEZWxldGUnKSB9LFxuICAgICAgYm9keTogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgIGdldHRleHQoJ1lvdSBhcmUgYWJvdXQgdG8gZGVsZXRlIHRoZSBzY2hlZHVsZSBcInt7c3ViamVjdH19XCIuIERvIHlvdSB3YW50IHRvIHByb2NlZWQ/JyksXG4gICAgICAgIHsgc3ViamVjdCB9XG4gICAgICApXG4gICAgfTtcbiAgICBjb25zdCBtb2RhbE9wdGlvbnMgPSB7IGluaXRpYWxTdGF0ZTogcGF5bG9hZCB9IGFzIE1vZGFsT3B0aW9ucztcbiAgICB0aGlzLm1vZGFsUmVmID0gdGhpcy5ic01vZGFsU2VydmljZS5zaG93KENvbmZpcm1Nb2RhbENvbXBvbmVudCwgbW9kYWxPcHRpb25zKTtcblxuICAgIGNvbnN0IGNvbmZpcm0gPSBhd2FpdCB0aGlzLm1vZGFsUmVmLmNvbnRlbnQucmVzdWx0O1xuICAgIGlmIChjb25maXJtKSB7XG4gICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgdGhpcy5yZXBvcnRzU2VydmljZS5kZWxldGVTY2hlZHVsZShzY2hlZHVsZSwgdGhpcy5fZXhwb3J0SWQpO1xuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgLy8gcmVmcmVzaCBzY2hlZHVsZSBsaXN0XG4gICAgICAgIHRoaXMuZ2V0U2NoZWR1bGVMaXN0KGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==