import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter } from '@angular/core';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { ActionType } from './export-schedules.interface';
import { ReportsService } from './reports.service';
import { CronService } from './cron.service';
import { cloneDeep } from 'lodash';
import { gettext } from '@c8y/ngx-components';
let ScheduleModalComponent = class ScheduleModalComponent {
    constructor(modalRef, reportsService, cronService) {
        this.modalRef = modalRef;
        this.reportsService = reportsService;
        this.cronService = cronService;
        this.emitter = new EventEmitter();
        this.ActionType = ActionType;
        this.multiEmailPattern = /^([a-z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-z0-9-]+(\.[a-z0-9-]+)*,?)*$/i;
        this.singleEmailPattern = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
        this.cronExpression = '* * * * *';
        this.validCron = false;
        this.emitterPayload = {
            success: false,
            message: ''
        };
        this.placeholdersInfo = gettext('Available placeholders: {tenant-domain}, {host}, {binaryId}. Whole link to downloadable file is: {tenant-domain}/inventory/binaries/{binaryId}.');
        this.savingStatus = {
            inProgress: false,
            done: false,
            error: false
        };
    }
    ngOnInit() {
        this.oldSchedule = cloneDeep(this.schedule);
        this.populateEmailFieldsFromSchedule(this.schedule);
        this.cronExpression = this.cronService.generateCron(this.schedule.cronConfig);
        this.validCron = this.cronService.validateModels(this.cronService.getBase(this.schedule.cronConfig), this.schedule.cronConfig);
    }
    populateEmailFieldsFromSchedule(schedule) {
        if (schedule.emailConfig.to && schedule.emailConfig.to.length) {
            this.emailTo = schedule.emailConfig.to.toString();
        }
        if (schedule.emailConfig.cc && schedule.emailConfig.cc.length) {
            this.emailCc = schedule.emailConfig.cc.toString();
        }
        if (schedule.emailConfig.bcc && schedule.emailConfig.bcc.length) {
            this.emailBcc = schedule.emailConfig.bcc.toString();
        }
        if (schedule.emailConfig.replyTo) {
            this.emailReplyTo = schedule.emailConfig.replyTo;
        }
        if (schedule.emailConfig.subject) {
            this.emailSubject = schedule.emailConfig.subject;
        }
        if (schedule.emailConfig.text) {
            this.emailText = schedule.emailConfig.text;
        }
    }
    save() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.populateScheduleFromCronExpression();
            this.populateScheduleFromEmailFields();
            this.savingStatus.inProgress = true;
            let success = false;
            if (this.actionType === ActionType.EDIT) {
                success = yield this.reportsService.updateSchedule(this.oldSchedule, this.schedule, this.exportId);
            }
            else {
                const date = new Date();
                const timestamp = date.getTime();
                this.schedule.timestamp = timestamp;
                success = yield this.reportsService.addSchedule(this.schedule, this.exportId);
            }
            if (success) {
                this.modalRef.hide();
                // signal to the parent component to update list
                this.emitterPayload.success = true;
                this.emitter.emit(this.emitterPayload);
            }
            this.savingStatus.inProgress = false;
        });
    }
    cancel() {
        this.modalRef.hide();
    }
    getCron(cron) {
        this.validCron = cron.valid;
        if (cron.valid) {
            this.cronExpression = cron.cron;
        }
    }
    populateScheduleFromCronExpression() {
        this.schedule.cronConfig = this.cronService.generateCronConfig(this.cronExpression);
    }
    convertStringOfEmailsToArray(stringOfEmails) {
        const arr = [];
        if (stringOfEmails) {
            const parts = stringOfEmails.split(',');
            parts.forEach(item => {
                if (item) {
                    arr.push(item);
                }
            });
        }
        return arr;
    }
    populateScheduleFromEmailFields() {
        this.schedule.emailConfig.to = this.emailTo
            ? this.convertStringOfEmailsToArray(this.emailTo)
            : null;
        this.schedule.emailConfig.cc = this.emailCc
            ? this.convertStringOfEmailsToArray(this.emailCc)
            : null;
        this.schedule.emailConfig.bcc = this.emailBcc
            ? this.convertStringOfEmailsToArray(this.emailBcc)
            : null;
        this.schedule.emailConfig.replyTo = this.emailReplyTo;
        this.schedule.emailConfig.subject = this.emailSubject;
        this.schedule.emailConfig.text = this.emailText;
    }
};
ScheduleModalComponent.ctorParameters = () => [
    { type: BsModalRef },
    { type: ReportsService },
    { type: CronService }
];
tslib_1.__decorate([
    Output()
], ScheduleModalComponent.prototype, "emitter", void 0);
ScheduleModalComponent = tslib_1.__decorate([
    Component({
        selector: 'schedule-modal',
        template: "<div class=\"modal-header text-center bg-primary\">\n  <header class=\"text-white\">\n    <div style=\"font-size: 62px;\">\n      <span c8yIcon=\"c8y-report\"></span>\n    </div>\n    <h4 class=\"text-uppercase\" style=\"margin:0; letter-spacing: 0.15em;\">\n      <span *ngIf=\"actionType === ActionType.CREATE\" translate>New export schedule</span>\n      <span *ngIf=\"actionType === ActionType.EDIT\" translate>Edit export schedule</span>\n      <span *ngIf=\"actionType === ActionType.DUPLICATE\" translate>Duplicate export schedule</span>\n    </h4>\n  </header>\n</div>\n\n<div class=\"modal-body\">\n  <p class=\"lead text-center p-t-24\" style=\"margin-bottom: 0;\" translate>\n    On schedule send export via email\n  </p>\n</div>\n<div class=\"modal-inner-scroll smart-rule-control\">\n  <form #scheduleForm=\"ngForm\" class=\"edit-smart-rule-details\">\n    <div class=\"list-group\">\n      <div class=\"list-group-item bg-gray-white\">\n        <div class=\"smart-list-icon-label\">\n          <span class=\"dot bg-primary-light\">1</span\n          ><strong class=\"p-l-4\" translate>Frequency</strong>\n        </div>\n        <div class=\"p-t-4\">\n          <div class=\"form-group\">\n            <cron [cronIn]=\"cronExpression\" (emitter)=\"getCron($event)\" name=\"cron\"></cron>\n          </div>\n        </div>\n      </div>\n      <div class=\"list-group-item\">\n        <div class=\"smart-list-icon-label\">\n          <span class=\"dot bg-primary-light\">2</span>&nbsp;<strong translate>Send email</strong>\n        </div>\n        <div class=\"form-horizontal p-t-16\">\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>Send to</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control\"\n                  name=\"to\"\n                  [(ngModel)]=\"emailTo\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  required\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>CC</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"cc\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailCc\"\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>BCC</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"bcc\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailBcc\"\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <label class=\"control-label col-sm-3\" translate>Reply to</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"replyTo\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailReplyTo\"\n                  [pattern]=\"singleEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_singleEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <label class=\"control-label col-sm-3\" translate>Subject</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"subject\"\n                  [(ngModel)]=\"emailSubject\"\n                  placeholder=\"{{ 'e.g. Daily report' | translate }}\"\n                  required\n                />\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em>{{ placeholdersInfo | translate }}</em>\n            </div>\n            <label class=\"col-sm-3 control-label\" translate>Message</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <textarea\n                  class=\"form-control\"\n                  name=\"text\"\n                  [(ngModel)]=\"emailText\"\n                  placeholder=\"{{ 'Message' | translate }}\"\n                  required\n                ></textarea>\n              </c8y-form-group>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n\n<div class=\"modal-footer\">\n  <button class=\"btn btn-default\" (click)=\"cancel()\" title=\"{{ 'Cancel' | translate }}\" translate>\n    Cancel\n  </button>\n  <button\n    class=\"btn btn-primary\"\n    (click)=\"save()\"\n    [ngClass]=\"{ ' btn-pending ': savingStatus.inProgress }\"\n    [disabled]=\"!validCron || !scheduleForm.form.valid\"\n  >\n    <span *ngIf=\"!savingStatus.inProgress\">\n      <span *ngIf=\"actionType === ActionType.CREATE\" title=\"{{ 'Create' | translate }}\" translate\n        >Create</span\n      >\n      <span *ngIf=\"actionType === ActionType.EDIT\" title=\"{{ 'Save' | translate }}\" translate\n        >Save</span\n      >\n      <span\n        *ngIf=\"actionType === ActionType.DUPLICATE\"\n        title=\"{{ 'Duplicate' | translate }}\"\n        translate\n        >Duplicate</span\n      >\n    </span>\n    <span *ngIf=\"savingStatus.inProgress\" title=\"{{ 'Saving' | translate }}\u2026\"\n      >{{ 'Saving' | translate }}\u2026</span\n    >\n  </button>\n</div>\n"
    })
], ScheduleModalComponent);
export { ScheduleModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGUtbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvcnRzLyIsInNvdXJjZXMiOlsic2NoZWR1bGUtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBWSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDbkMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTTlDLElBQWEsc0JBQXNCLEdBQW5DLE1BQWEsc0JBQXNCO0lBMEJqQyxZQUNTLFFBQW9CLEVBQ3BCLGNBQThCLEVBQzdCLFdBQXdCO1FBRnpCLGFBQVEsR0FBUixRQUFRLENBQVk7UUFDcEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzdCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBekJ4QixZQUFPLEdBQWlDLElBQUksWUFBWSxFQUFFLENBQUM7UUFHckUsZUFBVSxHQUFHLFVBQVUsQ0FBQztRQUN4QixzQkFBaUIsR0FBVyxpRUFBaUUsQ0FBQztRQUM5Rix1QkFBa0IsR0FBVyx5Q0FBeUMsQ0FBQztRQUN2RSxtQkFBYyxHQUFXLFdBQVcsQ0FBQztRQUNyQyxjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLG1CQUFjLEdBQW1CO1lBQy9CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBU0YscUJBQWdCLEdB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QixDQTBJbEM7U0ExSVksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCc01vZGFsUmVmIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBTY2hlZHVsZSwgQWN0aW9uVHlwZSB9IGZyb20gJy4vZXhwb3J0LXNjaGVkdWxlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRW1pdHRlZENyb24sIEVtaXR0ZXJQYXlsb2FkIH0gZnJvbSAnLi9leHBvcnQtc2NoZWR1bGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBSZXBvcnRzU2VydmljZSB9IGZyb20gJy4vcmVwb3J0cy5zZXJ2aWNlJztcbmltcG9ydCB7IENyb25TZXJ2aWNlIH0gZnJvbSAnLi9jcm9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2NoZWR1bGUtbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vc2NoZWR1bGUtbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNjaGVkdWxlTW9kYWxDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBzYXZpbmdTdGF0dXM6IGFueTtcbiAgc2NoZWR1bGU6IFNjaGVkdWxlO1xuICBvbGRTY2hlZHVsZTogU2NoZWR1bGU7XG4gIEBPdXRwdXQoKSBlbWl0dGVyOiBFdmVudEVtaXR0ZXI8RW1pdHRlclBheWxvYWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBleHBvcnRJZDogbnVtYmVyO1xuICBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlO1xuICBBY3Rpb25UeXBlID0gQWN0aW9uVHlwZTtcbiAgbXVsdGlFbWFpbFBhdHRlcm46IFJlZ0V4cCA9IC9eKFthLXowLTkhIyQlJicqKy89P15fYHt8fX4uLV0rQFthLXowLTktXSsoXFwuW2EtejAtOS1dKykqLD8pKiQvaTtcbiAgc2luZ2xlRW1haWxQYXR0ZXJuOiBSZWdFeHAgPSAvW2EtejAtOS5fJSstXStAW2EtejAtOS4tXStcXC5bYS16XXsyLDR9JC87XG4gIGNyb25FeHByZXNzaW9uOiBzdHJpbmcgPSAnKiAqICogKiAqJztcbiAgdmFsaWRDcm9uOiBib29sZWFuID0gZmFsc2U7XG4gIGVtaXR0ZXJQYXlsb2FkOiBFbWl0dGVyUGF5bG9hZCA9IHtcbiAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICBtZXNzYWdlOiAnJ1xuICB9O1xuXG4gIGVtYWlsVG86IHN0cmluZztcbiAgZW1haWxDYzogc3RyaW5nO1xuICBlbWFpbEJjYzogc3RyaW5nO1xuICBlbWFpbFJlcGx5VG86IHN0cmluZztcbiAgZW1haWxTdWJqZWN0OiBzdHJpbmc7XG4gIGVtYWlsVGV4dDogc3RyaW5nO1xuXG4gIHBsYWNlaG9sZGVyc0luZm8gPSBnZXR0ZXh0KCdBdmFpbGFibGUgcGxhY2Vob2xkZXJzOiB7dGVuYW50LWRvbWFpbn0sIHtob3N0fSwge2JpbmFyeUlkfS4gV2hvbGUgbGluayB0byBkb3dubG9hZGFibGUgZmlsZSBpczoge3RlbmFudC1kb21haW59L2ludmVudG9yeS9iaW5hcmllcy97YmluYXJ5SWR9LicpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBtb2RhbFJlZjogQnNNb2RhbFJlZixcbiAgICBwdWJsaWMgcmVwb3J0c1NlcnZpY2U6IFJlcG9ydHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgY3JvblNlcnZpY2U6IENyb25TZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuc2F2aW5nU3RhdHVzID0ge1xuICAgICAgaW5Qcm9ncmVzczogZmFsc2UsXG4gICAgICBkb25lOiBmYWxzZSxcbiAgICAgIGVycm9yOiBmYWxzZVxuICAgIH07XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLm9sZFNjaGVkdWxlID0gY2xvbmVEZWVwKHRoaXMuc2NoZWR1bGUpO1xuICAgIHRoaXMucG9wdWxhdGVFbWFpbEZpZWxkc0Zyb21TY2hlZHVsZSh0aGlzLnNjaGVkdWxlKTtcbiAgICB0aGlzLmNyb25FeHByZXNzaW9uID0gdGhpcy5jcm9uU2VydmljZS5nZW5lcmF0ZUNyb24odGhpcy5zY2hlZHVsZS5jcm9uQ29uZmlnKTtcbiAgICB0aGlzLnZhbGlkQ3JvbiA9IHRoaXMuY3JvblNlcnZpY2UudmFsaWRhdGVNb2RlbHMoXG4gICAgICB0aGlzLmNyb25TZXJ2aWNlLmdldEJhc2UodGhpcy5zY2hlZHVsZS5jcm9uQ29uZmlnKSxcbiAgICAgIHRoaXMuc2NoZWR1bGUuY3JvbkNvbmZpZ1xuICAgICk7XG4gIH1cblxuICBwb3B1bGF0ZUVtYWlsRmllbGRzRnJvbVNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSkge1xuICAgIGlmIChzY2hlZHVsZS5lbWFpbENvbmZpZy50byAmJiBzY2hlZHVsZS5lbWFpbENvbmZpZy50by5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZW1haWxUbyA9IHNjaGVkdWxlLmVtYWlsQ29uZmlnLnRvLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChzY2hlZHVsZS5lbWFpbENvbmZpZy5jYyAmJiBzY2hlZHVsZS5lbWFpbENvbmZpZy5jYy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZW1haWxDYyA9IHNjaGVkdWxlLmVtYWlsQ29uZmlnLmNjLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChzY2hlZHVsZS5lbWFpbENvbmZpZy5iY2MgJiYgc2NoZWR1bGUuZW1haWxDb25maWcuYmNjLmxlbmd0aCkge1xuICAgICAgdGhpcy5lbWFpbEJjYyA9IHNjaGVkdWxlLmVtYWlsQ29uZmlnLmJjYy50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcucmVwbHlUbykge1xuICAgICAgdGhpcy5lbWFpbFJlcGx5VG8gPSBzY2hlZHVsZS5lbWFpbENvbmZpZy5yZXBseVRvO1xuICAgIH1cbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcuc3ViamVjdCkge1xuICAgICAgdGhpcy5lbWFpbFN1YmplY3QgPSBzY2hlZHVsZS5lbWFpbENvbmZpZy5zdWJqZWN0O1xuICAgIH1cbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcudGV4dCkge1xuICAgICAgdGhpcy5lbWFpbFRleHQgPSBzY2hlZHVsZS5lbWFpbENvbmZpZy50ZXh0O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNhdmUoKSB7XG4gICAgdGhpcy5wb3B1bGF0ZVNjaGVkdWxlRnJvbUNyb25FeHByZXNzaW9uKCk7XG4gICAgdGhpcy5wb3B1bGF0ZVNjaGVkdWxlRnJvbUVtYWlsRmllbGRzKCk7XG5cbiAgICB0aGlzLnNhdmluZ1N0YXR1cy5pblByb2dyZXNzID0gdHJ1ZTtcbiAgICBsZXQgc3VjY2VzczogYm9vbGVhbiA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmFjdGlvblR5cGUgPT09IEFjdGlvblR5cGUuRURJVCkge1xuICAgICAgc3VjY2VzcyA9IGF3YWl0IHRoaXMucmVwb3J0c1NlcnZpY2UudXBkYXRlU2NoZWR1bGUoXG4gICAgICAgIHRoaXMub2xkU2NoZWR1bGUsXG4gICAgICAgIHRoaXMuc2NoZWR1bGUsXG4gICAgICAgIHRoaXMuZXhwb3J0SWRcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgY29uc3QgdGltZXN0YW1wID0gZGF0ZS5nZXRUaW1lKCk7XG4gICAgICB0aGlzLnNjaGVkdWxlLnRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICAgIHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnJlcG9ydHNTZXJ2aWNlLmFkZFNjaGVkdWxlKHRoaXMuc2NoZWR1bGUsIHRoaXMuZXhwb3J0SWQpO1xuICAgIH1cbiAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgdGhpcy5tb2RhbFJlZi5oaWRlKCk7XG4gICAgICAvLyBzaWduYWwgdG8gdGhlIHBhcmVudCBjb21wb25lbnQgdG8gdXBkYXRlIGxpc3RcbiAgICAgIHRoaXMuZW1pdHRlclBheWxvYWQuc3VjY2VzcyA9IHRydWU7XG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCh0aGlzLmVtaXR0ZXJQYXlsb2FkKTtcbiAgICB9XG4gICAgdGhpcy5zYXZpbmdTdGF0dXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMubW9kYWxSZWYuaGlkZSgpO1xuICB9XG5cbiAgZ2V0Q3Jvbihjcm9uOiBFbWl0dGVkQ3Jvbikge1xuICAgIHRoaXMudmFsaWRDcm9uID0gY3Jvbi52YWxpZDtcbiAgICBpZiAoY3Jvbi52YWxpZCkge1xuICAgICAgdGhpcy5jcm9uRXhwcmVzc2lvbiA9IGNyb24uY3JvbjtcbiAgICB9XG4gIH1cblxuICBwb3B1bGF0ZVNjaGVkdWxlRnJvbUNyb25FeHByZXNzaW9uKCkge1xuICAgIHRoaXMuc2NoZWR1bGUuY3JvbkNvbmZpZyA9IHRoaXMuY3JvblNlcnZpY2UuZ2VuZXJhdGVDcm9uQ29uZmlnKHRoaXMuY3JvbkV4cHJlc3Npb24pO1xuICB9XG5cbiAgY29udmVydFN0cmluZ09mRW1haWxzVG9BcnJheShzdHJpbmdPZkVtYWlsczogc3RyaW5nKSB7XG4gICAgY29uc3QgYXJyID0gW107XG4gICAgaWYgKHN0cmluZ09mRW1haWxzKSB7XG4gICAgICBjb25zdCBwYXJ0cyA9IHN0cmluZ09mRW1haWxzLnNwbGl0KCcsJyk7XG4gICAgICBwYXJ0cy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgIGFyci5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGFycjtcbiAgfVxuXG4gIHBvcHVsYXRlU2NoZWR1bGVGcm9tRW1haWxGaWVsZHMoKSB7XG4gICAgdGhpcy5zY2hlZHVsZS5lbWFpbENvbmZpZy50byA9IHRoaXMuZW1haWxUb1xuICAgICAgPyB0aGlzLmNvbnZlcnRTdHJpbmdPZkVtYWlsc1RvQXJyYXkodGhpcy5lbWFpbFRvKVxuICAgICAgOiBudWxsO1xuICAgIHRoaXMuc2NoZWR1bGUuZW1haWxDb25maWcuY2MgPSB0aGlzLmVtYWlsQ2NcbiAgICAgID8gdGhpcy5jb252ZXJ0U3RyaW5nT2ZFbWFpbHNUb0FycmF5KHRoaXMuZW1haWxDYylcbiAgICAgIDogbnVsbDtcbiAgICB0aGlzLnNjaGVkdWxlLmVtYWlsQ29uZmlnLmJjYyA9IHRoaXMuZW1haWxCY2NcbiAgICAgID8gdGhpcy5jb252ZXJ0U3RyaW5nT2ZFbWFpbHNUb0FycmF5KHRoaXMuZW1haWxCY2MpXG4gICAgICA6IG51bGw7XG4gICAgdGhpcy5zY2hlZHVsZS5lbWFpbENvbmZpZy5yZXBseVRvID0gdGhpcy5lbWFpbFJlcGx5VG87XG4gICAgdGhpcy5zY2hlZHVsZS5lbWFpbENvbmZpZy5zdWJqZWN0ID0gdGhpcy5lbWFpbFN1YmplY3Q7XG4gICAgdGhpcy5zY2hlZHVsZS5lbWFpbENvbmZpZy50ZXh0ID0gdGhpcy5lbWFpbFRleHQ7XG4gIH1cbn1cbiJdfQ==