import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { IEvent, IManagedObject, Realtime } from '@c8y/client';
import { DeviceConfigurationService } from './device-configuration.service';
import { gettext } from '@c8y/ngx-components';
let DeviceConfigurationComponent = class DeviceConfigurationComponent {
    constructor(route, deviceConfigurationService, realtime) {
        this.route = route;
        this.deviceConfigurationService = deviceConfigurationService;
        this.realtime = realtime;
        this.configSnapshot = {};
        this.deviceConfigurationService.repositoryConfigListUpdated.subscribe(() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.repositorySnapshot = undefined;
            this.repositorySnapshots = yield this.getSnapshotsFromRepository(this.device.type, this.configurationType);
        }));
    }
    ngOnInit() {
        this.device = this.route.snapshot.parent.data.contextData;
        this.supportedConfigurations = this.device.c8y_SupportedConfigurations.map(item => ({
            name: item
        }));
        this.repositorySnapshotsEmptyState = {
            icon: 'gears',
            title: gettext('No configurations available.'),
            text: gettext('Add configuration to configuration repository')
        };
        const eventsChannel = '/eventsWithChildren/' + this.device.id;
        this.eventsSubscription = this.realtime.observable(eventsChannel).subscribe(({ data }) => {
            this.updateConfigSnapshotOnEvent(data);
        });
    }
    onConfigTypeSelected(config) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.configurationType = undefined;
            this.repositorySnapshot = undefined;
            this.configSnapshot = {};
            const configEvent = yield this.deviceConfigurationService.getLatestConfigurationEvent(this.device.id, config.name);
            this.updateConfigSnapshotOnEvent(configEvent, config.name);
            this.configurationType = config.name;
            this.repositorySnapshots = yield this.getSnapshotsFromRepository(this.device.type, config.name);
        });
    }
    getSnapshotsFromRepository(deviceType, configurationType) {
        return this.deviceConfigurationService.getSnapshotsFromRepository(deviceType, configurationType);
    }
    updateConfigSnapshotOnEvent(event, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const type = configurationType || this.configurationType;
            if (event && event.type === type) {
                this.configSnapshot = {
                    time: event.time,
                    name: event.text,
                    deviceType: this.device.deviceType,
                    configurationType: type
                };
                this.configSnapshot.binary = yield this.deviceConfigurationService.getEventConfigurationBinary(event);
            }
        });
    }
    onRepositoryConfigSelected(config) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.repositorySnapshot = {
                time: config.creationTime,
                name: config.name,
                binaryUrl: config.url,
                deviceType: config.deviceType,
                configurationType: config.configurationType
            };
            if (config.url) {
                this.repositorySnapshot.binary = yield this.deviceConfigurationService.getConfigurationBinaryFile(config.url);
            }
        });
    }
    ngOnDestroy() {
        this.eventsSubscription.unsubscribe();
    }
};
DeviceConfigurationComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: DeviceConfigurationService },
    { type: Realtime }
];
DeviceConfigurationComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-device-configuration',
        template: "<div class=\"card card--grid card--grid--fullpage grid__col--4-8 grid__row--6-6\">\n  <!-- DEVICE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-header separator\">\n      <h4 class=\"card-title\" translate>Configurations</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Device-supported configurations</span></h5>\n    </div>\n    <div class=\"p-r-16\">\n      <c8y-device-configuration-list\n        [items]=\"supportedConfigurations\"\n        [itemIcon]=\"'gears'\"\n        (configSelected)=\"onConfigTypeSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-header separator bg-gray-lighter hidden-xs hidden-sm\">\n      <h4>&nbsp;</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Preview</span></h5>\n\n      <!-- EMPTY STATE -->\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small translate>Select a configuration to preview</small>\n        </p>\n      </div>\n\n      <!-- PREVIEW AVAILABLE STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"configurationType\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"configSnapshot\"\n        [canSaveSnapshot]=\"true\"\n        [operationToTrigger]=\"'c8y_UploadConfigFile'\"\n        [actionButtonText]=\"'Get snapshot from device' | translate\"\n        [actionButtonIcon]=\"'download'\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n\n  <!-- AVAILABLE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Available supported configurations</h5>\n    </div>\n\n    <!-- EMPTY STATE -->\n    <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n      <h1 [c8yIcon]=\"'gears'\"></h1>\n      <p>\n        <strong translate>No selection</strong><br />\n        <small translate>Select a configuration from the device-supported configuration list</small>\n      </p>\n    </div>\n    <div class=\"p-r-16\" *ngIf=\"configurationType\">\n      <c8y-device-configuration-list\n        [items]=\"repositorySnapshots\"\n        [itemIcon]=\"'file-text'\"\n        [emptyState]=\"repositorySnapshotsEmptyState\"\n        [isFilterEnabled]=\"true\"\n        (configSelected)=\"onRepositoryConfigSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Preview</h5>\n\n      <!-- EMPTY STATE -->\n\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!repositorySnapshot\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small *ngIf=\"!configurationType; else noSnapshot\" translate\n            >Select a configuration to preview</small\n          >\n          <ng-template #noSnapshot>\n            <small translate>Select the configuration you want to preview</small>\n          </ng-template>\n        </p>\n      </div>\n\n      <!-- CONFIGURATION SELECTED STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"repositorySnapshot\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"repositorySnapshot\"\n        [operationToTrigger]=\"'c8y_DownloadConfigFile'\"\n        [actionButtonText]=\"'Send configuration to device' | translate\"\n        [actionButtonIcon]=\"'upload'\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n</div>\n"
    })
], DeviceConfigurationComponent);
export { DeviceConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9kZXZpY2UtY29uZmlndXJhdGlvbi8iLCJzb3VyY2VzIjpbImRldmljZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU81RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFNOUMsSUFBYSw0QkFBNEIsR0FBekMsTUFBYSw0QkFBNEI7SUFXdkMsWUFDVSxLQUFxQixFQUNyQiwwQkFBc0QsRUFDdEQsUUFBa0I7UUFGbEIsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFDckIsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBWDVCLG1CQUFjLEdBQW1DLEVBQUUsQ0FBQztRQWFsRCxJQUFJLENBQUMsMEJBQTBCLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDLEdBQVMsRUFBRTtZQUMvRSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsU0FBUyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQ2hCLElBQUksQ0FBQyxpQkFBaUIsQ0FDdkIsQ0FBQztRQUNKLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUQsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsMkJBQTJCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNsRixJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxDQUFDLDZCQUE2QixHQUFHO1lBQ25DLElBQUksRUFBRSxPQUFPO1lBQ2IsS0FBSyxFQUFFLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQztZQUM5QyxJQUFJLEVBQUUsT0FBTyxDQUFDLCtDQUErQyxDQUFDO1NBQy9ELENBQUM7UUFDRixNQUFNLGFBQWEsR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUM5RCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQ3ZGLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFSyxvQkFBb0IsQ0FBQyxNQUFNOztZQUMvQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsU0FBUyxDQUFDO1lBQ25DLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7WUFDcEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7WUFFekIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsMEJBQTBCLENBQUMsMkJBQTJCLENBQ25GLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUNkLE1BQU0sQ0FBQyxJQUFJLENBQ1osQ0FBQztZQUNGLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTNELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEcsQ0FBQztLQUFBO0lBRUQsMEJBQTBCLENBQUMsVUFBVSxFQUFFLGlCQUFpQjtRQUN0RCxPQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQywwQkFBMEIsQ0FDL0QsVUFBVSxFQUNWLGlCQUFpQixDQUNsQixDQUFDO0lBQ0osQ0FBQztJQUVLLDJCQUEyQixDQUFDLEtBQWEsRUFBRSxpQkFBa0I7O1lBQ2pFLE1BQU0sSUFBSSxHQUFHLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztZQUN6RCxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRTtnQkFDaEMsSUFBSSxDQUFDLGNBQWMsR0FBRztvQkFDcEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO29CQUNoQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7b0JBQ2hCLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7b0JBQ2xDLGlCQUFpQixFQUFFLElBQUk7aUJBQ3hCLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsMEJBQTBCLENBQUMsMkJBQTJCLENBQzVGLEtBQUssQ0FDTixDQUFDO2FBQ0g7UUFDSCxDQUFDO0tBQUE7SUFFSywwQkFBMEIsQ0FBQyxNQUFNOztZQUNyQyxJQUFJLENBQUMsa0JBQWtCLEdBQUc7Z0JBQ3hCLElBQUksRUFBRSxNQUFNLENBQUMsWUFBWTtnQkFDekIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO2dCQUNqQixTQUFTLEVBQUUsTUFBTSxDQUFDLEdBQUc7Z0JBQ3JCLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVTtnQkFDN0IsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLGlCQUFpQjthQUM1QyxDQUFDO1lBQ0YsSUFBSSxNQUFNLENBQUMsR0FBRyxFQUFFO2dCQUNkLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsMEJBQTBCLENBQUMsMEJBQTBCLENBQy9GLE1BQU0sQ0FBQyxHQUFHLENBQ1gsQ0FBQzthQUNIO1FBQ0gsQ0FBQztLQUFBO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0NBQ0YsQ0FBQTs7WUFyRmtCLGNBQWM7WUFDTywwQkFBMEI7WUFDNUMsUUFBUTs7QUFkakIsNEJBQTRCO0lBSnhDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSwwQkFBMEI7UUFDcEMsaS9IQUFvRDtLQUNyRCxDQUFDO0dBQ1csNEJBQTRCLENBaUd4QztTQWpHWSw0QkFBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBJRXZlbnQsIElNYW5hZ2VkT2JqZWN0LCBSZWFsdGltZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9kZXZpY2UtY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIENvbmZpZ3VyYXRpb25MaXN0RW1wdHlTdGF0ZSxcbiAgQ29uZmlndXJhdGlvblNuYXBzaG90LFxuICBTdXBwb3J0ZWRDb25maWd1cmF0aW9uSXRlbVxufSBmcm9tICcuL2RldmljZS1jb25maWd1cmF0aW9uLm1vZGVsJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktZGV2aWNlLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERldmljZUNvbmZpZ3VyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHN1cHBvcnRlZENvbmZpZ3VyYXRpb25zOiBTdXBwb3J0ZWRDb25maWd1cmF0aW9uSXRlbVtdO1xuICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nO1xuICBjb25maWdTbmFwc2hvdDogUGFydGlhbDxDb25maWd1cmF0aW9uU25hcHNob3Q+ID0ge307XG4gIHJlcG9zaXRvcnlTbmFwc2hvdHM6IElNYW5hZ2VkT2JqZWN0W107XG4gIHJlcG9zaXRvcnlTbmFwc2hvdDogQ29uZmlndXJhdGlvblNuYXBzaG90O1xuICByZXBvc2l0b3J5U25hcHNob3RzRW1wdHlTdGF0ZTogQ29uZmlndXJhdGlvbkxpc3RFbXB0eVN0YXRlO1xuICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuXG4gIHByaXZhdGUgZXZlbnRzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBkZXZpY2VDb25maWd1cmF0aW9uU2VydmljZTogRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFsdGltZTogUmVhbHRpbWVcbiAgKSB7XG4gICAgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5yZXBvc2l0b3J5Q29uZmlnTGlzdFVwZGF0ZWQuc3Vic2NyaWJlKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90ID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3RzID0gYXdhaXQgdGhpcy5nZXRTbmFwc2hvdHNGcm9tUmVwb3NpdG9yeShcbiAgICAgICAgdGhpcy5kZXZpY2UudHlwZSxcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uVHlwZVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZGV2aWNlID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJlbnQuZGF0YS5jb250ZXh0RGF0YTtcbiAgICB0aGlzLnN1cHBvcnRlZENvbmZpZ3VyYXRpb25zID0gdGhpcy5kZXZpY2UuYzh5X1N1cHBvcnRlZENvbmZpZ3VyYXRpb25zLm1hcChpdGVtID0+ICh7XG4gICAgICBuYW1lOiBpdGVtXG4gICAgfSkpO1xuXG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3RzRW1wdHlTdGF0ZSA9IHtcbiAgICAgIGljb246ICdnZWFycycsXG4gICAgICB0aXRsZTogZ2V0dGV4dCgnTm8gY29uZmlndXJhdGlvbnMgYXZhaWxhYmxlLicpLFxuICAgICAgdGV4dDogZ2V0dGV4dCgnQWRkIGNvbmZpZ3VyYXRpb24gdG8gY29uZmlndXJhdGlvbiByZXBvc2l0b3J5JylcbiAgICB9O1xuICAgIGNvbnN0IGV2ZW50c0NoYW5uZWwgPSAnL2V2ZW50c1dpdGhDaGlsZHJlbi8nICsgdGhpcy5kZXZpY2UuaWQ7XG4gICAgdGhpcy5ldmVudHNTdWJzY3JpcHRpb24gPSB0aGlzLnJlYWx0aW1lLm9ic2VydmFibGUoZXZlbnRzQ2hhbm5lbCkuc3Vic2NyaWJlKCh7IGRhdGEgfSkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVDb25maWdTbmFwc2hvdE9uRXZlbnQoZGF0YSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBvbkNvbmZpZ1R5cGVTZWxlY3RlZChjb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25UeXBlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY29uZmlnU25hcHNob3QgPSB7fTtcblxuICAgIGNvbnN0IGNvbmZpZ0V2ZW50ID0gYXdhaXQgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5nZXRMYXRlc3RDb25maWd1cmF0aW9uRXZlbnQoXG4gICAgICB0aGlzLmRldmljZS5pZCxcbiAgICAgIGNvbmZpZy5uYW1lXG4gICAgKTtcbiAgICB0aGlzLnVwZGF0ZUNvbmZpZ1NuYXBzaG90T25FdmVudChjb25maWdFdmVudCwgY29uZmlnLm5hbWUpO1xuXG4gICAgdGhpcy5jb25maWd1cmF0aW9uVHlwZSA9IGNvbmZpZy5uYW1lO1xuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90cyA9IGF3YWl0IHRoaXMuZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkodGhpcy5kZXZpY2UudHlwZSwgY29uZmlnLm5hbWUpO1xuICB9XG5cbiAgZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkoZGV2aWNlVHlwZSwgY29uZmlndXJhdGlvblR5cGUpIHtcbiAgICByZXR1cm4gdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5nZXRTbmFwc2hvdHNGcm9tUmVwb3NpdG9yeShcbiAgICAgIGRldmljZVR5cGUsXG4gICAgICBjb25maWd1cmF0aW9uVHlwZVxuICAgICk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVDb25maWdTbmFwc2hvdE9uRXZlbnQoZXZlbnQ6IElFdmVudCwgY29uZmlndXJhdGlvblR5cGU/KSB7XG4gICAgY29uc3QgdHlwZSA9IGNvbmZpZ3VyYXRpb25UeXBlIHx8IHRoaXMuY29uZmlndXJhdGlvblR5cGU7XG4gICAgaWYgKGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09IHR5cGUpIHtcbiAgICAgIHRoaXMuY29uZmlnU25hcHNob3QgPSB7XG4gICAgICAgIHRpbWU6IGV2ZW50LnRpbWUsXG4gICAgICAgIG5hbWU6IGV2ZW50LnRleHQsXG4gICAgICAgIGRldmljZVR5cGU6IHRoaXMuZGV2aWNlLmRldmljZVR5cGUsXG4gICAgICAgIGNvbmZpZ3VyYXRpb25UeXBlOiB0eXBlXG4gICAgICB9O1xuICAgICAgdGhpcy5jb25maWdTbmFwc2hvdC5iaW5hcnkgPSBhd2FpdCB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmdldEV2ZW50Q29uZmlndXJhdGlvbkJpbmFyeShcbiAgICAgICAgZXZlbnRcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgb25SZXBvc2l0b3J5Q29uZmlnU2VsZWN0ZWQoY29uZmlnKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3QgPSB7XG4gICAgICB0aW1lOiBjb25maWcuY3JlYXRpb25UaW1lLFxuICAgICAgbmFtZTogY29uZmlnLm5hbWUsXG4gICAgICBiaW5hcnlVcmw6IGNvbmZpZy51cmwsXG4gICAgICBkZXZpY2VUeXBlOiBjb25maWcuZGV2aWNlVHlwZSxcbiAgICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBjb25maWcuY29uZmlndXJhdGlvblR5cGVcbiAgICB9O1xuICAgIGlmIChjb25maWcudXJsKSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdC5iaW5hcnkgPSBhd2FpdCB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmdldENvbmZpZ3VyYXRpb25CaW5hcnlGaWxlKFxuICAgICAgICBjb25maWcudXJsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZXZlbnRzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==