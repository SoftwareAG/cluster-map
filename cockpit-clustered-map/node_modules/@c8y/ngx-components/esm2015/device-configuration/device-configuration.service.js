import * as tslib_1 from "tslib";
import { EventEmitter, Injectable } from '@angular/core';
import { EventBinaryService, EventService, IEvent, IManagedObject, InventoryBinaryService, InventoryService, IOperation, OperationService } from '@c8y/client';
import { AlertService, gettext } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
let DeviceConfigurationService = class DeviceConfigurationService {
    constructor(eventService, eventBinaryService, operationService, alertService, inventoryService, inventoryBinaryService, translateService) {
        this.eventService = eventService;
        this.eventBinaryService = eventBinaryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.inventoryService = inventoryService;
        this.inventoryBinaryService = inventoryBinaryService;
        this.translateService = translateService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.repositoryConfigListUpdated = new EventEmitter();
    }
    getLatestConfigurationEvent(deviceId, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filter = {
                source: deviceId,
                type,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                pageSize: 1
            };
            const { data } = yield this.eventService.list(filter);
            return data[0];
        });
    }
    getEventConfigurationBinary(event) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let binary;
            try {
                const res = yield this.eventBinaryService.download(event);
                binary = res.text();
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return binary;
        });
    }
    createUploadConfigFileOperation(device, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let operation;
            const operationText = gettext('Retrieve {{ configurationType }} configuration snapshot from device {{ deviceName }}');
            const operationCfg = {
                deviceId: device.id,
                c8y_UploadConfigFile: {
                    type: configurationType
                },
                description: this.translateService.instant(operationText, {
                    configurationType,
                    deviceName: device.name
                })
            };
            try {
                const { data } = yield this.operationService.create(operationCfg);
                operation = data;
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return operation;
        });
    }
    getLatestConfigFileOperation(deviceId, configType, operationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filter = {
                deviceId,
                fragmentType: operationType,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 2000
            };
            const { data } = yield this.operationService.list(filter);
            return data.find(op => op[operationType].type === configType);
        });
    }
    getSnapshotsFromRepository(deviceType, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let query;
            const filter = {
                pageSize: 2000,
                withTotalPages: true
            };
            query = {
                __filter: {
                    __and: [
                        {
                            type: 'c8y_ConfigurationDump'
                        },
                        {
                            __or: [
                                { configurationType: { __eq: configurationType } },
                                {
                                    __not: {
                                        __has: 'configurationType'
                                    }
                                }
                            ]
                        }
                    ]
                },
                __orderby: [{ configurationType: -1, name: 1 }]
            };
            if (deviceType) {
                const deviceTypeFilter = {
                    __or: [
                        { deviceType: { __eq: deviceType } },
                        {
                            __not: {
                                __has: 'deviceType'
                            }
                        }
                    ]
                };
                query.__filter.__and.push(deviceTypeFilter);
            }
            return (yield this.inventoryService.listQuery(query, filter)).data;
        });
    }
    createDownloadConfigFileOperation(device, configurationType, binaryUrl) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let operation;
            const operationText = gettext('Send configuration {{ configurationType }} to device {{ deviceName }}');
            const operationCfg = {
                deviceId: device.id,
                c8y_DownloadConfigFile: {
                    url: binaryUrl,
                    type: configurationType
                },
                description: this.translateService.instant(operationText, {
                    configurationType,
                    deviceName: device.name
                })
            };
            try {
                const { data } = yield this.operationService.create(operationCfg);
                operation = data;
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return operation;
        });
    }
    getConfigurationBinaryFile(url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let binary;
            const moId = this.inventoryBinaryService.getIdFromUrl(url);
            if (moId) {
                const binaryMO = (yield this.inventoryService.detail(moId)).data;
                const res = yield this.inventoryBinaryService.download(binaryMO);
                binary = yield res.text();
            }
            else {
                binary = this.fetchExternalBinary(url);
            }
            return binary;
        });
    }
    saveToConfigurationRepository(config) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const mo = {};
            Object.assign(mo, {
                name: config.name,
                type: 'c8y_ConfigurationDump',
                deviceType: config.deviceType,
                configurationType: config.configurationType,
                c8y_Global: {}
            });
            const response = yield this.inventoryBinaryService.create(new Blob([config.binary]), {
                c8y_Global: {}
            });
            mo.url = response.data.self;
            return this.inventoryService.create(mo);
        });
    }
    updateRepositoryConfigList() {
        this.repositoryConfigListUpdated.emit();
    }
    fetchExternalBinary(url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let configBinary;
            try {
                const res = yield fetch(url);
                if (res.status === 200) {
                    configBinary = yield res.text();
                }
            }
            catch (ex) {
                // do nothing
            }
            return configBinary;
        });
    }
};
DeviceConfigurationService.ctorParameters = () => [
    { type: EventService },
    { type: EventBinaryService },
    { type: OperationService },
    { type: AlertService },
    { type: InventoryService },
    { type: InventoryBinaryService },
    { type: TranslateService }
];
DeviceConfigurationService = tslib_1.__decorate([
    Injectable()
], DeviceConfigurationService);
export { DeviceConfigurationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWNvbmZpZ3VyYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLWNvbmZpZ3VyYXRpb24vIiwic291cmNlcyI6WyJkZXZpY2UtY29uZmlndXJhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFlBQVksRUFDWixNQUFNLEVBQ04sY0FBYyxFQUNkLHNCQUFzQixFQUN0QixnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLGdCQUFnQixFQUNqQixNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzVELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3ZELElBQWEsMEJBQTBCLEdBQXZDLE1BQWEsMEJBQTBCO0lBS3JDLFlBQ1UsWUFBMEIsRUFDMUIsa0JBQXNDLEVBQ3RDLGdCQUFrQyxFQUNsQyxZQUEwQixFQUMxQixnQkFBa0MsRUFDbEMsc0JBQThDLEVBQzlDLGdCQUFrQztRQU5sQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFYbkMsYUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLFdBQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdB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QixZQUFZO1lBQ04sa0JBQWtCO1lBQ3BCLGdCQUFnQjtZQUNwQixZQUFZO1lBQ1IsZ0JBQWdCO1lBQ1Ysc0JBQXNCO1lBQzVCLGdCQUFnQjs7QUFaakMsMEJBQTBCO0lBRHRDLFVBQVUsRUFBRTtHQUNBLDBCQUEwQixDQStMdEM7U0EvTFksMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBFdmVudEJpbmFyeVNlcnZpY2UsXG4gIEV2ZW50U2VydmljZSxcbiAgSUV2ZW50LFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgT3BlcmF0aW9uU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZGF0ZUZyb20gPSBuZXcgRGF0ZSgwKTtcbiAgcmVhZG9ubHkgZGF0ZVRvID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDg2NDAwMDAwKTsgLy8gMSBkYXkgaW4gdGhlIGZ1dHVyZVxuICByZXBvc2l0b3J5Q29uZmlnTGlzdFVwZGF0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGV2ZW50U2VydmljZTogRXZlbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXZlbnRCaW5hcnlTZXJ2aWNlOiBFdmVudEJpbmFyeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgaW52ZW50b3J5QmluYXJ5U2VydmljZTogSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIGdldExhdGVzdENvbmZpZ3VyYXRpb25FdmVudChkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyLCB0eXBlOiBzdHJpbmcpOiBQcm9taXNlPElFdmVudD4ge1xuICAgIGNvbnN0IGZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgc291cmNlOiBkZXZpY2VJZCxcbiAgICAgIHR5cGUsXG4gICAgICBkYXRlRnJvbTogdGhpcy5kYXRlRnJvbS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0ZVRvOiB0aGlzLmRhdGVUby50b0lTT1N0cmluZygpLFxuICAgICAgcGFnZVNpemU6IDFcbiAgICB9O1xuXG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmV2ZW50U2VydmljZS5saXN0KGZpbHRlcik7XG4gICAgcmV0dXJuIGRhdGFbMF07XG4gIH1cblxuICBhc3luYyBnZXRFdmVudENvbmZpZ3VyYXRpb25CaW5hcnkoZXZlbnQ6IElFdmVudCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgbGV0IGJpbmFyeTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5ldmVudEJpbmFyeVNlcnZpY2UuZG93bmxvYWQoZXZlbnQpO1xuICAgICAgYmluYXJ5ID0gcmVzLnRleHQoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICAgIHJldHVybiBiaW5hcnk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVVcGxvYWRDb25maWdGaWxlT3BlcmF0aW9uKGRldmljZSwgY29uZmlndXJhdGlvblR5cGUpIHtcbiAgICBsZXQgb3BlcmF0aW9uO1xuICAgIGNvbnN0IG9wZXJhdGlvblRleHQgPSBnZXR0ZXh0KFxuICAgICAgJ1JldHJpZXZlIHt7IGNvbmZpZ3VyYXRpb25UeXBlIH19IGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZnJvbSBkZXZpY2Uge3sgZGV2aWNlTmFtZSB9fSdcbiAgICApO1xuICAgIGNvbnN0IG9wZXJhdGlvbkNmZzogSU9wZXJhdGlvbiA9IHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBjOHlfVXBsb2FkQ29uZmlnRmlsZToge1xuICAgICAgICB0eXBlOiBjb25maWd1cmF0aW9uVHlwZVxuICAgICAgfSxcbiAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChvcGVyYXRpb25UZXh0LCB7XG4gICAgICAgIGNvbmZpZ3VyYXRpb25UeXBlLFxuICAgICAgICBkZXZpY2VOYW1lOiBkZXZpY2UubmFtZVxuICAgICAgfSlcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb25DZmcpO1xuICAgICAgb3BlcmF0aW9uID0gZGF0YTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICBhc3luYyBnZXRMYXRlc3RDb25maWdGaWxlT3BlcmF0aW9uKGRldmljZUlkLCBjb25maWdUeXBlLCBvcGVyYXRpb25UeXBlKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgY29uc3QgZmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGZyYWdtZW50VHlwZTogb3BlcmF0aW9uVHlwZSxcbiAgICAgIGRhdGVGcm9tOiB0aGlzLmRhdGVGcm9tLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IHRoaXMuZGF0ZVRvLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMjAwMFxuICAgIH07XG5cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMub3BlcmF0aW9uU2VydmljZS5saXN0KGZpbHRlcik7XG4gICAgcmV0dXJuIGRhdGEuZmluZChvcCA9PiBvcFtvcGVyYXRpb25UeXBlXS50eXBlID09PSBjb25maWdUeXBlKTtcbiAgfVxuXG4gIGFzeW5jIGdldFNuYXBzaG90c0Zyb21SZXBvc2l0b3J5KGRldmljZVR5cGUsIGNvbmZpZ3VyYXRpb25UeXBlKTogUHJvbWlzZTxJTWFuYWdlZE9iamVjdFtdPiB7XG4gICAgbGV0IHF1ZXJ5OiBhbnk7XG4gICAgY29uc3QgZmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBwYWdlU2l6ZTogMjAwMCxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlXG4gICAgfTtcbiAgICBxdWVyeSA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIF9fYW5kOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ2M4eV9Db25maWd1cmF0aW9uRHVtcCdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIF9fb3I6IFtcbiAgICAgICAgICAgICAgeyBjb25maWd1cmF0aW9uVHlwZTogeyBfX2VxOiBjb25maWd1cmF0aW9uVHlwZSB9IH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBfX25vdDoge1xuICAgICAgICAgICAgICAgICAgX19oYXM6ICdjb25maWd1cmF0aW9uVHlwZSdcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgICBfX29yZGVyYnk6IFt7IGNvbmZpZ3VyYXRpb25UeXBlOiAtMSwgbmFtZTogMSB9XVxuICAgIH07XG5cbiAgICBpZiAoZGV2aWNlVHlwZSkge1xuICAgICAgY29uc3QgZGV2aWNlVHlwZUZpbHRlciA9IHtcbiAgICAgICAgX19vcjogW1xuICAgICAgICAgIHsgZGV2aWNlVHlwZTogeyBfX2VxOiBkZXZpY2VUeXBlIH0gfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBfX25vdDoge1xuICAgICAgICAgICAgICBfX2hhczogJ2RldmljZVR5cGUnXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9O1xuICAgICAgcXVlcnkuX19maWx0ZXIuX19hbmQucHVzaChkZXZpY2VUeXBlRmlsdGVyKTtcbiAgICB9XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXIpKS5kYXRhO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlRG93bmxvYWRDb25maWdGaWxlT3BlcmF0aW9uKGRldmljZSwgY29uZmlndXJhdGlvblR5cGUsIGJpbmFyeVVybCkge1xuICAgIGxldCBvcGVyYXRpb247XG4gICAgY29uc3Qgb3BlcmF0aW9uVGV4dCA9IGdldHRleHQoXG4gICAgICAnU2VuZCBjb25maWd1cmF0aW9uIHt7IGNvbmZpZ3VyYXRpb25UeXBlIH19IHRvIGRldmljZSB7eyBkZXZpY2VOYW1lIH19J1xuICAgICk7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnOiBJT3BlcmF0aW9uID0ge1xuICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgIGM4eV9Eb3dubG9hZENvbmZpZ0ZpbGU6IHtcbiAgICAgICAgdXJsOiBiaW5hcnlVcmwsXG4gICAgICAgIHR5cGU6IGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9LFxuICAgICAgZGVzY3JpcHRpb246IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KG9wZXJhdGlvblRleHQsIHtcbiAgICAgICAgY29uZmlndXJhdGlvblR5cGUsXG4gICAgICAgIGRldmljZU5hbWU6IGRldmljZS5uYW1lXG4gICAgICB9KVxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb25DZmcpO1xuICAgICAgb3BlcmF0aW9uID0gZGF0YTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICBhc3luYyBnZXRDb25maWd1cmF0aW9uQmluYXJ5RmlsZSh1cmwpIHtcbiAgICBsZXQgYmluYXJ5O1xuICAgIGNvbnN0IG1vSWQgPSB0aGlzLmludmVudG9yeUJpbmFyeVNlcnZpY2UuZ2V0SWRGcm9tVXJsKHVybCk7XG4gICAgaWYgKG1vSWQpIHtcbiAgICAgIGNvbnN0IGJpbmFyeU1PID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwobW9JZCkpLmRhdGE7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeVNlcnZpY2UuZG93bmxvYWQoYmluYXJ5TU8pO1xuICAgICAgYmluYXJ5ID0gYXdhaXQgcmVzLnRleHQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYmluYXJ5ID0gdGhpcy5mZXRjaEV4dGVybmFsQmluYXJ5KHVybCk7XG4gICAgfVxuICAgIHJldHVybiBiaW5hcnk7XG4gIH1cblxuICBhc3luYyBzYXZlVG9Db25maWd1cmF0aW9uUmVwb3NpdG9yeShjb25maWcpIHtcbiAgICBjb25zdCBtbzogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7fTtcbiAgICBPYmplY3QuYXNzaWduKG1vLCB7XG4gICAgICBuYW1lOiBjb25maWcubmFtZSxcbiAgICAgIHR5cGU6ICdjOHlfQ29uZmlndXJhdGlvbkR1bXAnLFxuICAgICAgZGV2aWNlVHlwZTogY29uZmlnLmRldmljZVR5cGUsXG4gICAgICBjb25maWd1cmF0aW9uVHlwZTogY29uZmlnLmNvbmZpZ3VyYXRpb25UeXBlLFxuICAgICAgYzh5X0dsb2JhbDoge31cbiAgICB9KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5U2VydmljZS5jcmVhdGUobmV3IEJsb2IoW2NvbmZpZy5iaW5hcnldKSwge1xuICAgICAgYzh5X0dsb2JhbDoge31cbiAgICB9KTtcbiAgICBtby51cmwgPSByZXNwb25zZS5kYXRhLnNlbGY7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUobW8pO1xuICB9XG5cbiAgdXBkYXRlUmVwb3NpdG9yeUNvbmZpZ0xpc3QoKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5Q29uZmlnTGlzdFVwZGF0ZWQuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmZXRjaEV4dGVybmFsQmluYXJ5KHVybCkge1xuICAgIGxldCBjb25maWdCaW5hcnk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgIGNvbmZpZ0JpbmFyeSA9IGF3YWl0IHJlcy50ZXh0KCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ0JpbmFyeTtcbiAgfVxufVxuIl19