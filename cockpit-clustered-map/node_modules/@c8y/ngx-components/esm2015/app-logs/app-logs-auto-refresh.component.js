import * as tslib_1 from "tslib";
import { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';
import { AppLogsService } from './app-logs.service';
import { fromEvent, Subject, of, interval, NEVER } from 'rxjs';
import { filter, catchError, tap, debounce, switchMap, takeUntil, finalize, delay, repeat, merge, scan } from 'rxjs/operators';
let AppLogsAutoRefreshComponent = class AppLogsAutoRefreshComponent {
    constructor(appLogsService) {
        this.appLogsService = appLogsService;
        this.cancel$ = new Subject();
        this.isAutoRefreshDisabled = false;
        this.logsToOutput = this.getEmptyLogsJson();
        this.isAutoRefreshOn = false;
        this.onNewLogs = new EventEmitter();
        this.toggleState = currentState => !currentState;
    }
    set buttonsDisabled(areDisabled) {
        this.isAutoRefreshDisabled = areDisabled;
        if (areDisabled && this.isAutoRefreshOn) {
            this.cancel$.next(false);
        }
    }
    ngAfterViewInit() {
        const clicks$ = fromEvent(this.button.nativeElement, 'click').pipe(merge(this.cancel$), debounce(() => interval(300)), scan(this.toggleState, false), tap(isAutoRefreshOn => this.setButtonState(isAutoRefreshOn)), switchMap(isOn => (isOn ? this.watchForNewLogs() : NEVER)));
        this.subscription = clicks$.subscribe();
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
    setButtonState(isAutoRefreshOn) {
        this.isAutoRefreshOn = isAutoRefreshOn;
    }
    watchForNewLogs() {
        return this.startPolling().pipe(takeUntil(this.cancel$.pipe(filter(isAutoRefreshOn => isAutoRefreshOn === false))), finalize(() => {
            this.isAutoRefreshOn = false;
        }));
    }
    startPolling() {
        return of(1).pipe(switchMap(() => this.getNewLogs().pipe(catchError(er => of(this.getEmptyLogsJson())))), tap(logs => this.updateLogsToOutput(logs)), delay(10000), repeat());
    }
    getNewLogs() {
        return this.appLogsService.getLogs$(this.getAppId(), this.getInstanceName());
    }
    getAppId() {
        return this.mo.applicationId;
    }
    getInstanceName() {
        return this.selectedInstance.name;
    }
    updateLogsToOutput(newLogs) {
        const { dateFrom, dateTo } = newLogs;
        if (dateFrom && dateTo) {
            this.logsToOutput = Object.assign({}, newLogs);
            this.onNewLogs.emit(this.logsToOutput);
        }
    }
    getEmptyLogsJson() {
        return {
            dateFrom: null,
            dateTo: null,
            logs: '',
            truncated: false
        };
    }
};
AppLogsAutoRefreshComponent.ctorParameters = () => [
    { type: AppLogsService }
];
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "selectedInstance", void 0);
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "mo", void 0);
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "buttonsDisabled", null);
tslib_1.__decorate([
    Output()
], AppLogsAutoRefreshComponent.prototype, "onNewLogs", void 0);
tslib_1.__decorate([
    ViewChild('autoRefresh', { static: true })
], AppLogsAutoRefreshComponent.prototype, "button", void 0);
AppLogsAutoRefreshComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-app-logs-auto-refresh',
        template: "<button #autoRefresh\n  type=\"button\"\n  class=\"btn btn-link c8y-realtime\"\n  [ngStyle]=\"{'width': 'auto'}\"\n  title=\"{{'Toggle auto refresh' | translate}}\"\n  [disabled]=\"isAutoRefreshDisabled\"\n>\n  <span class=\"c8y-pulse\" [ngClass]=\"isAutoRefreshOn ? 'active' : 'inactive'\"></span>\n  {{'Auto refresh' | translate}}\n</button>"
    })
], AppLogsAutoRefreshComponent);
export { AppLogsAutoRefreshComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvYXBwLWxvZ3MvIiwic291cmNlcyI6WyJhcHAtbG9ncy1hdXRvLXJlZnJlc2guY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBYyxNQUFNLGVBQWUsQ0FBQztBQUU5RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFjLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3pGLE9BQU8sRUFDTCxNQUFNLEVBQ04sVUFBVSxFQUNWLEdBQUcsRUFDSCxRQUFRLEVBQ1IsU0FBUyxFQUNULFNBQVMsRUFDVCxRQUFRLEVBQ1IsS0FBSyxFQUNMLE1BQU0sRUFDTixLQUFLLEVBQ0wsSUFBSSxFQUNMLE1BQU0sZ0JBQWdCLENBQUM7QUFNeEIsSUFBYSwyQkFBMkIsR0FBeEMsTUFBYSwyQkFBMkI7SUFtQnRDLFlBQW9CLGNBQThCO1FBQTlCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQWxCbEQsWUFBTyxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ25ELDBCQUFxQixHQUFZLEtBQUssQ0FBQztRQUN2QyxpQkFBWSxHQUFhLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2pELG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBVXZCLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO1FBdUIzQyxnQkFBVyxHQUFHLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUM7SUFsQkMsQ0FBQztJQVg3QyxJQUFJLGVBQWUsQ0FBQyxXQUFvQjtRQUMvQyxJQUFJLENBQUMscUJBQXFCLEdB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QUM7U0FDeEM7SUFDSCxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLE9BQU87WUFDTCxRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1lBQ1osSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsS0FBSztTQUNqQixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7O1lBckVxQyxjQUFjOztBQWJ6QztJQUFSLEtBQUssRUFBRTtxRUFBdUI7QUFDdEI7SUFBUixLQUFLLEVBQUU7dURBQVM7QUFDUjtJQUFSLEtBQUssRUFBRTtrRUFLUDtBQUNTO0lBQVQsTUFBTSxFQUFFOzhEQUEwQztBQUNQO0lBQTNDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7MkRBQW9CO0FBZnBELDJCQUEyQjtJQUp2QyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsMkJBQTJCO1FBQ3JDLG1XQUFxRDtLQUN0RCxDQUFDO0dBQ1csMkJBQTJCLENBd0Z2QztTQXhGWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIFZpZXdDaGlsZCwgRXZlbnRFbWl0dGVyLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2dzSlNPTiB9IGZyb20gJy4vbG9ncy5tb2RlbCc7XG5pbXBvcnQgeyBBcHBMb2dzU2VydmljZSB9IGZyb20gJy4vYXBwLWxvZ3Muc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tRXZlbnQsIFN1YmplY3QsIG9mLCBpbnRlcnZhbCwgTkVWRVIsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZmlsdGVyLFxuICBjYXRjaEVycm9yLFxuICB0YXAsXG4gIGRlYm91bmNlLFxuICBzd2l0Y2hNYXAsXG4gIHRha2VVbnRpbCxcbiAgZmluYWxpemUsXG4gIGRlbGF5LFxuICByZXBlYXQsXG4gIG1lcmdlLFxuICBzY2FuXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFwcC1sb2dzLWF1dG8tcmVmcmVzaCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9hcHAtbG9ncy1hdXRvLXJlZnJlc2guY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEFwcExvZ3NBdXRvUmVmcmVzaENvbXBvbmVudCB7XG4gIGNhbmNlbCQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuICBpc0F1dG9SZWZyZXNoRGlzYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgbG9nc1RvT3V0cHV0OiBMb2dzSlNPTiA9IHRoaXMuZ2V0RW1wdHlMb2dzSnNvbigpO1xuICBpc0F1dG9SZWZyZXNoT246IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoKSBzZWxlY3RlZEluc3RhbmNlOiBhbnk7XG4gIEBJbnB1dCgpIG1vOiBhbnk7XG4gIEBJbnB1dCgpIHNldCBidXR0b25zRGlzYWJsZWQoYXJlRGlzYWJsZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlzQXV0b1JlZnJlc2hEaXNhYmxlZCA9IGFyZURpc2FibGVkO1xuICAgIGlmIChhcmVEaXNhYmxlZCAmJiB0aGlzLmlzQXV0b1JlZnJlc2hPbikge1xuICAgICAgdGhpcy5jYW5jZWwkLm5leHQoZmFsc2UpO1xuICAgIH1cbiAgfVxuICBAT3V0cHV0KCkgb25OZXdMb2dzID0gbmV3IEV2ZW50RW1pdHRlcjxMb2dzSlNPTj4oKTtcbiAgQFZpZXdDaGlsZCgnYXV0b1JlZnJlc2gnLCB7IHN0YXRpYzogdHJ1ZSB9KSBidXR0b246IEVsZW1lbnRSZWY7XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcExvZ3NTZXJ2aWNlOiBBcHBMb2dzU2VydmljZSkge31cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgY29uc3QgY2xpY2tzJCA9IGZyb21FdmVudCh0aGlzLmJ1dHRvbi5uYXRpdmVFbGVtZW50LCAnY2xpY2snKS5waXBlKFxuICAgICAgbWVyZ2UodGhpcy5jYW5jZWwkKSxcbiAgICAgIGRlYm91bmNlKCgpID0+IGludGVydmFsKDMwMCkpLFxuICAgICAgc2Nhbih0aGlzLnRvZ2dsZVN0YXRlLCBmYWxzZSksXG4gICAgICB0YXAoaXNBdXRvUmVmcmVzaE9uID0+IHRoaXMuc2V0QnV0dG9uU3RhdGUoaXNBdXRvUmVmcmVzaE9uKSksXG4gICAgICBzd2l0Y2hNYXAoaXNPbiA9PiAoaXNPbiA/IHRoaXMud2F0Y2hGb3JOZXdMb2dzKCkgOiBORVZFUikpXG4gICAgKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IGNsaWNrcyQuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgdG9nZ2xlU3RhdGUgPSBjdXJyZW50U3RhdGUgPT4gIWN1cnJlbnRTdGF0ZTtcblxuICBwcml2YXRlIHNldEJ1dHRvblN0YXRlKGlzQXV0b1JlZnJlc2hPbjogYm9vbGVhbikge1xuICAgIHRoaXMuaXNBdXRvUmVmcmVzaE9uID0gaXNBdXRvUmVmcmVzaE9uO1xuICB9XG5cbiAgcHJpdmF0ZSB3YXRjaEZvck5ld0xvZ3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhcnRQb2xsaW5nKCkucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmNhbmNlbCQucGlwZShmaWx0ZXIoaXNBdXRvUmVmcmVzaE9uID0+IGlzQXV0b1JlZnJlc2hPbiA9PT0gZmFsc2UpKSksXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNBdXRvUmVmcmVzaE9uID0gZmFsc2U7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0UG9sbGluZygpIHtcbiAgICByZXR1cm4gb2YoMSkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldE5ld0xvZ3MoKS5waXBlKGNhdGNoRXJyb3IoZXIgPT4gb2YodGhpcy5nZXRFbXB0eUxvZ3NKc29uKCkpKSkpLFxuICAgICAgdGFwKGxvZ3MgPT4gdGhpcy51cGRhdGVMb2dzVG9PdXRwdXQobG9ncykpLFxuICAgICAgZGVsYXkoMTAwMDApLFxuICAgICAgcmVwZWF0KClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROZXdMb2dzKCk6IE9ic2VydmFibGU8TG9nc0pTT04+IHtcbiAgICByZXR1cm4gdGhpcy5hcHBMb2dzU2VydmljZS5nZXRMb2dzJCh0aGlzLmdldEFwcElkKCksIHRoaXMuZ2V0SW5zdGFuY2VOYW1lKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBcHBJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm1vLmFwcGxpY2F0aW9uSWQ7XG4gIH1cbiAgcHJpdmF0ZSBnZXRJbnN0YW5jZU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RlZEluc3RhbmNlLm5hbWU7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUxvZ3NUb091dHB1dChuZXdMb2dzKSB7XG4gICAgY29uc3QgeyBkYXRlRnJvbSwgZGF0ZVRvIH0gPSBuZXdMb2dzO1xuICAgIGlmIChkYXRlRnJvbSAmJiBkYXRlVG8pIHtcbiAgICAgIHRoaXMubG9nc1RvT3V0cHV0ID0geyAuLi5uZXdMb2dzIH07XG4gICAgICB0aGlzLm9uTmV3TG9ncy5lbWl0KHRoaXMubG9nc1RvT3V0cHV0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEVtcHR5TG9nc0pzb24oKTogTG9nc0pTT04ge1xuICAgIHJldHVybiB7XG4gICAgICBkYXRlRnJvbTogbnVsbCxcbiAgICAgIGRhdGVUbzogbnVsbCxcbiAgICAgIGxvZ3M6ICcnLFxuICAgICAgdHJ1bmNhdGVkOiBmYWxzZVxuICAgIH07XG4gIH1cbn1cbiJdfQ==