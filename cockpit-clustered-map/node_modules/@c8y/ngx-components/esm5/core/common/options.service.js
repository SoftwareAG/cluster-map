import * as tslib_1 from "tslib";
import { InjectionToken, Optional, Inject, Injectable } from '@angular/core';
import { camelCase, isUndefined } from 'lodash-es';
import { ApplicationOptions } from './ApplicationOptions';
import { SystemOptionsService, TenantOptionsService } from '@c8y/ngx-components/api';
export var HOOK_OPTIONS = new InjectionToken('App options');
/**
 * A service that allows to set or get application options
 * which configure the default behavior of the UI.
 */
var OptionsService = /** @class */ (function (_super) {
    tslib_1.__extends(OptionsService, _super);
    function OptionsService(options, systemOptionsService, tenantOptionService) {
        var _this = _super.call(this) || this;
        _this.systemOptionsService = systemOptionsService;
        _this.tenantOptionService = tenantOptionService;
        _this.setupOptions(options);
        return _this;
    }
    /**
     * Returns an application option used to configure the UI.
     * @param optionKey The application options key.
     * @param defaultValue A value to return if non is set.
     */
    OptionsService.prototype.get = function (optionKey, defaultValue) {
        var value = this[optionKey];
        if (typeof value === 'undefined') {
            value = this[camelCase(optionKey)];
        }
        return typeof value !== 'undefined' ? value : defaultValue;
    };
    /**
     * Sets an application option.
     * @param key The key to set.
     * @param value The value to set.
     */
    OptionsService.prototype.set = function (key, value) {
        this[camelCase(key)] = value;
    };
    /**
     * Gets support url from tenant options.
     * If response returns '404 not found' it gets the support url from application options.
     * If the support link within application options is not provided the UI will use the system options.
     * Is the support link explicitly set to false it will be hidden.
     * NOTE: The tenant option endpoint returns the system option setting if non is set on the tenant.
     *
     * @returns Returns support url or false.
     */
    OptionsService.prototype.getSupportUrl = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!isUndefined(this.supportUrl)) return [3 /*break*/, 2];
                        _a = this;
                        return [4 /*yield*/, this.getTenantOption('configuration', 'system.support.url')];
                    case 1:
                        _a.supportUrl = _b.sent();
                        _b.label = 2;
                    case 2: return [2 /*return*/, isUndefined(this.supportUrl) ? false : this.supportUrl];
                }
            });
        });
    };
    /**
     * Returns if the tenant allows to show the activate-support user menu entry.
     */
    OptionsService.prototype.getActivateSupportUser = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var option;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.getSystemOption('support-user', 'enabled', true)];
                    case 1:
                        option = _a.sent();
                        return [2 /*return*/, !option];
                }
            });
        });
    };
    /**
     * Gets a value from the system service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    OptionsService.prototype.getSystemOption = function (category, key, defaultValue) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.getOptionFromService(category, key, this.systemOptionsService, defaultValue)];
            });
        });
    };
    /**
     * Gets a value from the tenant service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    OptionsService.prototype.getTenantOption = function (category, key, defaultValue) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.getOptionFromService(category, key, this.tenantOptionService, defaultValue)];
            });
        });
    };
    OptionsService.prototype.setupOptions = function (options) {
        var _this = this;
        if (options) {
            if (!Array.isArray(options)) {
                options = [options];
            }
            options.forEach(function (optionMap) {
                if (optionMap) {
                    Object.keys(optionMap).forEach(function (key) {
                        _this[camelCase(key)] = optionMap[key];
                    });
                }
            });
        }
    };
    OptionsService.prototype.getOptionFromService = function (category, key, service, defaultValue) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, service.detail({ category: category, key: key })];
                    case 1:
                        data = (_a.sent()).data;
                        return [2 /*return*/, this.parseOptionRawValue(data.value, defaultValue)];
                    case 2:
                        ex_1 = _a.sent();
                        return [2 /*return*/, defaultValue];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    OptionsService.prototype.parseOptionRawValue = function (rawValue, defaultValue) {
        var value;
        try {
            value = JSON.parse(rawValue);
        }
        catch (e) {
            value = isUndefined(rawValue) ? defaultValue : rawValue;
        }
        return value;
    };
    OptionsService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_OPTIONS,] }] },
        { type: SystemOptionsService },
        { type: TenantOptionsService }
    ]; };
    OptionsService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Optional()), tslib_1.__param(0, Inject(HOOK_OPTIONS))
    ], OptionsService);
    return OptionsService;
}(ApplicationOptions));
export { OptionsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9ucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL29wdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVyRixNQUFNLENBQUMsSUFBTSxZQUFZLEdBQUcsSUFBSSxjQUFjLENBQXVDLGFBQWEsQ0FBQyxDQUFDO0FBRXBHOzs7R0FHRztBQUVIO0lBQW9DLDBDQUFrQjtJQUVwRCx3QkFDb0MsT0FBTyxFQUNqQyxvQkFBMEMsRUFDMUMsbUJBQXlDO1FBSG5ELFlBS0UsaUJBQU8sU0FFUjtRQUxTLDBCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMseUJBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtRQUdqRCxLQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDOztJQUM3QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILDRCQUFHLEdBQUgsVUFBSSxTQUErQixFQUFFLFlBQWtCO1FBQ3JELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QixJQUFJLE9BQU8sS0FBSyxLQUFLLFdBQVcsRUFBRTtZQUNoQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBQ0QsT0FBTyxPQUFPLEtBQUssS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxD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QUssR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO1NBQ3pEO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOztnREE1R0UsUUFBUSxZQUFJLE1BQU0sU0FBQyxZQUFZO2dCQUNGLG9CQUFvQjtnQkFDckIsb0JBQW9COztJQUx4QyxjQUFjO1FBRDFCLFVBQVUsRUFBRTtRQUlSLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFBO09BSHhCLGNBQWMsQ0FnSDFCO0lBQUQscUJBQUM7Q0FBQSxBQWhIRCxDQUFvQyxrQkFBa0IsR0FnSHJEO1NBaEhZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwsIEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY2FtZWxDYXNlLCBpc1VuZGVmaW5lZCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbk9wdGlvbnMgfSBmcm9tICcuL0FwcGxpY2F0aW9uT3B0aW9ucyc7XG5pbXBvcnQgeyBFeHRlbnNpb25GYWN0b3J5IH0gZnJvbSAnLi9leHRlbnNpb24taG9va3MnO1xuaW1wb3J0IHsgU3lzdGVtT3B0aW9uc1NlcnZpY2UsIFRlbmFudE9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuXG5leHBvcnQgY29uc3QgSE9PS19PUFRJT05TID0gbmV3IEluamVjdGlvblRva2VuPEV4dGVuc2lvbkZhY3Rvcnk8QXBwbGljYXRpb25PcHRpb25zPj4oJ0FwcCBvcHRpb25zJyk7XG5cbi8qKlxuICogQSBzZXJ2aWNlIHRoYXQgYWxsb3dzIHRvIHNldCBvciBnZXQgYXBwbGljYXRpb24gb3B0aW9uc1xuICogd2hpY2ggY29uZmlndXJlIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBVSS5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9wdGlvbnNTZXJ2aWNlIGV4dGVuZHMgQXBwbGljYXRpb25PcHRpb25zIHtcbiAgW2tleTogc3RyaW5nXTogYW55O1xuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhPT0tfT1BUSU9OUykgb3B0aW9ucyxcbiAgICBwcml2YXRlIHN5c3RlbU9wdGlvbnNTZXJ2aWNlOiBTeXN0ZW1PcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvblNlcnZpY2U6IFRlbmFudE9wdGlvbnNTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5zZXR1cE9wdGlvbnMob3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhcHBsaWNhdGlvbiBvcHRpb24gdXNlZCB0byBjb25maWd1cmUgdGhlIFVJLlxuICAgKiBAcGFyYW0gb3B0aW9uS2V5IFRoZSBhcHBsaWNhdGlvbiBvcHRpb25zIGtleS5cbiAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBBIHZhbHVlIHRvIHJldHVybiBpZiBub24gaXMgc2V0LlxuICAgKi9cbiAgZ2V0KG9wdGlvbktleToga2V5b2YgT3B0aW9uc1NlcnZpY2UsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXNbb3B0aW9uS2V5XTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdmFsdWUgPSB0aGlzW2NhbWVsQ2FzZShvcHRpb25LZXkpXTtcbiAgICB9XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIGFuIGFwcGxpY2F0aW9uIG9wdGlvbi5cbiAgICogQHBhcmFtIGtleSBUaGUga2V5IHRvIHNldC5cbiAgICogQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuXG4gICAqL1xuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzW2NhbWVsQ2FzZShrZXkpXSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgc3VwcG9ydCB1cmwgZnJvbSB0ZW5hbnQgb3B0aW9ucy5cbiAgICogSWYgcmVzcG9uc2UgcmV0dXJucyAnNDA0IG5vdCBmb3VuZCcgaXQgZ2V0cyB0aGUgc3VwcG9ydCB1cmwgZnJvbSBhcHBsaWNhdGlvbiBvcHRpb25zLlxuICAgKiBJZiB0aGUgc3VwcG9ydCBsaW5rIHdpdGhpbiBhcHBsaWNhdGlvbiBvcHRpb25zIGlzIG5vdCBwcm92aWRlZCB0aGUgVUkgd2lsbCB1c2UgdGhlIHN5c3RlbSBvcHRpb25zLlxuICAgKiBJcyB0aGUgc3VwcG9ydCBsaW5rIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlIGl0IHdpbGwgYmUgaGlkZGVuLlxuICAgKiBOT1RFOiBUaGUgdGVuYW50IG9wdGlvbiBlbmRwb2ludCByZXR1cm5zIHRoZSBzeXN0ZW0gb3B0aW9uIHNldHRpbmcgaWYgbm9uIGlzIHNldCBvbiB0aGUgdGVuYW50LlxuICAgKlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHN1cHBvcnQgdXJsIG9yIGZhbHNlLlxuICAgKi9cbiAgYXN5bmMgZ2V0U3VwcG9ydFVybCgpIHtcbiAgICBpZiAoaXNVbmRlZmluZWQodGhpcy5zdXBwb3J0VXJsKSkge1xuICAgICAgdGhpcy5zdXBwb3J0VXJsID0gYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oJ2NvbmZpZ3VyYXRpb24nLCAnc3lzdGVtLnN1cHBvcnQudXJsJyk7XG4gICAgfVxuICAgIHJldHVybiBpc1VuZGVmaW5lZCh0aGlzLnN1cHBvcnRVcmwpID8gZmFsc2UgOiB0aGlzLnN1cHBvcnRVcmw7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBpZiB0aGUgdGVuYW50IGFsbG93cyB0byBzaG93IHRoZSBhY3RpdmF0ZS1zdXBwb3J0IHVzZXIgbWVudSBlbnRyeS5cbiAgICovXG4gIGFzeW5jIGdldEFjdGl2YXRlU3VwcG9ydFVzZXIoKSB7XG4gICAgY29uc3Qgb3B0aW9uID0gYXdhaXQgdGhpcy5nZXRTeXN0ZW1PcHRpb24oJ3N1cHBvcnQtdXNlcicsICdlbmFibGVkJywgdHJ1ZSk7XG4gICAgcmV0dXJuICFvcHRpb247XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIHZhbHVlIGZyb20gdGhlIHN5c3RlbSBzZXJ2aWNlIGFuZCBwYXJzZXMgaXQuXG4gICAqXG4gICAqIEBwYXJhbSBjYXRlZ29yeSBUaGUgY2F0ZWdvcnkgZm9yIHRoaXMgb3B0aW9uLlxuICAgKiBAcGFyYW0ga2V5IFRoZSBrZXkgZm9yIHRoYXQgb3B0aW9uLlxuICAgKiBAcGFyYW0gZGVmYXVsdFZhbHVlIFRoZSBkZWZhdWx0IGlmIHRoZSBvcHRpb24gd2FzIG5vdCBmb3VuZC5cbiAgICovXG4gIGFzeW5jIGdldFN5c3RlbU9wdGlvbihjYXRlZ29yeTogc3RyaW5nLCBrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlPzogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uRnJvbVNlcnZpY2UoY2F0ZWdvcnksIGtleSwgdGhpcy5zeXN0ZW1PcHRpb25zU2VydmljZSwgZGVmYXVsdFZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGEgdmFsdWUgZnJvbSB0aGUgdGVuYW50IHNlcnZpY2UgYW5kIHBhcnNlcyBpdC5cbiAgICpcbiAgICogQHBhcmFtIGNhdGVnb3J5IFRoZSBjYXRlZ29yeSBmb3IgdGhpcyBvcHRpb24uXG4gICAqIEBwYXJhbSBrZXkgVGhlIGtleSBmb3IgdGhhdCBvcHRpb24uXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgVGhlIGRlZmF1bHQgaWYgdGhlIG9wdGlvbiB3YXMgbm90IGZvdW5kLlxuICAgKi9cbiAgYXN5bmMgZ2V0VGVuYW50T3B0aW9uKGNhdGVnb3J5OiBzdHJpbmcsIGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRPcHRpb25Gcm9tU2VydmljZShjYXRlZ29yeSwga2V5LCB0aGlzLnRlbmFudE9wdGlvblNlcnZpY2UsIGRlZmF1bHRWYWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwT3B0aW9ucyhvcHRpb25zOiBhbnlbXSB8IG51bGwpIHtcbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9wdGlvbnMpKSB7XG4gICAgICAgIG9wdGlvbnMgPSBbb3B0aW9uc107XG4gICAgICB9XG4gICAgICBvcHRpb25zLmZvckVhY2gob3B0aW9uTWFwID0+IHtcbiAgICAgICAgaWYgKG9wdGlvbk1hcCkge1xuICAgICAgICAgIE9iamVjdC5rZXlzKG9wdGlvbk1hcCkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgdGhpc1tjYW1lbENhc2Uoa2V5KV0gPSBvcHRpb25NYXBba2V5XTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRPcHRpb25Gcm9tU2VydmljZShjYXRlZ29yeSwga2V5LCBzZXJ2aWNlLCBkZWZhdWx0VmFsdWUpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBzZXJ2aWNlLmRldGFpbCh7IGNhdGVnb3J5LCBrZXkgfSk7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZU9wdGlvblJhd1ZhbHVlKGRhdGEudmFsdWUsIGRlZmF1bHRWYWx1ZSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZU9wdGlvblJhd1ZhbHVlKHJhd1ZhbHVlLCBkZWZhdWx0VmFsdWUpIHtcbiAgICBsZXQgdmFsdWU7XG4gICAgdHJ5IHtcbiAgICAgIHZhbHVlID0gSlNPTi5wYXJzZShyYXdWYWx1ZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdmFsdWUgPSBpc1VuZGVmaW5lZChyYXdWYWx1ZSkgPyBkZWZhdWx0VmFsdWUgOiByYXdWYWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG59XG4iXX0=