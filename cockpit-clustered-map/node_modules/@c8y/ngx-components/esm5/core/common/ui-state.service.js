import * as tslib_1 from "tslib";
import { Injectable, isDevMode } from '@angular/core';
import { keys } from 'lodash-es';
import { BehaviorSubject } from 'rxjs';
import { scan, distinctUntilChanged, map, filter } from 'rxjs/operators';
import { StateService } from './state-service.abstract';
import { OptionsService } from './options.service';
import { FetchClient } from '@c8y/client';
import { ApplicationService, IUser, ICurrentTenant } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
var AppStateService = /** @class */ (function (_super) {
    tslib_1.__extends(AppStateService, _super);
    function AppStateService(applicationService, apiService, options, fetchClient) {
        var _this = _super.call(this) || this;
        _this.applicationService = applicationService;
        _this.apiService = apiService;
        _this.options = options;
        _this.fetchClient = fetchClient;
        _this.state$ = new BehaviorSubject({
            app: {
                name: _this.options.name,
                contextPath: _this.getCurrentContextPath() || _this.options.contextPath
            },
            supportUrl: _this.options.supportUrl,
            lang: _this.options.get('defaultLanguage', 'en'),
            langs: _this.getLangs(),
            langsDetail: _this.options.languages,
            loginOptions: _this.options.loginOptions,
            activateSupportUserAvailable: undefined,
            versions: {
                backend: undefined,
                ui: _this.options.versions || { ngx: undefined }
            },
            hidePowered: _this.options.hidePowered,
            isLoading: false,
            showRightDrawer: _this.options.rightDrawer,
            loginExtraLink: _this.options.get('login_extra_link'),
            newsletter: _this.options.newsletter
        });
        _this.currentSupportUserName = new BehaviorSubject(null);
        _this.currentUser = new BehaviorSubject(null);
        _this.currentTenant = new BehaviorSubject(null);
        _this.apiService.calls
            .pipe(filter(function (_a) {
            var url = _a.url;
            return !/cep\/realtime/.test(url);
        }), map(function (_a) {
            var phase = _a.phase;
            return (phase === 'start' ? 1 : -1);
        }), scan(function (count, item) { return count + item; }, 0), map(function (count) { return count > 0; }), distinctUntilChanged())
            .subscribe(function (isLoading) { return (_this.state.isLoading = isLoading); });
        _this.assignApplicationKeyToDefaultHeaders();
        return _this;
    }
    AppStateService.prototype.assignApplicationKeyToDefaultHeaders = function () {
        if (!isDevMode()) {
            this.fetchClient.defaultHeaders = tslib_1.__assign({}, (this.fetchClient.defaultHeaders || {}), { 'X-Cumulocity-Application-Key': this.options.key });
        }
    };
    Object.defineProperty(AppStateService.prototype, "state", {
        /**
         * Returns the current state.
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    AppStateService.prototype.getLangs = function () {
        var languages = this.options.languages;
        return languages ? keys(languages).filter(function (k) { return languages[k]; }) : [];
    };
    Object.defineProperty(AppStateService.prototype, "uiVersion", {
        /**
         * Returns the correct UI version. In hybrid mode for angular and ngx.
         */
        get: function () {
            var version = this.state.versions.ui;
            return version.ngx || version.ng1;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Loads the app manifest. If no access -> throw an error to verify app access.
     */
    AppStateService.prototype.loadManifest = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var application, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.applicationService.detail(this.state.app.contextPath + "/manifest")];
                    case 1:
                        application = (_a.sent()).data.application;
                        this.state.app.manifest = application;
                        this.loadDefaultOptions();
                        return [3 /*break*/, 3];
                    case 2:
                        ex_1 = _a.sent();
                        throw ex_1;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Checks current users application list and matches it against given application name.
     * Returns true if application is in the list.
     * @param name application name
     */
    AppStateService.prototype.isApplicationAvailable = function (name) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.applicationService.listByUser(undefined, { pageSize: 100 })];
                    case 1:
                        data = (_a.sent()).data;
                        return [2 /*return*/, data.some(function (app) { return app.name === name; })];
                }
            });
        });
    };
    /**
     * Sets current user (including support user).
     * @param userInfo Info about current user and support user to be set.
     */
    AppStateService.prototype.setUser = function (userInfo) {
        this.currentSupportUserName.next(userInfo.supportUserName || null);
        this.currentUser.next(userInfo.user);
    };
    AppStateService.prototype.getCurrentContextPath = function () {
        var match = window.location.pathname.match(/\/apps\/(public\/){0,1}(.+?)(\/|\?|#|$)/);
        return match && match[2];
    };
    AppStateService.prototype.loadDefaultOptions = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        _a = this.state;
                        return [4 /*yield*/, this.options.getSupportUrl()];
                    case 1:
                        _a.supportUrl = _d.sent();
                        _b = this.state;
                        return [4 /*yield*/, this.options.getActivateSupportUser()];
                    case 2:
                        _b.activateSupportUserAvailable = _d.sent();
                        _c = this.state.versions;
                        return [4 /*yield*/, this.options.getSystemOption('system', 'version')];
                    case 3:
                        _c.backend = _d.sent();
                        try {
                            this.showIncompatibleVersionsError();
                        }
                        catch (ex) {
                            // ignore this
                        }
                        this.emitNewState();
                        return [2 /*return*/];
                }
            });
        });
    };
    AppStateService.prototype.showIncompatibleVersionsError = function () {
        var uiVersion = this.state.versions.ui.ngx;
        var backendVersion = this.state.versions.backend;
        var uiVersionArray = uiVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        var beVersionArray = backendVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        var multiplier = Math.pow(10, Math.ceil(Math.log10(Math.max.apply(Math, tslib_1.__spread(uiVersionArray, beVersionArray)) + 1)));
        var sumReducer = function (acc, cur) { return acc + cur; };
        var calculateVersionMapper = function (curr, idx) { return curr * (multiplier / Math.pow(10, idx)); };
        var uiVersionNumber = uiVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        var beVersionNumber = beVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        var showError = uiVersionNumber > beVersionNumber;
        if (showError) {
            var errorContent = "You are running version " + uiVersion + " of the UI and version " + backendVersion + " of backend!";
            console.log('%c ' + errorContent, 'font-weight: bold; font-size: 30px; color: red;');
        }
    };
    AppStateService.ctorParameters = function () { return [
        { type: ApplicationService },
        { type: ApiService },
        { type: OptionsService },
        { type: FetchClient }
    ]; };
    AppStateService = tslib_1.__decorate([
        Injectable()
    ], AppStateService);
    return AppStateService;
}(StateService));
export { AppStateService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktc3RhdGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTFDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUdyRDtJQUFxQywyQ0FBWTtJQTBCL0MseUJBQ1Usa0JBQXNDLEVBQ3ZDLFVBQXNCLEVBQ3JCLE9BQXVCLEVBQ3ZCLFdBQXdCO1FBSmxDLFlBTUUsaUJBQU8sU0FZUjtRQWpCUyx3QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3ZDLGdCQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3JCLGFBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBN0JsQyxZQUFNLEdBQXlCLElBQUksZUFBZSxDQUFNO1lBQ3RELEdBQUcsRUFBRTtnQkFDSCxJQUFJLEVBQUUsS0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJO2dCQUN2QixX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WUFBWSxHQUFHLDZCQUEyQixTQUFTLCtCQUEwQixjQUFjLGlCQUFjLENBQUM7WUFDaEgsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsWUFBWSxFQUFFLGlEQUFpRCxDQUFDLENBQUM7U0FDdEY7SUFDSCxDQUFDOztnQkEzSDZCLGtCQUFrQjtnQkFDM0IsVUFBVTtnQkFDWixjQUFjO2dCQUNWLFdBQVc7O0lBOUJ2QixlQUFlO1FBRDNCLFVBQVUsRUFBRTtPQUNBLGVBQWUsQ0F1SjNCO0lBQUQsc0JBQUM7Q0FBQSxBQXZKRCxDQUFxQyxZQUFZLEdBdUpoRDtTQXZKWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgaXNEZXZNb2RlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBrZXlzIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc2NhbiwgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9zdGF0ZS1zZXJ2aWNlLmFic3RyYWN0JztcbmltcG9ydCB7IE9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnLi9vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgRmV0Y2hDbGllbnQgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbmltcG9ydCB7IEFwcGxpY2F0aW9uU2VydmljZSwgSVVzZXIsIElDdXJyZW50VGVuYW50IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBpU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvYXBpJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcFN0YXRlU2VydmljZSBleHRlbmRzIFN0YXRlU2VydmljZSB7XG4gIHN0YXRlJDogQmVoYXZpb3JTdWJqZWN0PGFueT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe1xuICAgIGFwcDoge1xuICAgICAgbmFtZTogdGhpcy5vcHRpb25zLm5hbWUsXG4gICAgICBjb250ZXh0UGF0aDogdGhpcy5nZXRDdXJyZW50Q29udGV4dFBhdGgoKSB8fCB0aGlzLm9wdGlvbnMuY29udGV4dFBhdGhcbiAgICB9LFxuICAgIHN1cHBvcnRVcmw6IHRoaXMub3B0aW9ucy5zdXBwb3J0VXJsLFxuICAgIGxhbmc6IHRoaXMub3B0aW9ucy5nZXQoJ2RlZmF1bHRMYW5ndWFnZScsICdlbicpLFxuICAgIGxhbmdzOiB0aGlzLmdldExhbmdzKCksXG4gICAgbGFuZ3NEZXRhaWw6IHRoaXMub3B0aW9ucy5sYW5ndWFnZXMsXG4gICAgbG9naW5PcHRpb25zOiB0aGlzLm9wdGlvbnMubG9naW5PcHRpb25zLFxuICAgIGFjdGl2YXRlU3VwcG9ydFVzZXJBdmFpbGFibGU6IHVuZGVmaW5lZCxcbiAgICB2ZXJzaW9uczoge1xuICAgICAgYmFja2VuZDogdW5kZWZpbmVkLFxuICAgICAgdWk6IHRoaXMub3B0aW9ucy52ZXJzaW9ucyB8fCB7IG5neDogdW5kZWZpbmVkIH1cbiAgICB9LFxuICAgIGhpZGVQb3dlcmVkOiB0aGlzLm9wdGlvbnMuaGlkZVBvd2VyZWQsXG4gICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICBzaG93UmlnaHREcmF3ZXI6IHRoaXMub3B0aW9ucy5yaWdodERyYXdlcixcbiAgICBsb2dpbkV4dHJhTGluazogdGhpcy5vcHRpb25zLmdldCgnbG9naW5fZXh0cmFfbGluaycpLFxuICAgIG5ld3NsZXR0ZXI6IHRoaXMub3B0aW9ucy5uZXdzbGV0dGVyXG4gIH0pO1xuICBjdXJyZW50U3VwcG9ydFVzZXJOYW1lOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VXNlcjogQmVoYXZpb3JTdWJqZWN0PElVc2VyIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VGVuYW50OiBCZWhhdmlvclN1YmplY3Q8SUN1cnJlbnRUZW5hbnQgfCBudWxsPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwdWJsaWMgYXBpU2VydmljZTogQXBpU2VydmljZSxcbiAgICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmV0Y2hDbGllbnQ6IEZldGNoQ2xpZW50XG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hcGlTZXJ2aWNlLmNhbGxzXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKCh7IHVybCB9KSA9PiAhL2NlcFxcL3JlYWx0aW1lLy50ZXN0KHVybCkpLFxuICAgICAgICBtYXAoKHsgcGhhc2UgfSkgPT4gKHBoYXNlID09PSAnc3RhcnQnID8gMSA6IC0xKSksXG4gICAgICAgIHNjYW4oKGNvdW50LCBpdGVtKSA9PiBjb3VudCArIGl0ZW0sIDApLFxuICAgICAgICBtYXAoY291bnQgPT4gY291bnQgPiAwKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShpc0xvYWRpbmcgPT4gKHRoaXMuc3RhdGUuaXNMb2FkaW5nID0gaXNMb2FkaW5nKSk7XG5cbiAgICB0aGlzLmFzc2lnbkFwcGxpY2F0aW9uS2V5VG9EZWZhdWx0SGVhZGVycygpO1xuICB9XG5cbiAgYXNzaWduQXBwbGljYXRpb25LZXlUb0RlZmF1bHRIZWFkZXJzKCkge1xuICAgIGlmICghaXNEZXZNb2RlKCkpIHtcbiAgICAgIHRoaXMuZmV0Y2hDbGllbnQuZGVmYXVsdEhlYWRlcnMgPSB7XG4gICAgICAgIC4uLih0aGlzLmZldGNoQ2xpZW50LmRlZmF1bHRIZWFkZXJzIHx8IHt9KSxcbiAgICAgICAgJ1gtQ3VtdWxvY2l0eS1BcHBsaWNhdGlvbi1LZXknOiB0aGlzLm9wdGlvbnMua2V5XG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgZ2V0IHN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlJC52YWx1ZTtcbiAgfVxuXG4gIGdldExhbmdzKCkge1xuICAgIGNvbnN0IHsgbGFuZ3VhZ2VzIH0gPSB0aGlzLm9wdGlvbnM7XG4gICAgcmV0dXJuIGxhbmd1YWdlcyA/IGtleXMobGFuZ3VhZ2VzKS5maWx0ZXIoayA9PiBsYW5ndWFnZXNba10pIDogW107XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY29ycmVjdCBVSSB2ZXJzaW9uLiBJbiBoeWJyaWQgbW9kZSBmb3IgYW5ndWxhciBhbmQgbmd4LlxuICAgKi9cbiAgZ2V0IHVpVmVyc2lvbigpIHtcbiAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5zdGF0ZS52ZXJzaW9ucy51aTtcbiAgICByZXR1cm4gdmVyc2lvbi5uZ3ggfHwgdmVyc2lvbi5uZzE7XG4gIH1cblxuICAvKipcbiAgICogTG9hZHMgdGhlIGFwcCBtYW5pZmVzdC4gSWYgbm8gYWNjZXNzIC0+IHRocm93IGFuIGVycm9yIHRvIHZlcmlmeSBhcHAgYWNjZXNzLlxuICAgKi9cbiAgYXN5bmMgbG9hZE1hbmlmZXN0KCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGFwcGxpY2F0aW9uIH0gPSAoYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZGV0YWlsKFxuICAgICAgICBgJHt0aGlzLnN0YXRlLmFwcC5jb250ZXh0UGF0aH0vbWFuaWZlc3RgXG4gICAgICApKS5kYXRhIGFzIGFueTtcbiAgICAgIHRoaXMuc3RhdGUuYXBwLm1hbmlmZXN0ID0gYXBwbGljYXRpb247XG4gICAgICB0aGlzLmxvYWREZWZhdWx0T3B0aW9ucygpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aHJvdyBleDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGN1cnJlbnQgdXNlcnMgYXBwbGljYXRpb24gbGlzdCBhbmQgbWF0Y2hlcyBpdCBhZ2FpbnN0IGdpdmVuIGFwcGxpY2F0aW9uIG5hbWUuXG4gICAqIFJldHVybnMgdHJ1ZSBpZiBhcHBsaWNhdGlvbiBpcyBpbiB0aGUgbGlzdC5cbiAgICogQHBhcmFtIG5hbWUgYXBwbGljYXRpb24gbmFtZVxuICAgKi9cbiAgYXN5bmMgaXNBcHBsaWNhdGlvbkF2YWlsYWJsZShuYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3RCeVVzZXIodW5kZWZpbmVkLCB7IHBhZ2VTaXplOiAxMDAgfSk7XG4gICAgcmV0dXJuIGRhdGEuc29tZShhcHAgPT4gYXBwLm5hbWUgPT09IG5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgY3VycmVudCB1c2VyIChpbmNsdWRpbmcgc3VwcG9ydCB1c2VyKS5cbiAgICogQHBhcmFtIHVzZXJJbmZvIEluZm8gYWJvdXQgY3VycmVudCB1c2VyIGFuZCBzdXBwb3J0IHVzZXIgdG8gYmUgc2V0LlxuICAgKi9cbiAgc2V0VXNlcih1c2VySW5mbzogeyB1c2VyOiBJVXNlcjsgc3VwcG9ydFVzZXJOYW1lOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuY3VycmVudFN1cHBvcnRVc2VyTmFtZS5uZXh0KHVzZXJJbmZvLnN1cHBvcnRVc2VyTmFtZSB8fCBudWxsKTtcbiAgICB0aGlzLmN1cnJlbnRVc2VyLm5leHQodXNlckluZm8udXNlcik7XG4gIH1cblxuICBwcml2YXRlIGdldEN1cnJlbnRDb250ZXh0UGF0aCgpIHtcbiAgICBjb25zdCBtYXRjaCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZS5tYXRjaCgvXFwvYXBwc1xcLyhwdWJsaWNcXC8pezAsMX0oLis/KShcXC98XFw/fCN8JCkvKTtcbiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMl07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWREZWZhdWx0T3B0aW9ucygpIHtcbiAgICB0aGlzLnN0YXRlLnN1cHBvcnRVcmwgPSBhd2FpdCB0aGlzLm9wdGlvbnMuZ2V0U3VwcG9ydFVybCgpO1xuICAgIHRoaXMuc3RhdGUuYWN0aXZhdGVTdXBwb3J0VXNlckF2YWlsYWJsZSA9IGF3YWl0IHRoaXMub3B0aW9ucy5nZXRBY3RpdmF0ZVN1cHBvcnRVc2VyKCk7XG4gICAgdGhpcy5zdGF0ZS52ZXJzaW9ucy5iYWNrZW5kID0gYXdhaXQgdGhpcy5vcHRpb25zLmdldFN5c3RlbU9wdGlvbignc3lzdGVtJywgJ3ZlcnNpb24nKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy5zaG93SW5jb21wYXRpYmxlVmVyc2lvbnNFcnJvcigpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpZ25vcmUgdGhpc1xuICAgIH1cbiAgICB0aGlzLmVtaXROZXdTdGF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93SW5jb21wYXRpYmxlVmVyc2lvbnNFcnJvcigpIHtcbiAgICBjb25zdCB1aVZlcnNpb24gPSB0aGlzLnN0YXRlLnZlcnNpb25zLnVpLm5neDtcbiAgICBjb25zdCBiYWNrZW5kVmVyc2lvbiA9IHRoaXMuc3RhdGUudmVyc2lvbnMuYmFja2VuZDtcbiAgICBjb25zdCB1aVZlcnNpb25BcnJheSA9IHVpVmVyc2lvblxuICAgICAgLnJlcGxhY2UoL1teXFxkLl0vZywgJycpXG4gICAgICAuc3BsaXQoJy4nKVxuICAgICAgLm1hcChOdW1iZXIpO1xuICAgIGNvbnN0IGJlVmVyc2lvbkFycmF5ID0gYmFja2VuZFZlcnNpb25cbiAgICAgIC5yZXBsYWNlKC9bXlxcZC5dL2csICcnKVxuICAgICAgLnNwbGl0KCcuJylcbiAgICAgIC5tYXAoTnVtYmVyKTtcbiAgICBjb25zdCBtdWx0aXBsaWVyID0gTWF0aC5wb3coXG4gICAgICAxMCxcbiAgICAgIE1hdGguY2VpbChNYXRoLmxvZzEwKE1hdGgubWF4KC4uLnVpVmVyc2lvbkFycmF5LCAuLi5iZVZlcnNpb25BcnJheSkgKyAxKSlcbiAgICApO1xuICAgIGNvbnN0IHN1bVJlZHVjZXIgPSAoYWNjLCBjdXIpID0+IGFjYyArIGN1cjtcbiAgICBjb25zdCBjYWxjdWxhdGVWZXJzaW9uTWFwcGVyID0gKGN1cnIsIGlkeCkgPT4gY3VyciAqIChtdWx0aXBsaWVyIC8gTWF0aC5wb3coMTAsIGlkeCkpO1xuICAgIGNvbnN0IHVpVmVyc2lvbk51bWJlciA9IHVpVmVyc2lvbkFycmF5Lm1hcChjYWxjdWxhdGVWZXJzaW9uTWFwcGVyKS5yZWR1Y2Uoc3VtUmVkdWNlcik7XG4gICAgY29uc3QgYmVWZXJzaW9uTnVtYmVyID0gYmVWZXJzaW9uQXJyYXkubWFwKGNhbGN1bGF0ZVZlcnNpb25NYXBwZXIpLnJlZHVjZShzdW1SZWR1Y2VyKTtcbiAgICBjb25zdCBzaG93RXJyb3IgPSB1aVZlcnNpb25OdW1iZXIgPiBiZVZlcnNpb25OdW1iZXI7XG4gICAgaWYgKHNob3dFcnJvcikge1xuICAgICAgY29uc3QgZXJyb3JDb250ZW50ID0gYFlvdSBhcmUgcnVubmluZyB2ZXJzaW9uICR7dWlWZXJzaW9ufSBvZiB0aGUgVUkgYW5kIHZlcnNpb24gJHtiYWNrZW5kVmVyc2lvbn0gb2YgYmFja2VuZCFgO1xuICAgICAgY29uc29sZS5sb2coJyVjICcgKyBlcnJvckNvbnRlbnQsICdmb250LXdlaWdodDogYm9sZDsgZm9udC1zaXplOiAzMHB4OyBjb2xvcjogcmVkOycpO1xuICAgIH1cbiAgfVxufVxuIl19