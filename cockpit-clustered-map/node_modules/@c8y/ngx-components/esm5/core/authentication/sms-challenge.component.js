import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter, Input } from '@angular/core';
import { UserService, ICredentials } from '@c8y/client';
import { LoginService } from '../login/login.service';
import { AlertService } from '../alert/public-api';
import { gettext } from '../i18n/gettext';
var SmsChallengeComponent = /** @class */ (function () {
    function SmsChallengeComponent(loginService, users, alert) {
        this.loginService = loginService;
        this.users = users;
        this.alert = alert;
        this.onCancel = new EventEmitter();
        this.model = {
            smsToken: ''
        };
        this.isLoading = false;
        this.resendTfa = '0';
    }
    SmsChallengeComponent.prototype.verifyTFACode = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isLoading = true;
                        if (!this.useOAuthInternal()) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.verifyCodeWithOauth()];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 2: return [4 /*yield*/, this.verifyCodeWithBasicAuth()];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        this.isLoading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.resendTFASms = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, 3, 4]);
                        this.isLoading = true;
                        return [4 /*yield*/, this.users.verifyTFACode(this.resendTfa)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 2:
                        e_1 = _a.sent();
                        if (e_1.res.status === 403) {
                            this.loginService.cleanMessages();
                            this.loginService.addSuccessMessage('resend_sms');
                        }
                        else {
                            this.alert.addServerFailure(e_1);
                        }
                        return [3 /*break*/, 4];
                    case 3:
                        this.isLoading = false;
                        return [7 /*endfinally*/];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.useOAuthInternal = function () {
        return this.loginService.isPasswordGrantLogin(this.credentials);
    };
    SmsChallengeComponent.prototype.verifyCodeWithOauth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var credentials, e_2, resStatus;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 4, , 5]);
                        credentials = this.credentials;
                        return [4 /*yield*/, this.loginService.switchLoginMode(tslib_1.__assign({}, credentials, { tfa: this.model.smsToken }))];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.loginService.verifyAppAccess()];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.loginService.authFulfilled()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        e_2 = _a.sent();
                        resStatus = e_2.res && e_2.res.status;
                        if (resStatus === 401) {
                            // it is assumed that the user and password are correct so it must be the tfa code
                            this.alert.danger(gettext('Invalid code'));
                        }
                        else {
                            this.alert.addServerFailure(e_2);
                        }
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.verifyCodeWithBasicAuth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, tfaToken, e_3, resStatus;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.users.verifyTFACode(this.model.smsToken)];
                    case 1:
                        res = (_a.sent()).res;
                        tfaToken = res.headers.get('tfatoken');
                        this.credentials.tfa = tfaToken;
                        this.loginWithTFA(tfaToken);
                        return [3 /*break*/, 3];
                    case 2:
                        e_3 = _a.sent();
                        resStatus = e_3.res && e_3.res.status;
                        // BE returns 403 in case of invalid tfa code
                        if (resStatus === 403) {
                            this.alert.danger(gettext('Invalid code'));
                        }
                        else {
                            this.alert.addServerFailure(e_3);
                        }
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.loginWithTFA = function (tfaToken) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_4;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.loginService.login(this.loginService.useBasicAuth({ tfa: tfaToken }), this.credentials)];
                    case 1:
                        _a.sent();
                        this.loginService.saveTFAToken(tfaToken, sessionStorage);
                        if (this.loginService.rememberMe) {
                            this.loginService.saveTFAToken(tfaToken, localStorage);
                        }
                        return [3 /*break*/, 3];
                    case 2:
                        e_4 = _a.sent();
                        this.alert.addServerFailure(e_4);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.ctorParameters = function () { return [
        { type: LoginService },
        { type: UserService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], SmsChallengeComponent.prototype, "credentials", void 0);
    tslib_1.__decorate([
        Output()
    ], SmsChallengeComponent.prototype, "onCancel", void 0);
    SmsChallengeComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-sms-challenge',
            template: "<form #twoFactorForm=\"ngForm\" role=\"form\" class=\"loginForm\" (ngSubmit)=\"verifyTFACode()\" novalidate>\n  <div class=\"legend form-block center\" translate>Insert the code received via SMS</div>\n\n  <c8y-form-group>\n    <label translate>Verification code</label>\n    <input\n      [(ngModel)]=\"model.smsToken\"\n      #sms_token=\"ngModel\"\n      type=\"text\"\n      name=\"sms_token\"\n      autocapitalize=\"off\"\n      autocorrect=\"off\"\n      class=\"form-control\"\n      placeholder=\"{{ 'Verification code' | translate }}\"\n      required\n    />\n  </c8y-form-group>\n\n  <button\n    title=\"{{ 'Verify' | translate }}\"\n    [disabled]=\"!twoFactorForm.form.valid || isLoading\"\n    type=\"submit\"\n    class=\"btn btn-primary btn-lg btn-block form-group\"\n    translate\n  >\n    Verify\n  </button>\n\n  <div class=\"top-m-sm\">\n    <a\n      title=\"{{ 'Login' | translate }}\"\n      class=\"btn btn-link btn-sm pull-right\"\n      (click)=\"onCancel.emit()\"\n      translate\n      >Login</a\n    >\n    <a\n      title=\"{{ 'Send new code' | translate }}\"\n      [ngClass]=\"{ disabled: isLoading }\"\n      class=\"btn btn-link btn-sm\"\n      (click)=\"resendTFASms()\"\n      translate\n      >Send new code</a\n    >\n  </div>\n</form>\n"
        })
    ], SmsChallengeComponent);
    return SmsChallengeComponent;
}());
export { SmsChallengeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic21zLWNoYWxsZW5nZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9hdXRoZW50aWNhdGlvbi9zbXMtY2hhbGxlbmdlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQVExQztJQVlFLCtCQUNTLFlBQTBCLEVBQ3pCLEtBQWtCLEVBQ2xCLEtBQW1CO1FBRnBCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ3pCLFVBQUssR0FBTCxLQUFLLENBQWE7UUFDbEIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQVpuQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUV4QyxVQUFLLEdBQUc7WUFDTixRQUFRLEVBQUUsRUFBRTtTQUNiLENBQUM7UUFDRixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRVYsY0FBUyxHQUFXLEdBQUcsQ0FBQztJQU03QixDQUFDO0lBRUUsNkNBQWEsR0FBbkI7Ozs7O3dCQUNFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDOzZCQUNsQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBdkIsd0JBQXVCO3dCQUN6QixxQkFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBQTs7d0JBQWhDLFNBQWdDLENBQUM7OzRCQUVqQyxxQkFBTSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsRUFBQTs7d0JBQXBD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QUFDLFlBQVksQ0FBQyxFQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQTs7d0JBQWhHLFNBQWdHLENBQUM7d0JBQ2pHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQzt3QkFDekQsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRTs0QkFDaEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO3lCQUN4RDs7Ozt3QkFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUMsQ0FBQyxDQUFDOzs7Ozs7S0FFbEM7O2dCQS9Fc0IsWUFBWTtnQkFDbEIsV0FBVztnQkFDWCxZQUFZOztJQWJwQjtRQUFSLEtBQUssRUFBRTs4REFBMkI7SUFDekI7UUFBVCxNQUFNLEVBQUU7MkRBQStCO0lBSDdCLHFCQUFxQjtRQU5qQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsbUJBQW1CO1lBQzdCLDJ3Q0FBNkM7U0FFOUMsQ0FBQztPQUVXLHFCQUFxQixDQTZGakM7SUFBRCw0QkFBQztDQUFBLEFBN0ZELElBNkZDO1NBN0ZZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBVc2VyU2VydmljZSwgSUNyZWRlbnRpYWxzIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgTG9naW5TZXJ2aWNlIH0gZnJvbSAnLi4vbG9naW4vbG9naW4uc2VydmljZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi9hbGVydC9wdWJsaWMtYXBpJztcbmltcG9ydCB7IExvZ2luVmlld3MgfSBmcm9tICcuLi9sb2dpbi9sb2dpbi5tb2RlbCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNtcy1jaGFsbGVuZ2UnLFxuICB0ZW1wbGF0ZVVybDogJy4vc21zLWNoYWxsZW5nZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlczogW11cbn0pXG5cbmV4cG9ydCBjbGFzcyBTbXNDaGFsbGVuZ2VDb21wb25lbnQge1xuXG4gIEBJbnB1dCgpIGNyZWRlbnRpYWxzOiBJQ3JlZGVudGlhbHM7XG4gIEBPdXRwdXQoKSBvbkNhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBtb2RlbCA9IHtcbiAgICBzbXNUb2tlbjogJydcbiAgfTtcbiAgaXNMb2FkaW5nID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSByZXNlbmRUZmE6IHN0cmluZyA9ICcwJztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbG9naW5TZXJ2aWNlOiBMb2dpblNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1c2VyczogVXNlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyB2ZXJpZnlURkFDb2RlKCkge1xuICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICBpZiAodGhpcy51c2VPQXV0aEludGVybmFsKCkpIHtcbiAgICAgIGF3YWl0IHRoaXMudmVyaWZ5Q29kZVdpdGhPYXV0aCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnZlcmlmeUNvZGVXaXRoQmFzaWNBdXRoKCk7XG4gICAgfVxuICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyByZXNlbmRURkFTbXMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgIGF3YWl0IHRoaXMudXNlcnMudmVyaWZ5VEZBQ29kZSh0aGlzLnJlc2VuZFRmYSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUucmVzLnN0YXR1cyA9PT0gNDAzKSB7XG4gICAgICAgIHRoaXMubG9naW5TZXJ2aWNlLmNsZWFuTWVzc2FnZXMoKTtcbiAgICAgICAgdGhpcy5sb2dpblNlcnZpY2UuYWRkU3VjY2Vzc01lc3NhZ2UoJ3Jlc2VuZF9zbXMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShlKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVzZU9BdXRoSW50ZXJuYWwoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9naW5TZXJ2aWNlLmlzUGFzc3dvcmRHcmFudExvZ2luKHRoaXMuY3JlZGVudGlhbHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB2ZXJpZnlDb2RlV2l0aE9hdXRoKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGNyZWRlbnRpYWxzIH0gPSB0aGlzO1xuICAgICAgYXdhaXQgdGhpcy5sb2dpblNlcnZpY2Uuc3dpdGNoTG9naW5Nb2RlKHsuLi5jcmVkZW50aWFscywgdGZhOiB0aGlzLm1vZGVsLnNtc1Rva2VufSk7XG4gICAgICBhd2FpdCB0aGlzLmxvZ2luU2VydmljZS52ZXJpZnlBcHBBY2Nlc3MoKTtcbiAgICAgIGF3YWl0IHRoaXMubG9naW5TZXJ2aWNlLmF1dGhGdWxmaWxsZWQoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zdCByZXNTdGF0dXMgPSBlLnJlcyAmJiBlLnJlcy5zdGF0dXM7XG4gICAgICBpZiAocmVzU3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgLy8gaXQgaXMgYXNzdW1lZCB0aGF0IHRoZSB1c2VyIGFuZCBwYXNzd29yZCBhcmUgY29ycmVjdCBzbyBpdCBtdXN0IGJlIHRoZSB0ZmEgY29kZVxuICAgICAgICB0aGlzLmFsZXJ0LmRhbmdlcihnZXR0ZXh0KCdJbnZhbGlkIGNvZGUnKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB2ZXJpZnlDb2RlV2l0aEJhc2ljQXV0aCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXMgfSA9IGF3YWl0IHRoaXMudXNlcnMudmVyaWZ5VEZBQ29kZSh0aGlzLm1vZGVsLnNtc1Rva2VuKTtcbiAgICAgIGNvbnN0IHRmYVRva2VuID0gcmVzLmhlYWRlcnMuZ2V0KCd0ZmF0b2tlbicpO1xuICAgICAgdGhpcy5jcmVkZW50aWFscy50ZmEgPSB0ZmFUb2tlbjtcbiAgICAgIHRoaXMubG9naW5XaXRoVEZBKHRmYVRva2VuKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zdCByZXNTdGF0dXMgPSBlLnJlcyAmJiBlLnJlcy5zdGF0dXM7XG4gICAgICAvLyBCRSByZXR1cm5zIDQwMyBpbiBjYXNlIG9mIGludmFsaWQgdGZhIGNvZGVcbiAgICAgIGlmIChyZXNTdGF0dXMgPT09IDQwMykge1xuICAgICAgICB0aGlzLmFsZXJ0LmRhbmdlcihnZXR0ZXh0KCdJbnZhbGlkIGNvZGUnKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2dpbldpdGhURkEodGZhVG9rZW4pIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5sb2dpblNlcnZpY2UubG9naW4odGhpcy5sb2dpblNlcnZpY2UudXNlQmFzaWNBdXRoKHt0ZmE6IHRmYVRva2VufSksIHRoaXMuY3JlZGVudGlhbHMpO1xuICAgICAgdGhpcy5sb2dpblNlcnZpY2Uuc2F2ZVRGQVRva2VuKHRmYVRva2VuLCBzZXNzaW9uU3RvcmFnZSk7XG4gICAgICBpZiAodGhpcy5sb2dpblNlcnZpY2UucmVtZW1iZXJNZSkge1xuICAgICAgICB0aGlzLmxvZ2luU2VydmljZS5zYXZlVEZBVG9rZW4odGZhVG9rZW4sIGxvY2FsU3RvcmFnZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGUpO1xuICAgIH1cbiAgfVxufVxuIl19