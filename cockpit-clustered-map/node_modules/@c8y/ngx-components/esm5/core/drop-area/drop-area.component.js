import * as tslib_1 from "tslib";
import { Component, ViewChild, Input, Output, EventEmitter } from '@angular/core';
import { some } from 'lodash-es';
var DropAreaComponent = /** @class */ (function () {
    function DropAreaComponent() {
        this.title = 'Upload file';
        this.message = 'Drop file here';
        this.icon = 'plus-square';
        this.loadingMessage = 'Uploading ...';
        this.alwaysShow = false;
        this.clickToOpen = true;
        this.loading = false;
        this.progress = -1; // -1 = spinner
        this.dropped = new EventEmitter();
        this.isOver = false;
        this.fileIsEmpty = false;
    }
    DropAreaComponent.prototype.ngOnInit = function () {
        this.alwaysShow = this.alwaysShow || this.area.nativeElement.children.length === 0;
    };
    DropAreaComponent.prototype.toggle = function ($event) {
        this.zone.nativeElement.style.height = this.area.nativeElement.offsetHeight + 'px';
        this.onOver();
    };
    DropAreaComponent.prototype.showPicker = function ($event) {
        this.preventDefault($event);
        this.picker.nativeElement.value = '';
        this.picker.nativeElement.click();
    };
    DropAreaComponent.prototype.onOver = function () {
        if (!this.isOver) {
            this.isOver = true;
            document.addEventListener('dragover', this.preventDefault);
            document.addEventListener('drop', this.preventDefault);
        }
    };
    DropAreaComponent.prototype.onPick = function ($event) {
        this.fileIsEmpty = false;
        this.preventDefault($event);
        this.onFilesSelected($event.target.files);
    };
    DropAreaComponent.prototype.onDrop = function ($event) {
        this.preventDefault($event);
        this.onFilesSelected($event.dataTransfer.files);
        this.stopDragging();
    };
    DropAreaComponent.prototype.onFilesSelected = function (files) {
        this.fileIsEmpty = false;
        if (files && files.length > 0) {
            if (this.isAnyFileEmpty(files)) {
                this.fileIsEmpty = true;
                this.dropped.emit([]);
            }
            else {
                this.dropped.emit(this.compose(files));
            }
        }
    };
    DropAreaComponent.prototype.isAnyFileEmpty = function (files) {
        return some(Array.from(files), ['size', 0]);
    };
    DropAreaComponent.prototype.stopDragging = function () {
        document.removeEventListener('dragover', this.preventDefault);
        document.removeEventListener('drop', this.preventDefault);
        this.isOver = false;
    };
    DropAreaComponent.prototype.preventDefault = function ($event) {
        if ($event) {
            $event.preventDefault();
        }
    };
    DropAreaComponent.prototype.compose = function (files) {
        var _this = this;
        return Array.from(files).map(function (file) { return ({
            file: file,
            readAsJson: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { var _a, _b; return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        _b = (_a = JSON).parse;
                        return [4 /*yield*/, this.read(file, ReadAsType.TEXT)];
                    case 1: return [2 /*return*/, _b.apply(_a, [_c.sent()])];
                }
            }); }); },
            readAsText: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.read(file, ReadAsType.TEXT)];
            }); }); },
            readAsArrayBuffer: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.read(file, ReadAsType.ARRAY_BUFFER)];
            }); }); },
            readAsBinaryString: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.read(file, ReadAsType.BINARY_STRING)];
            }); }); },
            readAsDataURL: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.read(file, ReadAsType.DATA_URL)];
            }); }); }
        }); });
    };
    DropAreaComponent.prototype.read = function (file, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        var reader = new FileReader();
                        switch (type) {
                            case ReadAsType.TEXT: {
                                reader.readAsText(file);
                                break;
                            }
                            case ReadAsType.ARRAY_BUFFER: {
                                reader.readAsArrayBuffer(file);
                                break;
                            }
                            case ReadAsType.BINARY_STRING: {
                                reader.readAsBinaryString(file);
                                break;
                            }
                            case ReadAsType.DATA_URL: {
                                reader.readAsDataURL(file);
                                break;
                            }
                        }
                        reader.onload = function () { return _this.onLoad(reader, resolve, reject); };
                    })];
            });
        });
    };
    DropAreaComponent.prototype.onLoad = function (reader, resolve, reject) {
        if (reader.readyState !== 2) {
            return;
        }
        if (reader.error) {
            reject(reader.error);
        }
        resolve(reader.result);
    };
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "title", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "message", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "icon", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "loadingMessage", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "alwaysShow", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "clickToOpen", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "loading", void 0);
    tslib_1.__decorate([
        Input()
    ], DropAreaComponent.prototype, "progress", void 0);
    tslib_1.__decorate([
        Output()
    ], DropAreaComponent.prototype, "dropped", void 0);
    tslib_1.__decorate([
        ViewChild('area', { static: true })
    ], DropAreaComponent.prototype, "area", void 0);
    tslib_1.__decorate([
        ViewChild('zone', { static: false })
    ], DropAreaComponent.prototype, "zone", void 0);
    tslib_1.__decorate([
        ViewChild('picker', { static: false })
    ], DropAreaComponent.prototype, "picker", void 0);
    DropAreaComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-drop-area',
            template: "<div  [ngClass]=\"{'form-group': true,'has-error': fileIsEmpty }\">\n  <small class=\"form-control-feedback-message\">\n    <span *ngIf=\"fileIsEmpty\" translate>\n        File must not be empty, select another one.\n    </span>\n  </small>\n</div>\n<div class=\"drop-zone\" [style.pointerEvents]=\"loading ? 'none' : 'auto'\" #zone style=\"padding-bottom: 0px; height: auto; min-height: 120px; max-height: 80vh;\"\n  (dragleave)=\"stopDragging()\" (drop)=\"onDrop($event)\" (dragover)=\"onOver()\" [style.display]=\"isOver || alwaysShow || loading ? 'block' : 'none'\"\n  (click)=\"showPicker($event)\">\n  <div class=\"file-placeholder\" style=\"pointer-events: none;\" [ngClass]=\"{ 'drag-over': isOver }\">\n\n    <div *ngIf=\"loading\" class=\"hint-placeholder\" style=\"width: 300px;\">\n      <p>\n        {{loadingMessage}}\n      </p>\n      <div class=\"progress progress-striped active\" *ngIf=\"progress !== -1\">\n        <div class=\"progress-bar\" role=\"progressbar\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"100\" [style.width]=\"progress + '%'\"></div>\n      </div>\n      <div class=\"spinner\" *ngIf=\"progress === -1\" style=\"position: relative;\">\n        <div class=\"rect1\"></div>\n        <div class=\"rect2\"></div>\n        <div class=\"rect3\"></div>\n        <div class=\"rect4\"></div>\n        <div class=\"rect5\"></div>\n      </div>\n    </div>\n\n    <div *ngIf=\"!loading\" class=\"hint-placeholder\">\n      <i class=\"fa fw fa-{{icon}}\"></i>\n      <p>\n        <span>{{title}}</span>\n      </p>\n      <p>\n        <b>{{message}}</b>\n        <br>\n        <span *ngIf=\"alwaysShow && clickToOpen\" translate>or click to browse your computer.</span>\n      </p>\n    </div>\n\n  </div>\n</div>\n<input #picker *ngIf=\"clickToOpen\" (change)=\"onPick($event)\" multiple type=\"file\" style=\"opacity: 0; filter: alpha(opacity = 0); height: 0px\">\n<div #area [hidden]=\"isOver || loading\" (dragover)=\"toggle($event)\">\n  <ng-content></ng-content>\n</div>\n"
        })
    ], DropAreaComponent);
    return DropAreaComponent;
}());
export { DropAreaComponent };
var ReadAsType;
(function (ReadAsType) {
    ReadAsType[ReadAsType["TEXT"] = 0] = "TEXT";
    ReadAsType[ReadAsType["DATA_URL"] = 1] = "DATA_URL";
    ReadAsType[ReadAsType["ARRAY_BUFFER"] = 2] = "ARRAY_BUFFER";
    ReadAsType[ReadAsType["BINARY_STRING"] = 3] = "BINARY_STRING";
})(ReadAsType || (ReadAsType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcC1hcmVhLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2Ryb3AtYXJlYS9kcm9wLWFyZWEuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFNBQVMsRUFFVCxLQUFLLEVBRUwsTUFBTSxFQUNOLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBTWpDO0lBSkE7UUFLVyxVQUFLLEdBQUcsYUFBYSxDQUFDO1FBQ3RCLFlBQU8sR0FBRyxnQkFBZ0IsQ0FBQztRQUMzQixTQUFJLEdBQUcsYUFBYSxDQUFDO1FBQ3JCLG1CQUFjLEdBQUcsZUFBZSxDQUFDO1FBQ2pDLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkIsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDbkIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixhQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlO1FBQzdCLFlBQU8sR0FBZ0MsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNwRSxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBRWYsZ0JBQVcsR0FBRyxLQUFLLENBQUM7SUFpSHRCLENBQUM7SUE1R0Msb0NBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztJQUNyRixDQUFDO0lBRUQsa0NBQU0sR0FBTixVQUFPLE1BQU87UUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDbkYsSUFBSSxDQUFD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TSxFQUFFLEtBQUssRUFBRSxDQUFDO3FEQUFvQjtJQWZoRCxpQkFBaUI7UUFKN0IsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLGVBQWU7WUFDekIsOCtEQUF5QztTQUMxQyxDQUFDO09BQ1csaUJBQWlCLENBNkg3QjtJQUFELHdCQUFDO0NBQUEsQUE3SEQsSUE2SEM7U0E3SFksaUJBQWlCO0FBd0k5QixJQUFLLFVBS0o7QUFMRCxXQUFLLFVBQVU7SUFDYiwyQ0FBSSxDQUFBO0lBQ0osbURBQVEsQ0FBQTtJQUNSLDJEQUFZLENBQUE7SUFDWiw2REFBYSxDQUFBO0FBQ2YsQ0FBQyxFQUxJLFVBQVUsS0FBVixVQUFVLFFBS2QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIFZpZXdDaGlsZCxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBzb21lIH0gZnJvbSAnbG9kYXNoLWVzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRyb3AtYXJlYScsXG4gIHRlbXBsYXRlVXJsOiAnLi9kcm9wLWFyZWEuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERyb3BBcmVhQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgdGl0bGUgPSAnVXBsb2FkIGZpbGUnO1xuICBASW5wdXQoKSBtZXNzYWdlID0gJ0Ryb3AgZmlsZSBoZXJlJztcbiAgQElucHV0KCkgaWNvbiA9ICdwbHVzLXNxdWFyZSc7XG4gIEBJbnB1dCgpIGxvYWRpbmdNZXNzYWdlID0gJ1VwbG9hZGluZyAuLi4nO1xuICBASW5wdXQoKSBhbHdheXNTaG93ID0gZmFsc2U7XG4gIEBJbnB1dCgpIGNsaWNrVG9PcGVuID0gdHJ1ZTtcbiAgQElucHV0KCkgbG9hZGluZyA9IGZhbHNlO1xuICBASW5wdXQoKSBwcm9ncmVzcyA9IC0xOyAvLyAtMSA9IHNwaW5uZXJcbiAgQE91dHB1dCgpIGRyb3BwZWQ6IEV2ZW50RW1pdHRlcjxEcm9wcGVkRmlsZVtdPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgaXNPdmVyID0gZmFsc2U7XG5cbiAgZmlsZUlzRW1wdHkgPSBmYWxzZTtcbiAgQFZpZXdDaGlsZCgnYXJlYScsIHsgc3RhdGljOiB0cnVlIH0pIGFyZWE6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ3pvbmUnLCB7IHN0YXRpYzogZmFsc2UgfSkgem9uZTogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZCgncGlja2VyJywgeyBzdGF0aWM6IGZhbHNlIH0pIHBpY2tlcjogRWxlbWVudFJlZjtcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmFsd2F5c1Nob3cgPSB0aGlzLmFsd2F5c1Nob3cgfHwgdGhpcy5hcmVhLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW4ubGVuZ3RoID09PSAwO1xuICB9XG5cbiAgdG9nZ2xlKCRldmVudD8pIHtcbiAgICB0aGlzLnpvbmUubmF0aXZlRWxlbWVudC5zdHlsZS5oZWlnaHQgPSB0aGlzLmFyZWEubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQgKyAncHgnO1xuICAgIHRoaXMub25PdmVyKCk7XG4gIH1cblxuICBzaG93UGlja2VyKCRldmVudD8pIHtcbiAgICB0aGlzLnByZXZlbnREZWZhdWx0KCRldmVudCk7XG4gICAgdGhpcy5waWNrZXIubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgIHRoaXMucGlja2VyLm5hdGl2ZUVsZW1lbnQuY2xpY2soKTtcbiAgfVxuXG4gIG9uT3ZlcigpIHtcbiAgICBpZiAoIXRoaXMuaXNPdmVyKSB7XG4gICAgICB0aGlzLmlzT3ZlciA9IHRydWU7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMucHJldmVudERlZmF1bHQpO1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIHRoaXMucHJldmVudERlZmF1bHQpO1xuICAgIH1cbiAgfVxuXG4gIG9uUGljaygkZXZlbnQpIHtcbiAgICB0aGlzLmZpbGVJc0VtcHR5ID0gZmFsc2U7XG4gICAgdGhpcy5wcmV2ZW50RGVmYXVsdCgkZXZlbnQpO1xuICAgIHRoaXMub25GaWxlc1NlbGVjdGVkKCRldmVudC50YXJnZXQuZmlsZXMpO1xuICB9XG5cbiAgb25Ecm9wKCRldmVudCkge1xuICAgIHRoaXMucHJldmVudERlZmF1bHQoJGV2ZW50KTtcbiAgICB0aGlzLm9uRmlsZXNTZWxlY3RlZCgkZXZlbnQuZGF0YVRyYW5zZmVyLmZpbGVzKTtcbiAgICB0aGlzLnN0b3BEcmFnZ2luZygpO1xuICB9XG5cbiAgb25GaWxlc1NlbGVjdGVkKGZpbGVzKSB7XG4gICAgdGhpcy5maWxlSXNFbXB0eSA9IGZhbHNlO1xuICAgIGlmIChmaWxlcyAmJiBmaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICBpZiAodGhpcy5pc0FueUZpbGVFbXB0eShmaWxlcykpIHtcbiAgICAgICAgdGhpcy5maWxlSXNFbXB0eSA9IHRydWU7XG4gICAgICAgIHRoaXMuZHJvcHBlZC5lbWl0KFtdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZHJvcHBlZC5lbWl0KHRoaXMuY29tcG9zZShmaWxlcykpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlzQW55RmlsZUVtcHR5KGZpbGVzKSB7XG4gICAgcmV0dXJuIHNvbWUoQXJyYXkuZnJvbShmaWxlcyksIFsnc2l6ZScsIDBdKTtcbiAgfVxuXG4gIHN0b3BEcmFnZ2luZygpIHtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMucHJldmVudERlZmF1bHQpO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCB0aGlzLnByZXZlbnREZWZhdWx0KTtcbiAgICB0aGlzLmlzT3ZlciA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmV2ZW50RGVmYXVsdCgkZXZlbnQ/KSB7XG4gICAgaWYgKCRldmVudCkge1xuICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb21wb3NlKGZpbGVzOiBGaWxlTGlzdCkge1xuICAgIHJldHVybiBBcnJheS5mcm9tKGZpbGVzKS5tYXAoZmlsZSA9PiAoe1xuICAgICAgZmlsZSxcbiAgICAgIHJlYWRBc0pzb246IGFzeW5jICgpID0+IEpTT04ucGFyc2UoYXdhaXQgdGhpcy5yZWFkKGZpbGUsIFJlYWRBc1R5cGUuVEVYVCkpLFxuICAgICAgcmVhZEFzVGV4dDogYXN5bmMgKCkgPT4gdGhpcy5yZWFkKGZpbGUsIFJlYWRBc1R5cGUuVEVYVCksXG4gICAgICByZWFkQXNBcnJheUJ1ZmZlcjogYXN5bmMgKCkgPT4gdGhpcy5yZWFkKGZpbGUsIFJlYWRBc1R5cGUuQVJSQVlfQlVGRkVSKSxcbiAgICAgIHJlYWRBc0JpbmFyeVN0cmluZzogYXN5bmMgKCkgPT4gdGhpcy5yZWFkKGZpbGUsIFJlYWRBc1R5cGUuQklOQVJZX1NUUklORyksXG4gICAgICByZWFkQXNEYXRhVVJMOiBhc3luYyAoKSA9PiB0aGlzLnJlYWQoZmlsZSwgUmVhZEFzVHlwZS5EQVRBX1VSTClcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlYWQoZmlsZSwgdHlwZTogUmVhZEFzVHlwZSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlIFJlYWRBc1R5cGUuVEVYVDoge1xuICAgICAgICAgIHJlYWRlci5yZWFkQXNUZXh0KGZpbGUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgUmVhZEFzVHlwZS5BUlJBWV9CVUZGRVI6IHtcbiAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBSZWFkQXNUeXBlLkJJTkFSWV9TVFJJTkc6IHtcbiAgICAgICAgICByZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgUmVhZEFzVHlwZS5EQVRBX1VSTDoge1xuICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZWFkZXIub25sb2FkID0gKCkgPT4gdGhpcy5vbkxvYWQocmVhZGVyLCByZXNvbHZlLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkxvYWQocmVhZGVyLCByZXNvbHZlLCByZWplY3QpIHtcbiAgICBpZiAocmVhZGVyLnJlYWR5U3RhdGUgIT09IDIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJlYWRlci5lcnJvcikge1xuICAgICAgcmVqZWN0KHJlYWRlci5lcnJvcik7XG4gICAgfVxuICAgIHJlc29sdmUocmVhZGVyLnJlc3VsdCk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEcm9wcGVkRmlsZSB7XG4gIGZpbGU6IEZpbGU7XG4gIHJlYWRBc1RleHQoKTtcbiAgcmVhZEFzQXJyYXlCdWZmZXIoKTtcbiAgcmVhZEFzQmluYXJ5U3RyaW5nKCk7XG4gIHJlYWRBc0RhdGFVUkwoKTtcbiAgcmVhZEFzSnNvbigpO1xufVxuXG5lbnVtIFJlYWRBc1R5cGUge1xuICBURVhULFxuICBEQVRBX1VSTCxcbiAgQVJSQVlfQlVGRkVSLFxuICBCSU5BUllfU1RSSU5HXG59XG4iXX0=