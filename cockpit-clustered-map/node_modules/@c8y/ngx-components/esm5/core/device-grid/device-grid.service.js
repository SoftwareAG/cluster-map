import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IManagedObject, InventoryService, QueriesUtil } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import { StatusDeviceGridColumn } from './columns/status.device-grid-column';
import { NameDeviceGridColumn } from './columns/name.device-grid-column';
import { ModelDeviceGridColumn } from './columns/model.device-grid-column';
import { SerialNumberDeviceGridColumn } from './columns/serial-number.device-grid-column';
import { GroupDeviceGridColumn } from './columns/group.device-grid-column';
import { RegistrationDateDeviceGridColumn } from './columns/registration-date.device-grid-column';
import { SystemIdDeviceGridColumn } from './columns/system-id.device-grid-column';
import { ImeiDeviceGridColumn } from './columns/imei.device-grid-column';
import { AlarmsDeviceGridColumn } from './columns/alarms.device-grid-column';
import { map, sortBy, get, identity, remove, transform, assign, forEach } from 'lodash-es';
var DeviceGridService = /** @class */ (function () {
    function DeviceGridService(inventoryService, translateService) {
        this.inventoryService = inventoryService;
        this.translateService = translateService;
        this.queriesUtil = new QueriesUtil();
    }
    DeviceGridService.prototype.getDefaultColumns = function () {
        return [
            new StatusDeviceGridColumn(),
            new NameDeviceGridColumn(),
            new ModelDeviceGridColumn(),
            new SerialNumberDeviceGridColumn(),
            new GroupDeviceGridColumn(),
            new RegistrationDateDeviceGridColumn(),
            new SystemIdDeviceGridColumn(),
            new ImeiDeviceGridColumn(),
            new AlarmsDeviceGridColumn()
        ];
    };
    DeviceGridService.prototype.getDefaultPagination = function () {
        return {
            pageSize: 10,
            currentPage: 1
        };
    };
    DeviceGridService.prototype.getDefaultActionControls = function () {
        var _this = this;
        return [
            {
                type: "DELETE" /* Delete */,
                callback: function (item) { return _this.delete(item); }
            }
        ];
    };
    DeviceGridService.prototype.getDefaultBulkActionControls = function () {
        return [];
    };
    DeviceGridService.prototype.getProperName = function (device) {
        var id = device.id, name = device.name;
        return name ? name : this.translateService.instant('Device {{id}}', { id: id });
    };
    DeviceGridService.prototype.getModel = function (device) {
        var hardware = this.getHardware(device);
        return hardware && hardware.model;
    };
    DeviceGridService.prototype.getSerialNumber = function (device) {
        var hardware = this.getHardware(device);
        var serialPropertyName = this.isVendme(device) ? 'serial' : 'serialNumber';
        return hardware && hardware[serialPropertyName];
    };
    DeviceGridService.prototype.getParentsNames = function (device, featuredParentId) {
        var assetParentsReferences = device.assetParents.references;
        var assetParents = map(assetParentsReferences, 'managedObject');
        var sortedByName = sortBy(assetParents, ['name']);
        var featuredItems = remove(sortedByName, { id: featuredParentId });
        var items = featuredItems.concat(sortedByName);
        var names = map(items, 'name');
        return names.join(', ');
    };
    DeviceGridService.prototype.getDeviceHref = function (device) {
        return "#/device/" + device.id;
    };
    DeviceGridService.prototype.getAlarmsHref = function (device) {
        return this.getDeviceHref(device) + "/alarms";
    };
    DeviceGridService.prototype.delete = function (device) {
        console.log('should delete', device);
    };
    DeviceGridService.prototype.getDevices = function (columns, pagination) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filters;
            return tslib_1.__generator(this, function (_a) {
                filters = tslib_1.__assign({}, this.getDevicesFilters(columns, pagination), { withParents: true });
                return [2 /*return*/, this.inventoryService.list(filters)];
            });
        });
    };
    DeviceGridService.prototype.getDevicesCount = function (columns, pagination) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filters;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        filters = tslib_1.__assign({}, this.getDevicesFilters(columns, pagination), { pageSize: 1, currentPage: 1 });
                        return [4 /*yield*/, this.inventoryService.list(filters)];
                    case 1: return [2 /*return*/, (_a.sent()).paging.totalPages];
                }
            });
        });
    };
    DeviceGridService.prototype.getDevicesTotal = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filters;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        filters = {
                            q: '',
                            pageSize: 1,
                            withTotalPages: true
                        };
                        return [4 /*yield*/, this.inventoryService.list(filters)];
                    case 1: return [2 /*return*/, (_a.sent()).paging.totalPages];
                }
            });
        });
    };
    DeviceGridService.prototype.getDeviceQueryString = function (columns) {
        return this.queriesUtil.buildQuery(this.getQueryObj(columns));
    };
    DeviceGridService.prototype.getHardware = function (device) {
        var hardwarePropertyName = this.isVendme(device)
            ? 'com_nsn_startups_vendme_fragments_VendingMachineTypeInfo'
            : 'c8y_Hardware';
        return device && device[hardwarePropertyName];
    };
    DeviceGridService.prototype.isVendme = function (device) {
        return device.type === 'com_nsn_startups_vendme_VendingMachine';
    };
    DeviceGridService.prototype.getDevicesFilters = function (columns, pagination) {
        return {
            q: this.getDeviceQueryString(columns),
            pageSize: pagination.pageSize,
            currentPage: pagination.currentPage,
            withTotalPages: true
        };
    };
    DeviceGridService.prototype.getQueryObj = function (columns) {
        var _this = this;
        return transform(columns, function (query, column) { return _this.extendQueryByColumn(query, column); }, {
            __filter: {},
            __orderby: []
        });
    };
    DeviceGridService.prototype.extendQueryByColumn = function (query, column) {
        if (column.filterable && column.externalFilterQuery) {
            var getFilter = column.filteringConfig.getFilter || identity;
            var queryObj = getFilter(column.externalFilterQuery);
            if (queryObj.__or) {
                query.__filter.__and = query.__filter.__and || [];
                query.__filter.__and.push(queryObj);
            }
            else if (queryObj.__and && get(query, '__filter.__and')) {
                queryObj.__and.map(function (obj) { return query.__filter.__and.push(obj); });
            }
            else {
                assign(query.__filter, queryObj);
            }
        }
        if (column.sortable && column.sortOrder) {
            var cs_1 = {};
            forEach(column.sortingConfig.pathSortingConfigs, function (pathSortingConfig) {
                cs_1[pathSortingConfig.path] =
                    (column.sortOrder === 'asc' ? 1 : -1) * (pathSortingConfig.sortOrderModifier || 1);
            });
            query.__orderby.push(cs_1);
        }
        return query;
    };
    DeviceGridService.ctorParameters = function () { return [
        { type: InventoryService },
        { type: TranslateService }
    ]; };
    DeviceGridService = tslib_1.__decorate([
        Injectable()
    ], DeviceGridService);
    return DeviceGridService;
}());
export { DeviceGridService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWdyaWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2RldmljZS1ncmlkL2RldmljZS1ncmlkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDN0UsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0UsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDMUYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0UsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDbEcsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDbEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDN0UsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHM0Y7SUFHRSwyQkFDVSxnQkFBa0MsRUFDbEMsZ0JBQWtDO1FBRGxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFD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QUFFLENBQUMsQ0FBQztTQUMxQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQzs7Z0JBL0oyQixnQkFBZ0I7Z0JBQ2hCLGdCQUFnQjs7SUFMakMsaUJBQWlCO1FBRDdCLFVBQVUsRUFBRTtPQUNBLGlCQUFpQixDQW9LN0I7SUFBRCx3QkFBQztDQUFBLEFBcEtELElBb0tDO1NBcEtZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERldmljZUdyaWRDb2x1bW4sIERldmljZUdyaWRBY3Rpb25UeXBlIH0gZnJvbSAnLi9kZXZpY2UtZ3JpZC5tb2RlbHMnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UsIFF1ZXJpZXNVdGlsIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgUGFnaW5hdGlvbiwgQWN0aW9uQ29udHJvbCwgQnVsa0FjdGlvbkNvbnRyb2wsIFJvdyB9IGZyb20gJy4uL2RhdGEtZ3JpZC9kYXRhLWdyaWQubW9kZWwnO1xuaW1wb3J0IHsgU3RhdHVzRGV2aWNlR3JpZENvbHVtbiB9IGZyb20gJy4vY29sdW1ucy9zdGF0dXMuZGV2aWNlLWdyaWQtY29sdW1uJztcbmltcG9ydCB7IE5hbWVEZXZpY2VHcmlkQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW5zL25hbWUuZGV2aWNlLWdyaWQtY29sdW1uJztcbmltcG9ydCB7IE1vZGVsRGV2aWNlR3JpZENvbHVtbiB9IGZyb20gJy4vY29sdW1ucy9tb2RlbC5kZXZpY2UtZ3JpZC1jb2x1bW4nO1xuaW1wb3J0IHsgU2VyaWFsTnVtYmVyRGV2aWNlR3JpZENvbHVtbiB9IGZyb20gJy4vY29sdW1ucy9zZXJpYWwtbnVtYmVyLmRldmljZS1ncmlkLWNvbHVtbic7XG5pbXBvcnQgeyBHcm91cERldmljZUdyaWRDb2x1bW4gfSBmcm9tICcuL2NvbHVtbnMvZ3JvdXAuZGV2aWNlLWdyaWQtY29sdW1uJztcbmltcG9ydCB7IFJlZ2lzdHJhdGlvbkRhdGVEZXZpY2VHcmlkQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW5zL3JlZ2lzdHJhdGlvbi1kYXRlLmRldmljZS1ncmlkLWNvbHVtbic7XG5pbXBvcnQgeyBTeXN0ZW1JZERldmljZUdyaWRDb2x1bW4gfSBmcm9tICcuL2NvbHVtbnMvc3lzdGVtLWlkLmRldmljZS1ncmlkLWNvbHVtbic7XG5pbXBvcnQgeyBJbWVpRGV2aWNlR3JpZENvbHVtbiB9IGZyb20gJy4vY29sdW1ucy9pbWVpLmRldmljZS1ncmlkLWNvbHVtbic7XG5pbXBvcnQgeyBBbGFybXNEZXZpY2VHcmlkQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW5zL2FsYXJtcy5kZXZpY2UtZ3JpZC1jb2x1bW4nO1xuaW1wb3J0IHsgbWFwLCBzb3J0QnksIGdldCwgaWRlbnRpdHksIHJlbW92ZSwgdHJhbnNmb3JtLCBhc3NpZ24sIGZvckVhY2ggfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGV2aWNlR3JpZFNlcnZpY2Uge1xuICBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZVxuICApIHtcbiAgICB0aGlzLnF1ZXJpZXNVdGlsID0gbmV3IFF1ZXJpZXNVdGlsKCk7XG4gIH1cblxuICBnZXREZWZhdWx0Q29sdW1ucygpOiBEZXZpY2VHcmlkQ29sdW1uW10ge1xuICAgIHJldHVybiBbXG4gICAgICBuZXcgU3RhdHVzRGV2aWNlR3JpZENvbHVtbigpLFxuICAgICAgbmV3IE5hbWVEZXZpY2VHcmlkQ29sdW1uKCksXG4gICAgICBuZXcgTW9kZWxEZXZpY2VHcmlkQ29sdW1uKCksXG4gICAgICBuZXcgU2VyaWFsTnVtYmVyRGV2aWNlR3JpZENvbHVtbigpLFxuICAgICAgbmV3IEdyb3VwRGV2aWNlR3JpZENvbHVtbigpLFxuICAgICAgbmV3IFJlZ2lzdHJhdGlvbkRhdGVEZXZpY2VHcmlkQ29sdW1uKCksXG4gICAgICBuZXcgU3lzdGVtSWREZXZpY2VHcmlkQ29sdW1uKCksXG4gICAgICBuZXcgSW1laURldmljZUdyaWRDb2x1bW4oKSxcbiAgICAgIG5ldyBBbGFybXNEZXZpY2VHcmlkQ29sdW1uKClcbiAgICBdO1xuICB9XG5cbiAgZ2V0RGVmYXVsdFBhZ2luYXRpb24oKTogUGFnaW5hdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhZ2VTaXplOiAxMCxcbiAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgfTtcbiAgfVxuXG4gIGdldERlZmF1bHRBY3Rpb25Db250cm9scygpOiBBY3Rpb25Db250cm9sW10ge1xuICAgIHJldHVybiBbXG4gICAgICB7XG4gICAgICAgIHR5cGU6IERldmljZUdyaWRBY3Rpb25UeXBlLkRlbGV0ZSxcbiAgICAgICAgY2FsbGJhY2s6IChpdGVtOiBSb3cpID0+IHRoaXMuZGVsZXRlKGl0ZW0gYXMgSU1hbmFnZWRPYmplY3QpXG4gICAgICB9XG4gICAgXTtcbiAgfVxuXG4gIGdldERlZmF1bHRCdWxrQWN0aW9uQ29udHJvbHMoKTogQnVsa0FjdGlvbkNvbnRyb2xbXSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0UHJvcGVyTmFtZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGlkLCBuYW1lIH0gPSBkZXZpY2U7XG4gICAgcmV0dXJuIG5hbWUgPyBuYW1lIDogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoJ0RldmljZSB7e2lkfX0nLCB7IGlkIH0pO1xuICB9XG5cbiAgZ2V0TW9kZWwoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IHN0cmluZyB7XG4gICAgY29uc3QgaGFyZHdhcmUgPSB0aGlzLmdldEhhcmR3YXJlKGRldmljZSk7XG4gICAgcmV0dXJuIGhhcmR3YXJlICYmIGhhcmR3YXJlLm1vZGVsO1xuICB9XG5cbiAgZ2V0U2VyaWFsTnVtYmVyKGRldmljZTogSU1hbmFnZWRPYmplY3QpOiBzdHJpbmcge1xuICAgIGNvbnN0IGhhcmR3YXJlID0gdGhpcy5nZXRIYXJkd2FyZShkZXZpY2UpO1xuICAgIGNvbnN0IHNlcmlhbFByb3BlcnR5TmFtZSA9IHRoaXMuaXNWZW5kbWUoZGV2aWNlKSA/ICdzZXJpYWwnIDogJ3NlcmlhbE51bWJlcic7XG4gICAgcmV0dXJuIGhhcmR3YXJlICYmIGhhcmR3YXJlW3NlcmlhbFByb3BlcnR5TmFtZV07XG4gIH1cblxuICBnZXRQYXJlbnRzTmFtZXMoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgZmVhdHVyZWRQYXJlbnRJZD86IHN0cmluZyB8IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgYXNzZXRQYXJlbnRzUmVmZXJlbmNlcyA9IGRldmljZS5hc3NldFBhcmVudHMucmVmZXJlbmNlcztcbiAgICBjb25zdCBhc3NldFBhcmVudHMgPSBtYXAoYXNzZXRQYXJlbnRzUmVmZXJlbmNlcywgJ21hbmFnZWRPYmplY3QnKTtcbiAgICBjb25zdCBzb3J0ZWRCeU5hbWUgPSBzb3J0QnkoYXNzZXRQYXJlbnRzLCBbJ25hbWUnXSk7XG4gICAgY29uc3QgZmVhdHVyZWRJdGVtcyA9IHJlbW92ZShzb3J0ZWRCeU5hbWUsIHsgaWQ6IGZlYXR1cmVkUGFyZW50SWQgfSk7XG4gICAgY29uc3QgaXRlbXMgPSBmZWF0dXJlZEl0ZW1zLmNvbmNhdChzb3J0ZWRCeU5hbWUpO1xuICAgIGNvbnN0IG5hbWVzID0gbWFwKGl0ZW1zLCAnbmFtZScpO1xuICAgIHJldHVybiBuYW1lcy5qb2luKCcsICcpO1xuICB9XG5cbiAgZ2V0RGV2aWNlSHJlZihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCMvZGV2aWNlLyR7ZGV2aWNlLmlkfWA7XG4gIH1cblxuICBnZXRBbGFybXNIcmVmKGRldmljZTogSU1hbmFnZWRPYmplY3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHt0aGlzLmdldERldmljZUhyZWYoZGV2aWNlKX0vYWxhcm1zYDtcbiAgfVxuXG4gIGRlbGV0ZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgY29uc29sZS5sb2coJ3Nob3VsZCBkZWxldGUnLCBkZXZpY2UpO1xuICB9XG5cbiAgYXN5bmMgZ2V0RGV2aWNlcyhjb2x1bW5zOiBEZXZpY2VHcmlkQ29sdW1uW10sIHBhZ2luYXRpb246IFBhZ2luYXRpb24pIHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgLi4udGhpcy5nZXREZXZpY2VzRmlsdGVycyhjb2x1bW5zLCBwYWdpbmF0aW9uKSxcbiAgICAgIHdpdGhQYXJlbnRzOiB0cnVlXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3QoZmlsdGVycyk7XG4gIH1cblxuICBhc3luYyBnZXREZXZpY2VzQ291bnQoY29sdW1uczogRGV2aWNlR3JpZENvbHVtbltdLCBwYWdpbmF0aW9uOiBQYWdpbmF0aW9uKSB7XG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIC4uLnRoaXMuZ2V0RGV2aWNlc0ZpbHRlcnMoY29sdW1ucywgcGFnaW5hdGlvbiksXG4gICAgICBwYWdlU2l6ZTogMSxcbiAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgfTtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0KGZpbHRlcnMpKS5wYWdpbmcudG90YWxQYWdlcztcbiAgfVxuXG4gIGFzeW5jIGdldERldmljZXNUb3RhbCgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICBxOiAnJyxcbiAgICAgIHBhZ2VTaXplOiAxLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWVcbiAgICB9O1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3QoZmlsdGVycykpLnBhZ2luZy50b3RhbFBhZ2VzO1xuICB9XG5cbiAgZ2V0RGV2aWNlUXVlcnlTdHJpbmcoY29sdW1uczogRGV2aWNlR3JpZENvbHVtbltdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5xdWVyaWVzVXRpbC5idWlsZFF1ZXJ5KHRoaXMuZ2V0UXVlcnlPYmooY29sdW1ucykpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIYXJkd2FyZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogYW55IHtcbiAgICBjb25zdCBoYXJkd2FyZVByb3BlcnR5TmFtZSA9IHRoaXMuaXNWZW5kbWUoZGV2aWNlKVxuICAgICAgPyAnY29tX25zbl9zdGFydHVwc192ZW5kbWVfZnJhZ21lbnRzX1ZlbmRpbmdNYWNoaW5lVHlwZUluZm8nXG4gICAgICA6ICdjOHlfSGFyZHdhcmUnO1xuICAgIHJldHVybiBkZXZpY2UgJiYgZGV2aWNlW2hhcmR3YXJlUHJvcGVydHlOYW1lXTtcbiAgfVxuXG4gIHByaXZhdGUgaXNWZW5kbWUoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIHJldHVybiBkZXZpY2UudHlwZSA9PT0gJ2NvbV9uc25fc3RhcnR1cHNfdmVuZG1lX1ZlbmRpbmdNYWNoaW5lJztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGV2aWNlc0ZpbHRlcnMoY29sdW1uczogRGV2aWNlR3JpZENvbHVtbltdLCBwYWdpbmF0aW9uOiBQYWdpbmF0aW9uKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHE6IHRoaXMuZ2V0RGV2aWNlUXVlcnlTdHJpbmcoY29sdW1ucyksXG4gICAgICBwYWdlU2l6ZTogcGFnaW5hdGlvbi5wYWdlU2l6ZSxcbiAgICAgIGN1cnJlbnRQYWdlOiBwYWdpbmF0aW9uLmN1cnJlbnRQYWdlLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWVcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRRdWVyeU9iaihjb2x1bW5zOiBEZXZpY2VHcmlkQ29sdW1uW10pOiBhbnkge1xuICAgIHJldHVybiB0cmFuc2Zvcm0oY29sdW1ucywgKHF1ZXJ5LCBjb2x1bW4pID0+IHRoaXMuZXh0ZW5kUXVlcnlCeUNvbHVtbihxdWVyeSwgY29sdW1uKSwge1xuICAgICAgX19maWx0ZXI6IHt9LFxuICAgICAgX19vcmRlcmJ5OiBbXVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRlbmRRdWVyeUJ5Q29sdW1uKHF1ZXJ5OiBhbnksIGNvbHVtbjogRGV2aWNlR3JpZENvbHVtbik6IHZvaWQge1xuICAgIGlmIChjb2x1bW4uZmlsdGVyYWJsZSAmJiBjb2x1bW4uZXh0ZXJuYWxGaWx0ZXJRdWVyeSkge1xuICAgICAgY29uc3QgZ2V0RmlsdGVyID0gY29sdW1uLmZpbHRlcmluZ0NvbmZpZy5nZXRGaWx0ZXIgfHwgaWRlbnRpdHk7XG4gICAgICBjb25zdCBxdWVyeU9iaiA9IGdldEZpbHRlcihjb2x1bW4uZXh0ZXJuYWxGaWx0ZXJRdWVyeSk7XG5cbiAgICAgIGlmIChxdWVyeU9iai5fX29yKSB7XG4gICAgICAgIHF1ZXJ5Ll9fZmlsdGVyLl9fYW5kID0gcXVlcnkuX19maWx0ZXIuX19hbmQgfHwgW107XG4gICAgICAgIHF1ZXJ5Ll9fZmlsdGVyLl9fYW5kLnB1c2gocXVlcnlPYmopO1xuICAgICAgfSBlbHNlIGlmIChxdWVyeU9iai5fX2FuZCAmJiBnZXQocXVlcnksICdfX2ZpbHRlci5fX2FuZCcpKSB7XG4gICAgICAgIHF1ZXJ5T2JqLl9fYW5kLm1hcChvYmogPT4gcXVlcnkuX19maWx0ZXIuX19hbmQucHVzaChvYmopKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFzc2lnbihxdWVyeS5fX2ZpbHRlciwgcXVlcnlPYmopO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjb2x1bW4uc29ydGFibGUgJiYgY29sdW1uLnNvcnRPcmRlcikge1xuICAgICAgY29uc3QgY3MgPSB7fTtcbiAgICAgIGZvckVhY2goY29sdW1uLnNvcnRpbmdDb25maWcucGF0aFNvcnRpbmdDb25maWdzLCBwYXRoU29ydGluZ0NvbmZpZyA9PiB7XG4gICAgICAgIGNzW3BhdGhTb3J0aW5nQ29uZmlnLnBhdGhdID1cbiAgICAgICAgICAoY29sdW1uLnNvcnRPcmRlciA9PT0gJ2FzYycgPyAxIDogLTEpICogKHBhdGhTb3J0aW5nQ29uZmlnLnNvcnRPcmRlck1vZGlmaWVyIHx8IDEpO1xuICAgICAgfSk7XG4gICAgICBxdWVyeS5fX29yZGVyYnkucHVzaChjcyk7XG4gICAgfVxuICAgIHJldHVybiBxdWVyeTtcbiAgfVxufVxuIl19