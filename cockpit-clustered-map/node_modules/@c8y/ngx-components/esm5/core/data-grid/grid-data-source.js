import { chunk, flow, get, isNil, mapValues, omitBy, orderBy, pick } from 'lodash-es';
import { BehaviorSubject, defer, from, isObservable, of } from 'rxjs';
import { catchError, finalize, map, tap, switchMap } from 'rxjs/operators';
var GridDataSource = /** @class */ (function () {
    function GridDataSource() {
        this.loadingSubject = new BehaviorSubject(false);
        this.dataSourceSubject = new BehaviorSubject([]);
        this.dataStatsSubject = new BehaviorSubject({
            size: 0,
            filteredSize: 0,
            currentPage: 0,
            currentPageSize: 0,
            firstPageSize: 0
        });
        this.dataSelectionSubject = new BehaviorSubject({
            filteredDataIds: []
        });
        this.loading$ = this.loadingSubject.asObservable();
        this.data$ = this.dataSourceSubject.asObservable();
        this.stats$ = this.dataStatsSubject.asObservable();
        this.selection$ = this.dataSelectionSubject.asObservable();
    }
    GridDataSource.prototype.connect = function (collectionViewer) {
        return this.data$;
    };
    GridDataSource.prototype.disconnect = function (collectionViewer) {
        this.loadingSubject.complete();
        this.dataSourceSubject.complete();
        this.dataStatsSubject.complete();
        this.dataSelectionSubject.complete();
    };
    GridDataSource.prototype.loadData = function (_a) {
        var _this = this;
        var rows = _a.rows, columns = _a.columns, pagination = _a.pagination, searchText = _a.searchText, serverSideDataCallback = _a.serverSideDataCallback, selectable = _a.selectable, selectionPrimaryKey = _a.selectionPrimaryKey;
        var clientSideData$ = this.toObservable(rows).pipe(map(function (initialData) {
            var filteredSize = 0;
            var filteredDataIds = [];
            var transformedData = flow(function (data) { return _this.doClientSideSearch({ data: data, columns: columns, searchText: searchText }); }, function (data) { return _this.doClientSideFiltering({ data: data, columns: columns }); }, function (data) { return _this.doClientSideSorting({ data: data, columns: columns }); }, function (data) {
                filteredSize = data.length;
                filteredDataIds = selectable
                    ? data.map(function (item) { return item[selectionPrimaryKey]; })
                    : filteredDataIds;
                return data;
            }, function (data) { return _this.doClientSidePagination({ data: data, pagination: pagination }); })(initialData);
            _this.dataStatsSubject.next({
                size: initialData.length,
                filteredSize: filteredSize,
                currentPage: pagination.currentPage,
                currentPageSize: transformedData.length,
                firstPageSize: pagination.pageSize
            });
            _this.dataSelectionSubject.next({ filteredDataIds: filteredDataIds });
            return transformedData;
        }));
        var serverSideData$ = defer(function () {
            return _this.toObservable(serverSideDataCallback({
                columns: columns,
                searchText: searchText,
                pagination: pagination,
                selection: { enabled: selectable, primaryKey: selectionPrimaryKey }
            }));
        }).pipe(map(function (result) {
            var data = result.data, paging = result.paging, size = result.size, filteredSize = result.filteredSize, filteredDataIds = result.filteredDataIds;
            _this.dataStatsSubject.next({
                size: size,
                filteredSize: filteredSize,
                currentPage: paging.currentPage,
                currentPageSize: data.length,
                firstPageSize: paging.pageSize
            });
            _this.dataSelectionSubject.next({ filteredDataIds: filteredDataIds || [] });
            return data;
        }));
        var data$ = typeof serverSideDataCallback === 'function' ? serverSideData$ : clientSideData$;
        of([])
            .pipe(tap(function () { return _this.loadingSubject.next(true); }), switchMap(function () { return data$; }), catchError(function (err) {
            _this.dataStatsSubject.next({
                size: 0,
                filteredSize: 0,
                currentPage: 0,
                currentPageSize: 0,
                firstPageSize: 0
            });
            _this.dataSelectionSubject.next({ filteredDataIds: [] });
            return of([]);
        }), finalize(function () { return _this.loadingSubject.next(false); }))
            .subscribe(function (data) {
            _this.dataSourceSubject.next(data);
        });
    };
    GridDataSource.prototype.resolveValue = function (x, path) {
        return get(x, path);
    };
    GridDataSource.prototype.resolveFunction = function (x) {
        return typeof x === 'function' ? x() : x;
    };
    GridDataSource.prototype.normalizeNil = function (x) {
        return isNil(x) ? '' : x;
    };
    GridDataSource.prototype.doClientSideFiltering = function (_a) {
        var _this = this;
        var data = _a.data, columns = _a.columns;
        return columns.reduce(function (result, column) {
            var filterPredicate = column.filterPredicate;
            if (typeof filterPredicate === 'string') {
                return _this.doClientSideSearch({
                    data: result,
                    columns: [column],
                    searchText: filterPredicate
                });
            }
            if (typeof filterPredicate === 'function') {
                return result.filter(function (item) { return filterPredicate(item, column.path); });
            }
            return result;
        }, data);
    };
    GridDataSource.prototype.doClientSideSearch = function (_a) {
        var _this = this;
        var data = _a.data, columns = _a.columns, searchText = _a.searchText;
        var propPaths = columns.map(function (_a) {
            var path = _a.path;
            return path;
        }).filter(function (column) { return !isNil(column); });
        var regexSearch = this.createRegexSearch(searchText);
        return data.filter(function (item) {
            var itemWithResolvedValues = flow(function (x) { return pick(x, propPaths); }, function (x) { return mapValues(x, _this.resolveFunction); }, function (x) { return omitBy(x, isNil); })(item);
            var cellValues = Object.values(itemWithResolvedValues);
            return cellValues.some(function (cellValue) { return regexSearch.test(cellValue.toString()); });
        });
    };
    GridDataSource.prototype.doClientSideSorting = function (_a) {
        var data = _a.data, columns = _a.columns;
        var actives = columns.filter(function (_a) {
            var sortOrder = _a.sortOrder;
            return !!sortOrder;
        });
        var sortingState = {
            paths: actives.map(function (_a) {
                var path = _a.path;
                return path;
            }),
            orders: actives.map(function (_a) {
                var sortOrder = _a.sortOrder;
                return sortOrder;
            })
        };
        return orderBy(data, sortingState.paths, sortingState.orders);
    };
    GridDataSource.prototype.doClientSidePagination = function (_a) {
        var data = _a.data, pagination = _a.pagination;
        return pagination
            ? get(chunk(data, pagination.pageSize), pagination.currentPage - 1, [])
            : data;
    };
    GridDataSource.prototype.createRegexSearch = function (filterValue) {
        return RegExp(escapeRegExpPattern(filterValue), 'i');
    };
    GridDataSource.prototype.toObservable = function (x) {
        return isObservable(x) ? x : x instanceof Promise ? from(x) : of(x);
    };
    return GridDataSource;
}());
export { GridDataSource };
/**
 *
 * @param string pattern Regex pattern.
 * @return string The escaped regex.
 * @see https://stackoverflow.com/a/3561711/2013891
 */
function escapeRegExpPattern(pattern) {
    if (pattern === void 0) { pattern = ''; }
    return pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1kYXRhLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2RhdGEtZ3JpZC9ncmlkLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxLQUFLLEVBQ0wsSUFBSSxFQUNKLEdBQUcsRUFFSCxLQUFLLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixPQUFPLEVBRVAsSUFBSSxFQUNMLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQWMsRUFBRSxFQUFTLE1BQU0sTUFBTSxDQUFDO0FBQ3pGLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJM0U7SUFtQkU7UUFiUSxtQkFBYyxHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQ3JELHNCQUFpQixHQUFHLElBQUksZUFBZSxDQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELHFCQUFnQixHQUFHLElBQUksZUFBZSxDQUFrQjtZQUM5RCxJQUFJLEVBQUUsQ0FBQztZQUNQLFlBQVksRUFBRSxDQUFDO1lBQ2YsV0FBVyxFQUFFLENBQUM7WUFDZCxlQUFlLEVBQUUsQ0FBQztZQUNsQixhQUFhLEVBQUUsQ0FBQztTQUNqQixDQUFDLENBQUM7UUFDSyx5QkFBb0IsR0FBRyxJQUFJLGVBQWUsQ0FBTTtZQUN0RCxlQUFlLEVBQUUsRUFBRTtTQUNwQixDQUFDLENBQUM7UUFHRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0s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QixHQUF6QixVQUEwQixXQUFXO1FBQ25DLE9BQU8sTUFBTSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyxxQ0FBWSxHQUFwQixVQUFxQixDQUFDO1FBQ3BCLE9BQU8sWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFDSCxxQkFBQztBQUFELENBQUMsQUEzTUQsSUEyTUM7O0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFTLG1CQUFtQixDQUFDLE9BQVk7SUFBWix3QkFBQSxFQUFBLFlBQVk7SUFDdkMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3hELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2xsZWN0aW9uVmlld2VyLCBEYXRhU291cmNlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvbGxlY3Rpb25zJztcbmltcG9ydCB7XG4gIGNodW5rLFxuICBmbG93LFxuICBnZXQsXG4gIGlzTmFOIGFzIF9pc05hTixcbiAgaXNOaWwsXG4gIG1hcFZhbHVlcyxcbiAgb21pdEJ5LFxuICBvcmRlckJ5LFxuICBwYXJzZUludCBhcyBfcGFyc2VJbnQsXG4gIHBpY2tcbn0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZGVmZXIsIGZyb20sIGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YsIGVtcHR5IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaW5hbGl6ZSwgbWFwLCB0YXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQ29sdW1uLCBEYXRhU291cmNlU3RhdHMsIFNlcnZlclNpZGVEYXRhUmVzdWx0IH0gZnJvbSAnLi9kYXRhLWdyaWQubW9kZWwnO1xuXG5leHBvcnQgY2xhc3MgR3JpZERhdGFTb3VyY2UgaW1wbGVtZW50cyBEYXRhU291cmNlPG9iamVjdD4ge1xuICBsb2FkaW5nJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgZGF0YSQ6IE9ic2VydmFibGU8b2JqZWN0W10+O1xuICBzdGF0cyQ6IE9ic2VydmFibGU8RGF0YVNvdXJjZVN0YXRzPjtcbiAgc2VsZWN0aW9uJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIHByaXZhdGUgbG9hZGluZ1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgcHJpdmF0ZSBkYXRhU291cmNlU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8b2JqZWN0W10+KFtdKTtcbiAgcHJpdmF0ZSBkYXRhU3RhdHNTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxEYXRhU291cmNlU3RhdHM+KHtcbiAgICBzaXplOiAwLFxuICAgIGZpbHRlcmVkU2l6ZTogMCxcbiAgICBjdXJyZW50UGFnZTogMCxcbiAgICBjdXJyZW50UGFnZVNpemU6IDAsXG4gICAgZmlyc3RQYWdlU2l6ZTogMFxuICB9KTtcbiAgcHJpdmF0ZSBkYXRhU2VsZWN0aW9uU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55Pih7XG4gICAgZmlsdGVyZWREYXRhSWRzOiBbXVxuICB9KTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmxvYWRpbmckID0gdGhpcy5sb2FkaW5nU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLmRhdGEkID0gdGhpcy5kYXRhU291cmNlU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLnN0YXRzJCA9IHRoaXMuZGF0YVN0YXRzU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLnNlbGVjdGlvbiQgPSB0aGlzLmRhdGFTZWxlY3Rpb25TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgY29ubmVjdChjb2xsZWN0aW9uVmlld2VyOiBDb2xsZWN0aW9uVmlld2VyKTogT2JzZXJ2YWJsZTxvYmplY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmRhdGEkO1xuICB9XG5cbiAgZGlzY29ubmVjdChjb2xsZWN0aW9uVmlld2VyOiBDb2xsZWN0aW9uVmlld2VyKTogdm9pZCB7XG4gICAgdGhpcy5sb2FkaW5nU3ViamVjdC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZGF0YVNvdXJjZVN1YmplY3QuY29tcGxldGUoKTtcbiAgICB0aGlzLmRhdGFTdGF0c1N1YmplY3QuY29tcGxldGUoKTtcbiAgICB0aGlzLmRhdGFTZWxlY3Rpb25TdWJqZWN0LmNvbXBsZXRlKCk7XG4gIH1cblxuICBsb2FkRGF0YSh7XG4gICAgcm93cyxcbiAgICBjb2x1bW5zLFxuICAgIHBhZ2luYXRpb24sXG4gICAgc2VhcmNoVGV4dCxcbiAgICBzZXJ2ZXJTaWRlRGF0YUNhbGxiYWNrLFxuICAgIHNlbGVjdGFibGUsXG4gICAgc2VsZWN0aW9uUHJpbWFyeUtleVxuICB9KSB7XG4gICAgY29uc3QgY2xpZW50U2lkZURhdGEkID0gdGhpcy50b09ic2VydmFibGUocm93cykucGlwZShcbiAgICAgIG1hcChpbml0aWFsRGF0YSA9PiB7XG4gICAgICAgIGxldCBmaWx0ZXJlZFNpemUgPSAwO1xuICAgICAgICBsZXQgZmlsdGVyZWREYXRhSWRzID0gW107XG5cbiAgICAgICAgY29uc3QgdHJhbnNmb3JtZWREYXRhID0gZmxvdyhcbiAgICAgICAgICBkYXRhID0+IHRoaXMuZG9DbGllbnRTaWRlU2VhcmNoKHsgZGF0YSwgY29sdW1ucywgc2VhcmNoVGV4dCB9KSxcbiAgICAgICAgICBkYXRhID0+IHRoaXMuZG9DbGllbnRTaWRlRmlsdGVyaW5nKHsgZGF0YSwgY29sdW1ucyB9KSxcbiAgICAgICAgICBkYXRhID0+IHRoaXMuZG9DbGllbnRTaWRlU29ydGluZyh7IGRhdGEsIGNvbHVtbnMgfSksXG4gICAgICAgICAgZGF0YSA9PiB7XG4gICAgICAgICAgICBmaWx0ZXJlZFNpemUgPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgICAgIGZpbHRlcmVkRGF0YUlkcyA9IHNlbGVjdGFibGVcbiAgICAgICAgICAgICAgPyBkYXRhLm1hcChpdGVtID0+IGl0ZW1bc2VsZWN0aW9uUHJpbWFyeUtleV0pXG4gICAgICAgICAgICAgIDogZmlsdGVyZWREYXRhSWRzO1xuXG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGRhdGEgPT4gdGhpcy5kb0NsaWVudFNpZGVQYWdpbmF0aW9uKHsgZGF0YSwgcGFnaW5hdGlvbiB9KVxuICAgICAgICApKGluaXRpYWxEYXRhKTtcblxuICAgICAgICB0aGlzLmRhdGFTdGF0c1N1YmplY3QubmV4dCh7XG4gICAgICAgICAgc2l6ZTogaW5pdGlhbERhdGEubGVuZ3RoLFxuICAgICAgICAgIGZpbHRlcmVkU2l6ZSxcbiAgICAgICAgICBjdXJyZW50UGFnZTogcGFnaW5hdGlvbi5jdXJyZW50UGFnZSxcbiAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IHRyYW5zZm9ybWVkRGF0YS5sZW5ndGgsXG4gICAgICAgICAgZmlyc3RQYWdlU2l6ZTogcGFnaW5hdGlvbi5wYWdlU2l6ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5kYXRhU2VsZWN0aW9uU3ViamVjdC5uZXh0KHsgZmlsdGVyZWREYXRhSWRzIH0pO1xuXG4gICAgICAgIHJldHVybiB0cmFuc2Zvcm1lZERhdGE7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBzZXJ2ZXJTaWRlRGF0YSQgPSBkZWZlcigoKSA9PlxuICAgICAgdGhpcy50b09ic2VydmFibGUoXG4gICAgICAgIHNlcnZlclNpZGVEYXRhQ2FsbGJhY2soe1xuICAgICAgICAgIGNvbHVtbnMsXG4gICAgICAgICAgc2VhcmNoVGV4dCxcbiAgICAgICAgICBwYWdpbmF0aW9uLFxuICAgICAgICAgIHNlbGVjdGlvbjogeyBlbmFibGVkOiBzZWxlY3RhYmxlLCBwcmltYXJ5S2V5OiBzZWxlY3Rpb25QcmltYXJ5S2V5IH1cbiAgICAgICAgfSlcbiAgICAgIClcbiAgICApLnBpcGUoXG4gICAgICBtYXAoKHJlc3VsdDogU2VydmVyU2lkZURhdGFSZXN1bHQpID0+IHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBwYWdpbmcsIHNpemUsIGZpbHRlcmVkU2l6ZSwgZmlsdGVyZWREYXRhSWRzIH0gPSByZXN1bHQ7XG5cbiAgICAgICAgdGhpcy5kYXRhU3RhdHNTdWJqZWN0Lm5leHQoe1xuICAgICAgICAgIHNpemUsXG4gICAgICAgICAgZmlsdGVyZWRTaXplLFxuICAgICAgICAgIGN1cnJlbnRQYWdlOiBwYWdpbmcuY3VycmVudFBhZ2UsXG4gICAgICAgICAgY3VycmVudFBhZ2VTaXplOiBkYXRhLmxlbmd0aCxcbiAgICAgICAgICBmaXJzdFBhZ2VTaXplOiBwYWdpbmcucGFnZVNpemVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZGF0YVNlbGVjdGlvblN1YmplY3QubmV4dCh7IGZpbHRlcmVkRGF0YUlkczogZmlsdGVyZWREYXRhSWRzIHx8IFtdIH0pO1xuXG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgZGF0YSQgPSB0eXBlb2Ygc2VydmVyU2lkZURhdGFDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJyA/IHNlcnZlclNpZGVEYXRhJCA6IGNsaWVudFNpZGVEYXRhJDtcblxuICAgIG9mKFtdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmxvYWRpbmdTdWJqZWN0Lm5leHQodHJ1ZSkpLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gZGF0YSQpLFxuICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5kYXRhU3RhdHNTdWJqZWN0Lm5leHQoe1xuICAgICAgICAgICAgc2l6ZTogMCxcbiAgICAgICAgICAgIGZpbHRlcmVkU2l6ZTogMCxcbiAgICAgICAgICAgIGN1cnJlbnRQYWdlOiAwLFxuICAgICAgICAgICAgY3VycmVudFBhZ2VTaXplOiAwLFxuICAgICAgICAgICAgZmlyc3RQYWdlU2l6ZTogMFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuZGF0YVNlbGVjdGlvblN1YmplY3QubmV4dCh7IGZpbHRlcmVkRGF0YUlkczogW10gfSk7XG4gICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMubG9hZGluZ1N1YmplY3QubmV4dChmYWxzZSkpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKGRhdGEgPT4ge1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2VTdWJqZWN0Lm5leHQoZGF0YSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHJlc29sdmVWYWx1ZSh4LCBwYXRoKSB7XG4gICAgcmV0dXJuIGdldCh4LCBwYXRoKTtcbiAgfVxuXG4gIHJlc29sdmVGdW5jdGlvbih4KSB7XG4gICAgcmV0dXJuIHR5cGVvZiB4ID09PSAnZnVuY3Rpb24nID8geCgpIDogeDtcbiAgfVxuXG4gIG5vcm1hbGl6ZU5pbCh4KSB7XG4gICAgcmV0dXJuIGlzTmlsKHgpID8gJycgOiB4O1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NsaWVudFNpZGVGaWx0ZXJpbmcoeyBkYXRhLCBjb2x1bW5zIH0pIHtcbiAgICByZXR1cm4gY29sdW1ucy5yZWR1Y2UoKHJlc3VsdCwgY29sdW1uKSA9PiB7XG4gICAgICBjb25zdCB7IGZpbHRlclByZWRpY2F0ZSB9ID0gY29sdW1uO1xuXG4gICAgICBpZiAodHlwZW9mIGZpbHRlclByZWRpY2F0ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9DbGllbnRTaWRlU2VhcmNoKHtcbiAgICAgICAgICBkYXRhOiByZXN1bHQsXG4gICAgICAgICAgY29sdW1uczogW2NvbHVtbl0sXG4gICAgICAgICAgc2VhcmNoVGV4dDogZmlsdGVyUHJlZGljYXRlXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGZpbHRlclByZWRpY2F0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICByZXR1cm4gcmVzdWx0LmZpbHRlcihpdGVtID0+IGZpbHRlclByZWRpY2F0ZShpdGVtLCBjb2x1bW4ucGF0aCkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIGRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NsaWVudFNpZGVTZWFyY2goeyBkYXRhLCBjb2x1bW5zLCBzZWFyY2hUZXh0IH0pIHtcbiAgICBjb25zdCBwcm9wUGF0aHMgPSBjb2x1bW5zLm1hcCgoeyBwYXRoIH0pID0+IHBhdGgpLmZpbHRlcihjb2x1bW4gPT4gIWlzTmlsKGNvbHVtbikpO1xuXG4gICAgY29uc3QgcmVnZXhTZWFyY2ggPSB0aGlzLmNyZWF0ZVJlZ2V4U2VhcmNoKHNlYXJjaFRleHQpO1xuXG4gICAgcmV0dXJuIGRhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaXRlbVdpdGhSZXNvbHZlZFZhbHVlcyA9IGZsb3coXG4gICAgICAgIHggPT4gcGljayh4LCBwcm9wUGF0aHMpLFxuICAgICAgICB4ID0+IG1hcFZhbHVlcyh4LCB0aGlzLnJlc29sdmVGdW5jdGlvbiksXG4gICAgICAgIHggPT4gb21pdEJ5KHgsIGlzTmlsKVxuICAgICAgKShpdGVtKTtcblxuICAgICAgY29uc3QgY2VsbFZhbHVlcyA9IE9iamVjdC52YWx1ZXMoaXRlbVdpdGhSZXNvbHZlZFZhbHVlcyk7XG5cbiAgICAgIHJldHVybiBjZWxsVmFsdWVzLnNvbWUoY2VsbFZhbHVlID0+IHJlZ2V4U2VhcmNoLnRlc3QoY2VsbFZhbHVlLnRvU3RyaW5nKCkpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZG9DbGllbnRTaWRlU29ydGluZyh7IGRhdGEsIGNvbHVtbnMgfSkge1xuICAgIGNvbnN0IGFjdGl2ZXM6IENvbHVtbltdID0gY29sdW1ucy5maWx0ZXIoKHsgc29ydE9yZGVyIH06IENvbHVtbikgPT4gISFzb3J0T3JkZXIpO1xuXG4gICAgY29uc3Qgc29ydGluZ1N0YXRlID0ge1xuICAgICAgcGF0aHM6IGFjdGl2ZXMubWFwKCh7IHBhdGggfSkgPT4gcGF0aCksXG4gICAgICBvcmRlcnM6IGFjdGl2ZXMubWFwKCh7IHNvcnRPcmRlciB9KSA9PiBzb3J0T3JkZXIpXG4gICAgfTtcblxuICAgIHJldHVybiBvcmRlckJ5KGRhdGEsIHNvcnRpbmdTdGF0ZS5wYXRocywgc29ydGluZ1N0YXRlLm9yZGVycyk7XG4gIH1cblxuICBwcml2YXRlIGRvQ2xpZW50U2lkZVBhZ2luYXRpb24oeyBkYXRhLCBwYWdpbmF0aW9uIH0pIHtcbiAgICByZXR1cm4gcGFnaW5hdGlvblxuICAgICAgPyBnZXQoY2h1bmsoZGF0YSwgcGFnaW5hdGlvbi5wYWdlU2l6ZSksIHBhZ2luYXRpb24uY3VycmVudFBhZ2UgLSAxLCBbXSlcbiAgICAgIDogZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVnZXhTZWFyY2goZmlsdGVyVmFsdWUpIHtcbiAgICByZXR1cm4gUmVnRXhwKGVzY2FwZVJlZ0V4cFBhdHRlcm4oZmlsdGVyVmFsdWUpLCAnaScpO1xuICB9XG5cbiAgcHJpdmF0ZSB0b09ic2VydmFibGUoeCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGlzT2JzZXJ2YWJsZSh4KSA/IHggOiB4IGluc3RhbmNlb2YgUHJvbWlzZSA/IGZyb20oeCkgOiBvZih4KTtcbiAgfVxufVxuXG4vKipcbiAqXG4gKiBAcGFyYW0gc3RyaW5nIHBhdHRlcm4gUmVnZXggcGF0dGVybi5cbiAqIEByZXR1cm4gc3RyaW5nIFRoZSBlc2NhcGVkIHJlZ2V4LlxuICogQHNlZSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzU2MTcxMS8yMDEzODkxXG4gKi9cbmZ1bmN0aW9uIGVzY2FwZVJlZ0V4cFBhdHRlcm4ocGF0dGVybiA9ICcnKSB7XG4gIHJldHVybiBwYXR0ZXJuLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7XG59XG4iXX0=