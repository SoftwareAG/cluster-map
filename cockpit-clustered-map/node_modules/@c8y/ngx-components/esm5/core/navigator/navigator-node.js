import * as tslib_1 from "tslib";
import { matches } from 'lodash-es';
var NavigatorNode = /** @class */ (function () {
    function NavigatorNode(data) {
        this.children = [];
        this.parents = [];
        this.routerLinkExact = true;
        this.open = false;
        this.hidden = false;
        this.draggable = false;
        this.droppable = false;
        this.dragged = false;
        this.draggedHover = false;
        this.confirm = undefined;
        this._priority = 0;
        this.update(data);
    }
    Object.defineProperty(NavigatorNode.prototype, "hasChildren", {
        get: function () {
            return this.children.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigatorNode.prototype, "priority", {
        get: function () {
            if (this._priority) {
                return this._priority;
            }
            else {
                var childrenPriorities = this.children.map(function (_a) {
                    var priority = _a.priority;
                    return priority || 0;
                });
                if (childrenPriorities.length) {
                    return childrenPriorities.length ? Math.max.apply(Math, tslib_1.__spread(childrenPriorities)) : 0;
                }
                return 0;
            }
        },
        set: function (priority) {
            this._priority = priority;
        },
        enumerable: true,
        configurable: true
    });
    NavigatorNode.prototype.openOnStart = function (url) {
        return false;
    };
    NavigatorNode.prototype.add = function (node) {
        if (node === this) {
            throw new Error('Adding node to itself');
        }
        if (this.children.indexOf(node) === -1) {
            this.children.push(node);
        }
        if (node.parents.indexOf(this) === -1) {
            node.parents.push(this);
        }
        this.updateChildren();
    };
    NavigatorNode.prototype.remove = function (node) {
        var ix = this.children.indexOf(node);
        var pix = node.parents.indexOf(this);
        if (ix > -1) {
            this.children.splice(ix, 1);
        }
        if (pix > -1) {
            node.parents.splice(pix, 1);
        }
        this.updateChildren();
    };
    NavigatorNode.prototype.update = function (data) {
        if (data) {
            Object.assign(this, data);
            if (data.hidden !== undefined) {
                this.parents.forEach(function (p) {
                    p.updateHidden();
                });
            }
        }
    };
    NavigatorNode.prototype.find = function (predicate) {
        if (typeof predicate === 'string') {
            var compareLabel_1 = predicate.toLocaleLowerCase();
            predicate = function (_a) {
                var label = _a.label;
                return compareLabel_1 === label.toLowerCase();
            };
        }
        if (typeof predicate === 'object') {
            predicate = matches(predicate);
        }
        if (typeof predicate !== 'function') {
            throw new Error('Invalid search predicate');
        }
        return this.children.reduce(function (found, child) { return found || child.find(predicate); }, this.children.find(predicate));
    };
    NavigatorNode.prototype.empty = function () {
        this.children.length = 0;
    };
    NavigatorNode.prototype.click = function (options) {
        if (options === void 0) { options = {}; }
        // do nothing
    };
    NavigatorNode.prototype.drop = function ($event) {
        $event.stopPropagation();
        clearTimeout(this.expandDragTimeout);
    };
    NavigatorNode.prototype.dragStart = function ($event) {
        $event.stopPropagation();
        // we can't pass a object to setData, so we do it via service
        // set data is still needed, to make the drag&drop work
        $event.dataTransfer.setData('node', 'node');
        this.dragged = true;
    };
    NavigatorNode.prototype.dragEnd = function ($event) {
        $event.stopPropagation();
        this.dragged = false;
        $event.dataTransfer.clearData();
    };
    Object.defineProperty(NavigatorNode.prototype, "canDrop", {
        get: function () {
            return this.droppable;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigatorNode.prototype, "canNavigate", {
        get: function () {
            return typeof this.path !== 'undefined';
        },
        enumerable: true,
        configurable: true
    });
    NavigatorNode.prototype.dragEnter = function ($event) {
        var _this = this;
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = true;
        if (!this.open) {
            this.expandDragTimeout = setTimeout(function () { return _this.expand(); }, 1000);
        }
    };
    NavigatorNode.prototype.dragLeave = function ($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = false;
        clearTimeout(this.expandDragTimeout);
    };
    NavigatorNode.prototype.expand = function () {
        if (!this.open) {
            this.open = true;
            this.click({ open: true, expander: true });
        }
    };
    NavigatorNode.prototype.traverse = function (callback) {
        if (this.children) {
            this.children.forEach(function (child) {
                callback(child);
                child.traverse(callback);
            });
        }
    };
    NavigatorNode.prototype.destroy = function () {
        // nothing todo here
    };
    NavigatorNode.prototype.updateChildren = function () {
        this.sort();
        this.updateHidden();
    };
    NavigatorNode.prototype.sort = function () {
        this.children.sort(function (a, b) {
            if (a.priority > b.priority) {
                return -1;
            }
            else if (a.priority < b.priority) {
                return 1;
            }
            else if ((a.label || '').toLowerCase() < (b.label || '').toLowerCase()) {
                return -1;
            }
            else if ((a.label || '').toLowerCase() > (b.label || '').toLowerCase()) {
                return 1;
            }
            else {
                return 0;
            }
        });
    };
    NavigatorNode.prototype.updateHidden = function () {
        if (typeof this.path === 'undefined') {
            this.hidden = !this.children.some(function (_a) {
                var hidden = _a.hidden;
                return !hidden;
            });
        }
    };
    return NavigatorNode;
}());
export { NavigatorNode };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9uYXZpZ2F0b3IvbmF2aWdhdG9yLW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFXcEM7SUF3Q0UsdUJBQVksSUFBd0I7UUFwQ3BDLGFBQVEsR0FBb0IsRUFBRSxDQUFDO1FBRy9CLFlBQU8sR0FBb0IsRUFBRSxDQUFDO1FBRTlCLG9CQUFlLEdBQVksSUFBSSxDQUFDO1FBQ2hDLFNBQUksR0FBWSxLQUFLLENBQUM7UUFDdEIsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFDM0IsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixZQUFPLEdBQTRCLFNBQVMsQ0FBQztRQUNyQyxjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBd0I1QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUF0QkQsc0JBQUksc0NBQVc7YUFBZjtZQUNFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLENBQUM7OztPQUFBO0lBRUQsc0JBQUksbUNBQVE7YUFBWjtZQUNFLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNMLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBQyxFQUFZO3dCQUFWLHNCQUFRO29CQUFPLE9BQUEsUUFBUSxJQUFJLENBQUM7Z0JBQWIsQ0FBYSxDQUFDLENBQUM7Z0JBQzlFLElBQUksa0JBQWtCLENBQUMsTUFBTSxF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bGF0ZVJlZiwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWF0Y2hlcyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBOYXZpZ2F0b3JOb2RlRGF0YSB9IGZyb20gJy4vbmF2aWdhdG9yLW5vZGUtZGF0YSc7XG5pbXBvcnQgeyBQb3BvdmVyQ29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4uL21vZGFsL3BvcG92ZXItY29uZmlybS5jb21wb25lbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENsaWNrT3B0aW9ucyB7XG4gIGljb24/OiBib29sZWFuO1xuICBleHBhbmRlcj86IGJvb2xlYW47XG4gIG9wZW4/OiBib29sZWFuO1xuICAkZXZlbnQ/OiBhbnk7IC8vIFRPRE86IGFkZCBwcm9wZXIgdHlwZVxufVxuXG5leHBvcnQgY2xhc3MgTmF2aWdhdG9yTm9kZSB7XG4gIGljb246IHN0cmluZztcbiAgaWNvblRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcbiAgaWNvbkNvbXBvbmVudD86IFR5cGU8YW55PjtcbiAgY2hpbGRyZW46IE5hdmlnYXRvck5vZGVbXSA9IFtdO1xuICBsYWJlbDtcbiAgcGF0aDogc3RyaW5nO1xuICBwYXJlbnRzOiBOYXZpZ2F0b3JOb2RlW10gPSBbXTtcbiAgbG9hZGluZz86IGJvb2xlYW47XG4gIHJvdXRlckxpbmtFeGFjdDogYm9vbGVhbiA9IHRydWU7XG4gIG9wZW46IGJvb2xlYW4gPSBmYWxzZTtcbiAgaGlkZGVuOiBib29sZWFuID0gZmFsc2U7XG4gIGRyYWdnYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuICBkcm9wcGFibGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgZHJhZ2dlZCA9IGZhbHNlO1xuICBkcmFnZ2VkSG92ZXIgPSBmYWxzZTtcbiAgY29uZmlybTogUG9wb3ZlckNvbmZpcm1Db21wb25lbnQgPSB1bmRlZmluZWQ7XG4gIHByaXZhdGUgX3ByaW9yaXR5OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGV4cGFuZERyYWdUaW1lb3V0O1xuXG4gIGdldCBoYXNDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwO1xuICB9XG5cbiAgZ2V0IHByaW9yaXR5KCkge1xuICAgIGlmICh0aGlzLl9wcmlvcml0eSkge1xuICAgICAgcmV0dXJuIHRoaXMuX3ByaW9yaXR5O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjaGlsZHJlblByaW9yaXRpZXMgPSB0aGlzLmNoaWxkcmVuLm1hcCgoeyBwcmlvcml0eSB9KSA9PiBwcmlvcml0eSB8fCAwKTtcbiAgICAgIGlmIChjaGlsZHJlblByaW9yaXRpZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBjaGlsZHJlblByaW9yaXRpZXMubGVuZ3RoID8gTWF0aC5tYXgoLi4uY2hpbGRyZW5Qcmlvcml0aWVzKSA6IDA7XG4gICAgICB9XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICBzZXQgcHJpb3JpdHkocHJpb3JpdHkpIHtcbiAgICB0aGlzLl9wcmlvcml0eSA9IHByaW9yaXR5O1xuICB9XG5cbiAgY29uc3RydWN0b3IoZGF0YT86IE5hdmlnYXRvck5vZGVEYXRhKSB7XG4gICAgdGhpcy51cGRhdGUoZGF0YSk7XG4gIH1cblxuICBvcGVuT25TdGFydCh1cmw6IHN0cmluZykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFkZChub2RlOiBOYXZpZ2F0b3JOb2RlKSB7XG4gICAgaWYgKCBub2RlID09PSB0aGlzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FkZGluZyBub2RlIHRvIGl0c2VsZicpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jaGlsZHJlbi5pbmRleE9mKG5vZGUpID09PSAtMSkge1xuICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKG5vZGUpO1xuICAgIH1cbiAgICBpZiAobm9kZS5wYXJlbnRzLmluZGV4T2YodGhpcykgPT09IC0xKSB7XG4gICAgICBub2RlLnBhcmVudHMucHVzaCh0aGlzKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVDaGlsZHJlbigpO1xuICB9XG5cbiAgcmVtb3ZlKG5vZGU6IE5hdmlnYXRvck5vZGUpIHtcbiAgICBjb25zdCBpeCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihub2RlKTtcbiAgICBjb25zdCBwaXggPSBub2RlLnBhcmVudHMuaW5kZXhPZih0aGlzKTtcbiAgICBpZiAoaXggPiAtMSkge1xuICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaXgsIDEpO1xuICAgIH1cbiAgICBpZiAocGl4ID4gLTEpIHtcbiAgICAgIG5vZGUucGFyZW50cy5zcGxpY2UocGl4LCAxKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVDaGlsZHJlbigpO1xuICB9XG5cbiAgdXBkYXRlKGRhdGE/OiBOYXZpZ2F0b3JOb2RlRGF0YSkge1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHRoaXMsIGRhdGEpO1xuICAgICAgaWYgKGRhdGEuaGlkZGVuICAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMucGFyZW50cy5mb3JFYWNoKChwKSA9PiB7XG4gICAgICAgICAgcC51cGRhdGVIaWRkZW4oKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZmluZChwcmVkaWNhdGUpIHtcbiAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IGNvbXBhcmVMYWJlbCA9IHByZWRpY2F0ZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgICAgcHJlZGljYXRlID0gKHsgbGFiZWwgfSkgPT4gIGNvbXBhcmVMYWJlbCA9PT0gbGFiZWwudG9Mb3dlckNhc2UoKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwcmVkaWNhdGUgPT09ICdvYmplY3QnKSB7XG4gICAgICBwcmVkaWNhdGUgPSBtYXRjaGVzKHByZWRpY2F0ZSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcHJlZGljYXRlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2VhcmNoIHByZWRpY2F0ZScpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5yZWR1Y2UoXG4gICAgICAoZm91bmQsIGNoaWxkKSA9PiBmb3VuZCB8fCBjaGlsZC5maW5kKHByZWRpY2F0ZSksXG4gICAgICB0aGlzLmNoaWxkcmVuLmZpbmQocHJlZGljYXRlKVxuICAgICk7XG4gIH1cblxuICBlbXB0eSgpIHtcbiAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9IDA7XG4gIH1cblxuICBjbGljayhvcHRpb25zOiBDbGlja09wdGlvbnMgPSB7fSkge1xuICAgIC8vIGRvIG5vdGhpbmdcbiAgfVxuXG4gIGRyb3AoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cGFuZERyYWdUaW1lb3V0KTtcbiAgfVxuXG4gIGRyYWdTdGFydCgkZXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgLy8gd2UgY2FuJ3QgcGFzcyBhIG9iamVjdCB0byBzZXREYXRhLCBzbyB3ZSBkbyBpdCB2aWEgc2VydmljZVxuICAgIC8vIHNldCBkYXRhIGlzIHN0aWxsIG5lZWRlZCwgdG8gbWFrZSB0aGUgZHJhZyZkcm9wIHdvcmtcbiAgICAkZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEoJ25vZGUnLCAnbm9kZScpO1xuICAgIHRoaXMuZHJhZ2dlZCA9IHRydWU7XG4gIH1cblxuICBkcmFnRW5kKCRldmVudCkge1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmRyYWdnZWQgPSBmYWxzZTtcbiAgICAkZXZlbnQuZGF0YVRyYW5zZmVyLmNsZWFyRGF0YSgpO1xuICB9XG5cbiAgZ2V0IGNhbkRyb3AoKSB7XG4gICAgcmV0dXJuIHRoaXMuZHJvcHBhYmxlO1xuICB9XG5cbiAgZ2V0IGNhbk5hdmlnYXRlKCkge1xuICAgIHJldHVybiB0eXBlb2YgdGhpcy5wYXRoICE9PSAndW5kZWZpbmVkJztcbiAgfVxuXG4gIGRyYWdFbnRlcigkZXZlbnQpIHtcbiAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kcmFnZ2VkSG92ZXIgPSB0cnVlO1xuICAgIGlmICghdGhpcy5vcGVuKSB7XG4gICAgICB0aGlzLmV4cGFuZERyYWdUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmV4cGFuZCgpLCAxMDAwKTtcbiAgICB9XG4gIH1cblxuICBkcmFnTGVhdmUoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwYW5kRHJhZ1RpbWVvdXQpO1xuICB9XG5cbiAgZXhwYW5kKCkge1xuICAgIGlmICghdGhpcy5vcGVuKSB7XG4gICAgICB0aGlzLm9wZW4gPSB0cnVlO1xuICAgICAgdGhpcy5jbGljayh7b3BlbjogdHJ1ZSwgZXhwYW5kZXI6IHRydWV9KTtcbiAgICB9XG4gIH1cblxuICB0cmF2ZXJzZShjYWxsYmFjaykge1xuICAgIGlmICh0aGlzLmNoaWxkcmVuKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKGNoaWxkKTtcbiAgICAgICAgY2hpbGQudHJhdmVyc2UoY2FsbGJhY2spO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICAvLyBub3RoaW5nIHRvZG8gaGVyZVxuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUNoaWxkcmVuKCkge1xuICAgIHRoaXMuc29ydCgpO1xuICAgIHRoaXMudXBkYXRlSGlkZGVuKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc29ydCgpIHtcbiAgICB0aGlzLmNoaWxkcmVuLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChhLnByaW9yaXR5ID4gYi5wcmlvcml0eSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgICAgfSBlbHNlIGlmICgoYS5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSA8IChiLmxhYmVsIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH0gZWxzZSBpZiAoKGEubGFiZWwgfHwgJycpLnRvTG93ZXJDYXNlKCkgPiAoYi5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUhpZGRlbigpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucGF0aCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuaGlkZGVuID0gIXRoaXMuY2hpbGRyZW4uc29tZSgoeyBoaWRkZW4gfSkgPT4gIWhpZGRlbik7XG4gICAgfVxuICB9XG59XG4iXX0=