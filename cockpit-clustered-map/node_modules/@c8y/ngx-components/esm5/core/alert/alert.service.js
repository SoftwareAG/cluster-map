import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
var AlertService = /** @class */ (function (_super) {
    tslib_1.__extends(AlertService, _super);
    function AlertService() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.state$ = new BehaviorSubject([]);
        _this.MAX_ALERTS = 3;
        _this.ALERT_TIMEOUT = 3000;
        return _this;
    }
    Object.defineProperty(AlertService.prototype, "state", {
        /**
         * Returns all alerts.
         * @readonly
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Adds a new alert to the current state.
     */
    AlertService.prototype.add = function (alert) {
        this.addAlert(alert);
    };
    /**
     * Adds a alert by text.
     */
    AlertService.prototype.addByText = function (type, txt, detailedData) {
        this.addAlert({ text: txt, type: type, detailedData: detailedData });
    };
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    AlertService.prototype.list = function () {
        return this.state;
    };
    /**
     * Remove an alert from the current state.
     */
    AlertService.prototype.remove = function (alert) {
        var _this = this;
        this.changeAlerts(this.state.filter(function (item) { return !_this.areSame(alert, item); }));
    };
    /**
     * Removes last danger alert. Replacement for silentError.
     *
     * @example
     * ```typescript
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alarmService.removeLastDanger();
     *  }
     * ```
     */
    AlertService.prototype.removeLastDanger = function () {
        var firstDangerAlarm = this.state.reverse().find(function (_a) {
            var type = _a.type;
            return type === 'danger';
        });
        this.changeAlerts(this.state.filter(function (alarm) { return alarm !== firstDangerAlarm; }));
    };
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.saveSuccess = function (savedObject) {
        var _this = this;
        return function () {
            var text = savedObject + " saved successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.createSuccess = function (createdObject) {
        var _this = this;
        return function () {
            var text = createdObject + " created successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Clears all alerts.
     */
    AlertService.prototype.clearAll = function () {
        this.changeAlerts([]);
    };
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.success = function (text, detailedData) {
        this.addByText('success', text, detailedData);
    };
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.danger = function (text, detailedData) {
        this.addByText('danger', text, detailedData);
    };
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.info = function (text, detailedData) {
        this.addByText('info', text, detailedData);
    };
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.warning = function (text, detailedData) {
        this.addByText('warning', text, detailedData);
    };
    AlertService.prototype.addServerFailure = function (error, type) {
        if (type === void 0) { type = 'danger'; }
        var data = error.data, res = error.res;
        var text = data && data.message ? data.message : null;
        var detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        var hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url,
            };
        }
        this.addAlert({
            type: type,
            text: text,
            detailedData: detailedData
        });
    };
    AlertService.prototype.areSame = function (alert1, alert2) {
        return alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            alert1.detailedData === alert2.detailedData &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail;
    };
    AlertService.prototype.changeAlerts = function (newAlerts) {
        this.state$.next(newAlerts);
    };
    AlertService.prototype.addAlert = function (alert) {
        var _this = this;
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        var alertAlreadyAdded = this.state
            .find(function (item) { return _this.areSame(alert, item); });
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts(tslib_1.__spread(this.state, [alert]));
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    };
    AlertService.prototype.hideAutomaticallyIfNeeded = function (alert) {
        var _this = this;
        var isSuccess = alert.type === 'success';
        var noDetails = !alert.detailedData;
        var alertTimeout = (isSuccess && noDetails) ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(function () { return _this.remove(alert); }, alertTimeout);
        }
    };
    AlertService.prototype.removeOldestIfMax = function () {
        if (this.state.length > this.MAX_ALERTS) {
            var _a = tslib_1.__read(this.state), firstRemoved = _a.slice(1);
            this.changeAlerts(firstRemoved);
        }
    };
    AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
    AlertService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root',
        })
    ], AlertService);
    return AlertService;
}(StateService));
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDOztBQUcxQzs7R0FFRztBQUlIO0lBQWtDLHdDQUFZO0lBSDlDO1FBQUEscUVBK01DO1FBbk1DLFlBQU0sR0FBRyxJQUFJLGVBQWUsQ0FBVSxFQUFFLENBQUMsQ0FBQztRQUVsQyxnQkFBVSxHQUFHLENBQUMsQ0FBQztRQUNmLG1CQUFhLEdBQUcsSUFBSSxDQUFDOztLQWdNOUI7SUF0TUMsc0JBQUksK0JBQUs7UUFKVDs7O1dBR0c7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDM0IsQ0FBQzs7O09BQUE7SUFNRDs7T0FFRztJQUNILDBCQUFHLEdBQUgsVUFBSSxLQUFZO1FBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQ0FBUyxHQUFULFVBQVUsSUFBZSxFQUFFLEdBQVcsRUFBRSxZQUFxQjtRQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLE1BQUEsRUFBRSxZQUFZLGNBQUEsRUFBRSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVEOzs7T0FHRztJQUNILDJCQUFJLEdBQUo7UUFDRSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsNkJBQU0s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LENBQUMsQ0FBQztTQUNqQztJQUNILENBQUM7O0lBM01VLFlBQVk7UUFIeEIsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztPQUNXLFlBQVksQ0E0TXhCO3VCQXpORDtDQXlOQyxBQTVNRCxDQUFrQyxZQUFZLEdBNE03QztTQTVNWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWxlcnQgfSBmcm9tICcuL2FsZXJ0Lm1vZGVsJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3N0YXRlLXNlcnZpY2UuYWJzdHJhY3QnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uL2kxOG4vZ2V0dGV4dCc7XG5cbnR5cGUgYWxlcnRUeXBlID0gICdzdWNjZXNzJyB8ICd3YXJuaW5nJyB8ICdkYW5nZXInIHwgJ2luZm8nIHwgJ3N5c3RlbSc7XG4vKipcbiAqIEEgc2VydmljZSB3aGljaCBhbGxvd3MgdG8gZGlzcGxheSBhbGVydHMuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBBbGVydFNlcnZpY2UgZXh0ZW5kcyBTdGF0ZVNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBhbGVydHMuXG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IHN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlJC52YWx1ZTtcbiAgfVxuICBzdGF0ZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEFsZXJ0W10+KFtdKTtcblxuICBwcml2YXRlIE1BWF9BTEVSVFMgPSAzO1xuICBwcml2YXRlIEFMRVJUX1RJTUVPVVQgPSAzMDAwO1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgbmV3IGFsZXJ0IHRvIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgYWRkKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuYWRkQWxlcnQoYWxlcnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBhbGVydCBieSB0ZXh0LlxuICAgKi9cbiAgYWRkQnlUZXh0KHR5cGU6IGFsZXJ0VHlwZSwgdHh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuYWRkQWxlcnQoeyB0ZXh0OiB0eHQsIHR5cGUsIGRldGFpbGVkRGF0YSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBhbGVydHMuXG4gICAqIEBkZXByZWNhdGVkIFVzZSBhbGVydFNlcnZpY2UuYWxlcnRzIGluc3RlYWQuXG4gICAqL1xuICBsaXN0KCk6IEFsZXJ0W10ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbiBhbGVydCBmcm9tIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgcmVtb3ZlKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKHRoaXMuc3RhdGUuZmlsdGVyKChpdGVtKSA9PiAhdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgbGFzdCBkYW5nZXIgYWxlcnQuIFJlcGxhY2VtZW50IGZvciBzaWxlbnRFcnJvci5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiAgdHJ5IHtcbiAgICogICAgLy8gc29tZXRoaW5nIHRoYXQgbWlnaHQgdGhyb3cgYSBkYW5nZXIgc2VydmVyIG1zZ1xuICAgKiAgfSBjYXRjaCAoZXgpIHtcbiAgICogICB0aGlzLmFsYXJtU2VydmljZS5yZW1vdmVMYXN0RGFuZ2VyKCk7XG4gICAqICB9XG4gICAqIGBgYFxuICAgKi9cbiAgcmVtb3ZlTGFzdERhbmdlcigpIHtcbiAgICBjb25zdCBmaXJzdERhbmdlckFsYXJtID0gdGhpcy5zdGF0ZS5yZXZlcnNlKCkuZmluZCgoeyB0eXBlIH0pID0+IHR5cGUgPT09ICdkYW5nZXInKTtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcigoYWxhcm0pID0+IGFsYXJtICE9PSBmaXJzdERhbmdlckFsYXJtKSk7XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIHNhdmUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIHNhdmVkT2JqZWN0IFRoZSBvYmplY3Qgd2hpY2ggd2FzIHNhdmVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgc2F2ZVN1Y2Nlc3Moc2F2ZWRPYmplY3Q6IHN0cmluZykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7c2F2ZWRPYmplY3R9IHNhdmVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIGNyZWF0ZSBzdWNjZXNzZnVsIGFsZXJ0LlxuICAgKiBAcGFyYW0gY3JlYXRlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBjcmVhdGVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgY3JlYXRlU3VjY2VzcyhjcmVhdGVkT2JqZWN0KSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRleHQgPSBgJHtjcmVhdGVkT2JqZWN0fSBjcmVhdGVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIGFsbCBhbGVydHMuXG4gICAqL1xuICBjbGVhckFsbCgpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbXSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBzdWNjZXNzIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBzdWNjZXNzIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgc3VjY2Vzcyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIGRhbmdlciBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgZGFuZ2VyIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgZGFuZ2VyKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ2RhbmdlcicsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBpbmZvIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBpbmZvIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgaW5mbyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdpbmZvJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIHdhcm5pbmcgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIHdhcm5pbmcgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICB3YXJuaW5nKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ3dhcm5pbmcnLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgYWRkU2VydmVyRmFpbHVyZShlcnJvcjogYW55LCB0eXBlOiBhbGVydFR5cGUgPSAnZGFuZ2VyJykge1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBlcnJvcjtcbiAgICBsZXQgdGV4dCA9IGRhdGEgJiYgZGF0YS5tZXNzYWdlID8gZGF0YS5tZXNzYWdlIDogbnVsbDtcbiAgICBsZXQgZGV0YWlsZWREYXRhO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGEuZXhjZXB0aW9uTWVzc2FnZTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGE7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhc1JlbGV2YW50TWVzc2FnZSA9ICEhKHRleHQgfHwgZGV0YWlsZWREYXRhKTtcbiAgICBpZiAoIXRleHQpIHtcbiAgICAgIHRleHQgPSBnZXR0ZXh0KCdBIHNlcnZlciBlcnJvciBvY2N1cnJlZC4nKTtcbiAgICB9XG4gICAgaWYgKCFoYXNSZWxldmFudE1lc3NhZ2UpIHtcbiAgICAgIGRldGFpbGVkRGF0YSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiByZXMuc3RhdHVzVGV4dCxcbiAgICAgICAgdXJsOiByZXMudXJsLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZEFsZXJ0KHtcbiAgICAgIHR5cGUsXG4gICAgICB0ZXh0LFxuICAgICAgZGV0YWlsZWREYXRhXG4gICAgfSk7XG4gIH1cblxuICBhcmVTYW1lKGFsZXJ0MTogQWxlcnQsIGFsZXJ0MjogQWxlcnQpIHtcbiAgICByZXR1cm4gYWxlcnQxLnRleHQgPT09IGFsZXJ0Mi50ZXh0ICYmXG4gICAgICBhbGVydDEudHlwZSA9PT0gYWxlcnQyLnR5cGUgJiZcbiAgICAgIGFsZXJ0MS5kZXRhaWxlZERhdGEgPT09IGFsZXJ0Mi5kZXRhaWxlZERhdGEgJiZcbiAgICAgIGFsZXJ0MS5vbkNsb3NlID09PSBhbGVydDIub25DbG9zZSAmJlxuICAgICAgYWxlcnQxLm9uRGV0YWlsID09PSBhbGVydDIub25EZXRhaWw7XG4gIH1cblxuICBwcml2YXRlIGNoYW5nZUFsZXJ0cyhuZXdBbGVydHM6IEFsZXJ0W10pIHtcbiAgICB0aGlzLnN0YXRlJC5uZXh0KG5ld0FsZXJ0cyk7XG4gIH1cblxuICBwcml2YXRlIGFkZEFsZXJ0KGFsZXJ0OiBBbGVydCk6IHZvaWQge1xuICAgIGlmICghYWxlcnQudGV4dCAmJiAhYWxlcnQudHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYWRkIGVtcHR5IGFsZXJ0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgYWxlcnRBbHJlYWR5QWRkZWQgPSB0aGlzLnN0YXRlXG4gICAgICAgIC5maW5kKChpdGVtKSA9PiB0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKTtcbiAgICBpZiAoYWxlcnRBbHJlYWR5QWRkZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbLi4udGhpcy5zdGF0ZSwgYWxlcnRdKTtcbiAgICB0aGlzLmhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQpO1xuICAgIHRoaXMucmVtb3ZlT2xkZXN0SWZNYXgoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGlkZUF1dG9tYXRpY2FsbHlJZk5lZWRlZChhbGVydDogQWxlcnQpIHtcbiAgICBjb25zdCBpc1N1Y2Nlc3MgPSBhbGVydC50eXBlID09PSAnc3VjY2Vzcyc7XG4gICAgY29uc3Qgbm9EZXRhaWxzID0gIWFsZXJ0LmRldGFpbGVkRGF0YTtcbiAgICBsZXQgYWxlcnRUaW1lb3V0ID0gKGlzU3VjY2VzcyAmJiBub0RldGFpbHMpID8gdGhpcy5BTEVSVF9USU1FT1VUIDogMDtcbiAgICBpZiAodHlwZW9mIGFsZXJ0LnRpbWVvdXQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBhbGVydFRpbWVvdXQgPSBhbGVydC50aW1lb3V0O1xuICAgIH1cbiAgICBpZiAoYWxlcnRUaW1lb3V0KSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucmVtb3ZlKGFsZXJ0KSwgYWxlcnRUaW1lb3V0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZU9sZGVzdElmTWF4KCkge1xuICAgIGlmICh0aGlzLnN0YXRlLmxlbmd0aCA+IHRoaXMuTUFYX0FMRVJUUykge1xuICAgICAgY29uc3QgWywgLi4uZmlyc3RSZW1vdmVkXSA9IHRoaXMuc3RhdGU7XG4gICAgICB0aGlzLmNoYW5nZUFsZXJ0cyhmaXJzdFJlbW92ZWQpO1xuICAgIH1cbiAgfVxufVxuIl19