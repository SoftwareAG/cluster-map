import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter } from '@angular/core';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { ActionType } from './export-schedules.interface';
import { ReportsService } from './reports.service';
import { CronService } from './cron.service';
import { cloneDeep } from 'lodash';
import { gettext } from '@c8y/ngx-components';
var ScheduleModalComponent = /** @class */ (function () {
    function ScheduleModalComponent(modalRef, reportsService, cronService) {
        this.modalRef = modalRef;
        this.reportsService = reportsService;
        this.cronService = cronService;
        this.emitter = new EventEmitter();
        this.ActionType = ActionType;
        this.multiEmailPattern = /^([a-z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-z0-9-]+(\.[a-z0-9-]+)*,?)*$/i;
        this.singleEmailPattern = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
        this.cronExpression = '* * * * *';
        this.validCron = false;
        this.emitterPayload = {
            success: false,
            message: ''
        };
        this.placeholdersInfo = gettext('Available placeholders: {tenant-domain}, {host}, {binaryId}. Whole link to downloadable file is: {tenant-domain}/inventory/binaries/{binaryId}.');
        this.savingStatus = {
            inProgress: false,
            done: false,
            error: false
        };
    }
    ScheduleModalComponent.prototype.ngOnInit = function () {
        this.oldSchedule = cloneDeep(this.schedule);
        this.populateEmailFieldsFromSchedule(this.schedule);
        this.cronExpression = this.cronService.generateCron(this.schedule.cronConfig);
        this.validCron = this.cronService.validateModels(this.cronService.getBase(this.schedule.cronConfig), this.schedule.cronConfig);
    };
    ScheduleModalComponent.prototype.populateEmailFieldsFromSchedule = function (schedule) {
        if (schedule.emailConfig.to && schedule.emailConfig.to.length) {
            this.emailTo = schedule.emailConfig.to.toString();
        }
        if (schedule.emailConfig.cc && schedule.emailConfig.cc.length) {
            this.emailCc = schedule.emailConfig.cc.toString();
        }
        if (schedule.emailConfig.bcc && schedule.emailConfig.bcc.length) {
            this.emailBcc = schedule.emailConfig.bcc.toString();
        }
        if (schedule.emailConfig.replyTo) {
            this.emailReplyTo = schedule.emailConfig.replyTo;
        }
        if (schedule.emailConfig.subject) {
            this.emailSubject = schedule.emailConfig.subject;
        }
        if (schedule.emailConfig.text) {
            this.emailText = schedule.emailConfig.text;
        }
    };
    ScheduleModalComponent.prototype.save = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var success, date, timestamp;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.populateScheduleFromCronExpression();
                        this.populateScheduleFromEmailFields();
                        this.savingStatus.inProgress = true;
                        success = false;
                        if (!(this.actionType === ActionType.EDIT)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.reportsService.updateSchedule(this.oldSchedule, this.schedule, this.exportId)];
                    case 1:
                        success = _a.sent();
                        return [3 /*break*/, 4];
                    case 2:
                        date = new Date();
                        timestamp = date.getTime();
                        this.schedule.timestamp = timestamp;
                        return [4 /*yield*/, this.reportsService.addSchedule(this.schedule, this.exportId)];
                    case 3:
                        success = _a.sent();
                        _a.label = 4;
                    case 4:
                        if (success) {
                            this.modalRef.hide();
                            // signal to the parent component to update list
                            this.emitterPayload.success = true;
                            this.emitter.emit(this.emitterPayload);
                        }
                        this.savingStatus.inProgress = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    ScheduleModalComponent.prototype.cancel = function () {
        this.modalRef.hide();
    };
    ScheduleModalComponent.prototype.getCron = function (cron) {
        this.validCron = cron.valid;
        if (cron.valid) {
            this.cronExpression = cron.cron;
        }
    };
    ScheduleModalComponent.prototype.populateScheduleFromCronExpression = function () {
        this.schedule.cronConfig = this.cronService.generateCronConfig(this.cronExpression);
    };
    ScheduleModalComponent.prototype.convertStringOfEmailsToArray = function (stringOfEmails) {
        var arr = [];
        if (stringOfEmails) {
            var parts = stringOfEmails.split(',');
            parts.forEach(function (item) {
                if (item) {
                    arr.push(item);
                }
            });
        }
        return arr;
    };
    ScheduleModalComponent.prototype.populateScheduleFromEmailFields = function () {
        this.schedule.emailConfig.to = this.emailTo
            ? this.convertStringOfEmailsToArray(this.emailTo)
            : null;
        this.schedule.emailConfig.cc = this.emailCc
            ? this.convertStringOfEmailsToArray(this.emailCc)
            : null;
        this.schedule.emailConfig.bcc = this.emailBcc
            ? this.convertStringOfEmailsToArray(this.emailBcc)
            : null;
        this.schedule.emailConfig.replyTo = this.emailReplyTo;
        this.schedule.emailConfig.subject = this.emailSubject;
        this.schedule.emailConfig.text = this.emailText;
    };
    ScheduleModalComponent.ctorParameters = function () { return [
        { type: BsModalRef },
        { type: ReportsService },
        { type: CronService }
    ]; };
    tslib_1.__decorate([
        Output()
    ], ScheduleModalComponent.prototype, "emitter", void 0);
    ScheduleModalComponent = tslib_1.__decorate([
        Component({
            selector: 'schedule-modal',
            template: "<div class=\"modal-header text-center bg-primary\">\n  <header class=\"text-white\">\n    <div style=\"font-size: 62px;\">\n      <span c8yIcon=\"c8y-report\"></span>\n    </div>\n    <h4 class=\"text-uppercase\" style=\"margin:0; letter-spacing: 0.15em;\">\n      <span *ngIf=\"actionType === ActionType.CREATE\" translate>New export schedule</span>\n      <span *ngIf=\"actionType === ActionType.EDIT\" translate>Edit export schedule</span>\n      <span *ngIf=\"actionType === ActionType.DUPLICATE\" translate>Duplicate export schedule</span>\n    </h4>\n  </header>\n</div>\n\n<div class=\"modal-body\">\n  <p class=\"lead text-center p-t-24\" style=\"margin-bottom: 0;\" translate>\n    On schedule send export via email\n  </p>\n</div>\n<div class=\"modal-inner-scroll smart-rule-control\">\n  <form #scheduleForm=\"ngForm\" class=\"edit-smart-rule-details\">\n    <div class=\"list-group\">\n      <div class=\"list-group-item bg-gray-white\">\n        <div class=\"smart-list-icon-label\">\n          <span class=\"dot bg-primary-light\">1</span\n          ><strong class=\"p-l-4\" translate>Frequency</strong>\n        </div>\n        <div class=\"p-t-4\">\n          <div class=\"form-group\">\n            <cron [cronIn]=\"cronExpression\" (emitter)=\"getCron($event)\" name=\"cron\"></cron>\n          </div>\n        </div>\n      </div>\n      <div class=\"list-group-item\">\n        <div class=\"smart-list-icon-label\">\n          <span class=\"dot bg-primary-light\">2</span>&nbsp;<strong translate>Send email</strong>\n        </div>\n        <div class=\"form-horizontal p-t-16\">\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>Send to</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control\"\n                  name=\"to\"\n                  [(ngModel)]=\"emailTo\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  required\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>CC</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"cc\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailCc\"\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em translate>Enter one or more valid email addresses, separated with a comma.</em>\n            </div>\n            <label class=\"control-label col-sm-3\" translate>BCC</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"bcc\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailBcc\"\n                  [pattern]=\"multiEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_multiEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <label class=\"control-label col-sm-3\" translate>Reply to</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"replyTo\"\n                  placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n                  [(ngModel)]=\"emailReplyTo\"\n                  [pattern]=\"singleEmailPattern\"\n                />\n                <c8y-messages>\n                  <c8y-message\n                    name=\"pattern\"\n                    [text]=\"reportsService.ERROR_MESSAGES.pattern_singleEmail\"\n                  ></c8y-message>\n                </c8y-messages>\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <label class=\"control-label col-sm-3\" translate>Subject</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <input\n                  type=\"text\"\n                  class=\"form-control span\"\n                  name=\"subject\"\n                  [(ngModel)]=\"emailSubject\"\n                  placeholder=\"{{ 'e.g. Daily report' | translate }}\"\n                  required\n                />\n              </c8y-form-group>\n            </div>\n          </div>\n\n          <div class=\"form-group\">\n            <div class=\"text-muted col-sm-12 p-b-4\" style=\"display: flex; align-items: baseline;\">\n              <i [c8yIcon]=\"'info-circle'\" class=\"text-info m-r-8\"></i>\n              <em>{{ placeholdersInfo | translate }}</em>\n            </div>\n            <label class=\"col-sm-3 control-label\" translate>Message</label>\n            <div class=\"col-sm-9\">\n              <c8y-form-group>\n                <textarea\n                  class=\"form-control\"\n                  name=\"text\"\n                  [(ngModel)]=\"emailText\"\n                  placeholder=\"{{ 'Message' | translate }}\"\n                  required\n                ></textarea>\n              </c8y-form-group>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n\n<div class=\"modal-footer\">\n  <button class=\"btn btn-default\" (click)=\"cancel()\" title=\"{{ 'Cancel' | translate }}\" translate>\n    Cancel\n  </button>\n  <button\n    class=\"btn btn-primary\"\n    (click)=\"save()\"\n    [ngClass]=\"{ ' btn-pending ': savingStatus.inProgress }\"\n    [disabled]=\"!validCron || !scheduleForm.form.valid\"\n  >\n    <span *ngIf=\"!savingStatus.inProgress\">\n      <span *ngIf=\"actionType === ActionType.CREATE\" title=\"{{ 'Create' | translate }}\" translate\n        >Create</span\n      >\n      <span *ngIf=\"actionType === ActionType.EDIT\" title=\"{{ 'Save' | translate }}\" translate\n        >Save</span\n      >\n      <span\n        *ngIf=\"actionType === ActionType.DUPLICATE\"\n        title=\"{{ 'Duplicate' | translate }}\"\n        translate\n        >Duplicate</span\n      >\n    </span>\n    <span *ngIf=\"savingStatus.inProgress\" title=\"{{ 'Saving' | translate }}\u2026\"\n      >{{ 'Saving' | translate }}\u2026</span\n    >\n  </button>\n</div>\n"
        })
    ], ScheduleModalComponent);
    return ScheduleModalComponent;
}());
export { ScheduleModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGUtbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvcnRzLyIsInNvdXJjZXMiOlsic2NoZWR1bGUtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBWSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDbkMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTTlDO0lBMEJFLGdDQUNTLFFBQW9CLEVBQ3BCLGNBQThCLEVBQzdCLFdBQXdCO1FBRnpCLGFBQVEsR0FBUixRQUFRLENBQVk7UUFDcEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzdCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBekJ4QixZQUFPLEdBQWlDLElBQUksWUFBWSxFQUFFLENBQUM7UUFHckUsZUFBVSxHQUFHLFVBQVUsQ0FBQztRQUN4QixzQkFBaUIsR0FBVyxpRUFBaUUsQ0FBQztRQUM5Rix1QkFBa0IsR0FBVyx5Q0FBeUMsQ0FBQztRQUN2RSxtQkFBYyxHQUFXLFdBQVcsQ0FBQztRQUNyQyxjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLG1CQUFjLEdBQW1CO1lBQy9CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBU0YscUJBQWdCLEdBQUcsT0FBTyxDQUFDLGlKQUFpSixDQUFDLENBQUM7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O1lBQzFCLHFyUUFBOEM7U0FDL0MsQ0FBQztPQUNXLHNCQUFzQixDQTBJbEM7SUFBRCw2QkFBQztDQUFBLEFBMUlELElBMElDO1NBMUlZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQnNNb2RhbFJlZiB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgU2NoZWR1bGUsIEFjdGlvblR5cGUgfSBmcm9tICcuL2V4cG9ydC1zY2hlZHVsZXMuaW50ZXJmYWNlJztcbmltcG9ydCB7IEVtaXR0ZWRDcm9uLCBFbWl0dGVyUGF5bG9hZCB9IGZyb20gJy4vZXhwb3J0LXNjaGVkdWxlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUmVwb3J0c1NlcnZpY2UgfSBmcm9tICcuL3JlcG9ydHMuc2VydmljZSc7XG5pbXBvcnQgeyBDcm9uU2VydmljZSB9IGZyb20gJy4vY3Jvbi5zZXJ2aWNlJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3NjaGVkdWxlLW1vZGFsJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3NjaGVkdWxlLW1vZGFsLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTY2hlZHVsZU1vZGFsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgc2F2aW5nU3RhdHVzOiBhbnk7XG4gIHNjaGVkdWxlOiBTY2hlZHVsZTtcbiAgb2xkU2NoZWR1bGU6IFNjaGVkdWxlO1xuICBAT3V0cHV0KCkgZW1pdHRlcjogRXZlbnRFbWl0dGVyPEVtaXR0ZXJQYXlsb2FkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgZXhwb3J0SWQ6IG51bWJlcjtcbiAgYWN0aW9uVHlwZTogQWN0aW9uVHlwZTtcbiAgQWN0aW9uVHlwZSA9IEFjdGlvblR5cGU7XG4gIG11bHRpRW1haWxQYXR0ZXJuOiBSZWdFeHAgPSAvXihbYS16MC05ISMkJSYnKisvPT9eX2B7fH1+Li1dK0BbYS16MC05LV0rKFxcLlthLXowLTktXSspKiw/KSokL2k7XG4gIHNpbmdsZUVtYWlsUGF0dGVybjogUmVnRXhwID0gL1thLXowLTkuXyUrLV0rQFthLXowLTkuLV0rXFwuW2Etel17Miw0fSQvO1xuICBjcm9uRXhwcmVzc2lvbjogc3RyaW5nID0gJyogKiAqICogKic7XG4gIHZhbGlkQ3JvbjogYm9vbGVhbiA9IGZhbHNlO1xuICBlbWl0dGVyUGF5bG9hZDogRW1pdHRlclBheWxvYWQgPSB7XG4gICAgc3VjY2VzczogZmFsc2UsXG4gICAgbWVzc2FnZTogJydcbiAgfTtcblxuICBlbWFpbFRvOiBzdHJpbmc7XG4gIGVtYWlsQ2M6IHN0cmluZztcbiAgZW1haWxCY2M6IHN0cmluZztcbiAgZW1haWxSZXBseVRvOiBzdHJpbmc7XG4gIGVtYWlsU3ViamVjdDogc3RyaW5nO1xuICBlbWFpbFRleHQ6IHN0cmluZztcblxuICBwbGFjZWhvbGRlcnNJbmZvID0gZ2V0dGV4dCgnQXZhaWxhYmxlIHBsYWNlaG9sZGVyczoge3RlbmFudC1kb21haW59LCB7aG9zdH0sIHtiaW5hcnlJZH0uIFdob2xlIGxpbmsgdG8gZG93bmxvYWRhYmxlIGZpbGUgaXM6IHt0ZW5hbnQtZG9tYWlufS9pbnZlbnRvcnkvYmluYXJpZXMve2JpbmFyeUlkfS4nKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbW9kYWxSZWY6IEJzTW9kYWxSZWYsXG4gICAgcHVibGljIHJlcG9ydHNTZXJ2aWNlOiBSZXBvcnRzU2VydmljZSxcbiAgICBwcml2YXRlIGNyb25TZXJ2aWNlOiBDcm9uU2VydmljZVxuICApIHtcbiAgICB0aGlzLnNhdmluZ1N0YXR1cyA9IHtcbiAgICAgIGluUHJvZ3Jlc3M6IGZhbHNlLFxuICAgICAgZG9uZTogZmFsc2UsXG4gICAgICBlcnJvcjogZmFsc2VcbiAgICB9O1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5vbGRTY2hlZHVsZSA9IGNsb25lRGVlcCh0aGlzLnNjaGVkdWxlKTtcbiAgICB0aGlzLnBvcHVsYXRlRW1haWxGaWVsZHNGcm9tU2NoZWR1bGUodGhpcy5zY2hlZHVsZSk7XG4gICAgdGhpcy5jcm9uRXhwcmVzc2lvbiA9IHRoaXMuY3JvblNlcnZpY2UuZ2VuZXJhdGVDcm9uKHRoaXMuc2NoZWR1bGUuY3JvbkNvbmZpZyk7XG4gICAgdGhpcy52YWxpZENyb24gPSB0aGlzLmNyb25TZXJ2aWNlLnZhbGlkYXRlTW9kZWxzKFxuICAgICAgdGhpcy5jcm9uU2VydmljZS5nZXRCYXNlKHRoaXMuc2NoZWR1bGUuY3JvbkNvbmZpZyksXG4gICAgICB0aGlzLnNjaGVkdWxlLmNyb25Db25maWdcbiAgICApO1xuICB9XG5cbiAgcG9wdWxhdGVFbWFpbEZpZWxkc0Zyb21TY2hlZHVsZShzY2hlZHVsZTogU2NoZWR1bGUpIHtcbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcudG8gJiYgc2NoZWR1bGUuZW1haWxDb25maWcudG8ubGVuZ3RoKSB7XG4gICAgICB0aGlzLmVtYWlsVG8gPSBzY2hlZHVsZS5lbWFpbENvbmZpZy50by50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcuY2MgJiYgc2NoZWR1bGUuZW1haWxDb25maWcuY2MubGVuZ3RoKSB7XG4gICAgICB0aGlzLmVtYWlsQ2MgPSBzY2hlZHVsZS5lbWFpbENvbmZpZy5jYy50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAoc2NoZWR1bGUuZW1haWxDb25maWcuYmNjICYmIHNjaGVkdWxlLmVtYWlsQ29uZmlnLmJjYy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZW1haWxCY2MgPSBzY2hlZHVsZS5lbWFpbENvbmZpZy5iY2MudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKHNjaGVkdWxlLmVtYWlsQ29uZmlnLnJlcGx5VG8pIHtcbiAgICAgIHRoaXMuZW1haWxSZXBseVRvID0gc2NoZWR1bGUuZW1haWxDb25maWcucmVwbHlUbztcbiAgICB9XG4gICAgaWYgKHNjaGVkdWxlLmVtYWlsQ29uZmlnLnN1YmplY3QpIHtcbiAgICAgIHRoaXMuZW1haWxTdWJqZWN0ID0gc2NoZWR1bGUuZW1haWxDb25maWcuc3ViamVjdDtcbiAgICB9XG4gICAgaWYgKHNjaGVkdWxlLmVtYWlsQ29uZmlnLnRleHQpIHtcbiAgICAgIHRoaXMuZW1haWxUZXh0ID0gc2NoZWR1bGUuZW1haWxDb25maWcudGV4dDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYXZlKCkge1xuICAgIHRoaXMucG9wdWxhdGVTY2hlZHVsZUZyb21Dcm9uRXhwcmVzc2lvbigpO1xuICAgIHRoaXMucG9wdWxhdGVTY2hlZHVsZUZyb21FbWFpbEZpZWxkcygpO1xuXG4gICAgdGhpcy5zYXZpbmdTdGF0dXMuaW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgbGV0IHN1Y2Nlc3M6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBpZiAodGhpcy5hY3Rpb25UeXBlID09PSBBY3Rpb25UeXBlLkVESVQpIHtcbiAgICAgIHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnJlcG9ydHNTZXJ2aWNlLnVwZGF0ZVNjaGVkdWxlKFxuICAgICAgICB0aGlzLm9sZFNjaGVkdWxlLFxuICAgICAgICB0aGlzLnNjaGVkdWxlLFxuICAgICAgICB0aGlzLmV4cG9ydElkXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IGRhdGUuZ2V0VGltZSgpO1xuICAgICAgdGhpcy5zY2hlZHVsZS50aW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgICBzdWNjZXNzID0gYXdhaXQgdGhpcy5yZXBvcnRzU2VydmljZS5hZGRTY2hlZHVsZSh0aGlzLnNjaGVkdWxlLCB0aGlzLmV4cG9ydElkKTtcbiAgICB9XG4gICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgIHRoaXMubW9kYWxSZWYuaGlkZSgpO1xuICAgICAgLy8gc2lnbmFsIHRvIHRoZSBwYXJlbnQgY29tcG9uZW50IHRvIHVwZGF0ZSBsaXN0XG4gICAgICB0aGlzLmVtaXR0ZXJQYXlsb2FkLnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQodGhpcy5lbWl0dGVyUGF5bG9hZCk7XG4gICAgfVxuICAgIHRoaXMuc2F2aW5nU3RhdHVzLmluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLm1vZGFsUmVmLmhpZGUoKTtcbiAgfVxuXG4gIGdldENyb24oY3JvbjogRW1pdHRlZENyb24pIHtcbiAgICB0aGlzLnZhbGlkQ3JvbiA9IGNyb24udmFsaWQ7XG4gICAgaWYgKGNyb24udmFsaWQpIHtcbiAgICAgIHRoaXMuY3JvbkV4cHJlc3Npb24gPSBjcm9uLmNyb247XG4gICAgfVxuICB9XG5cbiAgcG9wdWxhdGVTY2hlZHVsZUZyb21Dcm9uRXhwcmVzc2lvbigpIHtcbiAgICB0aGlzLnNjaGVkdWxlLmNyb25Db25maWcgPSB0aGlzLmNyb25TZXJ2aWNlLmdlbmVyYXRlQ3JvbkNvbmZpZyh0aGlzLmNyb25FeHByZXNzaW9uKTtcbiAgfVxuXG4gIGNvbnZlcnRTdHJpbmdPZkVtYWlsc1RvQXJyYXkoc3RyaW5nT2ZFbWFpbHM6IHN0cmluZykge1xuICAgIGNvbnN0IGFyciA9IFtdO1xuICAgIGlmIChzdHJpbmdPZkVtYWlscykge1xuICAgICAgY29uc3QgcGFydHMgPSBzdHJpbmdPZkVtYWlscy5zcGxpdCgnLCcpO1xuICAgICAgcGFydHMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICBhcnIucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBhcnI7XG4gIH1cblxuICBwb3B1bGF0ZVNjaGVkdWxlRnJvbUVtYWlsRmllbGRzKCkge1xuICAgIHRoaXMuc2NoZWR1bGUuZW1haWxDb25maWcudG8gPSB0aGlzLmVtYWlsVG9cbiAgICAgID8gdGhpcy5jb252ZXJ0U3RyaW5nT2ZFbWFpbHNUb0FycmF5KHRoaXMuZW1haWxUbylcbiAgICAgIDogbnVsbDtcbiAgICB0aGlzLnNjaGVkdWxlLmVtYWlsQ29uZmlnLmNjID0gdGhpcy5lbWFpbENjXG4gICAgICA/IHRoaXMuY29udmVydFN0cmluZ09mRW1haWxzVG9BcnJheSh0aGlzLmVtYWlsQ2MpXG4gICAgICA6IG51bGw7XG4gICAgdGhpcy5zY2hlZHVsZS5lbWFpbENvbmZpZy5iY2MgPSB0aGlzLmVtYWlsQmNjXG4gICAgICA/IHRoaXMuY29udmVydFN0cmluZ09mRW1haWxzVG9BcnJheSh0aGlzLmVtYWlsQmNjKVxuICAgICAgOiBudWxsO1xuICAgIHRoaXMuc2NoZWR1bGUuZW1haWxDb25maWcucmVwbHlUbyA9IHRoaXMuZW1haWxSZXBseVRvO1xuICAgIHRoaXMuc2NoZWR1bGUuZW1haWxDb25maWcuc3ViamVjdCA9IHRoaXMuZW1haWxTdWJqZWN0O1xuICAgIHRoaXMuc2NoZWR1bGUuZW1haWxDb25maWcudGV4dCA9IHRoaXMuZW1haWxUZXh0O1xuICB9XG59XG4iXX0=