import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { ActionType } from './export-schedules.interface';
import { ReportsService } from './reports.service';
import { BsModalService, BsModalRef, ModalOptions } from 'ngx-bootstrap/modal';
import { ScheduleModalComponent } from './schedule-modal.component';
import { ConfirmModalComponent, Status, gettext } from '@c8y/ngx-components';
import { cloneDeep } from 'lodash-es';
import { CronService } from './cron.service';
import { TranslateService } from '@ngx-translate/core';
import { UserService } from '@c8y/client';
var ExportSchedulesComponent = /** @class */ (function () {
    function ExportSchedulesComponent(reportsService, bsModalService, cronService, translateService, userService) {
        this.reportsService = reportsService;
        this.bsModalService = bsModalService;
        this.cronService = cronService;
        this.translateService = translateService;
        this.userService = userService;
        this.scheduleList = [];
        this.initialSchedule = {
            timestamp: null,
            emailConfig: {
                to: [],
                cc: [],
                bcc: [],
                replyTo: '',
                text: this.translateService.instant(gettext('File with exported data can be downloaded from {tenant-domain}/inventory/binaries/{binaryId}.')),
                subject: ''
            },
            cronConfig: {
                minute: '0',
                hour: '0',
                day: '1',
                month: '1',
                weekday: '?'
            }
        };
        this.listClass = 'interact-list';
        this.sortReverse = false;
        this.isOpen = {};
        this.isEditMenuOpen = false;
        this.currentUserEmail = '';
        this.loadingStatus = {
            inProgress: false,
            done: false,
            error: false
        };
    }
    Object.defineProperty(ExportSchedulesComponent.prototype, "exportId", {
        set: function (exportId) {
            this._exportId = exportId;
        },
        enumerable: true,
        configurable: true
    });
    ExportSchedulesComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var currentUserEmail, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.getScheduleList(true);
                        return [4 /*yield*/, this.getCurrentUserEmail()];
                    case 1:
                        currentUserEmail = _b.sent();
                        this.initialSchedule.emailConfig.to = currentUserEmail;
                        _a = this;
                        return [4 /*yield*/, this.reportsService.getExport(this._exportId)];
                    case 2:
                        _a.exp = _b.sent();
                        this.initialSchedule.emailConfig.subject = this.translateService.instant(gettext('Export of "{{expName}}"'), { expName: this.exp.name });
                        return [2 /*return*/];
                }
            });
        });
    };
    ExportSchedulesComponent.prototype.getCurrentUserEmail = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.userService.current()];
                    case 1:
                        data = (_a.sent()).data;
                        return [2 /*return*/, data && data.email ? [data.email] : []];
                }
            });
        });
    };
    ExportSchedulesComponent.prototype.getScheduleList = function (withProgress) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (withProgress) {
                            this.loadingStatus.inProgress = true;
                        }
                        _a = this;
                        return [4 /*yield*/, this.reportsService.getScheduleList(this._exportId)];
                    case 1:
                        _a.scheduleList = _b.sent();
                        if (withProgress) {
                            this.loadingStatus.inProgress = false;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    ExportSchedulesComponent.prototype.addSchedule = function () {
        this.openAddEditModal(this._exportId, this.initialSchedule, ActionType.CREATE);
    };
    ExportSchedulesComponent.prototype.editSchedule = function (schedule, event) {
        event.preventDefault();
        this.openAddEditModal(this._exportId, schedule, ActionType.EDIT);
    };
    ExportSchedulesComponent.prototype.duplicateSchedule = function (schedule, event) {
        event.preventDefault();
        this.openAddEditModal(this._exportId, schedule, ActionType.DUPLICATE);
    };
    ExportSchedulesComponent.prototype.openAddEditModal = function (exportId, schedule, actionType) {
        var _this = this;
        var payload = { actionType: actionType, exportId: exportId, schedule: cloneDeep(schedule) };
        var modalOptions = { class: 'modal-sm', initialState: payload };
        this.modalRef = this.bsModalService.show(ScheduleModalComponent, modalOptions);
        this.modalRef.content.emitter.subscribe(function (load) {
            return _this.getMessageFromModal(load);
        });
    };
    ExportSchedulesComponent.prototype.getMessageFromModal = function (payload) {
        if (payload.success) {
            // refresh schedule list
            this.getScheduleList(false);
        }
    };
    ExportSchedulesComponent.prototype.removeSchedule = function (schedule, event) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var subject, payload, modalOptions, confirm, success;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        event.preventDefault();
                        subject = schedule.emailConfig.subject;
                        payload = {
                            status: Status.DANGER,
                            title: gettext('Delete schedule'),
                            labels: { ok: gettext('Delete') },
                            body: this.translateService.instant(gettext('You are about to delete the schedule "{{subject}}". Do you want to proceed?'), { subject: subject })
                        };
                        modalOptions = { initialState: payload };
                        this.modalRef = this.bsModalService.show(ConfirmModalComponent, modalOptions);
                        return [4 /*yield*/, this.modalRef.content.result];
                    case 1:
                        confirm = _a.sent();
                        if (!confirm) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.reportsService.deleteSchedule(schedule, this._exportId)];
                    case 2:
                        success = _a.sent();
                        if (success) {
                            // refresh schedule list
                            this.getScheduleList(false);
                        }
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    ExportSchedulesComponent.ctorParameters = function () { return [
        { type: ReportsService },
        { type: BsModalService },
        { type: CronService },
        { type: TranslateService },
        { type: UserService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], ExportSchedulesComponent.prototype, "exportId", null);
    ExportSchedulesComponent = tslib_1.__decorate([
        Component({
            selector: 'export-schedules',
            template: "<div>\n  <div *ngIf=\"loadingStatus.inProgress\" class=\"flex-row\">\n    <div style=\"position: relative; min-height: 40px;min-width: 55px;\">\n      <div class=\"spinner\">\n        <div class=\"rect1\"></div>\n        <div class=\"rect2\"></div>\n        <div class=\"rect3\"></div>\n        <div class=\"rect4\"></div>\n        <div class=\"rect5\"></div>\n      </div>\n    </div>\n    <span translate>Retrieving schedules\u2026</span>\n  </div>\n\n  <div *ngIf=\"!loadingStatus.inProgress && loadingStatus.done && loadingStatus.error\">\n    <div class=\"alert alert-warning\" translate>\n      Could not load schedules list.\n    </div>\n  </div>\n\n  <div *ngIf=\"!loadingStatus.inProgress && !loadingStatus.done && !loadingStatus.error\">\n    <div class=\"c8y-empty-state text-center\" *ngIf=\"!scheduleList.length\">\n      <h1 c8yIcon=\"c8y-report\" class=\"c8y-icon-duocolor\"></h1>\n      <h3 translate>No export schedules defined.</h3>\n    </div>\n\n    <div class=\"list-group\" *ngIf=\"scheduleList.length\">\n      <div\n        class=\"list-group-item flex-row pointer\"\n        *ngFor=\"let schedule of scheduleList\"\n        (click)=\"editSchedule(schedule, $event)\"\n      >\n        <div class=\"list-item-actions\" (click)=\"$event.stopPropagation()\">\n          <div class=\"settings dropdown\" dropdown>\n            <button\n              class=\"dropdown-toggle c8y-dropdown\"\n              dropdownToggle\n              aria-haspopup=\"true\"\n              aria-expanded=\"false\"\n              title=\"{{ 'Actions' | translate }}\"\n            >\n              <i [c8yIcon]=\"'ellipsis-v'\"></i>\n            </button>\n            <ul class=\"dropdown-menu dropdown-menu-right\" *dropdownMenu>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Edit schedule' | translate }}\"\n                  (click)=\"editSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'pencil'\"></i> {{ 'Edit' | translate }}\n                </a>\n              </li>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Duplicate schedule' | translate }}\"\n                  (click)=\"duplicateSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'copy'\"></i> {{ 'Duplicate' | translate }}\n                </a>\n              </li>\n              <li role=\"menuitem\">\n                <a\n                  href=\"\"\n                  title=\"{{ 'Delete schedule' | translate }}\"\n                  (click)=\"removeSchedule(schedule, $event)\"\n                >\n                  <i [c8yIcon]=\"'trash'\"></i> {{ 'Delete' | translate }}\n                </a>\n              </li>\n            </ul>\n          </div>\n        </div>\n        <div class=\"list-item-icon\">\n          <i c8yIcon=\"c8y-report\" class=\"c8y-icon-duocolor\"></i>\n        </div>\n        <div class=\"list-item-body flex-row\">\n          <div class=\"col-sm-6\">\n            <div class=\"text-truncate\" title=\"{{ schedule.emailConfig.subject }}\">\n              {{ schedule.emailConfig.subject }}\n            </div>\n          </div>\n          <div class=\"col-sm-6\">\n            <div class=\"flex-row\" style=\"align-items: baseline;\">\n              <i c8yIcon=\"calendar\" class=\"text-muted m-r-4\"></i>\n              <small class=\"smart-rule-information text-muted\">\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 2\" translate>\n                  Hourly: {{ schedule.cronConfig.minute | number: '2.0-0' }} minute(s) past the\n                  hour.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 3\" translate>\n                  Daily: at {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 4\" translate>\n                  Weekly: {{ cronService.getWeekDayName(schedule.cronConfig) }}, at\n                  {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 5\" translate>\n                  Monthly: {{ cronService.getMonthDayName(schedule.cronConfig) }} day of the month,\n                  at {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n                <span *ngIf=\"cronService.getBase(schedule.cronConfig) === 6\" translate>\n                  Yearly: {{ cronService.getMonthName(schedule.cronConfig) }},\n                  {{ cronService.getMonthDayName(schedule.cronConfig) }} day of the month, at\n                  {{ schedule.cronConfig.hour | number: '2.0-0' }}:{{\n                    schedule.cronConfig.minute | number: '2.0-0'\n                  }}.\n                </span>\n              </small>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <button\n    type=\"button\"\n    class=\"btn-add-block m-t-16\"\n    title=\"{{ 'Add schedule' | translate }}\"\n    (click)=\"addSchedule()\"\n  >\n    <i [c8yIcon]=\"'plus-square'\"></i> {{ 'Add schedule' | translate }}\n  </button>\n</div>\n"
        })
    ], ExportSchedulesComponent);
    return ExportSchedulesComponent;
}());
export { ExportSchedulesComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LXNjaGVkdWxlcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3JlcG9ydHMvIiwic291cmNlcyI6WyJleHBvcnQtc2NoZWR1bGVzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFvQyxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM1RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDL0UsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM3RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBTTFDO0lBdUNFLGtDQUNVLGNBQThCLEVBQzlCLGNBQThCLEVBQy9CLFdBQXdCLEVBQ3ZCLGdCQUFrQyxFQUNsQyxXQUF3QjtRQUp4QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQy9CLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3ZCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUF2Q2xDLGlCQUFZLEdBQWUsRUFBRSxDQUFDO1FBQzlCLG9C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TCxnQkFBZ0I7Z0JBQ3JCLFdBQVc7O0lBM0N6QjtRQUFSLEtBQUssRUFBRTs0REFFUDtJQUhVLHdCQUF3QjtRQUpwQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsa0JBQWtCO1lBQzVCLHc4S0FBZ0Q7U0FDakQsQ0FBQztPQUNXLHdCQUF3QixDQXFJcEM7SUFBRCwrQkFBQztDQUFBLEFBcklELElBcUlDO1NBcklZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRXhwb3J0LCBTY2hlZHVsZSwgRW1pdHRlclBheWxvYWQsIEFjdGlvblR5cGUgfSBmcm9tICcuL2V4cG9ydC1zY2hlZHVsZXMuaW50ZXJmYWNlJztcbmltcG9ydCB7IFJlcG9ydHNTZXJ2aWNlIH0gZnJvbSAnLi9yZXBvcnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UsIEJzTW9kYWxSZWYsIE1vZGFsT3B0aW9ucyB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgU2NoZWR1bGVNb2RhbENvbXBvbmVudCB9IGZyb20gJy4vc2NoZWR1bGUtbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IENvbmZpcm1Nb2RhbENvbXBvbmVudCwgU3RhdHVzLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQ3JvblNlcnZpY2UgfSBmcm9tICcuL2Nyb24uc2VydmljZSc7XG5pbXBvcnQgeyBJZFJlZmVyZW5jZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IFVzZXJTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdleHBvcnQtc2NoZWR1bGVzJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2V4cG9ydC1zY2hlZHVsZXMuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEV4cG9ydFNjaGVkdWxlc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBJbnB1dCgpIHNldCBleHBvcnRJZChleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICB0aGlzLl9leHBvcnRJZCA9IGV4cG9ydElkO1xuICB9XG4gIGV4cDogRXhwb3J0O1xuICBzY2hlZHVsZUxpc3Q6IFNjaGVkdWxlW10gPSBbXTtcbiAgaW5pdGlhbFNjaGVkdWxlOiBTY2hlZHVsZSA9IHtcbiAgICB0aW1lc3RhbXA6IG51bGwsXG4gICAgZW1haWxDb25maWc6IHtcbiAgICAgIHRvOiBbXSxcbiAgICAgIGNjOiBbXSxcbiAgICAgIGJjYzogW10sXG4gICAgICByZXBseVRvOiAnJyxcbiAgICAgIHRleHQ6IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICBnZXR0ZXh0KFxuICAgICAgICAgICdGaWxlIHdpdGggZXhwb3J0ZWQgZGF0YSBjYW4gYmUgZG93bmxvYWRlZCBmcm9tIHt0ZW5hbnQtZG9tYWlufS9pbnZlbnRvcnkvYmluYXJpZXMve2JpbmFyeUlkfS4nXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICBzdWJqZWN0OiAnJ1xuICAgIH0sXG4gICAgY3JvbkNvbmZpZzoge1xuICAgICAgbWludXRlOiAnMCcsXG4gICAgICBob3VyOiAnMCcsXG4gICAgICBkYXk6ICcxJyxcbiAgICAgIG1vbnRoOiAnMScsXG4gICAgICB3ZWVrZGF5OiAnPydcbiAgICB9XG4gIH07XG4gIGxpc3RDbGFzczogc3RyaW5nID0gJ2ludGVyYWN0LWxpc3QnO1xuICBsb2FkaW5nU3RhdHVzOiBhbnk7XG4gIHNvcnRUeXBlOiBzdHJpbmc7XG4gIHNvcnRSZXZlcnNlOiBib29sZWFuID0gZmFsc2U7XG4gIGlzT3BlbjogYW55ID0ge307XG4gIGlzRmxpcHBlZDogYm9vbGVhbjtcbiAgaXNFZGl0TWVudU9wZW46IGJvb2xlYW4gPSBmYWxzZTtcbiAgbW9kYWxSZWY6IEJzTW9kYWxSZWY7XG4gIGN1cnJlbnRVc2VyRW1haWw6IHN0cmluZyA9ICcnO1xuICBwcml2YXRlIF9leHBvcnRJZDogSWRSZWZlcmVuY2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvcnRzU2VydmljZTogUmVwb3J0c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHVibGljIGNyb25TZXJ2aWNlOiBDcm9uU2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1c2VyU2VydmljZTogVXNlclNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5sb2FkaW5nU3RhdHVzID0ge1xuICAgICAgaW5Qcm9ncmVzczogZmFsc2UsXG4gICAgICBkb25lOiBmYWxzZSxcbiAgICAgIGVycm9yOiBmYWxzZVxuICAgIH07XG4gIH1cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmdldFNjaGVkdWxlTGlzdCh0cnVlKTtcbiAgICBjb25zdCBjdXJyZW50VXNlckVtYWlsID0gYXdhaXQgdGhpcy5nZXRDdXJyZW50VXNlckVtYWlsKCk7XG4gICAgdGhpcy5pbml0aWFsU2NoZWR1bGUuZW1haWxDb25maWcudG8gPSBjdXJyZW50VXNlckVtYWlsO1xuICAgIHRoaXMuZXhwID0gYXdhaXQgdGhpcy5yZXBvcnRzU2VydmljZS5nZXRFeHBvcnQodGhpcy5fZXhwb3J0SWQpO1xuICAgIHRoaXMuaW5pdGlhbFNjaGVkdWxlLmVtYWlsQ29uZmlnLnN1YmplY3QgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgIGdldHRleHQoJ0V4cG9ydCBvZiBcInt7ZXhwTmFtZX19XCInKSxcbiAgICAgIHsgZXhwTmFtZTogdGhpcy5leHAubmFtZSB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldEN1cnJlbnRVc2VyRW1haWwoKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLnVzZXJTZXJ2aWNlLmN1cnJlbnQoKTtcbiAgICByZXR1cm4gZGF0YSAmJiBkYXRhLmVtYWlsID8gW2RhdGEuZW1haWxdIDogW107XG4gIH1cblxuICBhc3luYyBnZXRTY2hlZHVsZUxpc3Qod2l0aFByb2dyZXNzOiBib29sZWFuKSB7XG4gICAgaWYgKHdpdGhQcm9ncmVzcykge1xuICAgICAgdGhpcy5sb2FkaW5nU3RhdHVzLmluUHJvZ3Jlc3MgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnNjaGVkdWxlTGlzdCA9IGF3YWl0IHRoaXMucmVwb3J0c1NlcnZpY2UuZ2V0U2NoZWR1bGVMaXN0KHRoaXMuX2V4cG9ydElkKTtcbiAgICBpZiAod2l0aFByb2dyZXNzKSB7XG4gICAgICB0aGlzLmxvYWRpbmdTdGF0dXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGFkZFNjaGVkdWxlKCkge1xuICAgIHRoaXMub3BlbkFkZEVkaXRNb2RhbCh0aGlzLl9leHBvcnRJZCwgdGhpcy5pbml0aWFsU2NoZWR1bGUsIEFjdGlvblR5cGUuQ1JFQVRFKTtcbiAgfVxuXG4gIGVkaXRTY2hlZHVsZShzY2hlZHVsZTogU2NoZWR1bGUsIGV2ZW50OiBhbnkpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHRoaXMub3BlbkFkZEVkaXRNb2RhbCh0aGlzLl9leHBvcnRJZCwgc2NoZWR1bGUsIEFjdGlvblR5cGUuRURJVCk7XG4gIH1cblxuICBkdXBsaWNhdGVTY2hlZHVsZShzY2hlZHVsZTogU2NoZWR1bGUsIGV2ZW50OiBhbnkpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHRoaXMub3BlbkFkZEVkaXRNb2RhbCh0aGlzLl9leHBvcnRJZCwgc2NoZWR1bGUsIEFjdGlvblR5cGUuRFVQTElDQVRFKTtcbiAgfVxuXG4gIG9wZW5BZGRFZGl0TW9kYWwoZXhwb3J0SWQ6IElkUmVmZXJlbmNlLCBzY2hlZHVsZTogU2NoZWR1bGUsIGFjdGlvblR5cGU6IEFjdGlvblR5cGUpIHtcbiAgICBjb25zdCBwYXlsb2FkID0geyBhY3Rpb25UeXBlLCBleHBvcnRJZCwgc2NoZWR1bGU6IGNsb25lRGVlcChzY2hlZHVsZSkgfTtcbiAgICBjb25zdCBtb2RhbE9wdGlvbnMgPSB7IGNsYXNzOiAnbW9kYWwtc20nLCBpbml0aWFsU3RhdGU6IHBheWxvYWQgfSBhcyBNb2RhbE9wdGlvbnM7XG4gICAgdGhpcy5tb2RhbFJlZiA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhTY2hlZHVsZU1vZGFsQ29tcG9uZW50LCBtb2RhbE9wdGlvbnMpO1xuICAgIHRoaXMubW9kYWxSZWYuY29udGVudC5lbWl0dGVyLnN1YnNjcmliZSgobG9hZDogRW1pdHRlclBheWxvYWQpID0+XG4gICAgICB0aGlzLmdldE1lc3NhZ2VGcm9tTW9kYWwobG9hZClcbiAgICApO1xuICB9XG5cbiAgZ2V0TWVzc2FnZUZyb21Nb2RhbChwYXlsb2FkOiBFbWl0dGVyUGF5bG9hZCkge1xuICAgIGlmIChwYXlsb2FkLnN1Y2Nlc3MpIHtcbiAgICAgIC8vIHJlZnJlc2ggc2NoZWR1bGUgbGlzdFxuICAgICAgdGhpcy5nZXRTY2hlZHVsZUxpc3QoZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbW92ZVNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc3Qgc3ViamVjdCA9IHNjaGVkdWxlLmVtYWlsQ29uZmlnLnN1YmplY3Q7XG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIHN0YXR1czogU3RhdHVzLkRBTkdFUixcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdEZWxldGUgc2NoZWR1bGUnKSxcbiAgICAgIGxhYmVsczogeyBvazogZ2V0dGV4dCgnRGVsZXRlJykgfSxcbiAgICAgIGJvZHk6IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICBnZXR0ZXh0KCdZb3UgYXJlIGFib3V0IHRvIGRlbGV0ZSB0aGUgc2NoZWR1bGUgXCJ7e3N1YmplY3R9fVwiLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkPycpLFxuICAgICAgICB7IHN1YmplY3QgfVxuICAgICAgKVxuICAgIH07XG4gICAgY29uc3QgbW9kYWxPcHRpb25zID0geyBpbml0aWFsU3RhdGU6IHBheWxvYWQgfSBhcyBNb2RhbE9wdGlvbnM7XG4gICAgdGhpcy5tb2RhbFJlZiA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhDb25maXJtTW9kYWxDb21wb25lbnQsIG1vZGFsT3B0aW9ucyk7XG5cbiAgICBjb25zdCBjb25maXJtID0gYXdhaXQgdGhpcy5tb2RhbFJlZi5jb250ZW50LnJlc3VsdDtcbiAgICBpZiAoY29uZmlybSkge1xuICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMucmVwb3J0c1NlcnZpY2UuZGVsZXRlU2NoZWR1bGUoc2NoZWR1bGUsIHRoaXMuX2V4cG9ydElkKTtcbiAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgIC8vIHJlZnJlc2ggc2NoZWR1bGUgbGlzdFxuICAgICAgICB0aGlzLmdldFNjaGVkdWxlTGlzdChmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=