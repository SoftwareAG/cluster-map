import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { IEvent, IManagedObject, Realtime } from '@c8y/client';
import { DeviceConfigurationService } from './device-configuration.service';
import { gettext } from '@c8y/ngx-components';
var DeviceConfigurationComponent = /** @class */ (function () {
    function DeviceConfigurationComponent(route, deviceConfigurationService, realtime) {
        var _this = this;
        this.route = route;
        this.deviceConfigurationService = deviceConfigurationService;
        this.realtime = realtime;
        this.configSnapshot = {};
        this.deviceConfigurationService.repositoryConfigListUpdated.subscribe(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.repositorySnapshot = undefined;
                        _a = this;
                        return [4 /*yield*/, this.getSnapshotsFromRepository(this.device.type, this.configurationType)];
                    case 1:
                        _a.repositorySnapshots = _b.sent();
                        return [2 /*return*/];
                }
            });
        }); });
    }
    DeviceConfigurationComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.device = this.route.snapshot.parent.data.contextData;
        this.supportedConfigurations = this.device.c8y_SupportedConfigurations.map(function (item) { return ({
            name: item
        }); });
        this.repositorySnapshotsEmptyState = {
            icon: 'gears',
            title: gettext('No configurations available.'),
            text: gettext('Add configuration to configuration repository')
        };
        var eventsChannel = '/eventsWithChildren/' + this.device.id;
        this.eventsSubscription = this.realtime.observable(eventsChannel).subscribe(function (_a) {
            var data = _a.data;
            _this.updateConfigSnapshotOnEvent(data);
        });
    };
    DeviceConfigurationComponent.prototype.onConfigTypeSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var configEvent, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.configurationType = undefined;
                        this.repositorySnapshot = undefined;
                        this.configSnapshot = {};
                        return [4 /*yield*/, this.deviceConfigurationService.getLatestConfigurationEvent(this.device.id, config.name)];
                    case 1:
                        configEvent = _b.sent();
                        this.updateConfigSnapshotOnEvent(configEvent, config.name);
                        this.configurationType = config.name;
                        _a = this;
                        return [4 /*yield*/, this.getSnapshotsFromRepository(this.device.type, config.name)];
                    case 2:
                        _a.repositorySnapshots = _b.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.getSnapshotsFromRepository = function (deviceType, configurationType) {
        return this.deviceConfigurationService.getSnapshotsFromRepository(deviceType, configurationType);
    };
    DeviceConfigurationComponent.prototype.updateConfigSnapshotOnEvent = function (event, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var type, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        type = configurationType || this.configurationType;
                        if (!(event && event.type === type)) return [3 /*break*/, 2];
                        this.configSnapshot = {
                            time: event.time,
                            name: event.text,
                            deviceType: this.device.deviceType,
                            configurationType: type
                        };
                        _a = this.configSnapshot;
                        return [4 /*yield*/, this.deviceConfigurationService.getEventConfigurationBinary(event)];
                    case 1:
                        _a.binary = _b.sent();
                        _b.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.onRepositoryConfigSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.repositorySnapshot = {
                            time: config.creationTime,
                            name: config.name,
                            binaryUrl: config.url,
                            deviceType: config.deviceType,
                            configurationType: config.configurationType
                        };
                        if (!config.url) return [3 /*break*/, 2];
                        _a = this.repositorySnapshot;
                        return [4 /*yield*/, this.deviceConfigurationService.getConfigurationBinaryFile(config.url)];
                    case 1:
                        _a.binary = _b.sent();
                        _b.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.ngOnDestroy = function () {
        this.eventsSubscription.unsubscribe();
    };
    DeviceConfigurationComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: DeviceConfigurationService },
        { type: Realtime }
    ]; };
    DeviceConfigurationComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-device-configuration',
            template: "<div class=\"card card--grid card--grid--fullpage grid__col--4-8 grid__row--6-6\">\n  <!-- DEVICE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-header separator\">\n      <h4 class=\"card-title\" translate>Configurations</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Device-supported configurations</span></h5>\n    </div>\n    <div class=\"p-r-16\">\n      <c8y-device-configuration-list\n        [items]=\"supportedConfigurations\"\n        [itemIcon]=\"'gears'\"\n        (configSelected)=\"onConfigTypeSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-header separator bg-gray-lighter hidden-xs hidden-sm\">\n      <h4>&nbsp;</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Preview</span></h5>\n\n      <!-- EMPTY STATE -->\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small translate>Select a configuration to preview</small>\n        </p>\n      </div>\n\n      <!-- PREVIEW AVAILABLE STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"configurationType\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"configSnapshot\"\n        [canSaveSnapshot]=\"true\"\n        [operationToTrigger]=\"'c8y_UploadConfigFile'\"\n        [actionButtonText]=\"'Get snapshot from device' | translate\"\n        [actionButtonIcon]=\"'download'\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n\n  <!-- AVAILABLE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Available supported configurations</h5>\n    </div>\n\n    <!-- EMPTY STATE -->\n    <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n      <h1 [c8yIcon]=\"'gears'\"></h1>\n      <p>\n        <strong translate>No selection</strong><br />\n        <small translate>Select a configuration from the device-supported configuration list</small>\n      </p>\n    </div>\n    <div class=\"p-r-16\" *ngIf=\"configurationType\">\n      <c8y-device-configuration-list\n        [items]=\"repositorySnapshots\"\n        [itemIcon]=\"'file-text'\"\n        [emptyState]=\"repositorySnapshotsEmptyState\"\n        [isFilterEnabled]=\"true\"\n        (configSelected)=\"onRepositoryConfigSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Preview</h5>\n\n      <!-- EMPTY STATE -->\n\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!repositorySnapshot\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small *ngIf=\"!configurationType; else noSnapshot\" translate\n            >Select a configuration to preview</small\n          >\n          <ng-template #noSnapshot>\n            <small translate>Select the configuration you want to preview</small>\n          </ng-template>\n        </p>\n      </div>\n\n      <!-- CONFIGURATION SELECTED STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"repositorySnapshot\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"repositorySnapshot\"\n        [operationToTrigger]=\"'c8y_DownloadConfigFile'\"\n        [actionButtonText]=\"'Send configuration to device' | translate\"\n        [actionButtonIcon]=\"'upload'\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n</div>\n"
        })
    ], DeviceConfigurationComponent);
    return DeviceConfigurationComponent;
}());
export { DeviceConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9kZXZpY2UtY29uZmlndXJhdGlvbi8iLCJzb3VyY2VzIjpbImRldmljZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU81RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFNOUM7SUFXRSxzQ0FDVSxLQUFxQixFQUNyQiwwQkFBc0QsRUFDdEQsUUFBa0I7UUFINUIsaUJBWUM7UUFYUyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQiwrQkFBMEIsR0FBMUIsMEJBQTBCLENBQTRCO1FBQ3RELGFBQVEsR0FBUixRQUFRLENBQVU7UUFYNUIsbUJBQWMsR0FBbUMsRUFBRSxDQUFDO1FBYWxELElBQUksQ0FBQywwQkFBMEIsQ0FBQywyQkFBMkIsQ0FBQyxTQUFTLENBQUM7Ozs7O3dCQUNwRSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsU0FBUyxDQUFDO3dCQUNwQyxLQUFBLElBQUksQ0FBQTt3QkFBdUIscUJBQU0sSUFBSSxDQUFDLDBCQUEwQixDQUM5RCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFDaEIsSUFBSSxDQUFDLGlCQUFpQixDQUN2QixFQUFBOzt3QkFIRCxHQUFLLG1CQUFtQixHQUFHLFNBRzFCLENBQUM7Ozs7YUFDSCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsK0NBQVEsR0FBUjtRQUFBLGlCQWVDO1FBZEMs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Rzs0QkFDeEIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxZQUFZOzRCQUN6QixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUk7NEJBQ2pCLFNBQVMsRUFBRSxNQUFNLENBQUMsR0FBRzs0QkFDckIsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVOzRCQUM3QixpQkFBaUIsRUFBRSxNQUFNLENBQUMsaUJBQWlCO3lCQUM1QyxDQUFDOzZCQUNFLE1BQU0sQ0FBQyxHQUFHLEVBQVYsd0JBQVU7d0JBQ1osS0FBQSxJQUFJLENBQUMsa0JBQWtCLENBQUE7d0JBQVUscUJBQU0sSUFBSSxDQUFDLDBCQUEwQixDQUFDLDBCQUEwQixDQUMvRixNQUFNLENBQUMsR0FBRyxDQUNYLEVBQUE7O3dCQUZELEdBQXdCLE1BQU0sR0FBRyxTQUVoQyxDQUFDOzs7Ozs7S0FFTDtJQUVELGtEQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDeEMsQ0FBQzs7Z0JBcEZnQixjQUFjO2dCQUNPLDBCQUEwQjtnQkFDNUMsUUFBUTs7SUFkakIsNEJBQTRCO1FBSnhDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSwwQkFBMEI7WUFDcEMsaS9IQUFvRDtTQUNyRCxDQUFDO09BQ1csNEJBQTRCLENBaUd4QztJQUFELG1DQUFDO0NBQUEsQUFqR0QsSUFpR0M7U0FqR1ksNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkRlc3Ryb3ksIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSUV2ZW50LCBJTWFuYWdlZE9iamVjdCwgUmVhbHRpbWUgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uc2VydmljZSc7XG5pbXBvcnQge1xuICBDb25maWd1cmF0aW9uTGlzdEVtcHR5U3RhdGUsXG4gIENvbmZpZ3VyYXRpb25TbmFwc2hvdCxcbiAgU3VwcG9ydGVkQ29uZmlndXJhdGlvbkl0ZW1cbn0gZnJvbSAnLi9kZXZpY2UtY29uZmlndXJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRldmljZS1jb25maWd1cmF0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RldmljZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBEZXZpY2VDb25maWd1cmF0aW9uQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBzdXBwb3J0ZWRDb25maWd1cmF0aW9uczogU3VwcG9ydGVkQ29uZmlndXJhdGlvbkl0ZW1bXTtcbiAgY29uZmlndXJhdGlvblR5cGU6IHN0cmluZztcbiAgY29uZmlnU25hcHNob3Q6IFBhcnRpYWw8Q29uZmlndXJhdGlvblNuYXBzaG90PiA9IHt9O1xuICByZXBvc2l0b3J5U25hcHNob3RzOiBJTWFuYWdlZE9iamVjdFtdO1xuICByZXBvc2l0b3J5U25hcHNob3Q6IENvbmZpZ3VyYXRpb25TbmFwc2hvdDtcbiAgcmVwb3NpdG9yeVNuYXBzaG90c0VtcHR5U3RhdGU6IENvbmZpZ3VyYXRpb25MaXN0RW1wdHlTdGF0ZTtcbiAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdDtcblxuICBwcml2YXRlIGV2ZW50c1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2U6IERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lXG4gICkge1xuICAgIHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UucmVwb3NpdG9yeUNvbmZpZ0xpc3RVcGRhdGVkLnN1YnNjcmliZShhc3luYyAoKSA9PiB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdCA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90cyA9IGF3YWl0IHRoaXMuZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkoXG4gICAgICAgIHRoaXMuZGV2aWNlLnR5cGUsXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvblR5cGVcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmRldmljZSA9IHRoaXMucm91dGUuc25hcHNob3QucGFyZW50LmRhdGEuY29udGV4dERhdGE7XG4gICAgdGhpcy5zdXBwb3J0ZWRDb25maWd1cmF0aW9ucyA9IHRoaXMuZGV2aWNlLmM4eV9TdXBwb3J0ZWRDb25maWd1cmF0aW9ucy5tYXAoaXRlbSA9PiAoe1xuICAgICAgbmFtZTogaXRlbVxuICAgIH0pKTtcblxuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90c0VtcHR5U3RhdGUgPSB7XG4gICAgICBpY29uOiAnZ2VhcnMnLFxuICAgICAgdGl0bGU6IGdldHRleHQoJ05vIGNvbmZpZ3VyYXRpb25zIGF2YWlsYWJsZS4nKSxcbiAgICAgIHRleHQ6IGdldHRleHQoJ0FkZCBjb25maWd1cmF0aW9uIHRvIGNvbmZpZ3VyYXRpb24gcmVwb3NpdG9yeScpXG4gICAgfTtcbiAgICBjb25zdCBldmVudHNDaGFubmVsID0gJy9ldmVudHNXaXRoQ2hpbGRyZW4vJyArIHRoaXMuZGV2aWNlLmlkO1xuICAgIHRoaXMuZXZlbnRzU3Vic2NyaXB0aW9uID0gdGhpcy5yZWFsdGltZS5vYnNlcnZhYmxlKGV2ZW50c0NoYW5uZWwpLnN1YnNjcmliZSgoeyBkYXRhIH0pID0+IHtcbiAgICAgIHRoaXMudXBkYXRlQ29uZmlnU25hcHNob3RPbkV2ZW50KGRhdGEpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgb25Db25maWdUeXBlU2VsZWN0ZWQoY29uZmlnKSB7XG4gICAgdGhpcy5jb25maWd1cmF0aW9uVHlwZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNvbmZpZ1NuYXBzaG90ID0ge307XG5cbiAgICBjb25zdCBjb25maWdFdmVudCA9IGF3YWl0IHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuZ2V0TGF0ZXN0Q29uZmlndXJhdGlvbkV2ZW50KFxuICAgICAgdGhpcy5kZXZpY2UuaWQsXG4gICAgICBjb25maWcubmFtZVxuICAgICk7XG4gICAgdGhpcy51cGRhdGVDb25maWdTbmFwc2hvdE9uRXZlbnQoY29uZmlnRXZlbnQsIGNvbmZpZy5uYW1lKTtcblxuICAgIHRoaXMuY29uZmlndXJhdGlvblR5cGUgPSBjb25maWcubmFtZTtcbiAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdHMgPSBhd2FpdCB0aGlzLmdldFNuYXBzaG90c0Zyb21SZXBvc2l0b3J5KHRoaXMuZGV2aWNlLnR5cGUsIGNvbmZpZy5uYW1lKTtcbiAgfVxuXG4gIGdldFNuYXBzaG90c0Zyb21SZXBvc2l0b3J5KGRldmljZVR5cGUsIGNvbmZpZ3VyYXRpb25UeXBlKSB7XG4gICAgcmV0dXJuIHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkoXG4gICAgICBkZXZpY2VUeXBlLFxuICAgICAgY29uZmlndXJhdGlvblR5cGVcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlQ29uZmlnU25hcHNob3RPbkV2ZW50KGV2ZW50OiBJRXZlbnQsIGNvbmZpZ3VyYXRpb25UeXBlPykge1xuICAgIGNvbnN0IHR5cGUgPSBjb25maWd1cmF0aW9uVHlwZSB8fCB0aGlzLmNvbmZpZ3VyYXRpb25UeXBlO1xuICAgIGlmIChldmVudCAmJiBldmVudC50eXBlID09PSB0eXBlKSB7XG4gICAgICB0aGlzLmNvbmZpZ1NuYXBzaG90ID0ge1xuICAgICAgICB0aW1lOiBldmVudC50aW1lLFxuICAgICAgICBuYW1lOiBldmVudC50ZXh0LFxuICAgICAgICBkZXZpY2VUeXBlOiB0aGlzLmRldmljZS5kZXZpY2VUeXBlLFxuICAgICAgICBjb25maWd1cmF0aW9uVHlwZTogdHlwZVxuICAgICAgfTtcbiAgICAgIHRoaXMuY29uZmlnU25hcHNob3QuYmluYXJ5ID0gYXdhaXQgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5nZXRFdmVudENvbmZpZ3VyYXRpb25CaW5hcnkoXG4gICAgICAgIGV2ZW50XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9uUmVwb3NpdG9yeUNvbmZpZ1NlbGVjdGVkKGNvbmZpZykge1xuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90ID0ge1xuICAgICAgdGltZTogY29uZmlnLmNyZWF0aW9uVGltZSxcbiAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLFxuICAgICAgYmluYXJ5VXJsOiBjb25maWcudXJsLFxuICAgICAgZGV2aWNlVHlwZTogY29uZmlnLmRldmljZVR5cGUsXG4gICAgICBjb25maWd1cmF0aW9uVHlwZTogY29uZmlnLmNvbmZpZ3VyYXRpb25UeXBlXG4gICAgfTtcbiAgICBpZiAoY29uZmlnLnVybCkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3QuYmluYXJ5ID0gYXdhaXQgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5nZXRDb25maWd1cmF0aW9uQmluYXJ5RmlsZShcbiAgICAgICAgY29uZmlnLnVybFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmV2ZW50c1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=