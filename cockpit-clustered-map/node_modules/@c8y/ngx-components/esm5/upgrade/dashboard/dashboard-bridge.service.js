import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService, ContextDashboardManagedObject, ContextWidgetConfig } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
import { get } from 'lodash-es';
var DashboardBridgeService = /** @class */ (function () {
    function DashboardBridgeService(ng1Injector, zone, router, contextDashboardService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    Object.defineProperty(DashboardBridgeService.prototype, "ng1Components", {
        get: function () {
            return this.ng1Injector.get('c8yComponents');
        },
        enumerable: true,
        configurable: true
    });
    DashboardBridgeService.prototype.instantiateComponent = function (widget, element) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dashboard, context, child, transformedChild_1;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        dashboard = widget.dashboard, context = widget.context, child = widget.child;
                        if (!dashboard) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child)];
                    case 1:
                        transformedChild_1 = _a.sent();
                        if (!(this.dashboardSvc.forcedContext || dashboard.deviceType)) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild_1.config)];
                    case 2:
                        _a.sent();
                        _a.label = 3;
                    case 3: return [2 /*return*/, this.zone.runOutsideAngular(function () {
                            return _this.loadTemplate(transformedChild_1, child, element, context);
                        })];
                    case 4: return [2 /*return*/, this.loadConfigTemplate(element, widget)];
                }
            });
        });
    };
    DashboardBridgeService.prototype.editDashboard = function (dashboard) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id })];
            });
        });
    };
    DashboardBridgeService.prototype.copyDashboard = function () {
        var dashboard = this.getDashboard();
        var couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            return dashboard;
        }
    };
    DashboardBridgeService.prototype.pasteDashboard = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var newDashboard, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.dashboardSvc.pasteDashboard()];
                    case 1:
                        newDashboard = _a.sent();
                        return [4 /*yield*/, this.contextDashboardService.addTab(newDashboard)];
                    case 2:
                        _a.sent();
                        this.navigateToDashboard(newDashboard);
                        this.dashboardClipboard = undefined;
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    DashboardBridgeService.prototype.instantiateDeviceSelector = function (element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    };
    DashboardBridgeService.prototype.loadTemplate = function (transformedChild, child, element, context) {
        var scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = "<c8y-ui-component component-name=\"'" + child.widgetComponent + "'\" config=\"child.config\" context=\"dashboardContext\"></c8y-ui-component>";
        }
        else if (child.templateUrl) {
            element.innerHTML = "<ng-include src=\"'" + child.templateUrl + "'\"></ng-include>";
        }
        this.compile(element)(scope);
        return scope;
    };
    DashboardBridgeService.prototype.navigateToDashboard = function (dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    };
    DashboardBridgeService.prototype.getDashboard = function () {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    };
    DashboardBridgeService.prototype.loadConfigTemplate = function (element, widgetConfig, onlyDeviceSelector) {
        var _this = this;
        if (onlyDeviceSelector === void 0) { onlyDeviceSelector = false; }
        var settings = widgetConfig.settings;
        var scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = tslib_1.__assign({}, settings, settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.rootId = settings.context.id;
        scope.dashboard = get(widgetConfig, 'settings.dashboardMo');
        var configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = "<c8y-ui-component component-name=\"'" + widgetConfig.settings.configComponent + "'\" config=\"config\"></c8y-ui-component>";
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = "<ng-include src=\"'" + widgetConfig.settings.configTemplateUrl + "'\"></ng-include>";
            }
        }
        element.innerHTML = "\n    <ng-form name=\"forms.componentForm\">\n      <div class=\"form-group\"\n        ng-if=\"!settings.noDeviceTarget\"\n        ng-style=\"{height: settings.hideTarget && '0', overflow: 'hidden'}\"\n      >\n        <label translate>" + gettext('Target assets or devices') + "</label>\n        <c8y-device-selector-combo parent=\"rootId\"\n          selected-child-device=\"config.device\"\n          groups-selectable=\"settings.groupsSelectable\"\n        ></c8y-device-selector-combo>\n      </div>\n      " + configCmp + "\n    </ng-form>";
        scope.$watch('forms.componentForm.$invalid', function (formStatus) {
            _this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    };
    DashboardBridgeService.ctorParameters = function () { return [
        { type: undefined },
        { type: NgZone },
        { type: Router },
        { type: ContextDashboardService }
    ]; };
    DashboardBridgeService = tslib_1.__decorate([
        Injectable()
    ], DashboardBridgeService);
    return DashboardBridgeService;
}());
export { DashboardBridgeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsiZGFzaGJvYXJkL2Rhc2hib2FyZC1icmlkZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsNkJBQTZCLEVBQzdCLG1CQUFtQixFQUNwQixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2hDO0lBS0UsZ0NBQ1UsV0FBZ0IsRUFDaEIsSUFBWSxFQUNaLE1BQWMsRUFDZCx1QkFBZ0Q7UUFIaEQsZ0JBQVcsR0FBWCxXQUFXLENBQUs7UUFDaEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBRXhELElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELHNCQUFJLGlEQUFhO2FBQWpCO1lBQ0UsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMvQyxDQUFDOzs7T0FBQTtJQUVLLHFEQUFvQixHQUExQixVQUEyQixNQUFNLEVBQUUsT0FBTzs7Ozs7Ozt3QkFDaEMsU0FBUyxHQUFxQixNQUFNLFVBQTNCLEVBQUUsT0FBTyxHQUFZLE1BQU0sUUFBbEIsRUFBRSxLQUFLLEdBQUssTUFBTSxNQUFYLENBQVk7NkJBQ3pDLFNBQVMsRUFBVCx3QkFBUzt3QkFDYyxxQkFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLHlCQUF5QixDQUN4RSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsSUFBSSxPQUFPLEVBQzFDLFNBQVMsRUFDVCxLQUFLLENBQ04sRUFBQTs7d0JBSksscUJBQW1CLFNBSXhCOzZCQUNHLENBQUEsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQSxFQUF2RCx3QkFBdUQ7d0JBQ3pELHFCQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsOEJBQThCLENBQ3BELElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxJQUFJLE9BQU8sRUFDMUMsa0JBQWdCLENBQUMsTUFBTSxDQUN4QixFQUFBOzt3QkFIRCxTQUdDLENBQUM7OzRCQUVKLHNCQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7NEJBQ2pDLE9BQUEsS0FBSSxDQUFDLFlBQVksQ0FBQyxrQkFBZ0IsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQzt3QkFBNUQsQ0FBNEQsQ0FDN0QsRUFBQzs0QkFFRixzQkFBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxFQUFDOzs7O0tBRW5EO0lBRUssOENBQWEsR0FBbkIsVUFBb0IsU0FBUzs7O2dCQUMzQixzQkFBTyxJQUFJLENBQUMsWUFBWSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsV0FBVyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFDOzs7S0FDOUU7SUFFRCw4Q0FBYSxHQUFiO1FBQ0UsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RDLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzRSxJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7WUFDcEMsT0FBTyxTQUFTLENBQUM7U0FDbEI7SUFDSCxDQUFDO0lBRUssK0NBQWMsR0FBcEI7Ozs7Ozs7d0JBRXlCLHFCQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLEVBQUE7O3dCQUF2RCxZQUFZLEdBQUcsU0FBd0M7d0JBQzdELHFCQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUE7O3dCQUF2RCxTQUF1RCxDQUFDO3dCQUN4RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ3ZDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7Ozs7Ozs7OztLQUl2QztJQUVELDBEQUF5QixHQUF6QixVQUEwQixPQUFPLEVBQUUsWUFBaUM7UUFDbEUsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRU8sNkNBQVksR0FBcEIsVUFBcUIsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPO1FBQzVELElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RCxLQUFLLENBQUMsS0FBSyxHQUFHLGdCQUFnQixDQUFDO1FBQy9CLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxPQUFPLENBQUM7UUFDakMsSUFBSSxLQUFLLENBQUMsZUFBZSxFQUFFO1lBQ3pCLE9BQU8sQ0FBQyxTQUFTLEdBQUcseUNBQ2xCLEtBQUssQ0FBQyxlQUFlLGlGQUNrRCxDQUFDO1NBQzNFO2FBQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQzVCLE9BQU8sQ0FBQyxTQUFTLEdBQUcsd0JBQXFCLEtBQUssQ0FBQyxXQUFXLHNCQUFrQixDQUFDO1NBQzlFO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFTyxvREFBbUIsR0FBM0IsVUFBNEIsU0FBd0M7UUFDbEUsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUN6QyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQzthQUMzQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDdEQsVUFBVSxFQUFFLGlCQUFpQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7YUFDM0MsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRU8sNkNBQVksR0FBcEI7UUFDRSxPQUFPLGlCQUFpQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNoRSxDQUFDO0lBRU8sbURBQWtCLEdBQTFCLFVBQ0UsT0FBTyxFQUNQLFlBQWlDLEVBQ2pDLGtCQUEwQjtRQUg1QixpQkFnREM7UUE3Q0MsbUNBQUEsRUFBQSwwQkFBMEI7UUFFbEIsSUFBQSxnQ0FBUSxDQUFrQjtRQUNsQyxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFNUQsS0FBSyxDQUFDLFFBQVEsd0JBQVEsUUFBUSxFQUFLLFFBQVEsQ0FBQyxHQUFHLENBQUUsQ0FBQztRQUNsRCxLQUFLLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7UUFDckMsS0FBSyxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUM7UUFDNUIsS0FBSyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDakIsS0FBSyxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNuQyxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxZQUFZLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUU1RCxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGtCQUFrQixFQUFFO1lBQ3ZCLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUU7Z0JBQ3pDLFNBQVMsR0FBRyx5Q0FDVixZQUFZLENBQUMsUUFBUSxDQUFDLGVBQWUsOENBQ0MsQ0FBQzthQUMxQztpQkFBTSxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ2xELFNBQVMsR0FBRyx3QkFBcUIsWUFBWSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsc0JBQWtCLENBQUM7YUFDNUY7U0FDRjtRQUVELE9BQU8sQ0FBQyxTQUFTLEdBQUcsaVBBTUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLGlQQU10RCxTQUFTLHFCQUNGLENBQUM7UUFFWixLQUFLLENBQUMsTUFBTSxDQUFDLDhCQUE4QixFQUFFLFVBQUEsVUFBVTtZQUNyRCxLQUFJLENBQUMsdUJBQXVCLENBQUMsWUFBWSxHQUFHLFVBQVUsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFFL0UsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7Z0JBN0llLE1BQU07Z0JBQ0osTUFBTTtnQkFDVyx1QkFBdUI7O0lBVC9DLHNCQUFzQjtRQURsQyxVQUFVLEVBQUU7T0FDQSxzQkFBc0IsQ0FxSmxDO0lBQUQsNkJBQUM7Q0FBQSxBQXJKRCxJQXFKQztTQXJKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBnZXRBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgQ29udGV4dERhc2hib2FyZFNlcnZpY2UsXG4gIENvbnRleHREYXNoYm9hcmRNYW5hZ2VkT2JqZWN0LFxuICBDb250ZXh0V2lkZ2V0Q29uZmlnXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvY29udGV4dC1kYXNoYm9hcmQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhc2hib2FyZEJyaWRnZVNlcnZpY2Uge1xuICBkYXNoYm9hcmRTdmM7XG4gIGNvbXBpbGU7XG4gIGRhc2hib2FyZENsaXBib2FyZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG5nMUluamVjdG9yOiBhbnksXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIGNvbnRleHREYXNoYm9hcmRTZXJ2aWNlOiBDb250ZXh0RGFzaGJvYXJkU2VydmljZVxuICApIHtcbiAgICB0aGlzLmRhc2hib2FyZFN2YyA9IG5nMUluamVjdG9yLmdldCgnZGFzaGJvYXJkU3ZjJyk7XG4gICAgdGhpcy5jb21waWxlID0gbmcxSW5qZWN0b3IuZ2V0KCckY29tcGlsZScpO1xuICB9XG5cbiAgZ2V0IG5nMUNvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMubmcxSW5qZWN0b3IuZ2V0KCdjOHlDb21wb25lbnRzJyk7XG4gIH1cblxuICBhc3luYyBpbnN0YW50aWF0ZUNvbXBvbmVudCh3aWRnZXQsIGVsZW1lbnQpIHtcbiAgICBjb25zdCB7IGRhc2hib2FyZCwgY29udGV4dCwgY2hpbGQgfSA9IHdpZGdldDtcbiAgICBpZiAoZGFzaGJvYXJkKSB7XG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZENoaWxkID0gYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMudHJhbnNmb3JtQ2hpbGRXaXRoQ29udGV4dChcbiAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICBkYXNoYm9hcmQsXG4gICAgICAgIGNoaWxkXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgZGFzaGJvYXJkLmRldmljZVR5cGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMudXBkYXRlQ29uZmlnVGFyZ2V0c1dpdGhDb250ZXh0KFxuICAgICAgICAgIHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgY29udGV4dCxcbiAgICAgICAgICB0cmFuc2Zvcm1lZENoaWxkLmNvbmZpZ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PlxuICAgICAgICB0aGlzLmxvYWRUZW1wbGF0ZSh0cmFuc2Zvcm1lZENoaWxkLCBjaGlsZCwgZWxlbWVudCwgY29udGV4dClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmxvYWRDb25maWdUZW1wbGF0ZShlbGVtZW50LCB3aWRnZXQpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGVkaXREYXNoYm9hcmQoZGFzaGJvYXJkKSB7XG4gICAgcmV0dXJuIHRoaXMuZGFzaGJvYXJkU3ZjLmVkaXRDdXJyZW50RGFzaGJvYXJkKHsgZGFzaGJvYXJkSWQ6IGRhc2hib2FyZC5pZCB9KTtcbiAgfVxuXG4gIGNvcHlEYXNoYm9hcmQoKSB7XG4gICAgY29uc3QgZGFzaGJvYXJkID0gdGhpcy5nZXREYXNoYm9hcmQoKTtcbiAgICBjb25zdCBjb3VsZENvcHkgPSB0aGlzLmRhc2hib2FyZFN2Yy5jb3B5RGFzaGJvYXJkKGRhc2hib2FyZC5jOHlfRGFzaGJvYXJkKTtcbiAgICBpZiAoY291bGRDb3B5KSB7XG4gICAgICB0aGlzLmRhc2hib2FyZENsaXBib2FyZCA9IGRhc2hib2FyZDtcbiAgICAgIHJldHVybiBkYXNoYm9hcmQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGFzdGVEYXNoYm9hcmQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5ld0Rhc2hib2FyZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnBhc3RlRGFzaGJvYXJkKCk7XG4gICAgICBhd2FpdCB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmFkZFRhYihuZXdEYXNoYm9hcmQpO1xuICAgICAgdGhpcy5uYXZpZ2F0ZVRvRGFzaGJvYXJkKG5ld0Rhc2hib2FyZCk7XG4gICAgICB0aGlzLmRhc2hib2FyZENsaXBib2FyZCA9IHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaW50ZW5kZWQgZW1wdHlcbiAgICB9XG4gIH1cblxuICBpbnN0YW50aWF0ZURldmljZVNlbGVjdG9yKGVsZW1lbnQsIHdpZGdldENvbmZpZzogQ29udGV4dFdpZGdldENvbmZpZykge1xuICAgIHJldHVybiB0aGlzLmxvYWRDb25maWdUZW1wbGF0ZShlbGVtZW50LCB3aWRnZXRDb25maWcsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkVGVtcGxhdGUodHJhbnNmb3JtZWRDaGlsZCwgY2hpbGQsIGVsZW1lbnQsIGNvbnRleHQpIHtcbiAgICBjb25zdCBzY29wZSA9IHRoaXMubmcxSW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJykuJG5ldyh0cnVlKTtcbiAgICBzY29wZS5jaGlsZCA9IHRyYW5zZm9ybWVkQ2hpbGQ7XG4gICAgc2NvcGUuZGFzaGJvYXJkQ29udGV4dCA9IGNvbnRleHQ7XG4gICAgaWYgKGNoaWxkLndpZGdldENvbXBvbmVudCkge1xuICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBgPGM4eS11aS1jb21wb25lbnQgY29tcG9uZW50LW5hbWU9XCInJHtcbiAgICAgICAgY2hpbGQud2lkZ2V0Q29tcG9uZW50XG4gICAgICB9J1wiIGNvbmZpZz1cImNoaWxkLmNvbmZpZ1wiIGNvbnRleHQ9XCJkYXNoYm9hcmRDb250ZXh0XCI+PC9jOHktdWktY29tcG9uZW50PmA7XG4gICAgfSBlbHNlIGlmIChjaGlsZC50ZW1wbGF0ZVVybCkge1xuICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBgPG5nLWluY2x1ZGUgc3JjPVwiJyR7Y2hpbGQudGVtcGxhdGVVcmx9J1wiPjwvbmctaW5jbHVkZT5gO1xuICAgIH1cbiAgICB0aGlzLmNvbXBpbGUoZWxlbWVudCkoc2NvcGUpO1xuICAgIHJldHVybiBzY29wZTtcbiAgfVxuXG4gIHByaXZhdGUgbmF2aWdhdGVUb0Rhc2hib2FyZChkYXNoYm9hcmQ6IENvbnRleHREYXNoYm9hcmRNYW5hZ2VkT2JqZWN0KSB7XG4gICAgaWYgKC9kYXNoYm9hcmQvLnRlc3QodGhpcy5yb3V0ZXIudXJsKSkge1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycuLicsIGRhc2hib2FyZC5pZF0sIHtcbiAgICAgICAgcmVsYXRpdmVUbzogZ2V0QWN0aXZhdGVkUm91dGUodGhpcy5yb3V0ZXIpXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycuLicsICdkYXNoYm9hcmQnLCBkYXNoYm9hcmQuaWRdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmQoKSB7XG4gICAgcmV0dXJuIGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKS5zbmFwc2hvdC5kYXRhLmRhc2hib2FyZDtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZENvbmZpZ1RlbXBsYXRlKFxuICAgIGVsZW1lbnQsXG4gICAgd2lkZ2V0Q29uZmlnOiBDb250ZXh0V2lkZ2V0Q29uZmlnLFxuICAgIG9ubHlEZXZpY2VTZWxlY3RvciA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHsgc2V0dGluZ3MgfSA9IHdpZGdldENvbmZpZztcbiAgICBjb25zdCBzY29wZSA9IHRoaXMubmcxSW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJykuJG5ldyh0cnVlKTtcblxuICAgIHNjb3BlLnNldHRpbmdzID0geyAuLi5zZXR0aW5ncywgLi4uc2V0dGluZ3MubmcxIH07XG4gICAgc2NvcGUub3B0aW9ucyA9IHdpZGdldENvbmZpZy5vcHRpb25zO1xuICAgIHNjb3BlLmNvbmZpZyA9IHdpZGdldENvbmZpZztcbiAgICBzY29wZS5mb3JtcyA9IHt9O1xuICAgIHNjb3BlLnJvb3RJZCA9IHNldHRpbmdzLmNvbnRleHQuaWQ7XG4gICAgc2NvcGUuZGFzaGJvYXJkID0gZ2V0KHdpZGdldENvbmZpZywgJ3NldHRpbmdzLmRhc2hib2FyZE1vJyk7XG5cbiAgICBsZXQgY29uZmlnQ21wID0gJyc7XG4gICAgaWYgKCFvbmx5RGV2aWNlU2VsZWN0b3IpIHtcbiAgICAgIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke1xuICAgICAgICAgIHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdDb21wb25lbnRcbiAgICAgICAgfSdcIiBjb25maWc9XCJjb25maWdcIj48L2M4eS11aS1jb21wb25lbnQ+YDtcbiAgICAgIH0gZWxzZSBpZiAod2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ1RlbXBsYXRlVXJsKSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8bmctaW5jbHVkZSBzcmM9XCInJHt3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmx9J1wiPjwvbmctaW5jbHVkZT5gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYFxuICAgIDxuZy1mb3JtIG5hbWU9XCJmb3Jtcy5jb21wb25lbnRGb3JtXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiZm9ybS1ncm91cFwiXG4gICAgICAgIG5nLWlmPVwiIXNldHRpbmdzLm5vRGV2aWNlVGFyZ2V0XCJcbiAgICAgICAgbmctc3R5bGU9XCJ7aGVpZ2h0OiBzZXR0aW5ncy5oaWRlVGFyZ2V0ICYmICcwJywgb3ZlcmZsb3c6ICdoaWRkZW4nfVwiXG4gICAgICA+XG4gICAgICAgIDxsYWJlbCB0cmFuc2xhdGU+JHtnZXR0ZXh0KCdUYXJnZXQgYXNzZXRzIG9yIGRldmljZXMnKX08L2xhYmVsPlxuICAgICAgICA8Yzh5LWRldmljZS1zZWxlY3Rvci1jb21ibyBwYXJlbnQ9XCJyb290SWRcIlxuICAgICAgICAgIHNlbGVjdGVkLWNoaWxkLWRldmljZT1cImNvbmZpZy5kZXZpY2VcIlxuICAgICAgICAgIGdyb3Vwcy1zZWxlY3RhYmxlPVwic2V0dGluZ3MuZ3JvdXBzU2VsZWN0YWJsZVwiXG4gICAgICAgID48L2M4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8+XG4gICAgICA8L2Rpdj5cbiAgICAgICR7Y29uZmlnQ21wfVxuICAgIDwvbmctZm9ybT5gO1xuXG4gICAgc2NvcGUuJHdhdGNoKCdmb3Jtcy5jb21wb25lbnRGb3JtLiRpbnZhbGlkJywgZm9ybVN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IGZvcm1TdGF0dXM7XG4gICAgfSk7XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IHNjb3BlLmZvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQ7XG5cbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cbn1cbiJdfQ==