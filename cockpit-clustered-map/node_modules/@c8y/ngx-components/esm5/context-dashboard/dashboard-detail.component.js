import * as tslib_1 from "tslib";
import { Component, Inject, ViewChild } from '@angular/core';
import { ICON_LIST } from '@c8y/ngx-components';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { DASHBOARD_THEME_CLASSES, WIDGET_HEADER_CLASSES } from './context-dashboard.model';
import { clone } from 'lodash-es';
import { ContextDashboardService } from './context-dashboard.service';
var DashboardDetailComponent = /** @class */ (function () {
    function DashboardDetailComponent(modal, iconList, contextDashboardService) {
        var _this = this;
        this.modal = modal;
        this.contextDashboardService = contextDashboardService;
        this.styling = {
            themeClass: 'dashboard-theme-light',
            headerClass: 'panel-title-regular'
        };
        this.possibleStyling = { DASHBOARD_THEME_CLASSES: DASHBOARD_THEME_CLASSES, WIDGET_HEADER_CLASSES: WIDGET_HEADER_CLASSES };
        this.result = new Promise(function (resolve, reject) {
            _this._save = resolve;
            _this._cancel = reject;
        });
        this.DEFAULT_DASHBOARD_MARGIN = 12;
        this.DEFAULT_DASHBOARD_ICON = 'th';
        this.DEFAULT_DASHBOARD_PRIORITY = 10000;
        this.DEFAULT_DASHBOARD_NAME = 'Dashboard';
        this.icons = iconList;
        this.filteredIcons = iconList;
    }
    DashboardDetailComponent.prototype.ngAfterContentInit = function () {
        var defaultDashboardCfg = {
            name: this.DEFAULT_DASHBOARD_NAME,
            priority: this.DEFAULT_DASHBOARD_PRIORITY,
            icon: this.DEFAULT_DASHBOARD_ICON,
            deviceTypeValue: this.deviceType
        };
        if (this.dashboard) {
            this.current = clone(this.dashboard);
            this.setDashboardStyle();
        }
        else {
            this.dashboard = defaultDashboardCfg;
            this.dashboardDetailForm.form.markAsDirty();
        }
    };
    DashboardDetailComponent.prototype.save = function () {
        var _a, _b;
        this.dashboard.classes = (_a = {}, _a[this.styling.themeClass] = true, _a);
        this.dashboard.widgetClasses = (_b = {}, _b[this.styling.headerClass] = true, _b);
        this._save(this.dashboard);
    };
    DashboardDetailComponent.prototype.close = function () {
        this._cancel();
        this.modal.hide();
    };
    DashboardDetailComponent.prototype.getDashboardPreviewStyle = function () {
        var cssClasses = {};
        cssClasses[this.styling.headerClass] = true;
        cssClasses[this.styling.themeClass] = true;
        return cssClasses;
    };
    DashboardDetailComponent.prototype.selectIcon = function (icon) {
        this.dashboard.icon = icon;
        this.dashboardDetailForm.form.markAsDirty();
    };
    DashboardDetailComponent.prototype.updateFiltered = function (term) {
        if (term) {
            var search_1 = new RegExp(term, 'i');
            this.filteredIcons = this.icons.filter(function (val) { return search_1.test(val); });
        }
        else {
            this.filteredIcons = this.icons;
        }
    };
    DashboardDetailComponent.prototype.setDashboardStyle = function () {
        var _this = this;
        var allClasses = tslib_1.__assign({}, this.dashboard.classes, this.dashboard.widgetClasses);
        var styles = Object.keys(allClasses).map(function (c) { return c.split('-').pop(); });
        styles.forEach(function (styleName) {
            _this.styling.themeClass = _this.contextDashboardService.getStyling(DASHBOARD_THEME_CLASSES, styleName, _this.styling.themeClass);
            _this.styling.headerClass = _this.contextDashboardService.getStyling(WIDGET_HEADER_CLASSES, styleName, _this.styling.headerClass);
        });
    };
    DashboardDetailComponent.ctorParameters = function () { return [
        { type: BsModalRef },
        { type: Array, decorators: [{ type: Inject, args: [ICON_LIST,] }] },
        { type: ContextDashboardService }
    ]; };
    tslib_1.__decorate([
        ViewChild('dashboardDetailForm', { static: true })
    ], DashboardDetailComponent.prototype, "dashboardDetailForm", void 0);
    DashboardDetailComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-dashboard-detail',
            template: "<div class=\"modal-header\">\n  <h3 *ngIf=\"!current\" translate>\n    Add dashboard\n  </h3>\n  <h3 *ngIf=\"current\" translate>Edit dashboard</h3>\n</div>\n\n<div class=\"modal-body\">\n  <form #dashboardDetailForm=\"ngForm\">\n    <div class=\"row\">\n      <div class=\"col-sm-6\">\n        <div *ngIf=\"!isNamedDashboard\">\n          <h6 class=\"legend form-block\"><span translate>Tab</span></h6>\n          <div class=\"input-group\">\n            <c8y-form-group>\n              <label class=\"m-r-8\" translate>Icon</label>\n              <div dropdown class=\"dropdown\">\n                <button\n                  title=\"{{ 'Icon' | translate }}\"\n                  class=\"btn-default btn btn-gray\"\n                  dropdownToggle\n                >\n                  <i c8yIcon=\"{{dashboard.icon}}\"></i>\n                  <span class=\"caret\"></span> \n                </button>                  \n                <ul\n                  *dropdownMenu\n                  class=\"dropdown-menu modal-inner-scroll dropdown-menu-grid-4\"\n                  style=\"max-height: 250px;margin-left: 0;\"\n                >\n                  <ng-container *ngFor=\"let icon of filteredIcons\">\n                    <li (click)=\"selectIcon(icon)\">\n                      <a style=\"cursor: pointer\" title=\"{{icon}}\" [ngClass]=\"{'active': dashboard.icon === icon}\">\n                        <i class=\"icon\" [c8yIcon]=\"icon\" ></i>\n                      </a>\n                    </li>\n                  </ng-container>\n                </ul>\n              </div>\n            </c8y-form-group>\n            <c8y-form-group class=\"flex-grow\">\n              <label>\n                <span class=\"m-r-4\" translate>Menu label</span>\n                <button class=\"btn btn-clean\"\n                  popover=\"{{\n                    'Menu label to display in submenu when dashboard is attached' | translate\n                  }}\"\n                  triggers=\"focus\"\n                  placement=\"right\"\n                  container=\"body\"\n                >\n                  <i\n                    [c8yIcon]=\"'question-circle-o'\"\n                    class=\"text-primary\"\n                  ></i>\n                </button>\n              </label>\n              <input\n                title=\"{{ 'Menu label' | translate }}\"\n                class=\"form-control\"\n                name=\"name\"\n                [(ngModel)]=\"dashboard.name\"\n                placeholder=\"{{ 'e.g. My dashboard' | translate }}\"\n                required\n              />\n            </c8y-form-group>\n          </div>\n          <div class=\"row\">\n            <div class=\"col-sm-6\">\n              <c8y-form-group>\n                <label>\n                  <span translate class=\"m-r-4\">Position in navigation</span>\n                  <button class=\"btn btn-clean\"\n                    popover=\"{{\n                      'Position in navigation menu (10000 first, -10000 last)' | translate\n                    }}\"\n                    triggers=\"focus\"\n                    placement=\"right\"\n                    container=\"body\"\n                  >\n                    <i \n                      [c8yIcon]=\"'question-circle-o'\"\n                      class=\"text-primary\"\n                    ></i>\n                  </button>\n                  \n                </label>\n                <input\n                  title=\"{{ 'Position in navigation' | translate }}\"\n                  type=\"number\"\n                  class=\"form-control\"\n                  name=\"priority\"\n                  [(ngModel)]=\"dashboard.priority\"\n                  min=\"-10000\"\n                  max=\"10000\"\n                  placeholder=\"{{ 'e.g.' | translate }} 500\"\n                  required\n                />\n              </c8y-form-group>\n            </div>\n            <div class=\"col-sm-6\">\n             \n            </div>\n\n            <div style=\"position: relative;\">\n              <div class=\"col-sm-12\">\n                <div class=\"form-group m-b-24\" *ngIf=\"!current && deviceType\">\n                  <label class=\"c8y-checkbox\">\n                    <input type=\"checkbox\" name=\"deviceType\" [(ngModel)]=\"dashboard.deviceType\" />\n                    <span></span>\n                    {{ 'Apply dashboard to all devices of type ' | translate\n                    }}<i>{{ dashboard.deviceTypeValue }}</i>\n                  </label>\n                </div>\n\n                <div\n                  class=\"alert alert-info  m-b-24\"\n                  *ngIf=\"dashboard.deviceType && dashboard.deviceTypeValue\"\n                >\n                  <i c8y-icon=\"info\"></i>\n                  {{ 'This dashboard is shared between all devices of the type ' | translate }}\n                  <i>{{ dashboard.deviceTypeValue }}</i>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div>\n          <c8y-appearance-settings\n            [(themeClass)]=\"styling.themeClass\"\n            [(headerClass)]=\"styling.headerClass\"\n          >\n          </c8y-appearance-settings>\n          <div class=\"row\">\n            <div class=\"col-sm-6\">\n              <c8y-form-group>\n                <label>{{ 'Widget margin' | translate }}</label>\n                <div class=\"input-group\">\n                  <input\n                    title=\"{{ 'Widget margin' | translate }}\"\n                    id=\"margin\"\n                    name=\"margin\"\n                    type=\"number\"\n                    class=\"form-control\"\n                    [(ngModel)]=\"dashboard.widgetMargin\"\n                    min=\"0\"\n                    max=\"50\"\n                    placeholder=\"{{ DEFAULT_DASHBOARD_MARGIN }}\"\n                  />\n                  <span class=\"input-group-addon\">px</span>\n                </div>\n              </c8y-form-group>\n            </div>\n            <div class=\"col-sm-6\">\n              <label translate>Widget titles</label>\n              <c8y-form-group>\n                <label\n                  title=\"{{ 'Translate widget titles if possible' | translate }}\"\n                  class=\"c8y-checkbox\"\n                >\n                  <input\n                    type=\"checkbox\"\n                    name=\"translateWidgetTitle\"\n                    [(ngModel)]=\"dashboard.translateWidgetTitle\"\n                  /><span></span>\n                  <span>{{ 'Translate if possible' | translate }}</span>\n                </label>\n              </c8y-form-group>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-sm-6\">\n        <c8y-widget-preview\n          [tab]=\"!isNamedDashboard ? dashboard : undefined\"\n          [previewClasses]=\"getDashboardPreviewStyle()\"\n        ></c8y-widget-preview>\n      </div>\n    </div>\n  </form>\n</div>\n\n<div class=\"modal-footer\">\n  <button title=\"{{ 'Cancel' | translate }}\" class=\"btn btn-default\" (click)=\"close()\" translate>\n    Cancel\n  </button>\n  <button\n    title=\"{{ 'Save' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"save()\"\n    [disabled]=\"dashboardDetailForm.form.invalid || dashboardDetailForm.form.pristine\"\n    translate\n  >\n    Save\n  </button>\n</div>\n"
        }),
        tslib_1.__param(1, Inject(ICON_LIST))
    ], DashboardDetailComponent);
    return DashboardDetailComponent;
}());
export { DashboardDetailComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWRldGFpbC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2NvbnRleHQtZGFzaGJvYXJkLyIsInNvdXJjZXMiOlsiZGFzaGJvYXJkLWRldGFpbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFFTCx1QkFBdUIsRUFDdkIscUJBQXFCLEVBQ3RCLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNsQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQU90RTtJQTBCRSxrQ0FDVSxLQUFpQixFQUNOLFFBQWtCLEVBQzdCLHVCQUFnRDtRQUgxRCxpQkFPQztRQU5TLFVBQUssR0FBTCxLQUFLLENBQVk7UUFFakIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQXJCMUQsWUFBTyxHQUFHO1lBQ1IsVUFBVSxFQUFFLHVCQUF1QjtZQUNuQyxXQUFXLEVBQUUscUJBQXFCO1NBQ25DLENBQUM7UUFDRixvQkFBZSxHQUFHLEVBQUUsdUJBQXVCLHlCQUFBLEVBQUUscUJBQXFCLHVCQUFBLEVBQUUsQ0FBQztRQUNyRSxXQUFNLEdBQThCLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDOUQsS0FBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUM7WUFDckIsS0FBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7UUFFTSw2QkFBd0IsR0FBRyxFQUFFLENBQUM7UUFDOUIs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QUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFsQixDQUFrQixDQUFDLENBQUM7UUFDcEUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFBLFNBQVM7WUFDdEIsS0FBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFVBQVUsQ0FDL0QsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxLQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FDeEIsQ0FBQztZQUNGLEtBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxHQUFHLEtBQUksQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQ2hFLHFCQUFxQixFQUNyQixTQUFTLEVBQ1QsS0FBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQ3pCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7O2dCQTVFZ0IsVUFBVTs0Q0FDeEIsTUFBTSxTQUFDLFNBQVM7Z0JBQ2dCLHVCQUF1Qjs7SUE1Qk47UUFBbkQsU0FBUyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO3lFQUE2QjtJQURyRSx3QkFBd0I7UUFKcEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyxreU9BQWdEO1NBQ2pELENBQUM7UUE2QkcsbUJBQUEsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO09BNUJULHdCQUF3QixDQXdHcEM7SUFBRCwrQkFBQztDQUFBLEFBeEdELElBd0dDO1NBeEdZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5qZWN0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElDT05fTElTVCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgQnNNb2RhbFJlZiB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHtcbiAgQ29udGV4dERhc2hib2FyZCxcbiAgREFTSEJPQVJEX1RIRU1FX0NMQVNTRVMsXG4gIFdJREdFVF9IRUFERVJfQ0xBU1NFU1xufSBmcm9tICcuL2NvbnRleHQtZGFzaGJvYXJkLm1vZGVsJztcbmltcG9ydCB7IGNsb25lIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IENvbnRleHREYXNoYm9hcmRTZXJ2aWNlIH0gZnJvbSAnLi9jb250ZXh0LWRhc2hib2FyZC5zZXJ2aWNlJztcbmltcG9ydCB7IE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRhc2hib2FyZC1kZXRhaWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vZGFzaGJvYXJkLWRldGFpbC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgRGFzaGJvYXJkRGV0YWlsQ29tcG9uZW50IHtcbiAgQFZpZXdDaGlsZCgnZGFzaGJvYXJkRGV0YWlsRm9ybScsIHsgc3RhdGljOiB0cnVlIH0pIGRhc2hib2FyZERldGFpbEZvcm06IE5nRm9ybTtcbiAgZGFzaGJvYXJkOiBDb250ZXh0RGFzaGJvYXJkO1xuICBjdXJyZW50OiBDb250ZXh0RGFzaGJvYXJkO1xuICBkZXZpY2VUeXBlOiBzdHJpbmc7XG4gIGlzTmFtZWREYXNoYm9hcmQ6IGJvb2xlYW47XG4gIGljb25zOiBzdHJpbmdbXTtcbiAgZmlsdGVyZWRJY29uczogc3RyaW5nW107XG4gIHN0eWxpbmcgPSB7XG4gICAgdGhlbWVDbGFzczogJ2Rhc2hib2FyZC10aGVtZS1saWdodCcsXG4gICAgaGVhZGVyQ2xhc3M6ICdwYW5lbC10aXRsZS1yZWd1bGFyJ1xuICB9O1xuICBwb3NzaWJsZVN0eWxpbmcgPSB7IERBU0hCT0FSRF9USEVNRV9DTEFTU0VTLCBXSURHRVRfSEVBREVSX0NMQVNTRVMgfTtcbiAgcmVzdWx0OiBQcm9taXNlPENvbnRleHREYXNoYm9hcmQ+ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHRoaXMuX3NhdmUgPSByZXNvbHZlO1xuICAgIHRoaXMuX2NhbmNlbCA9IHJlamVjdDtcbiAgfSk7XG5cbiAgcmVhZG9ubHkgREVGQVVMVF9EQVNIQk9BUkRfTUFSR0lOID0gMTI7XG4gIHJlYWRvbmx5IERFRkFVTFRfREFTSEJPQVJEX0lDT04gPSAndGgnO1xuICByZWFkb25seSBERUZBVUxUX0RBU0hCT0FSRF9QUklPUklUWSA9IDEwMDAwO1xuICByZWFkb25seSBERUZBVUxUX0RBU0hCT0FSRF9OQU1FID0gJ0Rhc2hib2FyZCc7XG5cbiAgcHJpdmF0ZSBfc2F2ZTtcbiAgcHJpdmF0ZSBfY2FuY2VsO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbW9kYWw6IEJzTW9kYWxSZWYsXG4gICAgQEluamVjdChJQ09OX0xJU1QpIGljb25MaXN0OiBzdHJpbmdbXSxcbiAgICBwcml2YXRlIGNvbnRleHREYXNoYm9hcmRTZXJ2aWNlOiBDb250ZXh0RGFzaGJvYXJkU2VydmljZVxuICApIHtcbiAgICB0aGlzLmljb25zID0gaWNvbkxpc3Q7XG4gICAgdGhpcy5maWx0ZXJlZEljb25zID0gaWNvbkxpc3Q7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgY29uc3QgZGVmYXVsdERhc2hib2FyZENmZyA9IHtcbiAgICAgIG5hbWU6IHRoaXMuREVGQVVMVF9EQVNIQk9BUkRfTkFNRSxcbiAgICAgIHByaW9yaXR5OiB0aGlzLkRFRkFVTFRfREFTSEJPQVJEX1BSSU9SSVRZLFxuICAgICAgaWNvbjogdGhpcy5ERUZBVUxUX0RBU0hCT0FSRF9JQ09OLFxuICAgICAgZGV2aWNlVHlwZVZhbHVlOiB0aGlzLmRldmljZVR5cGVcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMuZGFzaGJvYXJkKSB7XG4gICAgICB0aGlzLmN1cnJlbnQgPSBjbG9uZSh0aGlzLmRhc2hib2FyZCk7XG4gICAgICB0aGlzLnNldERhc2hib2FyZFN0eWxlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGFzaGJvYXJkID0gZGVmYXVsdERhc2hib2FyZENmZztcbiAgICAgIHRoaXMuZGFzaGJvYXJkRGV0YWlsRm9ybS5mb3JtLm1hcmtBc0RpcnR5KCk7XG4gICAgfVxuICB9XG5cbiAgc2F2ZSgpIHtcbiAgICB0aGlzLmRhc2hib2FyZC5jbGFzc2VzID0geyBbdGhpcy5zdHlsaW5nLnRoZW1lQ2xhc3NdOiB0cnVlIH07XG4gICAgdGhpcy5kYXNoYm9hcmQud2lkZ2V0Q2xhc3NlcyA9IHsgW3RoaXMuc3R5bGluZy5oZWFkZXJDbGFzc106IHRydWUgfTtcbiAgICB0aGlzLl9zYXZlKHRoaXMuZGFzaGJvYXJkKTtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIHRoaXMuX2NhbmNlbCgpO1xuICAgIHRoaXMubW9kYWwuaGlkZSgpO1xuICB9XG5cbiAgZ2V0RGFzaGJvYXJkUHJldmlld1N0eWxlKCkge1xuICAgIGNvbnN0IGNzc0NsYXNzZXMgPSB7fTtcbiAgICBjc3NDbGFzc2VzW3RoaXMuc3R5bGluZy5oZWFkZXJDbGFzc10gPSB0cnVlO1xuICAgIGNzc0NsYXNzZXNbdGhpcy5zdHlsaW5nLnRoZW1lQ2xhc3NdID0gdHJ1ZTtcbiAgICByZXR1cm4gY3NzQ2xhc3NlcztcbiAgfVxuXG4gIHNlbGVjdEljb24oaWNvbikge1xuICAgIHRoaXMuZGFzaGJvYXJkLmljb24gPSBpY29uO1xuICAgIHRoaXMuZGFzaGJvYXJkRGV0YWlsRm9ybS5mb3JtLm1hcmtBc0RpcnR5KCk7XG4gIH1cblxuICB1cGRhdGVGaWx0ZXJlZCh0ZXJtOiBzdHJpbmcpIHtcbiAgICBpZiAodGVybSkge1xuICAgICAgY29uc3Qgc2VhcmNoID0gbmV3IFJlZ0V4cCh0ZXJtLCAnaScpO1xuICAgICAgdGhpcy5maWx0ZXJlZEljb25zID0gdGhpcy5pY29ucy5maWx0ZXIodmFsID0+IHNlYXJjaC50ZXN0KHZhbCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpbHRlcmVkSWNvbnMgPSB0aGlzLmljb25zO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0RGFzaGJvYXJkU3R5bGUoKSB7XG4gICAgY29uc3QgYWxsQ2xhc3NlcyA9IHtcbiAgICAgIC4uLnRoaXMuZGFzaGJvYXJkLmNsYXNzZXMsXG4gICAgICAuLi50aGlzLmRhc2hib2FyZC53aWRnZXRDbGFzc2VzXG4gICAgfTtcblxuICAgIGNvbnN0IHN0eWxlcyA9IE9iamVjdC5rZXlzKGFsbENsYXNzZXMpLm1hcChjID0+IGMuc3BsaXQoJy0nKS5wb3AoKSk7XG4gICAgc3R5bGVzLmZvckVhY2goc3R5bGVOYW1lID0+IHtcbiAgICAgIHRoaXMuc3R5bGluZy50aGVtZUNsYXNzID0gdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS5nZXRTdHlsaW5nKFxuICAgICAgICBEQVNIQk9BUkRfVEhFTUVfQ0xBU1NFUyxcbiAgICAgICAgc3R5bGVOYW1lLFxuICAgICAgICB0aGlzLnN0eWxpbmcudGhlbWVDbGFzc1xuICAgICAgKTtcbiAgICAgIHRoaXMuc3R5bGluZy5oZWFkZXJDbGFzcyA9IHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuZ2V0U3R5bGluZyhcbiAgICAgICAgV0lER0VUX0hFQURFUl9DTEFTU0VTLFxuICAgICAgICBzdHlsZU5hbWUsXG4gICAgICAgIHRoaXMuc3R5bGluZy5oZWFkZXJDbGFzc1xuICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuIl19