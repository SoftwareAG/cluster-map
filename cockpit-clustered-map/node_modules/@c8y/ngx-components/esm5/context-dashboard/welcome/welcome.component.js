import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { gettext, DocsService, DocLink, NavigatorService } from '@c8y/ngx-components';
import { Router } from '@angular/router';
import { TenantService, ApplicationService, IApplication } from '@c8y/client';
var WelcomeToCockpit = /** @class */ (function () {
    function WelcomeToCockpit(tenantService, docs, router, navigator, applicationService) {
        this.tenantService = tenantService;
        this.docs = docs;
        this.router = router;
        this.navigator = navigator;
        this.applicationService = applicationService;
        this.quickLinks = [];
        this.REPORT_NODE = 'Reports';
        this.CONFIGURATION_NODE = 'Configuration';
        this.TRIAL = 'TRIAL';
    }
    WelcomeToCockpit.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = this;
                        return [4 /*yield*/, this.tenantService.currentTenantType()];
                    case 1:
                        _a.tenantType = _b.sent();
                        this.setMessage();
                        this.navSubscription = this.navigator.items$.subscribe(function (nodes) {
                            _this.navNodes = nodes;
                        });
                        this.docsSubscription = this.docs.items$.subscribe(function (links) {
                            _this.links = links;
                        });
                        // <---TRIAL & REGULAR TENANT --->
                        this.createConnectSmartphoneQuickLink();
                        return [4 /*yield*/, this.createQuicklinkRegisterDevice()];
                    case 2:
                        _b.sent();
                        // <--- TRIAL TENANT --->
                        if (this.tenantType === this.TRIAL) {
                            this.createQuicklinkUserGuide();
                            return [2 /*return*/];
                        }
                        // <--- REGULAR TENANT --->
                        this.createQuicklinkAddGroup();
                        this.createQuickLinkReports();
                        this.createQuicklinkDataPointLibrary();
                        this.createQuicklinkSmartRules();
                        return [2 /*return*/];
                }
            });
        });
    };
    WelcomeToCockpit.prototype.ngOnDestroy = function () {
        if (this.docsSubscription && !this.docsSubscription.closed) {
            this.docsSubscription.unsubscribe();
        }
        if (this.navSubscription && !this.navSubscription.closed) {
            this.navSubscription.unsubscribe();
        }
    };
    WelcomeToCockpit.prototype.setMessage = function () {
        if (this.tenantType === this.TRIAL) {
            this.welcomeMessage = gettext("\n        The Cockpit application allows you to build IoT applications in minutes.\n        To get started, connect any device to the platform.\n        If you do not have an IoT device to hand, you can start by connecting your smartphone.\n        Click below to be guided through the process.\n      ");
        }
        else {
            this.welcomeMessage = gettext("\n        The Cockpit application provides you with options to manage\n        and monitor Internet of Things assets and data from business perspective.\n      ");
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkAddGroup = function () {
        // comes from angularJS factory c8yQuickLinks
        var addGroup = this.links.find(function (link) { return link.label === 'Add group'; });
        if (addGroup) {
            this.quickLinks.push(addGroup);
        }
    };
    WelcomeToCockpit.prototype.createConnectSmartphoneQuickLink = function () {
        // Provider in SensorPhoneModule defines the
        // 'Connect smartphone' quicklink.
        var connectSmartphone = this.links.find(function (link) { return link.label === 'Connect smartphone'; });
        if (connectSmartphone) {
            this.quickLinks.push(connectSmartphone);
        }
    };
    WelcomeToCockpit.prototype.createQuickLinkReports = function () {
        var _this = this;
        var reports = {
            icon: 'c8y-reports',
            label: gettext('Reports'),
            url: '/export'
        };
        var reportsNode = this.findNavigatorNode(this.REPORT_NODE);
        if (reportsNode && reportsNode.show) {
            reports.click = function () {
                reportsNode.open = true;
                _this.router.navigateByUrl(reports.url);
            };
            this.quickLinks.push(reports);
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkDataPointLibrary = function () {
        var _this = this;
        var dataPointLib = {
            icon: 'c8y-data-points',
            label: gettext('Data point library'),
            url: '/datapointlibrary'
        };
        var configurationNode = this.findNavigatorNode(this.CONFIGURATION_NODE);
        if (configurationNode && configurationNode.show) {
            dataPointLib.click = function () {
                configurationNode.open = true;
                _this.router.navigateByUrl(dataPointLib.url);
            };
            this.quickLinks.push(dataPointLib);
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkSmartRules = function () {
        var _this = this;
        var smartRules = {
            icon: 'c8y-smart-rules',
            label: gettext('Smart rules'),
            url: '/rules'
        };
        var configurationNode = this.findNavigatorNode(this.CONFIGURATION_NODE);
        if (configurationNode && configurationNode.show) {
            smartRules.click = function () {
                configurationNode.open = true;
                _this.router.navigateByUrl(smartRules.url);
            };
            this.quickLinks.push(smartRules);
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkRegisterDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data, deviceManagement, deviceMgmtUrl_1, registerDevice;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.applicationService.listByUser()];
                    case 1:
                        data = (_a.sent()).data;
                        if (data) {
                            deviceManagement = data.find(function (app) { return app.contextPath === 'devicemanagement'; });
                            if (deviceManagement) {
                                deviceMgmtUrl_1 = this.applicationService.getHref(deviceManagement);
                                registerDevice = {
                                    icon: 'c8y-device-connect',
                                    label: gettext('Register device'),
                                    click: function () { return window.open(deviceMgmtUrl_1 + "/#/deviceregistration", '_self'); }
                                };
                                this.quickLinks.push(registerDevice);
                            }
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    WelcomeToCockpit.prototype.createQuicklinkUserGuide = function () {
        var _this = this;
        var userGuide = {
            icon: 'c8y-user',
            label: gettext('User guide'),
            url: '/users-guide/getting-started',
            click: function () {
                var userGuideURL = _this.docs.getUserGuideLink(userGuide.url);
                window.open(userGuideURL);
            }
        };
        this.quickLinks.push(userGuide);
    };
    WelcomeToCockpit.prototype.findNavigatorNode = function (nodeRealName) {
        if (this.navNodes && this.navNodes.length > 0) {
            return this.navNodes.find(function (node) { return node.realName === nodeRealName; });
        }
        return undefined;
    };
    WelcomeToCockpit.ctorParameters = function () { return [
        { type: TenantService },
        { type: DocsService },
        { type: Router },
        { type: NavigatorService },
        { type: ApplicationService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], WelcomeToCockpit.prototype, "config", void 0);
    WelcomeToCockpit = tslib_1.__decorate([
        Component({
            selector: 'c8y-welcome-to-cockpit',
            template: "<div class=\"welcome-widget welcome-cockpit\">\r\n  <div class=\"flex-row\">\r\n    <div class=\"col-xs-12 col-md-5 flex-item-v-stretch p-24\">\r\n      <h2 class=\"text-light\">{{ 'Welcome to Cockpit' | translate }}</h2>\r\n      <p class=\"text-16 text-light p-t-16 p-b-24\">{{ welcomeMessage | translate }}</p>\r\n      <div class=\"card-group interact-grid tight-grid\">\r\n        <div *ngFor=\"let link of quickLinks\" class=\"col-sm-4 col-xs-6\">\r\n          <c8y-quick-link\r\n            (click)=\"link.click ? link.click() : false\"\r\n            [icon]=\"link.icon\"\r\n            [label]=\"link.label\"\r\n            class=\"card\"\r\n          >\r\n          </c8y-quick-link>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <!-- <div class=\"col-sm-6 welcome-illustration flex-item-v-stretch\"></div> -->\r\n  </div>\r\n</div>\r\n"
        })
    ], WelcomeToCockpit);
    return WelcomeToCockpit;
}());
export { WelcomeToCockpit };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VsY29tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2NvbnRleHQtZGFzaGJvYXJkLyIsInNvdXJjZXMiOlsid2VsY29tZS93ZWxjb21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUV6QyxPQUFPLEVBQUUsYUFBYSxFQUFFLGtCQUFrQixFQUFFLFlBQVksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQU05RTtJQWNFLDBCQUNVLGFBQTRCLEVBQzVCLElBQWlCLEVBQ2pCLE1BQWMsRUFDZCxTQUEyQixFQUMzQixrQkFBc0M7UUFKdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUNqQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQWhCaEQsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUVDLGdCQUFXLEdBQVcsU0FBUyxDQUFDO1FBQ2hDLHVCQUFrQixHQUFXLGVBQWUsQ0FBQztRQUM3QyxVQUFLLEdBQVcsT0FBTyxDQUFDO0lBYXRDLENBQUM7SUFFRSxtQ0FBUSxHQUFkOzs7Ozs7O3dCQUNFLEtBQUEsSUFBSSxDQUFBO3dCQUFjLHFCQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLEVBQUUsRUFBQTs7d0JBQTlELEdBQUssVUFBVSxHQUFHLFNBQTRDLENBQUM7d0JBQy9ELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzt3QkFDbEIsSUFBSSxDQUFD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QXFCO1lBQ2xDLElBQUksRUFBRSxVQUFVO1lBQ2hCLEtBQUssRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDO1lBQzVCLEdBQUcsRUFBRSw4QkFBOEI7WUFDbkMsS0FBSyxFQUFFO2dCQUNMLElBQU0sWUFBWSxHQUFHLEtBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBVyxDQUFDO2dCQUN6RSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzVCLENBQUM7U0FDRixDQUFDO1FBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVPLDRDQUFpQixHQUF6QixVQUEwQixZQUFvQjtRQUM1QyxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUFTLElBQUssT0FBQSxJQUFJLENBQUMsUUFBUSxLQUFLLFlBQVksRUFBOUIsQ0FBOEIsQ0FBQyxDQUFDO1NBQzFFO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7Z0JBbkt3QixhQUFhO2dCQUN0QixXQUFXO2dCQUNULE1BQU07Z0JBQ0gsZ0JBQWdCO2dCQUNQLGtCQUFrQjs7SUFsQnZDO1FBQVIsS0FBSyxFQUFFO29EQUFRO0lBREwsZ0JBQWdCO1FBSjVCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx3QkFBd0I7WUFDbEMsbTJCQUF1QztTQUN4QyxDQUFDO09BQ1csZ0JBQWdCLENBbUw1QjtJQUFELHVCQUFDO0NBQUEsQUFuTEQsSUFtTEM7U0FuTFksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGdldHRleHQsIERvY3NTZXJ2aWNlLCBEb2NMaW5rLCBOYXZpZ2F0b3JTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUZW5hbnRTZXJ2aWNlLCBBcHBsaWNhdGlvblNlcnZpY2UsIElBcHBsaWNhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXdlbGNvbWUtdG8tY29ja3BpdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi93ZWxjb21lLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBXZWxjb21lVG9Db2NrcGl0IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSBjb25maWc7XG4gIHdlbGNvbWVNZXNzYWdlO1xuICBxdWlja0xpbmtzID0gW107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBSRVBPUlRfTk9ERTogc3RyaW5nID0gJ1JlcG9ydHMnO1xuICBwcml2YXRlIHJlYWRvbmx5IENPTkZJR1VSQVRJT05fTk9ERTogc3RyaW5nID0gJ0NvbmZpZ3VyYXRpb24nO1xuICBwcml2YXRlIHJlYWRvbmx5IFRSSUFMOiBzdHJpbmcgPSAnVFJJQUwnO1xuICBwcml2YXRlIHRlbmFudFR5cGU6IHN0cmluZztcbiAgcHJpdmF0ZSBuYXZOb2RlczogYW55W107XG4gIHByaXZhdGUgbGlua3M6IERvY0xpbmtbXTtcbiAgcHJpdmF0ZSBkb2NzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgbmF2U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0ZW5hbnRTZXJ2aWNlOiBUZW5hbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgZG9jczogRG9jc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIG5hdmlnYXRvcjogTmF2aWdhdG9yU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnRlbmFudFR5cGUgPSBhd2FpdCB0aGlzLnRlbmFudFNlcnZpY2UuY3VycmVudFRlbmFudFR5cGUoKTtcbiAgICB0aGlzLnNldE1lc3NhZ2UoKTtcbiAgICB0aGlzLm5hdlN1YnNjcmlwdGlvbiA9IHRoaXMubmF2aWdhdG9yLml0ZW1zJC5zdWJzY3JpYmUobm9kZXMgPT4ge1xuICAgICAgdGhpcy5uYXZOb2RlcyA9IG5vZGVzO1xuICAgIH0pO1xuICAgIHRoaXMuZG9jc1N1YnNjcmlwdGlvbiA9IHRoaXMuZG9jcy5pdGVtcyQuc3Vic2NyaWJlKGxpbmtzID0+IHtcbiAgICAgIHRoaXMubGlua3MgPSBsaW5rcztcbiAgICB9KTtcblxuICAgIC8vIDwtLS1UUklBTCAmIFJFR1VMQVIgVEVOQU5UIC0tLT5cbiAgICB0aGlzLmNyZWF0ZUNvbm5lY3RTbWFydHBob25lUXVpY2tMaW5rKCk7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVRdWlja2xpbmtSZWdpc3RlckRldmljZSgpO1xuXG4gICAgLy8gPC0tLSBUUklBTCBURU5BTlQgLS0tPlxuICAgIGlmICh0aGlzLnRlbmFudFR5cGUgPT09IHRoaXMuVFJJQUwpIHtcbiAgICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rVXNlckd1aWRlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gPC0tLSBSRUdVTEFSIFRFTkFOVCAtLS0+XG4gICAgdGhpcy5jcmVhdGVRdWlja2xpbmtBZGRHcm91cCgpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tMaW5rUmVwb3J0cygpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rRGF0YVBvaW50TGlicmFyeSgpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rU21hcnRSdWxlcygpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuZG9jc1N1YnNjcmlwdGlvbiAmJiAhdGhpcy5kb2NzU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgdGhpcy5kb2NzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubmF2U3Vic2NyaXB0aW9uICYmICF0aGlzLm5hdlN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMubmF2U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRNZXNzYWdlKCkge1xuICAgIGlmICh0aGlzLnRlbmFudFR5cGUgPT09IHRoaXMuVFJJQUwpIHtcbiAgICAgIHRoaXMud2VsY29tZU1lc3NhZ2UgPSBnZXR0ZXh0KGBcbiAgICAgICAgVGhlIENvY2twaXQgYXBwbGljYXRpb24gYWxsb3dzIHlvdSB0byBidWlsZCBJb1QgYXBwbGljYXRpb25zIGluIG1pbnV0ZXMuXG4gICAgICAgIFRvIGdldCBzdGFydGVkLCBjb25uZWN0IGFueSBkZXZpY2UgdG8gdGhlIHBsYXRmb3JtLlxuICAgICAgICBJZiB5b3UgZG8gbm90IGhhdmUgYW4gSW9UIGRldmljZSB0byBoYW5kLCB5b3UgY2FuIHN0YXJ0IGJ5IGNvbm5lY3RpbmcgeW91ciBzbWFydHBob25lLlxuICAgICAgICBDbGljayBiZWxvdyB0byBiZSBndWlkZWQgdGhyb3VnaCB0aGUgcHJvY2Vzcy5cbiAgICAgIGApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndlbGNvbWVNZXNzYWdlID0gZ2V0dGV4dChgXG4gICAgICAgIFRoZSBDb2NrcGl0IGFwcGxpY2F0aW9uIHByb3ZpZGVzIHlvdSB3aXRoIG9wdGlvbnMgdG8gbWFuYWdlXG4gICAgICAgIGFuZCBtb25pdG9yIEludGVybmV0IG9mIFRoaW5ncyBhc3NldHMgYW5kIGRhdGEgZnJvbSBidXNpbmVzcyBwZXJzcGVjdGl2ZS5cbiAgICAgIGApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUXVpY2tsaW5rQWRkR3JvdXAoKSB7XG4gICAgLy8gY29tZXMgZnJvbSBhbmd1bGFySlMgZmFjdG9yeSBjOHlRdWlja0xpbmtzXG4gICAgY29uc3QgYWRkR3JvdXA6IFBhcnRpYWw8RG9jTGluaz4gPSB0aGlzLmxpbmtzLmZpbmQobGluayA9PiBsaW5rLmxhYmVsID09PSAnQWRkIGdyb3VwJyk7XG4gICAgaWYgKGFkZEdyb3VwKSB7XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChhZGRHcm91cCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDb25uZWN0U21hcnRwaG9uZVF1aWNrTGluaygpIHtcbiAgICAvLyBQcm92aWRlciBpbiBTZW5zb3JQaG9uZU1vZHVsZSBkZWZpbmVzIHRoZVxuICAgIC8vICdDb25uZWN0IHNtYXJ0cGhvbmUnIHF1aWNrbGluay5cbiAgICBjb25zdCBjb25uZWN0U21hcnRwaG9uZSA9IHRoaXMubGlua3MuZmluZChsaW5rID0+IGxpbmsubGFiZWwgPT09ICdDb25uZWN0IHNtYXJ0cGhvbmUnKTtcbiAgICBpZiAoY29ubmVjdFNtYXJ0cGhvbmUpIHtcbiAgICAgIHRoaXMucXVpY2tMaW5rcy5wdXNoKGNvbm5lY3RTbWFydHBob25lKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrTGlua1JlcG9ydHMoKSB7XG4gICAgY29uc3QgcmVwb3J0czogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICdjOHktcmVwb3J0cycsXG4gICAgICBsYWJlbDogZ2V0dGV4dCgnUmVwb3J0cycpLFxuICAgICAgdXJsOiAnL2V4cG9ydCdcbiAgICB9O1xuXG4gICAgY29uc3QgcmVwb3J0c05vZGUgPSB0aGlzLmZpbmROYXZpZ2F0b3JOb2RlKHRoaXMuUkVQT1JUX05PREUpO1xuICAgIGlmIChyZXBvcnRzTm9kZSAmJiByZXBvcnRzTm9kZS5zaG93KSB7XG4gICAgICByZXBvcnRzLmNsaWNrID0gKCkgPT4ge1xuICAgICAgICByZXBvcnRzTm9kZS5vcGVuID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChyZXBvcnRzLnVybCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2gocmVwb3J0cyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVRdWlja2xpbmtEYXRhUG9pbnRMaWJyYXJ5KCkge1xuICAgIGNvbnN0IGRhdGFQb2ludExpYjogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICdjOHktZGF0YS1wb2ludHMnLFxuICAgICAgbGFiZWw6IGdldHRleHQoJ0RhdGEgcG9pbnQgbGlicmFyeScpLFxuICAgICAgdXJsOiAnL2RhdGFwb2ludGxpYnJhcnknXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbmZpZ3VyYXRpb25Ob2RlID0gdGhpcy5maW5kTmF2aWdhdG9yTm9kZSh0aGlzLkNPTkZJR1VSQVRJT05fTk9ERSk7XG4gICAgaWYgKGNvbmZpZ3VyYXRpb25Ob2RlICYmIGNvbmZpZ3VyYXRpb25Ob2RlLnNob3cpIHtcbiAgICAgIGRhdGFQb2ludExpYi5jbGljayA9ICgpID0+IHtcbiAgICAgICAgY29uZmlndXJhdGlvbk5vZGUub3BlbiA9IHRydWU7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwoZGF0YVBvaW50TGliLnVybCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2goZGF0YVBvaW50TGliKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrbGlua1NtYXJ0UnVsZXMoKSB7XG4gICAgY29uc3Qgc21hcnRSdWxlczogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICdjOHktc21hcnQtcnVsZXMnLFxuICAgICAgbGFiZWw6IGdldHRleHQoJ1NtYXJ0IHJ1bGVzJyksXG4gICAgICB1cmw6ICcvcnVsZXMnXG4gICAgfTtcbiAgICBjb25zdCBjb25maWd1cmF0aW9uTm9kZSA9IHRoaXMuZmluZE5hdmlnYXRvck5vZGUodGhpcy5DT05GSUdVUkFUSU9OX05PREUpO1xuICAgIGlmIChjb25maWd1cmF0aW9uTm9kZSAmJiBjb25maWd1cmF0aW9uTm9kZS5zaG93KSB7XG4gICAgICBzbWFydFJ1bGVzLmNsaWNrID0gKCkgPT4ge1xuICAgICAgICBjb25maWd1cmF0aW9uTm9kZS5vcGVuID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChzbWFydFJ1bGVzLnVybCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2goc21hcnRSdWxlcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVRdWlja2xpbmtSZWdpc3RlckRldmljZSgpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3RCeVVzZXIoKTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgY29uc3QgZGV2aWNlTWFuYWdlbWVudDogSUFwcGxpY2F0aW9uID0gZGF0YS5maW5kKFxuICAgICAgICBhcHAgPT4gYXBwLmNvbnRleHRQYXRoID09PSAnZGV2aWNlbWFuYWdlbWVudCdcbiAgICAgICk7XG4gICAgICBpZiAoZGV2aWNlTWFuYWdlbWVudCkge1xuICAgICAgICBjb25zdCBkZXZpY2VNZ210VXJsID0gdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZ2V0SHJlZihkZXZpY2VNYW5hZ2VtZW50KTtcbiAgICAgICAgY29uc3QgcmVnaXN0ZXJEZXZpY2U6IFBhcnRpYWw8RG9jTGluaz4gPSB7XG4gICAgICAgICAgaWNvbjogJ2M4eS1kZXZpY2UtY29ubmVjdCcsXG4gICAgICAgICAgbGFiZWw6IGdldHRleHQoJ1JlZ2lzdGVyIGRldmljZScpLFxuICAgICAgICAgIGNsaWNrOiAoKSA9PiB3aW5kb3cub3BlbihgJHtkZXZpY2VNZ210VXJsfS8jL2RldmljZXJlZ2lzdHJhdGlvbmAsICdfc2VsZicpXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucXVpY2tMaW5rcy5wdXNoKHJlZ2lzdGVyRGV2aWNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrbGlua1VzZXJHdWlkZSgpIHtcbiAgICBjb25zdCB1c2VyR3VpZGU6IFBhcnRpYWw8RG9jTGluaz4gPSB7XG4gICAgICBpY29uOiAnYzh5LXVzZXInLFxuICAgICAgbGFiZWw6IGdldHRleHQoJ1VzZXIgZ3VpZGUnKSxcbiAgICAgIHVybDogJy91c2Vycy1ndWlkZS9nZXR0aW5nLXN0YXJ0ZWQnLFxuICAgICAgY2xpY2s6ICgpID0+IHtcbiAgICAgICAgY29uc3QgdXNlckd1aWRlVVJMID0gdGhpcy5kb2NzLmdldFVzZXJHdWlkZUxpbmsodXNlckd1aWRlLnVybCkgYXMgc3RyaW5nO1xuICAgICAgICB3aW5kb3cub3Blbih1c2VyR3VpZGVVUkwpO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5xdWlja0xpbmtzLnB1c2godXNlckd1aWRlKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZE5hdmlnYXRvck5vZGUobm9kZVJlYWxOYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5uYXZOb2RlcyAmJiB0aGlzLm5hdk5vZGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB0aGlzLm5hdk5vZGVzLmZpbmQoKG5vZGU6IGFueSkgPT4gbm9kZS5yZWFsTmFtZSA9PT0gbm9kZVJlYWxOYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19