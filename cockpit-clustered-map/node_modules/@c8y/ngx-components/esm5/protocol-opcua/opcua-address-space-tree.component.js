import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { AddressSpaceNode, AddressSpaceService, NodeNavigationData } from './address-space.service';
import { OpcuaService } from './opcuaService';
import { AlertService } from '@c8y/ngx-components';
import { DynamicDataSource } from './dynamic-data-source';
import { NestedTreeControl } from '@angular/cdk/tree';
import { clone } from 'lodash';
var OpcuaAddressSpaceTreeComponent = /** @class */ (function () {
    function OpcuaAddressSpaceTreeComponent(addressSpaceService, opcuaService, alertService) {
        var _this = this;
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.focusEmitter = new EventEmitter();
        this.selectedNode = new EventEmitter();
        this.dataSource = null;
        this.loading = false;
        this.getChildren = function (node) { return (node.expanded ? node.children : []); };
        this.hasChild = function (_, _nodeData) {
            return _this.addressSpaceService.childrenAvailable(_nodeData.references);
        };
    }
    Object.defineProperty(OpcuaAddressSpaceTreeComponent.prototype, "moId", {
        set: function (id) {
            this._moId = id || undefined;
        },
        enumerable: true,
        configurable: true
    });
    OpcuaAddressSpaceTreeComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.nodeNavDataSubscription = this.addressSpaceService
            .getNodeNavData$()
            .subscribe(function (nodeNavData) { return _this.openNode(nodeNavData); });
        this.subscriptionRef = this.focusEmitter.subscribe(function (node) {
            _this.focused = _this.isFocusedNode(node) ? undefined : node;
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.ngOnDestroy = function () {
        // clean up the address-space-tree
        this.addressSpaceService.resetTreeToRootNode();
        if (this.nodeNavDataSubscription && !this.nodeNavDataSubscription.closed) {
            this.nodeNavDataSubscription.unsubscribe();
        }
        if (this.subscriptionRef && !this.subscriptionRef.closed) {
            this.subscriptionRef.unsubscribe();
        }
    };
    OpcuaAddressSpaceTreeComponent.prototype.openNode = function (nodeNavData) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var node, selectedAncestorIds, nodeId, clonedAncestors, n;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        node = nodeNavData.node, selectedAncestorIds = nodeNavData.selectedAncestorIds;
                        // We just set the nodeId when the selectedAncestorIds variable an empty array.
                        // If selectedAncestorIds contain any id we assume that the tree should be travsersed beginning
                        // from the root node.
                        if (node && node.nodeId && selectedAncestorIds && selectedAncestorIds.length === 0) {
                            nodeId = node.nodeId;
                        }
                        // Always recreate the tree when routing to a specific nested node,
                        // because previous modifications to the tree-structure could cause errors
                        // while traversing with 'old' tree-data
                        // -----------------
                        // setupTree is able to handle nodeId = undefined
                        return [4 /*yield*/, this.setupTree(nodeId)];
                    case 1:
                        // Always recreate the tree when routing to a specific nested node,
                        // because previous modifications to the tree-structure could cause errors
                        // while traversing with 'old' tree-data
                        // -----------------
                        // setupTree is able to handle nodeId = undefined
                        _a.sent();
                        if (!selectedAncestorIds || selectedAncestorIds.length === 0) {
                            return [2 /*return*/];
                        }
                        if (!(nodeNavData && this.dataSource)) return [3 /*break*/, 3];
                        clonedAncestors = clone(selectedAncestorIds);
                        clonedAncestors.shift();
                        return [4 /*yield*/, this.dataSource.toggleNode(this.dataSource.data[0], true)];
                    case 2:
                        n = _a.sent();
                        this.setChildNodes(n.children, clonedAncestors);
                        this.toggleFocusedNode(node);
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.setChildNodes = function (nodes, ids) {
        var _this = this;
        if (nodes) {
            ids.forEach(function (id) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                var match, idx, toggledNode;
                return tslib_1.__generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            match = nodes.find(function (n) { return n.nodeId === id; });
                            if (!(match && ids.length > 0)) return [3 /*break*/, 2];
                            idx = ids.findIndex(function (value) { return value === id; });
                            if (idx >= 0) {
                                ids.splice(idx, 1);
                            }
                            return [4 /*yield*/, this.dataSource.toggleNode(match, true)];
                        case 1:
                            toggledNode = _a.sent();
                            this.setChildNodes(toggledNode.children, ids);
                            _a.label = 2;
                        case 2: return [2 /*return*/];
                    }
                });
            }); });
        }
    };
    OpcuaAddressSpaceTreeComponent.prototype.setupTree = function (nodeId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, data, _a, rootNode;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.loading = true;
                        if (!this._moId || this._moId.length === 0) {
                            this._moId = this.opcuaService.getMoId();
                        }
                        return [4 /*yield*/, this.addressSpaceService.getNode(this._moId, nodeId)];
                    case 1:
                        res = _b.sent();
                        if (!res) return [3 /*break*/, 8];
                        if (!(res.status !== 200)) return [3 /*break*/, 5];
                        if (!res.json) return [3 /*break*/, 3];
                        return [4 /*yield*/, res.json()];
                    case 2:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        _a = undefined;
                        _b.label = 4;
                    case 4:
                        data = _a;
                        this.alertService.addServerFailure({ data: data, res: res });
                        this.dataSource = undefined;
                        return [3 /*break*/, 7];
                    case 5: return [4 /*yield*/, res.json()];
                    case 6:
                        rootNode = (_b.sent());
                        this.nestedTreeControl = new NestedTreeControl(this.getChildren);
                        this.dataSource = new DynamicDataSource(this.nestedTreeControl, this.addressSpaceService, this._moId);
                        this.dataSource.data = [rootNode];
                        _b.label = 7;
                    case 7:
                        this.loading = false;
                        return [3 /*break*/, 9];
                    case 8:
                        this.loading = false;
                        _b.label = 9;
                    case 9: return [2 /*return*/];
                }
            });
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.getMoId = function () {
        if (!this._moId || this._moId.length === 0) {
            return this.opcuaService.getMoId();
        }
        return this._moId;
    };
    OpcuaAddressSpaceTreeComponent.prototype.getIcon = function (nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    };
    OpcuaAddressSpaceTreeComponent.prototype.toggleFocusedNode = function (node) {
        var relativePath = [];
        this.getRelativePath(node, relativePath);
        node.relativePath = relativePath;
        this.selectedNode.emit(node);
        this.focused = this.isFocusedNode(node) ? undefined : node;
    };
    OpcuaAddressSpaceTreeComponent.prototype.isFocusedNode = function (node) {
        if (this.focused) {
            return node.nodeId === this.focused.nodeId;
        }
        return false;
    };
    OpcuaAddressSpaceTreeComponent.prototype.getRelativePath = function (node, relativePath) {
        if (node.parentNode) {
            relativePath.unshift(node.browseName);
            this.getRelativePath(node.parentNode, relativePath);
        }
    };
    OpcuaAddressSpaceTreeComponent.ctorParameters = function () { return [
        { type: AddressSpaceService },
        { type: OpcuaService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "moId", null);
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "node", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "focusEmitter", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaAddressSpaceTreeComponent.prototype, "selectedNode", void 0);
    OpcuaAddressSpaceTreeComponent = tslib_1.__decorate([
        Component({
            selector: 'opcua-address-space-tree',
            template: "<div class=\"card-block\" *ngIf=\"dataSource && !loading\">\n  <cdk-tree [dataSource]=\"dataSource\" [treeControl]=\"nestedTreeControl\">\n    <!-- This is the tree node template for leaf nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node\" (click)=\"toggleFocusedNode(node)\"\n    [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\">\n      <span>\n        <i class=\"right-m-xs\" \n        [c8yIcon]=\"getIcon(node.nodeClassName)\" \n        [ngClass]=\"{'strong':isFocusedNode(node)}\" \n        style=\"cursor: pointer\"></i>\n        {{node.displayName}}\n      </span>\n    </cdk-nested-tree-node>\n    <!-- This is the tree node template for expandable nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node; when: hasChild\">\n      <div class=\"flex-row\">\n        <button cdkTreeNodeToggle class=\"btn-clean text-primary right-m-xs\" [disabled]=\"node.currentlyLoadingChildren\">\n          <i class=\"fa\" [ngClass]=\"{'fa-plus-square': !node.expanded, 'fa-minus-square': node.expanded}\"></i>\n        </button>\n        <i class=\"right-m-xs\" [c8yIcon]=\"getIcon(node.nodeClassName)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"></i>\n        <span (click)=\"toggleFocusedNode(node)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"> {{node.displayName}} </span>\n        <span class=\"left-m-xs\" [style.visibility]=\"node.currentlyLoadingChildren ? 'visible': 'hidden'\">\n          <i class=\"fa fa-circle-o-notch fa-spin\"></i>\n        </span>\n      </div>\n      <ng-container cdkTreeNodeOutlet></ng-container>\n    </cdk-nested-tree-node>\n  </cdk-tree>\n</div>\n<div style=\"padding: 8px;\" *ngIf=\"loading\">\n  <div class=\"spinner\" style=\"position: relative\">\n    <div class=\"rect1\"></div>\n    <div class=\"rect2\"></div>\n    <div class=\"rect3\"></div>\n    <div class=\"rect4\"></div>\n    <div class=\"rect5\"></div>\n  </div>\n</div>\n<div class=\"alert alert-info m-t-16\" *ngIf=\"!dataSource && !loading\" translate>\n  No source data available to fetch address space.\n</div>"
        })
    ], OpcuaAddressSpaceTreeComponent);
    return OpcuaAddressSpaceTreeComponent;
}());
export { OpcuaAddressSpaceTreeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcHJvdG9jb2wtb3BjdWEvIiwic291cmNlcyI6WyJvcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQVUsWUFBWSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBYSxNQUFNLFFBQVEsQ0FBQztBQVExQztJQWdCRSx3Q0FDVSxtQkFBd0MsRUFDeEMsWUFBMEIsRUFDMUIsWUFBMEI7UUFIcEMsaUJBSUk7UUFITSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBWjNCLGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO1FBQ25GLGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO1FBRTlGLGVBQVUsR0FBc0IsSUFBSSxDQUFDO1FBRXJDLFlBQU8sR0FBWSxLQUFLLENBQUM7UUFVekIsZ0JBQVcsR0FBRyxVQUFDLElBQXNCLElBQUssT0FBQSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElB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QUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3JEO0lBQ0gsQ0FBQzs7Z0JBOUk4QixtQkFBbUI7Z0JBQzFCLFlBQVk7Z0JBQ1osWUFBWTs7SUFqQnBDO1FBREMsS0FBSyxFQUFFOzhEQUdQO0lBRVE7UUFBUixLQUFLLEVBQUU7Z0VBQU07SUFDTDtRQUFSLEtBQUssRUFBRTt3RUFBcUY7SUFDbkY7UUFBVCxNQUFNLEVBQUU7d0VBQXFGO0lBUm5GLDhCQUE4QjtRQUoxQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsMEJBQTBCO1lBQ3BDLHdrRUFBd0Q7U0FDekQsQ0FBQztPQUNXLDhCQUE4QixDQWdLMUM7SUFBRCxxQ0FBQztDQUFBLEFBaEtELElBZ0tDO1NBaEtZLDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgT25Jbml0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWRkcmVzc1NwYWNlTm9kZSwgQWRkcmVzc1NwYWNlU2VydmljZSwgTm9kZU5hdmlnYXRpb25EYXRhIH0gZnJvbSAnLi9hZGRyZXNzLXNwYWNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3BjdWFTZXJ2aWNlIH0gZnJvbSAnLi9vcGN1YVNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBEeW5hbWljRGF0YVNvdXJjZSB9IGZyb20gJy4vZHluYW1pYy1kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBOZXN0ZWRUcmVlQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90cmVlJztcbmltcG9ydCB7IGNsb25lLCBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyByZWxhdGl2ZSB9IGZyb20gJ3BhdGgnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUnLFxuICB0ZW1wbGF0ZVVybDogJy4vb3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YUFkZHJlc3NTcGFjZVRyZWVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpXG4gIHNldCBtb0lkKGlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9tb0lkID0gaWQgfHwgdW5kZWZpbmVkO1xuICB9XG5cbiAgQElucHV0KCkgbm9kZTtcbiAgQElucHV0KCkgZm9jdXNFbWl0dGVyOiBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+KCk7XG4gIEBPdXRwdXQoKSBzZWxlY3RlZE5vZGU6IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPiA9IG5ldyBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4oKTtcbiAgbmVzdGVkVHJlZUNvbnRyb2w6IE5lc3RlZFRyZWVDb250cm9sPEFkZHJlc3NTcGFjZU5vZGU+O1xuICBkYXRhU291cmNlOiBEeW5hbWljRGF0YVNvdXJjZSA9IG51bGw7XG4gIGZvY3VzZWQ6IEFkZHJlc3NTcGFjZU5vZGU7XG4gIGxvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgc3Vic2NyaXB0aW9uUmVmOiBTdWJzY3JpcHRpb247XG4gIG5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgX21vSWQ6IHN0cmluZztcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhZGRyZXNzU3BhY2VTZXJ2aWNlOiBBZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZVxuICApIHt9XG5cbiAgZ2V0Q2hpbGRyZW4gPSAobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkgPT4gKG5vZGUuZXhwYW5kZWQgPyBub2RlLmNoaWxkcmVuIDogW10pO1xuICBoYXNDaGlsZCA9IChfOiBudW1iZXIsIF9ub2RlRGF0YTogQWRkcmVzc1NwYWNlTm9kZSkgPT5cbiAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuY2hpbGRyZW5BdmFpbGFibGUoX25vZGVEYXRhLnJlZmVyZW5jZXMpXG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbiA9IHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZVxuICAgICAgLmdldE5vZGVOYXZEYXRhJCgpXG4gICAgICAuc3Vic2NyaWJlKG5vZGVOYXZEYXRhID0+IHRoaXMub3Blbk5vZGUobm9kZU5hdkRhdGEpKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvblJlZiA9IHRoaXMuZm9jdXNFbWl0dGVyLnN1YnNjcmliZShub2RlID0+IHtcbiAgICAgIHRoaXMuZm9jdXNlZCA9IHRoaXMuaXNGb2N1c2VkTm9kZShub2RlKSA/IHVuZGVmaW5lZCA6IG5vZGU7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICAvLyBjbGVhbiB1cCB0aGUgYWRkcmVzcy1zcGFjZS10cmVlXG4gICAgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLnJlc2V0VHJlZVRvUm9vdE5vZGUoKTtcblxuICAgIGlmICh0aGlzLm5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uICYmICF0aGlzLm5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgdGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvblJlZiAmJiAhdGhpcy5zdWJzY3JpcHRpb25SZWYuY2xvc2VkKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvblJlZi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9wZW5Ob2RlKG5vZGVOYXZEYXRhOiBOb2RlTmF2aWdhdGlvbkRhdGEpIHtcbiAgICBjb25zdCB7IG5vZGUsIHNlbGVjdGVkQW5jZXN0b3JJZHMgfSA9IG5vZGVOYXZEYXRhO1xuICAgIGxldCBub2RlSWQ7XG5cbiAgICAvLyBXZSBqdXN0IHNldCB0aGUgbm9kZUlkIHdoZW4gdGhlIHNlbGVjdGVkQW5jZXN0b3JJZHMgdmFyaWFibGUgYW4gZW1wdHkgYXJyYXkuXG4gICAgLy8gSWYgc2VsZWN0ZWRBbmNlc3RvcklkcyBjb250YWluIGFueSBpZCB3ZSBhc3N1bWUgdGhhdCB0aGUgdHJlZSBzaG91bGQgYmUgdHJhdnNlcnNlZCBiZWdpbm5pbmdcbiAgICAvLyBmcm9tIHRoZSByb290IG5vZGUuXG4gICAgaWYgKG5vZGUgJiYgbm9kZS5ub2RlSWQgJiYgc2VsZWN0ZWRBbmNlc3RvcklkcyAmJiBzZWxlY3RlZEFuY2VzdG9ySWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgbm9kZUlkID0gbm9kZS5ub2RlSWQ7XG4gICAgfVxuICAgIC8vIEFsd2F5cyByZWNyZWF0ZSB0aGUgdHJlZSB3aGVuIHJvdXRpbmcgdG8gYSBzcGVjaWZpYyBuZXN0ZWQgbm9kZSxcbiAgICAvLyBiZWNhdXNlIHByZXZpb3VzIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHRyZWUtc3RydWN0dXJlIGNvdWxkIGNhdXNlIGVycm9yc1xuICAgIC8vIHdoaWxlIHRyYXZlcnNpbmcgd2l0aCAnb2xkJyB0cmVlLWRhdGFcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIHNldHVwVHJlZSBpcyBhYmxlIHRvIGhhbmRsZSBub2RlSWQgPSB1bmRlZmluZWRcbiAgICBhd2FpdCB0aGlzLnNldHVwVHJlZShub2RlSWQpO1xuXG4gICAgaWYgKCFzZWxlY3RlZEFuY2VzdG9ySWRzIHx8IHNlbGVjdGVkQW5jZXN0b3JJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG5vZGVOYXZEYXRhICYmIHRoaXMuZGF0YVNvdXJjZSkge1xuICAgICAgY29uc3QgY2xvbmVkQW5jZXN0b3JzID0gY2xvbmUoc2VsZWN0ZWRBbmNlc3Rvcklkcyk7XG4gICAgICBjbG9uZWRBbmNlc3RvcnMuc2hpZnQoKTtcblxuICAgICAgY29uc3QgbiA9IGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50b2dnbGVOb2RlKHRoaXMuZGF0YVNvdXJjZS5kYXRhWzBdLCB0cnVlKTtcbiAgICAgIHRoaXMuc2V0Q2hpbGROb2RlcyhuLmNoaWxkcmVuLCBjbG9uZWRBbmNlc3RvcnMpO1xuXG4gICAgICB0aGlzLnRvZ2dsZUZvY3VzZWROb2RlKG5vZGUpO1xuICAgIH1cbiAgfVxuXG4gIHNldENoaWxkTm9kZXMobm9kZXM6IEFkZHJlc3NTcGFjZU5vZGVbXSwgaWRzOiBzdHJpbmdbXSkge1xuICAgIGlmIChub2Rlcykge1xuICAgICAgaWRzLmZvckVhY2goYXN5bmMgaWQgPT4ge1xuICAgICAgICBjb25zdCBtYXRjaCA9IG5vZGVzLmZpbmQobiA9PiBuLm5vZGVJZCA9PT0gaWQpO1xuICAgICAgICBpZiAobWF0Y2ggJiYgaWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBpZHggPSBpZHMuZmluZEluZGV4KHZhbHVlID0+IHZhbHVlID09PSBpZCk7XG4gICAgICAgICAgaWYgKGlkeCA+PSAwKSB7XG4gICAgICAgICAgICBpZHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHRvZ2dsZWROb2RlID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRvZ2dsZU5vZGUobWF0Y2gsIHRydWUpO1xuICAgICAgICAgIHRoaXMuc2V0Q2hpbGROb2Rlcyh0b2dnbGVkTm9kZS5jaGlsZHJlbiwgaWRzKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0dXBUcmVlKG5vZGVJZD86IHN0cmluZykge1xuICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG5cbiAgICBpZiAoIXRoaXMuX21vSWQgfHwgdGhpcy5fbW9JZC5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX21vSWQgPSB0aGlzLm9wY3VhU2VydmljZS5nZXRNb0lkKCk7XG4gICAgfVxuXG4gICAgLy8gYWRkcmVzc1NwYWNlU2VydmljZS5nZXROb2RlIHJldHVybnMgZWl0aGVyIHRoZSByb290IG5vZGUgb2YgdGhlIHNlcnZlciAobW9JZClcbiAgICAvLyBvciBpZiBub2RlSWQgIT09IHVuZGVmaW5lZCB0aGUgbm9kZSB3aXRoIGdpdmVuIG5vZGVJZFxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5nZXROb2RlKHRoaXMuX21vSWQsIG5vZGVJZCk7XG4gICAgaWYgKHJlcykge1xuICAgICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICBjb25zdCBkYXRhID0gcmVzLmpzb24gPyBhd2FpdCByZXMuanNvbigpIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKHsgZGF0YSwgcmVzIH0pO1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSB1bmRlZmluZWQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByb290Tm9kZSA9IChhd2FpdCByZXMuanNvbigpKSBhcyBBZGRyZXNzU3BhY2VOb2RlO1xuICAgICAgICB0aGlzLm5lc3RlZFRyZWVDb250cm9sID0gbmV3IE5lc3RlZFRyZWVDb250cm9sPEFkZHJlc3NTcGFjZU5vZGU+KHRoaXMuZ2V0Q2hpbGRyZW4pO1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSBuZXcgRHluYW1pY0RhdGFTb3VyY2UoXG4gICAgICAgICAgdGhpcy5uZXN0ZWRUcmVlQ29udHJvbCxcbiAgICAgICAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UsXG4gICAgICAgICAgdGhpcy5fbW9JZFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2UuZGF0YSA9IFtyb290Tm9kZV07XG4gICAgICB9XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgZ2V0TW9JZCgpIHtcbiAgICBpZiAoIXRoaXMuX21vSWQgfHwgdGhpcy5fbW9JZC5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0aGlzLm9wY3VhU2VydmljZS5nZXRNb0lkKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9tb0lkO1xuICB9XG5cbiAgZ2V0SWNvbihub2RlQ2xhc3NOYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5nZXRJY29uKG5vZGVDbGFzc05hbWUpO1xuICB9XG5cbiAgdG9nZ2xlRm9jdXNlZE5vZGUobm9kZSkge1xuICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IFtdO1xuICAgIHRoaXMuZ2V0UmVsYXRpdmVQYXRoKG5vZGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgbm9kZS5yZWxhdGl2ZVBhdGggPSByZWxhdGl2ZVBhdGg7XG5cbiAgICB0aGlzLnNlbGVjdGVkTm9kZS5lbWl0KG5vZGUpO1xuICAgIHRoaXMuZm9jdXNlZCA9IHRoaXMuaXNGb2N1c2VkTm9kZShub2RlKSA/IHVuZGVmaW5lZCA6IG5vZGU7XG4gIH1cblxuICBpc0ZvY3VzZWROb2RlKG5vZGU6IEFkZHJlc3NTcGFjZU5vZGUpIHtcbiAgICBpZiAodGhpcy5mb2N1c2VkKSB7XG4gICAgICByZXR1cm4gbm9kZS5ub2RlSWQgPT09IHRoaXMuZm9jdXNlZC5ub2RlSWQ7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVsYXRpdmVQYXRoKG5vZGU6IEFkZHJlc3NTcGFjZU5vZGUsIHJlbGF0aXZlUGF0aDogc3RyaW5nW10pIHtcbiAgICBpZiAobm9kZS5wYXJlbnROb2RlKSB7XG4gICAgICByZWxhdGl2ZVBhdGgudW5zaGlmdChub2RlLmJyb3dzZU5hbWUpO1xuICAgICAgdGhpcy5nZXRSZWxhdGl2ZVBhdGgobm9kZS5wYXJlbnROb2RlLCByZWxhdGl2ZVBhdGgpO1xuICAgIH1cbiAgfVxufVxuIl19