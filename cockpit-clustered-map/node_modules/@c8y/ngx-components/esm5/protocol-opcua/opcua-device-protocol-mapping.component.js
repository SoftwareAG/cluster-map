import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ControlContainer, NgModelGroup } from '@angular/forms';
import { AlertService, gettext } from '@c8y/ngx-components';
import { isEmpty, assign, unset, get, cloneDeep } from 'lodash';
import { OpcuaDeviceProtocolObjectMapping } from './opcua-device-protocol-object-mapping.component';
import { AddressSpaceService } from './address-space.service';
var OpcuaDeviceProtocolMapping = /** @class */ (function () {
    function OpcuaDeviceProtocolMapping(alertService, addressSpaceService) {
        var _this = this;
        this.alertService = alertService;
        this.addressSpaceService = addressSpaceService;
        this.onAction = new EventEmitter();
        this.isPathFocused = false;
        this.isBrowsePathUniq = true;
        this.dataReporting = 'default';
        this.isTreeOpen = false;
        this.isNew = false;
        this.resetModel = false;
        this.moId = '';
        this.getMappings = function () { return _this.getParentAttr('mappings'); };
    }
    OpcuaDeviceProtocolMapping.prototype.toggleDetail = function () {
        this.isDetailOpen = !this.isDetailOpen;
        if (this.resetModel) {
            this.initialFormSetup();
        }
    };
    OpcuaDeviceProtocolMapping.prototype.ngOnInit = function () {
        this.initialFormSetup();
    };
    OpcuaDeviceProtocolMapping.prototype.initialFormSetup = function () {
        var mapping = {
            id: '',
            browsePath: [],
            name: '',
            subscriptionType: {
                type: 'None'
            }
        };
        var customAction = {
            headers: [{ key: 'Authorization', value: '' }, { key: 'Content-Type', value: '' }],
            bodyTemplate: '',
            type: 'HttpPost',
            endpoint: ''
        };
        this.mapping = assign({}, mapping, cloneDeep(this._model));
        if (isEmpty(this.mapping.browsePath)) {
            this.isNew = true;
            this.isDetailOpen = true;
        }
        else {
            this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
            this.nodeDisplayName = this.mapping.name;
        }
        if (this.referencedRootNodeId) {
            this.referencedNode = { nodeId: this.referencedRootNodeId };
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
        else {
            this.referencedNode = { nodeId: '' };
        }
        if (get(this.mapping, 'customAction')) {
            this.customAction = assign(customAction, get(this.mapping, 'customAction'));
            this.customAction.headers = this.mapHeadersObjectToList(get(this.customAction, 'headers'));
        }
        else {
            this.customAction = assign({}, customAction);
        }
        unset(this.mapping, 'customAction');
        if (get(this._model, 'subscriptionType')) {
            this.dataReporting = 'custom';
        }
        else {
            this.dataReporting = 'default';
        }
        this.resetModel = false;
    };
    OpcuaDeviceProtocolMapping.prototype.showAddressSpaceTree = function () {
        return !isEmpty(this.referencedServerId);
    };
    OpcuaDeviceProtocolMapping.prototype.ngAfterViewInit = function () {
        if (get(this.mapping, 'subscriptionType') &&
            get(this.mapping, 'subscriptionType.type') !== 'None') {
            this.dataReporting = 'custom';
        }
    };
    OpcuaDeviceProtocolMapping.prototype.mapHeadersObjectToList = function (headers) {
        if (Object.keys(headers).length > 0) {
            return Object.keys(headers).map(function (item) {
                return { key: item, value: headers[item] };
            });
        }
    };
    OpcuaDeviceProtocolMapping.prototype.stringfyBrowsePath = function (path) {
        return JSON.stringify(path);
    };
    OpcuaDeviceProtocolMapping.prototype.updateBrowsePath = function (node) {
        this.mapping.browsePath = node.relativePath;
        this.nodeDisplayName = node.displayName;
        this.mapping.name = this.nodeDisplayName;
        this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
        this.browsePathModel.control.markAsDirty();
    };
    OpcuaDeviceProtocolMapping.prototype.updateDisplayname = function () {
        this.mapping.name = this.nodeDisplayName;
    };
    OpcuaDeviceProtocolMapping.prototype.updateBrowsePathInput = function () {
        if (this.browsePath) {
            try {
                this.mapping.browsePath = JSON.parse(this.browsePath);
            }
            catch (error) {
                return;
            }
        }
    };
    OpcuaDeviceProtocolMapping.prototype.save = function () {
        if (this.dataReporting === 'default') {
            unset(this.mapping, 'subscriptionType');
        }
        var customAction = this.subFormRef.value.customAction;
        if (customAction.hasCustomAction) {
            var reducedHeaders = this.customAction.headers.reduce(function (result, item) {
                result[item.key] = item.value;
                return result;
            }, {});
            if (customAction.bodyTemplate) {
                var bodyTemplateAsString = customAction.bodyTemplate;
                // parsing the string back into object and then stringify it back
                // will remove all whitespaces, linebreaks etc.
                var obj = JSON.parse(bodyTemplateAsString);
                var result = JSON.stringify(obj);
                this.customAction.bodyTemplate = result;
            }
            this.customAction = assign(this.customAction, { headers: reducedHeaders });
            this.mapping = assign(this.mapping, { customAction: this.customAction });
        }
        this.onAction.emit({ action: 'save', data: assign({}, this.mapping) });
        this.isDetailOpen = false;
    };
    OpcuaDeviceProtocolMapping.prototype.cancel = function () {
        this.isDetailOpen = false;
        this.resetModel = true;
        if (this.mapping.id === 'new') {
            this.onAction.emit({ action: 'delete', data: assign({}, this.mapping) });
        }
    };
    OpcuaDeviceProtocolMapping.prototype.onDelete = function () {
        this.onAction.emit({ action: 'delete', data: this.mapping });
    };
    OpcuaDeviceProtocolMapping.prototype.isFormValid = function (variableForm) {
        return variableForm.valid && this.objectMappingForm.$componentScope.mappingForm.$valid;
    };
    OpcuaDeviceProtocolMapping.prototype.isActive = function () {
        return this.isDetailOpen;
    };
    OpcuaDeviceProtocolMapping.prototype.setTreeFromRefNode = function () {
        if (this.referencedRootNodeId) {
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
    };
    OpcuaDeviceProtocolMapping.ctorParameters = function () { return [
        { type: AlertService },
        { type: AddressSpaceService }
    ]; };
    tslib_1.__decorate([
        ViewChild(OpcuaDeviceProtocolObjectMapping, { static: false })
    ], OpcuaDeviceProtocolMapping.prototype, "objectMappingForm", void 0);
    tslib_1.__decorate([
        ViewChild('variableForm', { static: false })
    ], OpcuaDeviceProtocolMapping.prototype, "subFormRef", void 0);
    tslib_1.__decorate([
        ViewChild('browsePathModel', { static: false })
    ], OpcuaDeviceProtocolMapping.prototype, "browsePathModel", void 0);
    tslib_1.__decorate([
        Input('resource')
    ], OpcuaDeviceProtocolMapping.prototype, "_model", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaDeviceProtocolMapping.prototype, "index", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaDeviceProtocolMapping.prototype, "getParentAttr", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaDeviceProtocolMapping.prototype, "referencedServerId", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaDeviceProtocolMapping.prototype, "referencedRootNodeId", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaDeviceProtocolMapping.prototype, "onAction", void 0);
    OpcuaDeviceProtocolMapping = tslib_1.__decorate([
        Component({
            selector: 'opcua-device-protocol-mapping',
            template: "<div class=\"list-group-item collapsible\" [ngClass]=\"{ expanded: isDetailOpen }\">\n  <div class=\"flex-row\" (click)=\"toggleDetail()\">\n    <div class=\"list-item-actions\">\n      <button class=\"btn btn-clean showOnHover flex-item-right\" title=\"{{ 'Delete' | translate }}\">\n        <i c8yIcon=\"minus-circle\" class=\"text-danger\" (click)=\"onDelete()\"></i>\n      </button>\n      <button\n        type=\"button\"\n        title=\"{{ 'Expand' | translate }}\"\n        class=\"collapse-btn\"\n        [ngClass]=\"{ active: isDetailOpen }\"\n      >\n        <i class=\"fa fw fa-chevron-down\"></i>\n      </button>\n    </div>\n\n    <div class=\"list-item-icon\">\n      <i c8yIcon=\"sliders\"></i>\n    </div>\n\n    <div class=\"list-item-body\">\n      <div class=\"row flex-row\">\n        <div class=\"col-sm-7 col-xs-12\">\n          <p>\n            {{ nodeDisplayName }}<br />\n            <small\n              *ngIf=\"mapping.browsePath.length > 0\"\n              class=\"text-muted text-truncate\"\n              title=\"{{ mapping.browsePath | json }}\"\n              >{{ mapping.browsePath | json }}</small\n            >\n          </p>\n\n          <p></p>\n        </div>\n\n        <div class=\"col-sm-4 col-xs-10\">\n          <div class=\"list-functionalities\">\n            <label class=\"small right-m hidden-xs\" translate>Functionalities</label>&nbsp;\n            <c8y-object-mapping-status-icons [mapping]=\"mapping\"></c8y-object-mapping-status-icons>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"detail\" [collapse]=\"!isDetailOpen\" [isAnimated]=\"true\">\n    <div class=\"form\" [ngModelGroup]=\"index\" #variableForm=\"ngModelGroup\" *ngIf=\"isDetailOpen\">\n      <div class=\"row top-p-sm\">\n        <c8y-form-group class=\"col-md-4\" [status]=\"!isBrowsePathUniq ? 'error' : ''\">\n          <label translate>Path</label>\n          <div\n            class=\"dropdown\"\n            dropdown\n            #dropdown=\"bs-dropdown\"\n            [insideClick]=\"true\"\n            style=\"width:100%;\"\n          >\n            <input\n              class=\"form-control\"\n              c8yBrowsePathValidator\n              [getMappings]=\"getMappings\"\n              [model]=\"mapping\"\n              type=\"text\"\n              name=\"browsePath\"\n              dropdownToggle\n              placeholder=\"{{ 'e.g.' | translate }} {{ ['2:Node1', '2:SubNode1'] | json }}\"\n              [(ngModel)]=\"browsePath\"\n              (change)=\"updateBrowsePathInput()\"\n              (focus)=\"setTreeFromRefNode()\"\n              required\n              #browsePathModel=\"ngModel\"\n            />\n            <div\n              *dropdownMenu\n              class=\"dropdown-menu panel-inner-scroll\"\n              style=\"max-height:200px; width: 100%;\"\n            >\n              <opcua-address-space-tree\n                *ngIf=\"showAddressSpaceTree()\"\n                [node]=\"referencedNode\"\n                [moId]=\"referencedServerId\"\n                (selectedNode)=\"updateBrowsePath($event); dropdown.hide()\"\n              ></opcua-address-space-tree>\n            </div>\n          </div>\n          <c8y-messages>\n            <c8y-message\n              name=\"invalidBrowsePathNotation\"\n              text=\"{{ 'Must be a valid array of strings.' | translate }}\"\n            ></c8y-message>\n            <c8y-message\n              name=\"browsePathNotUnique\"\n              text=\"{{ 'Variable with this path is already added.' | translate }}\"\n            ></c8y-message>\n          </c8y-messages>\n        </c8y-form-group>\n\n        <c8y-form-group class=\"col-md-4\">\n          <label translate>Name</label>\n          <div class=\"input-group\">\n            <input\n              class=\"form-control\"\n              type=\"test\"\n              name=\"displayName\"\n              placeholder=\"{{ 'e.g. childDevice2' | translate }} \"\n              required\n              [(ngModel)]=\"nodeDisplayName\"\n              (change)=\"updateDisplayname()\"\n            />\n          </div>\n        </c8y-form-group>\n      </div>\n      <div class=\"row\" ngModelGroup=\"dataReportingSection\">\n        <c8y-form-group class=\"col-sm-4 col-md-3 col-lg-2\">\n          <label>\n            <span translate>Data reporting</span>\n          </label>\n          <div class=\"input-group\">\n            <label class=\"c8y-radio radio-inline\">\n              <input\n                type=\"radio\"\n                [(ngModel)]=\"dataReporting\"\n                name=\"ReportingMode\"\n                value=\"default\"\n              />\n              <span></span> {{ 'Default' | translate }}\n            </label>\n            <label class=\"c8y-radio radio-inline\">\n              <input type=\"radio\" [(ngModel)]=\"dataReporting\" name=\"ReportingMode\" value=\"custom\" />\n              <span></span> {{ 'Custom' | translate }}\n            </label>\n          </div>\n        </c8y-form-group>\n        <div\n          class=\"col-sm-8 col-md-9 col-lg-10\"\n          *ngIf=\"dataReporting === 'custom'\"\n          ngModelGroup=\"overriddenSubscription\"\n        >\n          <opcua-device-protocol-data-reporting\n            [model]=\"mapping\"\n          ></opcua-device-protocol-data-reporting>\n        </div>\n      </div>\n\n      <c8y-object-mapping [mapping]=\"mapping\" [hideAutoObserve]=\"true\"></c8y-object-mapping>\n      <div ngModelGroup=\"customAction\">\n        <opcua-device-protocol-mapping-customaction\n          [customAction]=\"customAction\"\n        ></opcua-device-protocol-mapping-customaction>\n      </div>\n      <button\n        id=\"cancelBtn\"\n        class=\"btn btn-default top-m-md bottom-m-lg\"\n        style=\"min-width: 100px;\"\n        (click)=\"cancel()\"\n        translate\n      >\n        Cancel\n      </button>\n      <button\n        id=\"saveBtn\"\n        class=\"btn btn-primary top-m-md bottom-m-lg\"\n        style=\"min-width: 100px;\"\n        (click)=\"save()\"\n        [disabled]=\"!isFormValid(variableForm)\"\n        translate\n      >\n        Save\n      </button>\n    </div>\n  </div>\n</div>\n",
            viewProviders: [{ provide: ControlContainer, useExisting: NgModelGroup }]
        })
    ], OpcuaDeviceProtocolMapping);
    return OpcuaDeviceProtocolMapping;
}());
export { OpcuaDeviceProtocolMapping };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9wcm90b2NvbC1vcGN1YS8iLCJzb3VyY2VzIjpbIm9wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUYsT0FBTyxFQUFVLGdCQUFnQixFQUFlLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBZ0IsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBQ3BHLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBTzlEO0lBMkJFLG9DQUNVLFlBQTBCLEVBQzFCLG1CQUF3QztRQUZsRCxpQkFHSTtRQUZNLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFuQnhDLGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQU9oRSxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUl0QixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDeEIsa0JBQWEsR0FBRyxTQUFTLENBQUM7UUFDMUIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixVQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ2QsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNYLFNBQUksR0FBVyxFQUFFLENBQUM7UUFhMUIsZ0JB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QUssRUFBRTtxRUFBZTtJQUNkO1FBQVIsS0FBSyxFQUFFOzBFQUFvQjtJQUNuQjtRQUFSLEtBQUssRUFBRTs0RUFBc0I7SUFDcEI7UUFBVCxNQUFNLEVBQUU7Z0VBQXVEO0lBVnJELDBCQUEwQjtRQUx0QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsK0JBQStCO1lBQ3pDLDBsTUFBbUQ7WUFDbkQsYUFBYSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxDQUFDO1NBQzFFLENBQUM7T0FDVywwQkFBMEIsQ0FxTnRDO0lBQUQsaUNBQUM7Q0FBQSxBQXJORCxJQXFOQztTQXJOWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5nRm9ybSwgQ29udHJvbENvbnRhaW5lciwgRm9ybUNvbnRyb2wsIE5nTW9kZWxHcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgaXNFbXB0eSwgYXNzaWduLCB1bnNldCwgZ2V0LCByZWplY3QsIGZpbmQsIGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPcGN1YURldmljZVByb3RvY29sT2JqZWN0TWFwcGluZyB9IGZyb20gJy4vb3BjdWEtZGV2aWNlLXByb3RvY29sLW9iamVjdC1tYXBwaW5nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBZGRyZXNzU3BhY2VTZXJ2aWNlIH0gZnJvbSAnLi9hZGRyZXNzLXNwYWNlLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvcGN1YS1kZXZpY2UtcHJvdG9jb2wtbWFwcGluZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtbWFwcGluZy5odG1sJyxcbiAgdmlld1Byb3ZpZGVyczogW3sgcHJvdmlkZTogQ29udHJvbENvbnRhaW5lciwgdXNlRXhpc3Rpbmc6IE5nTW9kZWxHcm91cCB9XVxufSlcbmV4cG9ydCBjbGFzcyBPcGN1YURldmljZVByb3RvY29sTWFwcGluZyBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBWaWV3Q2hpbGQoT3BjdWFEZXZpY2VQcm90b2NvbE9iamVjdE1hcHBpbmcsIHsgc3RhdGljOiBmYWxzZSB9KSBvYmplY3RNYXBwaW5nRm9ybTogYW55O1xuICBAVmlld0NoaWxkKCd2YXJpYWJsZUZvcm0nLCB7IHN0YXRpYzogZmFsc2UgfSkgc3ViRm9ybVJlZjogYW55O1xuICBAVmlld0NoaWxkKCdicm93c2VQYXRoTW9kZWwnLCB7IHN0YXRpYzogZmFsc2UgfSkgYnJvd3NlUGF0aE1vZGVsOiBhbnk7XG5cbiAgQElucHV0KCdyZXNvdXJjZScpIF9tb2RlbDtcbiAgQElucHV0KCkgaW5kZXg7XG4gIEBJbnB1dCgpIGdldFBhcmVudEF0dHI7XG4gIEBJbnB1dCgpIHJlZmVyZW5jZWRTZXJ2ZXJJZDtcbiAgQElucHV0KCkgcmVmZXJlbmNlZFJvb3ROb2RlSWQ7XG4gIEBPdXRwdXQoKSBvbkFjdGlvbjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBtYXBwaW5nO1xuXG4gIGlzRGV0YWlsT3BlbjtcbiAgY3VzdG9tQWN0aW9uO1xuICByZWZlcmVuY2VkTm9kZTtcbiAgaXNQYXRoRm9jdXNlZCA9IGZhbHNlO1xuICBncm91cE5hbWU6IHN0cmluZztcbiAgYnJvd3NlUGF0aDogc3RyaW5nO1xuICBub2RlRGlzcGxheU5hbWU6IHN0cmluZztcbiAgaXNCcm93c2VQYXRoVW5pcSA9IHRydWU7XG4gIGRhdGFSZXBvcnRpbmcgPSAnZGVmYXVsdCc7XG4gIGlzVHJlZU9wZW4gPSBmYWxzZTtcbiAgaXNOZXcgPSBmYWxzZTtcbiAgcmVzZXRNb2RlbCA9IGZhbHNlO1xuICBwcml2YXRlIG1vSWQ6IHN0cmluZyA9ICcnO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWRkcmVzc1NwYWNlU2VydmljZTogQWRkcmVzc1NwYWNlU2VydmljZVxuICApIHt9XG5cbiAgdG9nZ2xlRGV0YWlsKCkge1xuICAgIHRoaXMuaXNEZXRhaWxPcGVuID0gIXRoaXMuaXNEZXRhaWxPcGVuO1xuICAgIGlmICh0aGlzLnJlc2V0TW9kZWwpIHtcbiAgICAgIHRoaXMuaW5pdGlhbEZvcm1TZXR1cCgpO1xuICAgIH1cbiAgfVxuXG4gIGdldE1hcHBpbmdzID0gKCkgPT4gdGhpcy5nZXRQYXJlbnRBdHRyKCdtYXBwaW5ncycpO1xuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdGlhbEZvcm1TZXR1cCgpO1xuICB9XG5cbiAgaW5pdGlhbEZvcm1TZXR1cCgpIHtcbiAgICBjb25zdCBtYXBwaW5nID0ge1xuICAgICAgaWQ6ICcnLFxuICAgICAgYnJvd3NlUGF0aDogW10sXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHN1YnNjcmlwdGlvblR5cGU6IHtcbiAgICAgICAgdHlwZTogJ05vbmUnXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGN1c3RvbUFjdGlvbiA9IHtcbiAgICAgIGhlYWRlcnM6IFt7IGtleTogJ0F1dGhvcml6YXRpb24nLCB2YWx1ZTogJycgfSwgeyBrZXk6ICdDb250ZW50LVR5cGUnLCB2YWx1ZTogJycgfV0sXG4gICAgICBib2R5VGVtcGxhdGU6ICcnLFxuICAgICAgdHlwZTogJ0h0dHBQb3N0JyxcbiAgICAgIGVuZHBvaW50OiAnJ1xuICAgIH07XG5cbiAgICB0aGlzLm1hcHBpbmcgPSBhc3NpZ24oe30sIG1hcHBpbmcsIGNsb25lRGVlcCh0aGlzLl9tb2RlbCkpO1xuICAgIGlmIChpc0VtcHR5KHRoaXMubWFwcGluZy5icm93c2VQYXRoKSkge1xuICAgICAgdGhpcy5pc05ldyA9IHRydWU7XG4gICAgICB0aGlzLmlzRGV0YWlsT3BlbiA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYnJvd3NlUGF0aCA9IHRoaXMuc3RyaW5nZnlCcm93c2VQYXRoKHRoaXMubWFwcGluZy5icm93c2VQYXRoKTtcbiAgICAgIHRoaXMubm9kZURpc3BsYXlOYW1lID0gdGhpcy5tYXBwaW5nLm5hbWU7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQpIHtcbiAgICAgIHRoaXMucmVmZXJlbmNlZE5vZGUgPSB7IG5vZGVJZDogdGhpcy5yZWZlcmVuY2VkUm9vdE5vZGVJZCB9O1xuICAgICAgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLnRyaWdnZXJOb2RlVG9PcGVuKHtcbiAgICAgICAgbm9kZToge1xuICAgICAgICAgIG5vZGVJZDogdGhpcy5yZWZlcmVuY2VkUm9vdE5vZGVJZCxcbiAgICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgICAgZXhwYW5kZWQ6IGZhbHNlLFxuICAgICAgICAgIGFic29sdXRlUGF0aHM6IFtbXV1cbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0ZWRBbmNlc3RvcklkczogW11cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlZmVyZW5jZWROb2RlID0geyBub2RlSWQ6ICcnIH07XG4gICAgfVxuXG4gICAgaWYgKGdldCh0aGlzLm1hcHBpbmcsICdjdXN0b21BY3Rpb24nKSkge1xuICAgICAgdGhpcy5jdXN0b21BY3Rpb24gPSBhc3NpZ24oY3VzdG9tQWN0aW9uLCBnZXQodGhpcy5tYXBwaW5nLCAnY3VzdG9tQWN0aW9uJykpO1xuICAgICAgdGhpcy5jdXN0b21BY3Rpb24uaGVhZGVycyA9IHRoaXMubWFwSGVhZGVyc09iamVjdFRvTGlzdChnZXQodGhpcy5jdXN0b21BY3Rpb24sICdoZWFkZXJzJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1c3RvbUFjdGlvbiA9IGFzc2lnbih7fSwgY3VzdG9tQWN0aW9uKTtcbiAgICB9XG5cbiAgICB1bnNldCh0aGlzLm1hcHBpbmcsICdjdXN0b21BY3Rpb24nKTtcbiAgICBpZiAoZ2V0KHRoaXMuX21vZGVsLCAnc3Vic2NyaXB0aW9uVHlwZScpKSB7XG4gICAgICB0aGlzLmRhdGFSZXBvcnRpbmcgPSAnY3VzdG9tJztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kYXRhUmVwb3J0aW5nID0gJ2RlZmF1bHQnO1xuICAgIH1cbiAgICB0aGlzLnJlc2V0TW9kZWwgPSBmYWxzZTtcbiAgfVxuXG4gIHNob3dBZGRyZXNzU3BhY2VUcmVlKCkge1xuICAgIHJldHVybiAhaXNFbXB0eSh0aGlzLnJlZmVyZW5jZWRTZXJ2ZXJJZCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKFxuICAgICAgZ2V0KHRoaXMubWFwcGluZywgJ3N1YnNjcmlwdGlvblR5cGUnKSAmJlxuICAgICAgZ2V0KHRoaXMubWFwcGluZywgJ3N1YnNjcmlwdGlvblR5cGUudHlwZScpICE9PSAnTm9uZSdcbiAgICApIHtcbiAgICAgIHRoaXMuZGF0YVJlcG9ydGluZyA9ICdjdXN0b20nO1xuICAgIH1cbiAgfVxuXG4gIG1hcEhlYWRlcnNPYmplY3RUb0xpc3QoaGVhZGVycykge1xuICAgIGlmIChPYmplY3Qua2V5cyhoZWFkZXJzKS5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXMoaGVhZGVycykubWFwKGl0ZW0gPT4ge1xuICAgICAgICByZXR1cm4geyBrZXk6IGl0ZW0sIHZhbHVlOiBoZWFkZXJzW2l0ZW1dIH07XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzdHJpbmdmeUJyb3dzZVBhdGgocGF0aCkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXRoKTtcbiAgfVxuXG4gIHVwZGF0ZUJyb3dzZVBhdGgobm9kZSkge1xuICAgIHRoaXMubWFwcGluZy5icm93c2VQYXRoID0gbm9kZS5yZWxhdGl2ZVBhdGg7XG4gICAgdGhpcy5ub2RlRGlzcGxheU5hbWUgPSBub2RlLmRpc3BsYXlOYW1lO1xuICAgIHRoaXMubWFwcGluZy5uYW1lID0gdGhpcy5ub2RlRGlzcGxheU5hbWU7XG4gICAgdGhpcy5icm93c2VQYXRoID0gdGhpcy5zdHJpbmdmeUJyb3dzZVBhdGgodGhpcy5tYXBwaW5nLmJyb3dzZVBhdGgpO1xuICAgIHRoaXMuYnJvd3NlUGF0aE1vZGVsLmNvbnRyb2wubWFya0FzRGlydHkoKTtcbiAgfVxuXG4gIHVwZGF0ZURpc3BsYXluYW1lKCkge1xuICAgIHRoaXMubWFwcGluZy5uYW1lID0gdGhpcy5ub2RlRGlzcGxheU5hbWU7XG4gIH1cblxuICB1cGRhdGVCcm93c2VQYXRoSW5wdXQoKSB7XG4gICAgaWYgKHRoaXMuYnJvd3NlUGF0aCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5tYXBwaW5nLmJyb3dzZVBhdGggPSBKU09OLnBhcnNlKHRoaXMuYnJvd3NlUGF0aCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2F2ZSgpIHtcbiAgICBpZiAodGhpcy5kYXRhUmVwb3J0aW5nID09PSAnZGVmYXVsdCcpIHtcbiAgICAgIHVuc2V0KHRoaXMubWFwcGluZywgJ3N1YnNjcmlwdGlvblR5cGUnKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGN1c3RvbUFjdGlvbiB9ID0gdGhpcy5zdWJGb3JtUmVmLnZhbHVlO1xuICAgIGlmIChjdXN0b21BY3Rpb24uaGFzQ3VzdG9tQWN0aW9uKSB7XG4gICAgICBjb25zdCByZWR1Y2VkSGVhZGVycyA9IHRoaXMuY3VzdG9tQWN0aW9uLmhlYWRlcnMucmVkdWNlKChyZXN1bHQsIGl0ZW0pID0+IHtcbiAgICAgICAgcmVzdWx0W2l0ZW0ua2V5XSA9IGl0ZW0udmFsdWU7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9LCB7fSk7XG5cbiAgICAgIGlmIChjdXN0b21BY3Rpb24uYm9keVRlbXBsYXRlKSB7XG4gICAgICAgIGNvbnN0IGJvZHlUZW1wbGF0ZUFzU3RyaW5nID0gY3VzdG9tQWN0aW9uLmJvZHlUZW1wbGF0ZSBhcyBzdHJpbmc7XG5cbiAgICAgICAgLy8gcGFyc2luZyB0aGUgc3RyaW5nIGJhY2sgaW50byBvYmplY3QgYW5kIHRoZW4gc3RyaW5naWZ5IGl0IGJhY2tcbiAgICAgICAgLy8gd2lsbCByZW1vdmUgYWxsIHdoaXRlc3BhY2VzLCBsaW5lYnJlYWtzIGV0Yy5cbiAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZShib2R5VGVtcGxhdGVBc1N0cmluZyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04uc3RyaW5naWZ5KG9iaik7XG5cbiAgICAgICAgdGhpcy5jdXN0b21BY3Rpb24uYm9keVRlbXBsYXRlID0gcmVzdWx0O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmN1c3RvbUFjdGlvbiA9IGFzc2lnbih0aGlzLmN1c3RvbUFjdGlvbiwgeyBoZWFkZXJzOiByZWR1Y2VkSGVhZGVycyB9KTtcbiAgICAgIHRoaXMubWFwcGluZyA9IGFzc2lnbih0aGlzLm1hcHBpbmcsIHsgY3VzdG9tQWN0aW9uOiB0aGlzLmN1c3RvbUFjdGlvbiB9KTtcbiAgICB9XG5cbiAgICB0aGlzLm9uQWN0aW9uLmVtaXQoeyBhY3Rpb246ICdzYXZlJywgZGF0YTogYXNzaWduKHt9LCB0aGlzLm1hcHBpbmcpIH0pO1xuICAgIHRoaXMuaXNEZXRhaWxPcGVuID0gZmFsc2U7XG4gIH1cblxuICBjYW5jZWwoKSB7XG4gICAgdGhpcy5pc0RldGFpbE9wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnJlc2V0TW9kZWwgPSB0cnVlO1xuICAgIGlmICh0aGlzLm1hcHBpbmcuaWQgPT09ICduZXcnKSB7XG4gICAgICB0aGlzLm9uQWN0aW9uLmVtaXQoeyBhY3Rpb246ICdkZWxldGUnLCBkYXRhOiBhc3NpZ24oe30sIHRoaXMubWFwcGluZykgfSk7XG4gICAgfVxuICB9XG5cbiAgb25EZWxldGUoKSB7XG4gICAgdGhpcy5vbkFjdGlvbi5lbWl0KHsgYWN0aW9uOiAnZGVsZXRlJywgZGF0YTogdGhpcy5tYXBwaW5nIH0pO1xuICB9XG5cbiAgaXNGb3JtVmFsaWQodmFyaWFibGVGb3JtKSB7XG4gICAgcmV0dXJuIHZhcmlhYmxlRm9ybS52YWxpZCAmJiB0aGlzLm9iamVjdE1hcHBpbmdGb3JtLiRjb21wb25lbnRTY29wZS5tYXBwaW5nRm9ybS4kdmFsaWQ7XG4gIH1cblxuICBpc0FjdGl2ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pc0RldGFpbE9wZW47XG4gIH1cblxuICBzZXRUcmVlRnJvbVJlZk5vZGUoKSB7XG4gICAgaWYgKHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQpIHtcbiAgICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS50cmlnZ2VyTm9kZVRvT3Blbih7XG4gICAgICAgIG5vZGU6IHtcbiAgICAgICAgICBub2RlSWQ6IHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQsXG4gICAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICAgIGV4cGFuZGVkOiBmYWxzZSxcbiAgICAgICAgICBhYnNvbHV0ZVBhdGhzOiBbW11dXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdGVkQW5jZXN0b3JJZHM6IFtdXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==