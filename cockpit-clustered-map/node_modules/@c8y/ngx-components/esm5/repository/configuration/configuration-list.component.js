import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { AlertService, gettext } from '@c8y/ngx-components';
import { pipe, Subject, timer, of } from 'rxjs';
import { debounce, distinctUntilChanged, map } from 'rxjs/operators';
import { RepositoryService } from '../repository.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { ConfigurationNewModalComponent } from './configuration-new-modal.component';
var ConfigurationListComponent = /** @class */ (function () {
    function ConfigurationListComponent(alert, repositoryService, modalService) {
        this.alert = alert;
        this.repositoryService = repositoryService;
        this.modalService = modalService;
        this.filterChange$ = new Subject();
        this.filterTerm = '';
        this.CARRIAGE_RETURN_KEY = 13;
        this.CARRIAGE_RETURN_CODE = 'Enter';
        this.DELETED_SUCCESS_MSG = gettext('Configuration deleted.');
    }
    ConfigurationListComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.reset()];
                    case 1:
                        _a.sent();
                        this.filterChange$
                            .pipe(debounce(function (event) {
                            return event.code === _this.CARRIAGE_RETURN_CODE || event.keyCode === _this.CARRIAGE_RETURN_KEY
                                ? timer(10)
                                : timer(300);
                        }), map(function (e) { return e.target.value; }), distinctUntilChanged())
                            .subscribe(function (filterTerm) {
                            _this.filterTerm = filterTerm;
                            _this.setPipe(filterTerm);
                        });
                        return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.ngOnDestroy = function () {
        this.filterChange$.complete();
    };
    ConfigurationListComponent.prototype.add = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.modalService.show(ConfigurationNewModalComponent, {
                                class: 'modal-sm',
                                ignoreBackdropClick: true
                            }).content.result];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.reset()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.edit = function (configuration) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var modal, ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        modal = this.modalService.show(ConfigurationNewModalComponent, {
                            class: 'modal-sm',
                            ignoreBackdropClick: true,
                            initialState: {
                                selected: { id: configuration.id, configurationType: configuration.configurationType },
                                versionOrName: configuration.name,
                                deviceType: configuration.deviceType,
                                description: configuration.description,
                                binary: { url: configuration.url }
                            }
                        }).content;
                        modal.mo = configuration;
                        return [4 /*yield*/, modal.result];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.reset()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_2 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.delete = function (configuration) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_3;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.repositoryService.delete(configuration)];
                    case 1:
                        _a.sent();
                        this.alert.success(this.DELETED_SUCCESS_MSG);
                        return [4 /*yield*/, this.reset()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_3 = _a.sent();
                        this.alert.addServerFailure(ex_3);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.setPipe = function (filterTerm) {
        var _this = this;
        this.filterPipe = pipe(map(function (data) {
            return filterTerm.trim().length === 0
                ? data
                : data.filter(function (mo) {
                    return _this.filterContainString(mo.name, filterTerm) ||
                        _this.filterContainString(mo.configurationType, filterTerm);
                });
        }));
    };
    ConfigurationListComponent.prototype.filterContainString = function (name, filterTerm) {
        var term = filterTerm.toLowerCase().trim();
        return name && name.toLowerCase().indexOf(term) > -1;
    };
    ConfigurationListComponent.prototype.reset = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        this.filterTerm = '';
                        _a = this;
                        _b = of;
                        return [4 /*yield*/, this.repositoryService.listConfigurations()];
                    case 1:
                        _a.configurations$ = _b.apply(void 0, [_c.sent()]);
                        this.setPipe('');
                        return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.ctorParameters = function () { return [
        { type: AlertService },
        { type: RepositoryService },
        { type: BsModalService }
    ]; };
    ConfigurationListComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-configuration-list',
            template: "<c8y-title>\n  <span translate>Configuration snapshots repository</span>&nbsp;\n  <small *ngIf=\"(configurations$ | async)?.paging.totalPages === 1 && !filterTerm\"\n    >{{ (configurations$ | async).data.length }} <span translate>snapshots</span></small\n  >\n  <small\n    *ngIf=\"(configurations$ | async)?.paging.totalPages > 1 && !filterTerm\"\n    [tooltip]=\"'More data available. Scroll to the bottom of the list to load it.' | translate\"\n    container=\"body\"\n    >{{ (configurations$ | async).paging.pageSize }}+ <span translate>snapshots</span></small\n  >\n  <small *ngIf=\"filterTerm\"\n    ><span translate>Search results for</span>&nbsp;\"{{ this.filterTerm }}\"</small\n  >\n</c8y-title>\n\n<c8y-action-bar-item itemClass=\"navbar-form\">\n  <div class=\"input-group input-group-search\">\n    <input\n      class=\"form-control\"\n      placeholder=\"{{ 'Filter\u2026' | translate }}\"\n      type=\"text\"\n      [value]=\"filterTerm\"\n      (keyup)=\"filterChange$.next($event)\"\n    />\n    <span class=\"input-group-btn\">\n      <button class=\"btn btn-clean\" (click)=\"filterTerm = ''; setPipe('')\">\n        <i [c8yIcon]=\"filterTerm.length === 0 ? 'filter' : 'close'\"></i>\n      </button>\n    </span>\n  </div>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" (click)=\"add()\">\n    <i c8yIcon=\"plus-square\"></i> {{ 'Add configuration snapshot' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"!filterTerm && (configurations$ | async)?.data.length === 0\"\n>\n  <h1 c8yIcon=\"gears\"></h1>\n  <h3 translate>There are no configuration snapshots defined</h3>\n  <p translate>Add a configuration snapshot first.</p>\n  <div>\n    <button (click)=\"add()\" class=\"btn btn-primary\" translate>\n      Add configuration snapshot\n    </button>\n  </div>\n  <p c8y-guide-docs>\n    <small translate\n      >Find out more in the\n      <a c8y-guide-href=\"users-guide/device-management/#configuration-repository\"\n        >User guide`KEEP_ORIGINAL`</a\n      >.</small\n    >\n  </p>\n</div>\n\n<ng-template #notFound>\n  <c8y-li class=\"p-8 text-center\">\n    <p>\n      <span translate>No more entries found for filter:</span>&nbsp;<strong>{{\n        filterTerm\n      }}</strong>\n    </p>\n    <button class=\"btn btn-primary btn-xs m-t-8\" translate (click)=\"filterTerm = ''; setPipe('')\">\n      Reset filter\n    </button>\n  </c8y-li>\n</ng-template>\n<div class=\"p-b-32\">\n  <c8y-list-group>\n    <c8y-li\n      *c8yFor=\"\n        let configuration of configurations$;\n        pipe: filterPipe;\n        notFound: this.filterTerm ? notFound : undefined\n      \"\n    >\n      <c8y-li-icon icon=\"gears\"></c8y-li-icon>\n      <div class=\"row flex-row\">\n        <div class=\"col-xs-3\">\n          <c8y-highlight\n            [text]=\"configuration.name || '-'\"\n            elementClass=\"text-info\"\n            [pattern]=\"filterTerm\"\n          ></c8y-highlight>\n        </div>\n        <div class=\"col-xs-3\">\n          <span class=\"text-muted text-truncate\" [title]=\"configuration.description\">{{\n            configuration.description\n          }}</span>\n        </div>\n        <div class=\"col-xs-3\">\n          <small translate class=\"text-muted text-uppercase\">Device type:</small>&nbsp;\n          {{ configuration.deviceType || '-' }}\n        </div>\n        <div class=\"col-xs-3 text-right\">\n          <span class=\"label label-primary\" *ngIf=\"configuration.configurationType\">\n            <c8y-highlight\n              [text]=\"configuration.configurationType\"\n              elementClass=\"text-info\"\n              [pattern]=\"filterTerm\"\n            ></c8y-highlight>\n          </span>\n        </div>\n      </div>\n      <c8y-li-action (click)=\"edit(configuration)\" icon=\"pencil\">\n        Edit\n      </c8y-li-action>\n      <c8y-li-action (click)=\"delete(configuration)\" icon=\"trash-o\">\n        Delete\n      </c8y-li-action>\n    </c8y-li>\n  </c8y-list-group>\n</div>\n"
        })
    ], ConfigurationListComponent);
    return ConfigurationListComponent;
}());
export { ConfigurationListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdGlvbi1saXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbImNvbmZpZ3VyYXRpb24vY29uZmlndXJhdGlvbi1saXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUVsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzVELE9BQU8sRUFBYyxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFPckY7SUFTRSxvQ0FDVSxLQUFtQixFQUNuQixpQkFBb0MsRUFDcEMsWUFBNEI7UUFGNUIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGlCQUFZLEdBQVosWUFBWSxDQUFnQjtRQVR0QyxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDOUIsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNDLHdCQUFtQixHQUFHLEVBQUUsQ0FBQztRQUN6Qix5QkFBb0IsR0FBRyxPQUFPLENBQUM7UUFDL0Isd0JBQW1CLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFNdEUsQ0FBQztJQUVFLDZDQUFRLEdBQWQ7Ozs7OzRCQUNFLHFCQUFNLElBQUksQ0FB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QSxBQXpHRCxJQXlHQztTQXpHWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIElSZXN1bHRMaXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBwaXBlLCBTdWJqZWN0LCB0aW1lciwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25OZXdNb2RhbENvbXBvbmVudCB9IGZyb20gJy4vY29uZmlndXJhdGlvbi1uZXctbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IFJlcG9zaXRvcnlNb2RhbCB9IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktY29uZmlndXJhdGlvbi1saXN0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvbmZpZ3VyYXRpb24tbGlzdC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQ29uZmlndXJhdGlvbkxpc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBjb25maWd1cmF0aW9ucyQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PjtcbiAgZmlsdGVyUGlwZTtcbiAgZmlsdGVyQ2hhbmdlJCA9IG5ldyBTdWJqZWN0KCk7XG4gIGZpbHRlclRlcm0gPSAnJztcbiAgcHJpdmF0ZSByZWFkb25seSBDQVJSSUFHRV9SRVRVUk5fS0VZID0gMTM7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FSUklBR0VfUkVUVVJOX0NPREUgPSAnRW50ZXInO1xuICBwcml2YXRlIHJlYWRvbmx5IERFTEVURURfU1VDQ0VTU19NU0cgPSBnZXR0ZXh0KCdDb25maWd1cmF0aW9uIGRlbGV0ZWQuJyk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeVNlcnZpY2U6IFJlcG9zaXRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5yZXNldCgpO1xuXG4gICAgdGhpcy5maWx0ZXJDaGFuZ2UkXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2UoKGV2ZW50OiBhbnkpID0+XG4gICAgICAgICAgZXZlbnQuY29kZSA9PT0gdGhpcy5DQVJSSUFHRV9SRVRVUk5fQ09ERSB8fCBldmVudC5rZXlDb2RlID09PSB0aGlzLkNBUlJJQUdFX1JFVFVSTl9LRVlcbiAgICAgICAgICAgID8gdGltZXIoMTApXG4gICAgICAgICAgICA6IHRpbWVyKDMwMClcbiAgICAgICAgKSxcbiAgICAgICAgbWFwKChlOiBhbnkpID0+IGUudGFyZ2V0LnZhbHVlKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShmaWx0ZXJUZXJtID0+IHtcbiAgICAgICAgdGhpcy5maWx0ZXJUZXJtID0gZmlsdGVyVGVybTtcbiAgICAgICAgdGhpcy5zZXRQaXBlKGZpbHRlclRlcm0pO1xuICAgICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmZpbHRlckNoYW5nZSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIGFzeW5jIGFkZCgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgKHRoaXMubW9kYWxTZXJ2aWNlLnNob3coQ29uZmlndXJhdGlvbk5ld01vZGFsQ29tcG9uZW50LCB7XG4gICAgICAgIGNsYXNzOiAnbW9kYWwtc20nLFxuICAgICAgICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlXG4gICAgICB9KS5jb250ZW50IGFzIENvbmZpZ3VyYXRpb25OZXdNb2RhbENvbXBvbmVudCkucmVzdWx0O1xuICAgICAgYXdhaXQgdGhpcy5yZXNldCgpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZWRpdChjb25maWd1cmF0aW9uOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtb2RhbCA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3coQ29uZmlndXJhdGlvbk5ld01vZGFsQ29tcG9uZW50LCB7XG4gICAgICAgIGNsYXNzOiAnbW9kYWwtc20nLFxuICAgICAgICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlLFxuICAgICAgICBpbml0aWFsU3RhdGU6IHtcbiAgICAgICAgICBzZWxlY3RlZDogeyBpZDogY29uZmlndXJhdGlvbi5pZCwgY29uZmlndXJhdGlvblR5cGU6IGNvbmZpZ3VyYXRpb24uY29uZmlndXJhdGlvblR5cGUgfSxcbiAgICAgICAgICB2ZXJzaW9uT3JOYW1lOiBjb25maWd1cmF0aW9uLm5hbWUsXG4gICAgICAgICAgZGV2aWNlVHlwZTogY29uZmlndXJhdGlvbi5kZXZpY2VUeXBlLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBjb25maWd1cmF0aW9uLmRlc2NyaXB0aW9uLFxuICAgICAgICAgIGJpbmFyeTogeyB1cmw6IGNvbmZpZ3VyYXRpb24udXJsIH1cbiAgICAgICAgfSBhcyBSZXBvc2l0b3J5TW9kYWxcbiAgICAgIH0pLmNvbnRlbnQgYXMgQ29uZmlndXJhdGlvbk5ld01vZGFsQ29tcG9uZW50O1xuICAgICAgbW9kYWwubW8gPSBjb25maWd1cmF0aW9uO1xuICAgICAgYXdhaXQgbW9kYWwucmVzdWx0O1xuICAgICAgYXdhaXQgdGhpcy5yZXNldCgpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGNvbmZpZ3VyYXRpb246IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZGVsZXRlKGNvbmZpZ3VyYXRpb24pO1xuICAgICAgdGhpcy5hbGVydC5zdWNjZXNzKHRoaXMuREVMRVRFRF9TVUNDRVNTX01TRyk7XG4gICAgICBhd2FpdCB0aGlzLnJlc2V0KCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgc2V0UGlwZShmaWx0ZXJUZXJtOiBzdHJpbmcpIHtcbiAgICB0aGlzLmZpbHRlclBpcGUgPSBwaXBlKFxuICAgICAgbWFwKChkYXRhOiBbXSkgPT5cbiAgICAgICAgZmlsdGVyVGVybS50cmltKCkubGVuZ3RoID09PSAwXG4gICAgICAgICAgPyBkYXRhXG4gICAgICAgICAgOiBkYXRhLmZpbHRlcihcbiAgICAgICAgICAgICAgKG1vOiBJTWFuYWdlZE9iamVjdCkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckNvbnRhaW5TdHJpbmcobW8ubmFtZSwgZmlsdGVyVGVybSkgfHxcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckNvbnRhaW5TdHJpbmcobW8uY29uZmlndXJhdGlvblR5cGUsIGZpbHRlclRlcm0pXG4gICAgICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyQ29udGFpblN0cmluZyhuYW1lOiBzdHJpbmcsIGZpbHRlclRlcm06IHN0cmluZykge1xuICAgIGNvbnN0IHRlcm0gPSBmaWx0ZXJUZXJtLnRvTG93ZXJDYXNlKCkudHJpbSgpO1xuICAgIHJldHVybiBuYW1lICYmIG5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRlcm0pID4gLTE7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlc2V0KCkge1xuICAgIHRoaXMuZmlsdGVyVGVybSA9ICcnO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbnMkID0gb2YoYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0Q29uZmlndXJhdGlvbnMoKSk7XG4gICAgdGhpcy5zZXRQaXBlKCcnKTtcbiAgfVxufVxuIl19