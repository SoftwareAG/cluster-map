import * as tslib_1 from "tslib";
import { gettext, NavigatorNode, DeviceStatusComponent } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { Subject } from 'rxjs';
import { LoadMoreNode } from './load-more-node';
import { GroupFragment } from './group-fragment.model';
var Action;
(function (Action) {
    Action[Action["FETCH"] = 0] = "FETCH";
    Action[Action["NEXT"] = 1] = "NEXT";
    Action[Action["REFRESH"] = 2] = "REFRESH";
})(Action || (Action = {}));
var AssetNode = /** @class */ (function (_super) {
    tslib_1.__extends(AssetNode, _super);
    function AssetNode(service, config) {
        if (config === void 0) { config = {}; }
        var _this = _super.call(this, config) || this;
        _this.service = service;
        _this.root = _this.root || false;
        _this.mo = _this.mo || {};
        _this.path = _this.root ? 'group' : (_this.isDevice ? "device/" + _this.mo.id : "group/" + _this.mo.id);
        _this.draggable = !_this.service.moduleConfig.disableDragAndDrop && !_this.root;
        _this.droppable = !_this.service.moduleConfig.disableDragAndDrop && !_this.isDevice;
        _this.routerLinkExact = _this.root;
        _this.updateIcon(false);
        _this.onUpdateSubscription = _this.service
            .onUpdate(_this)
            .subscribe(function (_a) {
            var data = _a.data, method = _a.method;
            return _this.refresh(data, method);
        });
        return _this;
    }
    Object.defineProperty(AssetNode.prototype, "label", {
        get: function () {
            return (this.root && gettext('Groups')) || this.mo.name || '--';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AssetNode.prototype, "hasChildren", {
        get: function () {
            return this.root || this.service.groups.isGroup(this.mo);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AssetNode.prototype, "iconComponent", {
        get: function () {
            return this.isDevice ? DeviceStatusComponent : undefined;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AssetNode.prototype, "isDevice", {
        get: function () {
            return !!(this.mo.c8y_IsDevice || get(this.mo, 'deviceParents.references.length'));
        },
        enumerable: true,
        configurable: true
    });
    AssetNode.prototype.openOnStart = function (url) {
        var urlRegex = /^\/group\//;
        if (this.root) {
            if (this.service.moduleConfig.openOnStart || urlRegex.test(url)) {
                return true;
            }
        }
        var matches = url.match(/\/(group)\/(\d+)/);
        var isMatch = false;
        if (matches) {
            var id_1 = matches[2];
            isMatch = [].concat(get(this.mo, 'childAssets.references', [])).some(function (_a) {
                var managedObject = _a.managedObject;
                return managedObject.id === id_1;
            });
            return isMatch;
        }
        return false;
    };
    AssetNode.prototype.refresh = function (mo, method) {
        if (mo === void 0) { mo = {}; }
        if (method === void 0) { method = 'GET'; }
        if (mo.id === this.mo.id) {
            this.mo = mo;
        }
        else if (method === 'DELETE') {
            this.parents.forEach(function (node) { return node.refresh(); });
            return;
        }
        if (this.events) {
            this.events.next(Action.REFRESH);
        }
    };
    AssetNode.prototype.click = function (options) {
        if (options === void 0) { options = {}; }
        if (this.isDevice) {
            this.service.preferBreadcrumb(this.parents);
            return;
        }
        if (!this.events) {
            this.hookEvents();
        }
        this.updateIcon(options.open);
        if (options.open) {
            this.events.next(Action.FETCH);
        }
    };
    AssetNode.prototype.addManagedObject = function (mo) {
        var childAdditions = this.mo.childAdditions;
        if (!this.isChildAddition(childAdditions, mo)) {
            this.add(this.service.createChildNode(mo));
        }
    };
    AssetNode.prototype.isChildAddition = function (childAdditions, mo) {
        return (childAdditions &&
            childAdditions.references.some(function (_a) {
                var id = _a.managedObject.id;
                return id === mo.id;
            }));
    };
    AssetNode.prototype.destroy = function () {
        this.onUpdateSubscription.unsubscribe();
    };
    Object.defineProperty(AssetNode.prototype, "canDrop", {
        get: function () {
            var _this = this;
            var nodeToMove = this.service.draggedData;
            if (nodeToMove) {
                var shouldGetChildOfItsOwn = !!nodeToMove.find(function (child) { return child === _this; });
                var isAlreadyChild = this.children
                    .some(function (child) { return child.mo && child.mo.id === nodeToMove.mo.id; });
                var preventMove = this === nodeToMove || shouldGetChildOfItsOwn || isAlreadyChild;
                return this.droppable && !preventMove;
            }
            return this.droppable;
        },
        enumerable: true,
        configurable: true
    });
    AssetNode.prototype.dragStart = function ($event) {
        _super.prototype.dragStart.call(this, $event);
        this.service.draggedData = this;
        this.service.rootNode.droppable = !this.isDevice;
    };
    AssetNode.prototype.dragEnd = function ($event) {
        _super.prototype.dragEnd.call(this, $event);
    };
    AssetNode.prototype.drop = function ($event) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var nodeToMove;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _super.prototype.drop.call(this, $event);
                        nodeToMove = this.service.draggedData;
                        if (!this.canDrop) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.moveNode(nodeToMove)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 3];
                    case 2:
                        this.draggedHover = false;
                        this.service.draggedData = undefined;
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    AssetNode.prototype.fetch = function () {
        return this.root ? this.service.getRootNodes() : this.service.getGroupItems(this.mo.id);
    };
    AssetNode.prototype.moveNode = function (nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var isCopy, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 6, 7, 8]);
                        return [4 /*yield*/, this.showDropConfirm(nodeToMove)];
                    case 1:
                        isCopy = _a.sent();
                        return [4 /*yield*/, this.verifyNodeAccess(nodeToMove)];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.addMovedNode(nodeToMove)];
                    case 3:
                        _a.sent();
                        if (!!isCopy) return [3 /*break*/, 5];
                        return [4 /*yield*/, this.removeMovedNode(nodeToMove)];
                    case 4:
                        _a.sent();
                        _a.label = 5;
                    case 5:
                        this.expand();
                        return [3 /*break*/, 8];
                    case 6:
                        ex_1 = _a.sent();
                        if (ex_1) {
                            this.service.alert.addServerFailure(ex_1);
                        }
                        return [3 /*break*/, 8];
                    case 7:
                        this.draggedHover = false;
                        this.service.draggedData = undefined;
                        return [7 /*endfinally*/];
                    case 8: return [2 /*return*/];
                }
            });
        });
    };
    AssetNode.prototype.showDropConfirm = function (nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var buttons;
            return tslib_1.__generator(this, function (_a) {
                this.confirm.title = gettext('Move');
                this.confirm.message = gettext('Do you want to move the group?');
                buttons = [{
                        label: gettext('Cancel'),
                        action: function () { return Promise.reject(); }
                    }, {
                        label: gettext('Move'),
                        status: 'default',
                        action: function () { return Promise.resolve(false); }
                    }];
                if (nodeToMove.isDevice) {
                    this.confirm.title = gettext('Move or add');
                    this.confirm.message = gettext('Do you want to move or add the device?');
                    buttons.push({
                        label: gettext('Add'),
                        status: 'primary',
                        action: function () { return Promise.resolve(true); }
                    });
                }
                return [2 /*return*/, this.confirm.show(buttons)];
            });
        });
    };
    AssetNode.prototype.verifyNodeAccess = function (nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.service.inventory.update({ id: nodeToMove.mo.id })];
            });
        });
    };
    AssetNode.prototype.addMovedNode = function (nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var mo, data, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.root) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.service.inventory.update({ id: nodeToMove.mo.id, type: GroupFragment.groupType })];
                    case 1:
                        data = (_a.sent()).data;
                        mo = data;
                        return [3 /*break*/, 4];
                    case 2: return [4 /*yield*/, this.service.inventory.childAssetsAdd(nodeToMove.mo, this.mo)];
                    case 3:
                        data = (_a.sent()).data;
                        mo = data;
                        _a.label = 4;
                    case 4:
                        this.addManagedObject(mo);
                        return [2 /*return*/];
                }
            });
        });
    };
    AssetNode.prototype.removeMovedNode = function (nodeToMove) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, parent_1, e_1_1;
            var e_1, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        _d.trys.push([0, 8, 9, 10]);
                        _a = tslib_1.__values(nodeToMove.parents), _b = _a.next();
                        _d.label = 1;
                    case 1:
                        if (!!_b.done) return [3 /*break*/, 7];
                        parent_1 = _b.value;
                        if (parent_1.mo && parent_1.mo.type === GroupFragment.dynamicGroupType) {
                            return [3 /*break*/, 7]; // smart groups don't need to be changed
                        }
                        if (!parent_1.root) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.service.inventory.update({ id: nodeToMove.mo.id, type: GroupFragment.subGroupType })];
                    case 2:
                        _d.sent();
                        return [3 /*break*/, 5];
                    case 3: return [4 /*yield*/, this.service.inventory.childAssetsRemove(nodeToMove.mo, parent_1.mo)];
                    case 4:
                        _d.sent();
                        _d.label = 5;
                    case 5:
                        parent_1.remove(nodeToMove);
                        _d.label = 6;
                    case 6:
                        _b = _a.next();
                        return [3 /*break*/, 1];
                    case 7: return [3 /*break*/, 10];
                    case 8:
                        e_1_1 = _d.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 10];
                    case 9:
                        try {
                            if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
                        }
                        finally { if (e_1) throw e_1.error; }
                        return [7 /*endfinally*/];
                    case 10: return [2 /*return*/];
                }
            });
        });
    };
    AssetNode.prototype.hookEvents = function () {
        var _this = this;
        this.events = new Subject();
        this.events.subscribe(function (evt) {
            if (!_this.loading) {
                _this.handleEvent(evt);
            }
        });
    };
    AssetNode.prototype.handleEvent = function (evt) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        if (!(!this.children.length && evt === Action.FETCH)) return [3 /*break*/, 2];
                        this.loading = true;
                        _a = this.addNodes;
                        return [4 /*yield*/, this.fetch()];
                    case 1:
                        _a.apply(this, [_c.sent()]);
                        this.loading = false;
                        return [3 /*break*/, 5];
                    case 2:
                        if (!(evt === Action.NEXT)) return [3 /*break*/, 4];
                        this.loadMoreNode.loading = true;
                        _b = this.addNodes;
                        return [4 /*yield*/, this.paging.next()];
                    case 3:
                        _b.apply(this, [_c.sent()]);
                        this.loadMoreNode.loading = false;
                        return [3 /*break*/, 5];
                    case 4:
                        if (evt === Action.REFRESH) {
                            this.loading = false;
                            this.paging = undefined;
                            this.loadMoreNode = undefined;
                            this.empty();
                            this.events.next(Action.FETCH);
                        }
                        _c.label = 5;
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    AssetNode.prototype.addNodes = function (res) {
        var _this = this;
        if (res.paging) {
            var _a = this.paging = res.paging, pageSize = _a.pageSize, currentPage = _a.currentPage, totalPages = _a.totalPages;
            if (currentPage === 1) {
                this.empty();
            }
            var itemsCount = res.data.length;
            var moreItemsAvailable = totalPages ? (currentPage < totalPages) : (itemsCount === pageSize);
            this.toggleLoadMore(moreItemsAvailable);
        }
        (res.data || res).map(function (mo) { return _this.addManagedObject(mo); });
    };
    AssetNode.prototype.updateIcon = function (open) {
        this.icon = this.service.groups.icon(
        // if it's root we are going to pass a fake mo to get the same icon as groups
        this.root ? { type: GroupFragment.groupType } : this.mo, open);
    };
    AssetNode.prototype.toggleLoadMore = function (show) {
        var _this = this;
        if (!this.loadMoreNode && show) {
            this.loadMoreNode = new LoadMoreNode();
            this.add(this.loadMoreNode);
            this.loadMoreNode.click = function () { return _this.events.next(Action.NEXT); };
        }
        if (this.loadMoreNode) {
            this.loadMoreNode.hidden = !show;
        }
    };
    return AssetNode;
}(NavigatorNode));
export { AssetNode };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtbm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvYXNzZXRzLW5hdmlnYXRvci8iLCJzb3VyY2VzIjpbImFzc2V0LW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBZ0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFFLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFFN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV2RCxJQUFLLE1BSUo7QUFKRCxXQUFLLE1BQU07SUFDVCxxQ0FBSyxDQUFBO0lBQ0wsbUNBQUksQ0FBQTtJQUNKLHlDQUFPLENBQUE7QUFDVCxDQUFDLEVBSkksTUFBTSxLQUFOLE1BQU0sUUFJVjtBQUVEO0lBQStCLHFDQUFhO0lBeUIxQyxtQkFDWSxPQUF5QixFQUNuQyxNQUFXO1FBQVgsdUJBQUEsRUFBQSxXQUFXO1FBRmIsWUFJRSxrQkFBTSxNQUFNLENBQUMsU0FXZDtRQWRXLGFBQU8sR0FBUCxPQUFPLENBQWtCO1FBSW5DLEtBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSSxDQUFDLElBQUksSUFBSSxLQUFLLENBQUM7UUFDL0IsS0FBSSxDQUFDLEVBQUUsR0FBRyxLQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUN4QixLQUFJLENBQUMsSUFBSSxHQUFHLEtBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFVLEtBQUksQ0FBQyxFQUFFLENBQUMsRUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFTLEtBQUksQ0FB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LElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQztTQUNsQztJQUNILENBQUM7SUFDSCxnQkFBQztBQUFELENBQUMsQUFsUkQsQ0FBK0IsYUFBYSxHQWtSM0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYWdpbmcgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBDbGlja09wdGlvbnMsIGdldHRleHQsIE5hdmlnYXRvck5vZGUsIERldmljZVN0YXR1c0NvbXBvbmVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXNzZXROb2RlTW8sIEFzc2V0Tm9kZVNlcnZpY2UgfSBmcm9tICcuL2Fzc2V0LW5vZGUuc2VydmljZSc7XG5pbXBvcnQgeyBMb2FkTW9yZU5vZGUgfSBmcm9tICcuL2xvYWQtbW9yZS1ub2RlJztcbmltcG9ydCB7IEdyb3VwRnJhZ21lbnQgfSBmcm9tICcuL2dyb3VwLWZyYWdtZW50Lm1vZGVsJztcblxuZW51bSBBY3Rpb24ge1xuICBGRVRDSCxcbiAgTkVYVCxcbiAgUkVGUkVTSFxufVxuXG5leHBvcnQgY2xhc3MgQXNzZXROb2RlIGV4dGVuZHMgTmF2aWdhdG9yTm9kZSB7XG4gIHJvb3Q6IGJvb2xlYW47XG4gIG1vOiBhbnk7XG5cbiAgZ2V0IGxhYmVsKCkge1xuICAgIHJldHVybiAodGhpcy5yb290ICYmIGdldHRleHQoJ0dyb3VwcycpKSB8fCB0aGlzLm1vLm5hbWUgfHwgJy0tJztcbiAgfVxuXG4gIGdldCBoYXNDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5yb290IHx8IHRoaXMuc2VydmljZS5ncm91cHMuaXNHcm91cCh0aGlzLm1vKTtcbiAgfVxuXG4gIGdldCBpY29uQ29tcG9uZW50KCkge1xuICAgIHJldHVybiB0aGlzLmlzRGV2aWNlID8gRGV2aWNlU3RhdHVzQ29tcG9uZW50IDogdW5kZWZpbmVkO1xuICB9XG5cbiAgZ2V0IGlzRGV2aWNlKCkge1xuICAgIHJldHVybiAhISh0aGlzLm1vLmM4eV9Jc0RldmljZSB8fCBnZXQodGhpcy5tbywgJ2RldmljZVBhcmVudHMucmVmZXJlbmNlcy5sZW5ndGgnKSk7XG4gIH1cblxuICBwcml2YXRlIGV2ZW50czogU3ViamVjdDxBY3Rpb24+O1xuICBwcml2YXRlIHBhZ2luZzogUGFnaW5nPEFzc2V0Tm9kZU1vPjtcbiAgcHJpdmF0ZSBsb2FkTW9yZU5vZGU6IExvYWRNb3JlTm9kZTtcbiAgcHJpdmF0ZSBvblVwZGF0ZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBzZXJ2aWNlOiBBc3NldE5vZGVTZXJ2aWNlLFxuICAgIGNvbmZpZyA9IHt9XG4gICkge1xuICAgIHN1cGVyKGNvbmZpZyk7XG4gICAgdGhpcy5yb290ID0gdGhpcy5yb290IHx8IGZhbHNlO1xuICAgIHRoaXMubW8gPSB0aGlzLm1vIHx8IHt9O1xuICAgIHRoaXMucGF0aCA9IHRoaXMucm9vdCA/ICdncm91cCcgOiAodGhpcy5pc0RldmljZSA/IGBkZXZpY2UvJHt0aGlzLm1vLmlkfWAgOiBgZ3JvdXAvJHt0aGlzLm1vLmlkfWApO1xuICAgIHRoaXMuZHJhZ2dhYmxlID0gIXRoaXMuc2VydmljZS5tb2R1bGVDb25maWcuZGlzYWJsZURyYWdBbmREcm9wICYmICF0aGlzLnJvb3Q7XG4gICAgdGhpcy5kcm9wcGFibGUgPSAhdGhpcy5zZXJ2aWNlLm1vZHVsZUNvbmZpZy5kaXNhYmxlRHJhZ0FuZERyb3AgJiYgIXRoaXMuaXNEZXZpY2U7XG4gICAgdGhpcy5yb3V0ZXJMaW5rRXhhY3QgPSB0aGlzLnJvb3Q7XG4gICAgdGhpcy51cGRhdGVJY29uKGZhbHNlKTtcbiAgICB0aGlzLm9uVXBkYXRlU3Vic2NyaXB0aW9uID0gdGhpcy5zZXJ2aWNlXG4gICAgICAub25VcGRhdGUodGhpcylcbiAgICAgIC5zdWJzY3JpYmUoKHsgZGF0YSwgbWV0aG9kIH0pID0+IHRoaXMucmVmcmVzaChkYXRhLCBtZXRob2QpKTtcbiAgfVxuXG4gIG9wZW5PblN0YXJ0KHVybCkge1xuICAgIGNvbnN0IHVybFJlZ2V4ID0gL15cXC9ncm91cFxcLy87XG4gICAgaWYgKHRoaXMucm9vdCkge1xuICAgICAgaWYgKHRoaXMuc2VydmljZS5tb2R1bGVDb25maWcub3Blbk9uU3RhcnQgfHwgdXJsUmVnZXgudGVzdCh1cmwpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBtYXRjaGVzID0gdXJsLm1hdGNoKC9cXC8oZ3JvdXApXFwvKFxcZCspLyk7XG4gICAgbGV0IGlzTWF0Y2ggPSBmYWxzZTtcbiAgICBpZiAobWF0Y2hlcykge1xuICAgICAgY29uc3QgaWQgPSBtYXRjaGVzWzJdO1xuICAgICAgaXNNYXRjaCA9IFtdLmNvbmNhdChcbiAgICAgICAgZ2V0KHRoaXMubW8sICdjaGlsZEFzc2V0cy5yZWZlcmVuY2VzJywgW10pLFxuICAgICAgKS5zb21lKCh7IG1hbmFnZWRPYmplY3QgfSkgPT4gbWFuYWdlZE9iamVjdC5pZCA9PT0gaWQpO1xuICAgICAgcmV0dXJuIGlzTWF0Y2g7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJlZnJlc2gobW86IGFueSA9IHt9LCBtZXRob2QgPSAnR0VUJykge1xuICAgIGlmIChtby5pZCA9PT0gdGhpcy5tby5pZCkge1xuICAgICAgdGhpcy5tbyA9IG1vO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnREVMRVRFJykge1xuICAgICAgdGhpcy5wYXJlbnRzLmZvckVhY2goKG5vZGU6IEFzc2V0Tm9kZSkgPT4gbm9kZS5yZWZyZXNoKCkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5ldmVudHMpIHtcbiAgICAgIHRoaXMuZXZlbnRzLm5leHQoQWN0aW9uLlJFRlJFU0gpO1xuICAgIH1cbiAgfVxuXG4gIGNsaWNrKG9wdGlvbnM6IENsaWNrT3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKHRoaXMuaXNEZXZpY2UpIHtcbiAgICAgIHRoaXMuc2VydmljZS5wcmVmZXJCcmVhZGNydW1iKHRoaXMucGFyZW50cyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy5ldmVudHMpIHtcbiAgICAgIHRoaXMuaG9va0V2ZW50cygpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlSWNvbihvcHRpb25zLm9wZW4pO1xuICAgIGlmIChvcHRpb25zLm9wZW4pIHtcbiAgICAgIHRoaXMuZXZlbnRzLm5leHQoQWN0aW9uLkZFVENIKTtcbiAgICB9XG4gIH1cblxuICBhZGRNYW5hZ2VkT2JqZWN0KG1vKSB7XG4gICAgY29uc3QgeyBjaGlsZEFkZGl0aW9ucyB9ID0gdGhpcy5tbztcbiAgICBpZiAoIXRoaXMuaXNDaGlsZEFkZGl0aW9uKGNoaWxkQWRkaXRpb25zLCBtbykpIHtcbiAgICAgIHRoaXMuYWRkKHRoaXMuc2VydmljZS5jcmVhdGVDaGlsZE5vZGUobW8pKTtcbiAgICB9XG4gIH1cblxuICBpc0NoaWxkQWRkaXRpb24oY2hpbGRBZGRpdGlvbnMsIG1vKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIGNoaWxkQWRkaXRpb25zICYmXG4gICAgICBjaGlsZEFkZGl0aW9ucy5yZWZlcmVuY2VzLnNvbWUoKHsgbWFuYWdlZE9iamVjdDogeyBpZCB9IH0pID0+IGlkID09PSBtby5pZClcbiAgICApO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLm9uVXBkYXRlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBnZXQgY2FuRHJvcCgpIHtcbiAgICBjb25zdCBub2RlVG9Nb3ZlID0gdGhpcy5zZXJ2aWNlLmRyYWdnZWREYXRhO1xuICAgIGlmIChub2RlVG9Nb3ZlKSB7XG4gICAgICBjb25zdCBzaG91bGRHZXRDaGlsZE9mSXRzT3duID0gISFub2RlVG9Nb3ZlLmZpbmQoKGNoaWxkKSA9PiBjaGlsZCA9PT0gdGhpcyk7XG4gICAgICBjb25zdCBpc0FscmVhZHlDaGlsZCA9ICh0aGlzLmNoaWxkcmVuIGFzIEFzc2V0Tm9kZVtdKVxuICAgICAgICAuc29tZSgoY2hpbGQpID0+IGNoaWxkLm1vICYmIGNoaWxkLm1vLmlkID09PSBub2RlVG9Nb3ZlLm1vLmlkKTtcbiAgICAgIGNvbnN0IHByZXZlbnRNb3ZlID0gdGhpcyA9PT0gbm9kZVRvTW92ZSB8fCBzaG91bGRHZXRDaGlsZE9mSXRzT3duIHx8IGlzQWxyZWFkeUNoaWxkO1xuICAgICAgcmV0dXJuIHRoaXMuZHJvcHBhYmxlICYmICFwcmV2ZW50TW92ZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZHJvcHBhYmxlO1xuICB9XG5cbiAgZHJhZ1N0YXJ0KCRldmVudCkge1xuICAgIHN1cGVyLmRyYWdTdGFydCgkZXZlbnQpO1xuICAgIHRoaXMuc2VydmljZS5kcmFnZ2VkRGF0YSA9IHRoaXM7XG4gICAgdGhpcy5zZXJ2aWNlLnJvb3ROb2RlLmRyb3BwYWJsZSA9ICF0aGlzLmlzRGV2aWNlO1xuICB9XG5cbiAgZHJhZ0VuZCgkZXZlbnQpIHtcbiAgICBzdXBlci5kcmFnRW5kKCRldmVudCk7XG4gIH1cblxuICBhc3luYyBkcm9wKCRldmVudCkge1xuICAgIHN1cGVyLmRyb3AoJGV2ZW50KTtcbiAgICBjb25zdCBub2RlVG9Nb3ZlID0gdGhpcy5zZXJ2aWNlLmRyYWdnZWREYXRhO1xuICAgIGlmICh0aGlzLmNhbkRyb3ApIHtcbiAgICAgIGF3YWl0IHRoaXMubW92ZU5vZGUobm9kZVRvTW92ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG4gICAgICB0aGlzLnNlcnZpY2UuZHJhZ2dlZERhdGEgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGZldGNoKCkge1xuICAgIHJldHVybiB0aGlzLnJvb3QgPyB0aGlzLnNlcnZpY2UuZ2V0Um9vdE5vZGVzKCkgOiB0aGlzLnNlcnZpY2UuZ2V0R3JvdXBJdGVtcyh0aGlzLm1vLmlkKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbW92ZU5vZGUobm9kZVRvTW92ZTogQXNzZXROb2RlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGlzQ29weSA9IGF3YWl0IHRoaXMuc2hvd0Ryb3BDb25maXJtKG5vZGVUb01vdmUpO1xuICAgICAgYXdhaXQgdGhpcy52ZXJpZnlOb2RlQWNjZXNzKG5vZGVUb01vdmUpO1xuICAgICAgYXdhaXQgdGhpcy5hZGRNb3ZlZE5vZGUobm9kZVRvTW92ZSk7XG4gICAgICBpZiAoIWlzQ29weSkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlbW92ZU1vdmVkTm9kZShub2RlVG9Nb3ZlKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZXhwYW5kKCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGlmIChleCkge1xuICAgICAgICB0aGlzLnNlcnZpY2UuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG4gICAgICB0aGlzLnNlcnZpY2UuZHJhZ2dlZERhdGEgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzaG93RHJvcENvbmZpcm0obm9kZVRvTW92ZTogQXNzZXROb2RlKSB7XG4gICAgdGhpcy5jb25maXJtLnRpdGxlID0gZ2V0dGV4dCgnTW92ZScpO1xuICAgIHRoaXMuY29uZmlybS5tZXNzYWdlID0gZ2V0dGV4dCgnRG8geW91IHdhbnQgdG8gbW92ZSB0aGUgZ3JvdXA/Jyk7XG4gICAgY29uc3QgYnV0dG9uczogYW55ID0gW3tcbiAgICAgIGxhYmVsOiBnZXR0ZXh0KCdDYW5jZWwnKSxcbiAgICAgIGFjdGlvbjogKCkgPT4gUHJvbWlzZS5yZWplY3QoKVxuICAgIH0sIHtcbiAgICAgIGxhYmVsOiBnZXR0ZXh0KCdNb3ZlJyksXG4gICAgICBzdGF0dXM6ICdkZWZhdWx0JyxcbiAgICAgIGFjdGlvbjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKVxuICAgIH1dO1xuICAgIGlmIChub2RlVG9Nb3ZlLmlzRGV2aWNlKSB7XG4gICAgICB0aGlzLmNvbmZpcm0udGl0bGUgPSBnZXR0ZXh0KCdNb3ZlIG9yIGFkZCcpO1xuICAgICAgdGhpcy5jb25maXJtLm1lc3NhZ2UgPSBnZXR0ZXh0KCdEbyB5b3Ugd2FudCB0byBtb3ZlIG9yIGFkZCB0aGUgZGV2aWNlPycpO1xuICAgICAgYnV0dG9ucy5wdXNoKHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0FkZCcpLFxuICAgICAgICBzdGF0dXM6ICdwcmltYXJ5JyxcbiAgICAgICAgYWN0aW9uOiAoKSA9PiBQcm9taXNlLnJlc29sdmUodHJ1ZSlcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jb25maXJtLnNob3coYnV0dG9ucyk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHZlcmlmeU5vZGVBY2Nlc3Mobm9kZVRvTW92ZTogQXNzZXROb2RlKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5pbnZlbnRvcnkudXBkYXRlKHsgaWQ6IG5vZGVUb01vdmUubW8uaWQgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGFkZE1vdmVkTm9kZShub2RlVG9Nb3ZlOiBBc3NldE5vZGUpIHtcbiAgICBsZXQgbW87XG4gICAgaWYgKHRoaXMucm9vdCkge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLnNlcnZpY2UuaW52ZW50b3J5LnVwZGF0ZSh7IGlkOiBub2RlVG9Nb3ZlLm1vLmlkLCB0eXBlOiBHcm91cEZyYWdtZW50Lmdyb3VwVHlwZSB9KTtcbiAgICAgIG1vID0gZGF0YTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLnNlcnZpY2UuaW52ZW50b3J5LmNoaWxkQXNzZXRzQWRkKG5vZGVUb01vdmUubW8sIHRoaXMubW8pO1xuICAgICAgbW8gPSBkYXRhO1xuICAgIH1cbiAgICB0aGlzLmFkZE1hbmFnZWRPYmplY3QobW8pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZW1vdmVNb3ZlZE5vZGUobm9kZVRvTW92ZTogQXNzZXROb2RlKSB7XG4gICAgZm9yIChjb25zdCBwYXJlbnQgb2Ygbm9kZVRvTW92ZS5wYXJlbnRzIGFzIEFzc2V0Tm9kZVtdKSB7XG4gICAgICBpZiAocGFyZW50Lm1vICYmIHBhcmVudC5tby50eXBlID09PSBHcm91cEZyYWdtZW50LmR5bmFtaWNHcm91cFR5cGUpIHtcbiAgICAgICAgYnJlYWs7IC8vIHNtYXJ0IGdyb3VwcyBkb24ndCBuZWVkIHRvIGJlIGNoYW5nZWRcbiAgICAgIH1cbiAgICAgIGlmIChwYXJlbnQucm9vdCkge1xuICAgICAgICBhd2FpdCB0aGlzLnNlcnZpY2UuaW52ZW50b3J5LnVwZGF0ZSh7IGlkOiBub2RlVG9Nb3ZlLm1vLmlkLCB0eXBlOiBHcm91cEZyYWdtZW50LnN1Ykdyb3VwVHlwZSB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2VydmljZS5pbnZlbnRvcnkuY2hpbGRBc3NldHNSZW1vdmUobm9kZVRvTW92ZS5tbywgcGFyZW50Lm1vKTtcbiAgICAgIH1cbiAgICAgIHBhcmVudC5yZW1vdmUobm9kZVRvTW92ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBob29rRXZlbnRzKCkge1xuICAgIHRoaXMuZXZlbnRzID0gbmV3IFN1YmplY3QoKTtcbiAgICB0aGlzLmV2ZW50cy5zdWJzY3JpYmUoKGV2dCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmxvYWRpbmcpIHtcbiAgICAgICAgdGhpcy5oYW5kbGVFdmVudChldnQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVFdmVudChldnQ6IEFjdGlvbikge1xuICAgIGlmICghdGhpcy5jaGlsZHJlbi5sZW5ndGggJiYgZXZ0ID09PSBBY3Rpb24uRkVUQ0gpIHtcbiAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgICB0aGlzLmFkZE5vZGVzKGF3YWl0IHRoaXMuZmV0Y2goKSk7XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKGV2dCA9PT0gQWN0aW9uLk5FWFQpIHtcbiAgICAgIHRoaXMubG9hZE1vcmVOb2RlLmxvYWRpbmcgPSB0cnVlO1xuICAgICAgdGhpcy5hZGROb2Rlcyhhd2FpdCB0aGlzLnBhZ2luZy5uZXh0KCkpO1xuICAgICAgdGhpcy5sb2FkTW9yZU5vZGUubG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoZXZ0ID09PSBBY3Rpb24uUkVGUkVTSCkge1xuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLnBhZ2luZyA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMubG9hZE1vcmVOb2RlID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5lbXB0eSgpO1xuICAgICAgdGhpcy5ldmVudHMubmV4dChBY3Rpb24uRkVUQ0gpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkTm9kZXMocmVzKSB7XG4gICAgaWYgKHJlcy5wYWdpbmcpIHtcbiAgICAgIGNvbnN0IHsgcGFnZVNpemUsIGN1cnJlbnRQYWdlLCB0b3RhbFBhZ2VzIH0gPSB0aGlzLnBhZ2luZyA9IHJlcy5wYWdpbmc7XG4gICAgICBpZiAoY3VycmVudFBhZ2UgPT09IDEpIHtcbiAgICAgICAgdGhpcy5lbXB0eSgpO1xuICAgICAgfVxuICAgICAgY29uc3QgaXRlbXNDb3VudCA9IHJlcy5kYXRhLmxlbmd0aDtcbiAgICAgIGNvbnN0IG1vcmVJdGVtc0F2YWlsYWJsZSA9IHRvdGFsUGFnZXMgPyAoY3VycmVudFBhZ2UgPCB0b3RhbFBhZ2VzKSA6IChpdGVtc0NvdW50ID09PSBwYWdlU2l6ZSk7XG4gICAgICB0aGlzLnRvZ2dsZUxvYWRNb3JlKG1vcmVJdGVtc0F2YWlsYWJsZSk7XG4gICAgfVxuICAgIChyZXMuZGF0YSB8fCByZXMpLm1hcCgobW8pID0+IHRoaXMuYWRkTWFuYWdlZE9iamVjdChtbykpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJY29uKG9wZW4pIHtcbiAgICB0aGlzLmljb24gPSB0aGlzLnNlcnZpY2UuZ3JvdXBzLmljb24oXG4gICAgICAvLyBpZiBpdCdzIHJvb3Qgd2UgYXJlIGdvaW5nIHRvIHBhc3MgYSBmYWtlIG1vIHRvIGdldCB0aGUgc2FtZSBpY29uIGFzIGdyb3Vwc1xuICAgICAgdGhpcy5yb290ID8geyB0eXBlOiBHcm91cEZyYWdtZW50Lmdyb3VwVHlwZSB9IDogdGhpcy5tbyxcbiAgICAgIG9wZW5cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVMb2FkTW9yZShzaG93OiBib29sZWFuKSB7XG4gICAgaWYgKCF0aGlzLmxvYWRNb3JlTm9kZSAmJiBzaG93KSB7XG4gICAgICB0aGlzLmxvYWRNb3JlTm9kZSA9IG5ldyBMb2FkTW9yZU5vZGUoKTtcbiAgICAgIHRoaXMuYWRkKHRoaXMubG9hZE1vcmVOb2RlKTtcbiAgICAgIHRoaXMubG9hZE1vcmVOb2RlLmNsaWNrID0gKCkgPT4gdGhpcy5ldmVudHMubmV4dChBY3Rpb24uTkVYVCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubG9hZE1vcmVOb2RlKSB7XG4gICAgICB0aGlzLmxvYWRNb3JlTm9kZS5oaWRkZW4gPSAhc2hvdztcbiAgICB9XG4gIH1cbn1cbiJdfQ==