!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@c8y/ngx-components"),require("@c8y/client"),require("@c8y/ngx-components/api"),require("rxjs"),require("rxjs/operators"),require("lodash-es")):"function"==typeof define&&define.amd?define("@c8y/ngx-components/assets-navigator",["exports","@angular/core","@c8y/ngx-components","@c8y/client","@c8y/ngx-components/api","rxjs","rxjs/operators","lodash-es"],t):t(((e=e||self).c8y=e.c8y||{},e.c8y["ngx-components"]=e.c8y["ngx-components"]||{},e.c8y["ngx-components"]["assets-navigator"]={}),e.ng.core,e.c8y["ngx-components"],e.client,e.c8y["ngx-components"].api,e.rxjs,e.rxjs.operators,e.lodashEs)}(this,(function(e,t,r,o,n,i,a,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function u(e,t){function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var p=function(){return(p=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function d(e,t,r,o){var n,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,r,a):n(t,r))||a);return i>3&&a&&Object.defineProperty(t,r,a),a}function h(e,t){return function(r,o){t(r,o,e)}}function l(e,t,r,o){return new(r||(r=Promise))((function(n,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){e.done?n(e.value):new r((function(t){t(e.value)})).then(a,s)}c((o=o.apply(e,t||[])).next())}))}function y(e,t){var r,o,n,i,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){a.label=i[1];break}if(6===i[0]&&a.label<n[1]){a.label=n[1],n=i;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(i);break}n[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function f(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function g(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var o,n,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)a.push(o.value)}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return a}var v,m,b=new t.InjectionToken("AssetNodeConfig"),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.priority=-1/0,t.label=r.gettext("Load more"),t.icon="plus",t.droppable=!0,t}return u(t,e),t}(r.NavigatorNode);(v=e.GroupFragment||(e.GroupFragment={})).groupType="c8y_DeviceGroup",v.subGroupType="c8y_DeviceSubgroup",v.groupFragmentType="c8y_IsDeviceGroup",v.dataBrokerSourceFragment="c8y_BrokerSource",v.dynamicGroupType="c8y_DynamicGroup",v.dynamicGroupFragment="c8y_IsDynamicGroup",v.dynamicGroupColumnConfig="c8y_UIDeviceFilterConfig",v.dynamicGroupQueryString="c8y_DeviceQueryString",function(e){e[e.FETCH=0]="FETCH",e[e.NEXT=1]="NEXT",e[e.REFRESH=2]="REFRESH"}(m||(m={}));var N=function(t){function o(e,r){void 0===r&&(r={});var o=t.call(this,r)||this;return o.service=e,o.root=o.root||!1,o.mo=o.mo||{},o.path=o.root?"group":o.isDevice?"device/"+o.mo.id:"group/"+o.mo.id,o.draggable=!o.service.moduleConfig.disableDragAndDrop&&!o.root,o.droppable=!o.service.moduleConfig.disableDragAndDrop&&!o.isDevice,o.routerLinkExact=o.root,o.updateIcon(!1),o.onUpdateSubscription=o.service.onUpdate(o).subscribe((function(e){var t=e.data,r=e.method;return o.refresh(t,r)})),o}return u(o,t),Object.defineProperty(o.prototype,"label",{get:function(){return this.root&&r.gettext("Groups")||this.mo.name||"--"},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"hasChildren",{get:function(){return this.root||this.service.groups.isGroup(this.mo)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"iconComponent",{get:function(){return this.isDevice?r.DeviceStatusComponent:void 0},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"isDevice",{get:function(){return!(!this.mo.c8y_IsDevice&&!s.get(this.mo,"deviceParents.references.length"))},enumerable:!0,configurable:!0}),o.prototype.openOnStart=function(e){if(this.root&&(this.service.moduleConfig.openOnStart||/^\/group\//.test(e)))return!0;var t=e.match(/\/(group)\/(\d+)/);if(t){var r=t[2];return[].concat(s.get(this.mo,"childAssets.references",[])).some((function(e){return e.managedObject.id===r}))}return!1},o.prototype.refresh=function(e,t){if(void 0===e&&(e={}),void 0===t&&(t="GET"),e.id===this.mo.id)this.mo=e;else if("DELETE"===t)return void this.parents.forEach((function(e){return e.refresh()}));this.events&&this.events.next(m.REFRESH)},o.prototype.click=function(e){void 0===e&&(e={}),this.isDevice?this.service.preferBreadcrumb(this.parents):(this.events||this.hookEvents(),this.updateIcon(e.open),e.open&&this.events.next(m.FETCH))},o.prototype.addManagedObject=function(e){var t=this.mo.childAdditions;this.isChildAddition(t,e)||this.add(this.service.createChildNode(e))},o.prototype.isChildAddition=function(e,t){return e&&e.references.some((function(e){return e.managedObject.id===t.id}))},o.prototype.destroy=function(){this.onUpdateSubscription.unsubscribe()},Object.defineProperty(o.prototype,"canDrop",{get:function(){var e=this,t=this.service.draggedData;if(t){var r=!!t.find((function(t){return t===e})),o=this.children.some((function(e){return e.mo&&e.mo.id===t.mo.id})),n=this===t||r||o;return this.droppable&&!n}return this.droppable},enumerable:!0,configurable:!0}),o.prototype.dragStart=function(e){t.prototype.dragStart.call(this,e),this.service.draggedData=this,this.service.rootNode.droppable=!this.isDevice},o.prototype.dragEnd=function(e){t.prototype.dragEnd.call(this,e)},o.prototype.drop=function(e){return l(this,void 0,void 0,(function(){var r;return y(this,(function(o){switch(o.label){case 0:return t.prototype.drop.call(this,e),r=this.service.draggedData,this.canDrop?[4,this.moveNode(r)]:[3,2];case 1:return o.sent(),[3,3];case 2:this.draggedHover=!1,this.service.draggedData=void 0,o.label=3;case 3:return[2]}}))}))},o.prototype.fetch=function(){return this.root?this.service.getRootNodes():this.service.getGroupItems(this.mo.id)},o.prototype.moveNode=function(e){return l(this,void 0,void 0,(function(){var t,r;return y(this,(function(o){switch(o.label){case 0:return o.trys.push([0,6,7,8]),[4,this.showDropConfirm(e)];case 1:return t=o.sent(),[4,this.verifyNodeAccess(e)];case 2:return o.sent(),[4,this.addMovedNode(e)];case 3:return o.sent(),t?[3,5]:[4,this.removeMovedNode(e)];case 4:o.sent(),o.label=5;case 5:return this.expand(),[3,8];case 6:return(r=o.sent())&&this.service.alert.addServerFailure(r),[3,8];case 7:return this.draggedHover=!1,this.service.draggedData=void 0,[7];case 8:return[2]}}))}))},o.prototype.showDropConfirm=function(e){return l(this,void 0,void 0,(function(){var t;return y(this,(function(o){return this.confirm.title=r.gettext("Move"),this.confirm.message=r.gettext("Do you want to move the group?"),t=[{label:r.gettext("Cancel"),action:function(){return Promise.reject()}},{label:r.gettext("Move"),status:"default",action:function(){return Promise.resolve(!1)}}],e.isDevice&&(this.confirm.title=r.gettext("Move or add"),this.confirm.message=r.gettext("Do you want to move or add the device?"),t.push({label:r.gettext("Add"),status:"primary",action:function(){return Promise.resolve(!0)}})),[2,this.confirm.show(t)]}))}))},o.prototype.verifyNodeAccess=function(e){return l(this,void 0,void 0,(function(){return y(this,(function(t){return[2,this.service.inventory.update({id:e.mo.id})]}))}))},o.prototype.addMovedNode=function(t){return l(this,void 0,void 0,(function(){var r,o;return y(this,(function(n){switch(n.label){case 0:return this.root?[4,this.service.inventory.update({id:t.mo.id,type:e.GroupFragment.groupType})]:[3,2];case 1:return o=n.sent().data,r=o,[3,4];case 2:return[4,this.service.inventory.childAssetsAdd(t.mo,this.mo)];case 3:o=n.sent().data,r=o,n.label=4;case 4:return this.addManagedObject(r),[2]}}))}))},o.prototype.removeMovedNode=function(t){return l(this,void 0,void 0,(function(){var r,o,n,i,a,s;return y(this,(function(c){switch(c.label){case 0:c.trys.push([0,8,9,10]),r=f(t.parents),o=r.next(),c.label=1;case 1:return o.done?[3,7]:(n=o.value).mo&&n.mo.type===e.GroupFragment.dynamicGroupType?[3,7]:n.root?[4,this.service.inventory.update({id:t.mo.id,type:e.GroupFragment.subGroupType})]:[3,3];case 2:return c.sent(),[3,5];case 3:return[4,this.service.inventory.childAssetsRemove(t.mo,n.mo)];case 4:c.sent(),c.label=5;case 5:n.remove(t),c.label=6;case 6:return o=r.next(),[3,1];case 7:return[3,10];case 8:return i=c.sent(),a={error:i},[3,10];case 9:try{o&&!o.done&&(s=r.return)&&s.call(r)}finally{if(a)throw a.error}return[7];case 10:return[2]}}))}))},o.prototype.hookEvents=function(){var e=this;this.events=new i.Subject,this.events.subscribe((function(t){e.loading||e.handleEvent(t)}))},o.prototype.handleEvent=function(e){return l(this,void 0,void 0,(function(){var t,r;return y(this,(function(o){switch(o.label){case 0:return this.children.length||e!==m.FETCH?[3,2]:(this.loading=!0,t=this.addNodes,[4,this.fetch()]);case 1:return t.apply(this,[o.sent()]),this.loading=!1,[3,5];case 2:return e!==m.NEXT?[3,4]:(this.loadMoreNode.loading=!0,r=this.addNodes,[4,this.paging.next()]);case 3:return r.apply(this,[o.sent()]),this.loadMoreNode.loading=!1,[3,5];case 4:e===m.REFRESH&&(this.loading=!1,this.paging=void 0,this.loadMoreNode=void 0,this.empty(),this.events.next(m.FETCH)),o.label=5;case 5:return[2]}}))}))},o.prototype.addNodes=function(e){var t=this;if(e.paging){var r=this.paging=e.paging,o=r.pageSize,n=r.currentPage,i=r.totalPages;1===n&&this.empty();var a=e.data.length,s=i?n<i:a===o;this.toggleLoadMore(s)}(e.data||e).map((function(e){return t.addManagedObject(e)}))},o.prototype.updateIcon=function(t){this.icon=this.service.groups.icon(this.root?{type:e.GroupFragment.groupType}:this.mo,t)},o.prototype.toggleLoadMore=function(e){var t=this;!this.loadMoreNode&&e&&(this.loadMoreNode=new S,this.add(this.loadMoreNode),this.loadMoreNode.click=function(){return t.events.next(m.NEXT)}),this.loadMoreNode&&(this.loadMoreNode.hidden=!e)},o}(r.NavigatorNode),G=function(e){function t(t,r){void 0===r&&(r={});var o=e.call(this,t,r)||this;return o.service=t,o.draggable=!1,o.droppable=!1,o}return u(t,e),Object.defineProperty(t.prototype,"hasChildren",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"query",{get:function(){return this.mo.c8y_DeviceQueryString},enumerable:!0,configurable:!0}),t.prototype.fetch=function(){return this.service.getDynamicGroupItems(this.query)},t}(N),F=function(){function r(){this.icons={brokerSourceInactive:{icon:"c8y-group-remote-inactive"},brokerSource:{icon:"c8y-group-remote",iconOpen:"c8y-group-remote-open"},group:{icon:"c8y-group",iconOpen:"c8y-group-open"},dynamicGroup:{icon:"c8y-group-smart",iconOpen:"c8y-group-smart-open"},other:{icon:"circle",iconClass:"statusUnknown"}},this.dataBrokerSourceFragmentInactive="_"+e.GroupFragment.dataBrokerSourceFragment}return r.prototype.isGroup=function(t){return!!t[e.GroupFragment.groupFragmentType]||t.type===e.GroupFragment.groupType||t.type===e.GroupFragment.subGroupType},r.prototype.isDynamicGroup=function(t){return!!t[e.GroupFragment.dynamicGroupFragment]||t.type===e.GroupFragment.dynamicGroupType},r.prototype.isDataBroker=function(t){return!!t[e.GroupFragment.dataBrokerSourceFragment]||!!t[this.dataBrokerSourceFragmentInactive]},r.prototype.isDataBrokerActive=function(t){return!!t[e.GroupFragment.dataBrokerSourceFragment]&&!t[this.dataBrokerSourceFragmentInactive]},r.prototype.icon=function(e,t){var r="other";this.isDynamicGroup(e)?r="dynamicGroup":this.isDataBrokerActive(e)?r="brokerSource":this.isDataBroker(e)?r="brokerSourceInactive":this.isGroup(e)&&(r="group");var o=this.icons[r];return t&&o.iconOpen||o.icon},r=d([t.Injectable()],r)}(),D=function(){function c(e,t,r,o,n,i,a,s,c){this.inventory=e,this.groups=t,this.apiService=r,this.modal=o,this.alert=n,this.breadcrumbService=i,this.user=a,this.appState=s,this.moduleConfig=c,this.firstUrl=!0,this.moduleConfig=p({rootNodePriority:2e3},c||{})}return c.prototype.createRootNode=function(){return this.rootNode=this.createAssetNode({root:!0,priority:this.moduleConfig.rootNodePriority}),this.rootNode},c.prototype.createDynamicGroupNode=function(e){return new G(this,e)},c.prototype.createAssetNode=function(e){return new N(this,e)},c.prototype.createChildNode=function(t){var r={mo:t};return t.type===e.GroupFragment.dynamicGroupType?this.createDynamicGroupNode(r):this.createAssetNode(r)},c.prototype.getRootNodes=function(){var t=this;if(this.user.hasRole(this.appState.currentUser.value,"ROLE_INVENTORY_READ")){var r=this.rootQueryFilter(),n=this.createFilter({query:r,pageSize:20,skipChildrenNames:!0});return this.inventory.list(n)}var i=this.createFilter({fragmentType:e.GroupFragment.groupFragmentType,withTotalPages:!0,pageSize:500,skipChildrenNames:!0});return this.inventory.list$(i,{hot:!1,pagingStrategy:o.PagingStrategy.ALL,realtime:!1}).pipe(a.scan((function(e,t){return function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(g(arguments[t]));return e}(e,t)}),[]),a.map((function(e){return t.rejectSubgroups(e)}))).toPromise()},c.prototype.getGroupItems=function(e){var t=this.groupQueryFilter(e),r=this.createFilter({query:t,skipChildrenNames:!0});return this.inventory.list(r)},c.prototype.getDynamicGroupItems=function(e){var t=this.createFilter({q:e});return this.inventory.list(t)},c.prototype.groupQueryFilter=function(e){return"$filter=(bygroupid("+e+"))$orderby=name"},c.prototype.rootQueryFilter=function(){var t=this.moduleConfig,r=["(type eq '"+e.GroupFragment.groupType+"')"];return t.smartGroups&&r.push("(type eq '"+e.GroupFragment.dynamicGroupType+"')"),"$filter=("+r.join(" or ")+")$orderby=name"},c.prototype.onUpdate=function(e){var t=this,r=e.mo,o=e.root;return r.id?this.apiService.hookResponse((function(e){var t=e.url,o=e.method;return["PUT","DELETE","POST"].includes(o)&&RegExp("((inventory/managedObjects)|(service/smartgroup/smartgroups))/"+r.id).test(t)})).pipe(a.filter((function(){return!t.draggedData})),a.mergeMap(this.apiService.resolveData),a.filter((function(e){return!e.data.c8y_Dashboard}))):o?this.apiService.hookResponse((function(e){var r=e.url,o=e.method,n=e.options;return RegExp("((inventory/managedObjects)|(service/smartgroup/smartgroups))/?$").test(r)&&"POST"===o&&t.isNewManagedObjectRoot(n)})):i.empty()},c.prototype.isNewManagedObjectRoot=function(t){void 0===t&&(t={});var r=t.data,o=!1;return"object"==typeof r&&!(o=!!r[e.GroupFragment.groupFragmentType])&&this.moduleConfig.smartGroups&&(o=!!r[e.GroupFragment.dynamicGroupFragment]),o},c.prototype.preferBreadcrumb=function(e){1===e.length&&this.breadcrumbService.selectPreferredByPath(e[0].path)},c.prototype.rejectSubgroups=function(e){var t=s.flatMap(e,"childAssets.references"),r=s.map(t,"managedObject.id");return s.reject(e,(function(e){return s.includes(r,e.id)}))},c.prototype.createFilter=function(e){void 0===e&&(e={});return p({},{currentPage:1,withTotalPages:!0,pageSize:10},e)},c.ctorParameters=function(){return[{type:o.InventoryService},{type:F},{type:n.ApiService},{type:r.ModalService},{type:r.AlertService},{type:r.BreadcrumbService},{type:o.UserService},{type:r.AppStateService},{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[b]}]}]},c=d([t.Injectable(),h(8,t.Optional()),h(8,t.Inject(b))],c)}(),x=function(){function e(e){this.service=e}return e.prototype.get=function(){return this.service.rootNode||this.service.createRootNode(),this.service.rootNode},e.ctorParameters=function(){return[{type:D}]},e=d([t.Injectable()],e)}(),j=function(){function e(){}var o;return o=e,e.config=function(e){return{ngModule:o,providers:[{provide:b,useValue:e}]}},e=o=d([t.NgModule({declarations:[],imports:[r.ModalModule,r.DeviceStatusModule],providers:[r.ModalService,D,F,{provide:r.HOOK_NAVIGATOR_NODES,useClass:x,multi:!0}],entryComponents:[r.DeviceStatusComponent]})],e)}();e.AssetNode=N,e.AssetNodeFactory=x,e.AssetNodeService=D,e.AssetsNavigatorModule=j,e.DeviceGroupService=F,e.ɵa=b,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=c8y-ngx-components-assets-navigator.umd.min.js.map