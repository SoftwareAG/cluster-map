!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("@c8y/ngx-components"),require("ngx-bootstrap/modal"),require("@c8y/client"),require("@ngx-translate/core"),require("rxjs/operators"),require("rxjs"),require("ngx-bootstrap/dropdown"),require("ngx-bootstrap/popover"),require("ngx-bootstrap/tooltip"),require("ngx-bootstrap/buttons"),require("@angular/forms")):"function"==typeof define&&define.amd?define("@c8y/ngx-components/trusted-certificates",["exports","@angular/core","@angular/router","@c8y/ngx-components","ngx-bootstrap/modal","@c8y/client","@ngx-translate/core","rxjs/operators","rxjs","ngx-bootstrap/dropdown","ngx-bootstrap/popover","ngx-bootstrap/tooltip","ngx-bootstrap/buttons","@angular/forms"],e):e(((t=t||self).c8y=t.c8y||{},t.c8y["ngx-components"]=t.c8y["ngx-components"]||{},t.c8y["ngx-components"]["trusted-certificates"]={}),t.ng.core,t.ng.router,t.c8y["ngx-components"],t.modal,t.client,t.core$1,t.rxjs.operators,t.rxjs,t.dropdown,t.popover,t.tooltip,t.buttons,t.ng.forms)}(this,(function(t,e,n,r,a,i,s,c,o,l,u,d,f,p){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var b=function(){return(b=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};function v(t,e,n,r){var a,i=arguments.length,s=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var c=t.length-1;c>=0;c--)(a=t[c])&&(s=(i<3?a(s):i>3?a(e,n,s):a(e,n))||s);return i>3&&s&&Object.defineProperty(e,n,s),s}function h(t,e,n,r){return new(n||(n=Promise))((function(a,i){function s(t){try{o(r.next(t))}catch(t){i(t)}}function c(t){try{o(r.throw(t))}catch(t){i(t)}}function o(t){t.done?a(t.value):new n((function(e){e(t.value)})).then(s,c)}o((r=r.apply(t,e||[])).next())}))}function m(t,e){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(a=(a=s.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var g=function(){function t(t,e,n){var a=this;this.modal=t,this.trustedCertificateService=e,this.alertService=n,this.AUTO_REGISTRATION_POPOVER=r.gettext("All devices with credentials signed by this certificate will be able to communicate with the platform without a prior registration."),this.trustedCertificate={status:"DISABLED"},this.result=new Promise((function(t,e){a._save=t,a._cancel=e}))}return t.prototype.save=function(){return h(this,void 0,void 0,(function(){var t;return m(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.trustedCertificateService.create(this.trustedCertificate)];case 1:return e.sent(),this.alertService.success(r.gettext("Certificate saved.")),this._save(),[3,3];case 2:return t=e.sent(),this.alertService.addServerFailure(t),[3,3];case 3:return[2]}}))}))},t.prototype.close=function(){this._cancel(),this.modal.hide()},t.ctorParameters=function(){return[{type:a.BsModalRef},{type:i.TrustedCertificateService},{type:r.AlertService}]},t=v([e.Component({selector:"c8y-add-trusted-certificate",template:'<div class="modal-header bg-primary text-center text-white">\n  <div style="font-size: 62px;">\n    <span c8yIcon="certificate"></span>\n  </div>\n  <h4 class="text-uppercase" translate>\n    Add trusted certificate\n  </h4>\n</div>\n<div class="modal-body">\n  <form #addTrustedCertificateForm="ngForm" class="p-t-24">\n    <c8y-form-group>\n      <label translate for="certificateName">Certificate name</label>\n      <input\n        id="certificateName"\n        type="text"\n        class="form-control"\n        autocomplete="off"\n        name="certificateName"\n        [(ngModel)]="trustedCertificate.name"\n        placeholder="{{ \'e.g. My certificate\' | translate }}"\n        required\n      />\n    </c8y-form-group>\n    <c8y-form-group>\n      <label translate for="certificate">Certificate</label>\n      <textarea\n        id="certificate"\n        class="form-control"\n        rows="6"\n        name="certificateInPemFormat"\n        [(ngModel)]="trustedCertificate.certInPemFormat"\n        placeholder="{{ \'Paste the certificate in PEM format here (required)\' | translate }}"\n        required\n      ></textarea>\n    </c8y-form-group>\n    <c8y-form-group>\n      <label class="c8y-checkbox" title="{{ \'Auto registration\' | translate }}">\n        <input\n          id="autoRegistration"\n          type="checkbox"\n          name="autoRegistration"\n          [(ngModel)]="trustedCertificate.autoRegistrationEnabled"\n        /><span></span>&nbsp;\n        {{ \'Auto registration\' | translate }}\n        <button\n          class="btn btn-clean"\n          popover="{{ AUTO_REGISTRATION_POPOVER | translate }}"\n          triggers="focus"\n        >\n          <i [c8yIcon]="\'question-circle-o\'"></i>\n        </button>\n      </label>\n    </c8y-form-group>\n    <button\n      type="button"\n      class="btn"\n      name="certificateStatus"\n      [(ngModel)]="trustedCertificate.status"\n      btnCheckbox\n      btnCheckboxTrue="ENABLED"\n      btnCheckboxFalse="DISABLED"\n    >\n      <span\n        title="{{ \'Disabled`trusted certificate status`\' | translate }}"\n        [hidden]="trustedCertificate.status !== \'DISABLED\'"\n      >\n        {{ \'Disabled`trusted certificate status`\' | translate }}\n      </span>\n      <span\n        title="{{ \'Enabled`trusted certificate status`\' | translate }}"\n        [hidden]="trustedCertificate.status !== \'ENABLED\'"\n      >\n        {{ \'Enabled`trusted certificate status`\' | translate }}\n      </span>\n    </button>\n  </form>\n</div>\n<div class="modal-footer">\n  <button title="{{ \'Cancel\' | translate }}" class="btn btn-default" (click)="close()" translate>\n    Cancel\n  </button>\n\n  <button\n    title="{{ \'Add certificate\' | translate }}"\n    class="btn btn-primary"\n    (click)="save()"\n    [disabled]="addTrustedCertificateForm.form.invalid || addTrustedCertificateForm.form.pristine"\n    translate\n  >\n    Add certificate\n  </button>\n</div>\n'})],t)}(),y=function(){function t(t,e,n,r,a){var i=this;this.bsModal=t,this.alertService=e,this.trustedCertificateService=n,this.modalService=r,this.translateService=a,this.reloading=new o.BehaviorSubject(!1),this.reload=new o.BehaviorSubject(null),this.trustedCertificates=this.reload.pipe(c.tap((function(){return i.reloading.next(!0)})),c.switchMap((function(){return i.getTrustedCertificates()})),c.tap((function(){return i.reloading.next(!1)}))),this.sortByExpirationDateAsc=o.pipe(c.tap((function(t){return t.sort((function(t,e){return t.notAfter.localeCompare(e.notAfter)}))})))}return t.prototype.ngOnInit=function(){return h(this,void 0,void 0,(function(){return m(this,(function(t){switch(t.label){case 0:return[4,this.loadTrustedCertificates()];case 1:return t.sent(),[2]}}))}))},t.prototype.loadTrustedCertificates=function(){return h(this,void 0,void 0,(function(){return m(this,(function(t){return this.reload.next(),[2]}))}))},t.prototype.getTrustedCertificates=function(){return this.trustedCertificateService.list({pageSize:1e3,withTotalPages:!0})},t.prototype.addTrustedCertificate=function(){return h(this,void 0,void 0,(function(){var t;return m(this,(function(e){switch(e.label){case 0:t=this.bsModal.show(g,{class:"modal-sm",ignoreBackdropClick:!0}).content,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.result];case 2:return e.sent(),t.close(),this.reload.next(),[3,4];case 3:return e.sent(),[3,4];case 4:return[2]}}))}))},t.prototype.deleteTrustedCertificate=function(t,e){return h(this,void 0,void 0,(function(){var e,n,a,i,s,c;return m(this,(function(o){switch(o.label){case 0:e=r.gettext("Delete trusted certificate"),n=r.gettext('You are about to delete a trusted certificate "{{ certificateName }}".'),a=r.gettext("Do you want to proceed?"),i=t.name,s=[this.translateService.instant(n,{certificateName:i}),this.translateService.instant(a)].join(" "),o.label=1;case 1:return o.trys.push([1,4,,5]),[4,this.modalService.confirm(e,s,r.Status.DANGER,{ok:r.gettext("Delete")})];case 2:return o.sent(),[4,this.trustedCertificateService.delete(t.fingerprint)];case 3:return o.sent(),this.alertService.success(r.gettext("Certificate deleted.")),this.reload.next(),[3,5];case 4:return c=o.sent(),this.alertService.addServerFailure(c),[3,5];case 5:return[2]}}))}))},t.prototype.updateCertificate=function(t,e){return h(this,void 0,void 0,(function(){var n;return m(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.trustedCertificateService.update(b({fingerprint:t.fingerprint},e))];case 1:return a.sent(),this.alertService.success(r.gettext("Certificate saved.")),[3,3];case 2:return n=a.sent(),this.alertService.addServerFailure(n),[3,3];case 3:return[2]}}))}))},t.prototype.highlightDependingOnExpirationStatus=function(t){var e=(new Date).getTime(),n=(new Date).getTime()+7776e6,r=new Date(t.notAfter).getTime();return r<e?"text-danger":r<n?"text-warning":""},t.ctorParameters=function(){return[{type:a.BsModalService},{type:r.AlertService},{type:i.TrustedCertificateService},{type:r.ModalService},{type:s.TranslateService}]},t=v([e.Component({selector:"c8y-trusted-certificates",template:'<c8y-title>{{ \'Trusted certificates\' | translate }}</c8y-title>\n\n<c8y-action-bar-item [placement]="\'right\'">\n  <button\n    title="{{ \'Add certificate\' | translate }}"\n    class="btn btn-link"\n    (click)="addTrustedCertificate()"\n  >\n    <i c8yIcon="plus-square"></i> {{ \'Add trusted certificate\' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]="\'right\'">\n  <button\n    title="{{ \'Reload\' | translate }}"\n    class="btn btn-link"\n    (click)="loadTrustedCertificates()"\n  >\n    <i c8yIcon="refresh" [ngClass]="{ \'fa-spin\': reloading | async }"></i>\n    {{ \'Reload\' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class="c8y-empty-state text-center" *ngIf="(trustedCertificates | async)?.data.length === 0">\n  <h1 class="c8y-icon fa fa-certificate"></h1>\n  <h3 translate>No trusted certificates to display.</h3>\n  <p translate>Add your first certificate by clicking below.</p>\n  <p>\n    <button\n      title="{{ \'Add trusted certificate\' | translate }}"\n      (click)="addTrustedCertificate()"\n      class="btn btn-primary"\n      translate\n    >\n      Add trusted certificate\n    </button>\n  </p>\n</div>\n\n<c8y-list-group class="elevation-1">\n  <c8y-li\n    *c8yFor="\n      let trustedCertificate of trustedCertificates | async;\n      let i = index;\n      pipe: sortByExpirationDateAsc;\n      loadMore: \'none\'\n    "\n  >\n    <c8y-li-icon>\n      <i c8yIcon="certificate"></i>\n      <i\n        c8yIcon="check-circle"\n        class="text-success"\n        *ngIf="trustedCertificate.status === \'ENABLED\'"\n      ></i>\n      <i c8yIcon="ban" class="text-danger" *ngIf="trustedCertificate.status === \'DISABLED\'"></i>\n    </c8y-li-icon>\n\n    <c8y-li-body class="content-flex-50">\n      <div class="col-6">{{ trustedCertificate.name }}</div>\n      <div class="col-6">\n        <span class="text-label-small m-r-8" translate>Algorithm</span>\n        {{ trustedCertificate.algorithmName }}\n      </div>\n      <div class="col-6">\n        <span class="text-label-small m-r-8" translate>Expiration date</span>\n        <small [ngClass]="highlightDependingOnExpirationStatus(trustedCertificate)">\n          <i c8yIcon="calendar" class="m-r-4"></i>\n          <span>{{ trustedCertificate.notAfter | date: \'medium\' }}</span>\n        </small>\n      </div>\n      <div class="col-6">\n        <span title="{{ \'Auto registration\' | translate }}" translate class="text-label-small m-r-8"\n          >Auto registration</span\n        >\n        <small *ngIf="trustedCertificate.autoRegistrationEnabled">{{\n          \'Enabled`auto registration`\' | translate\n        }}</small>\n        <small *ngIf="!trustedCertificate.autoRegistrationEnabled">{{\n          \'Disabled`auto registration`\' | translate\n        }}</small>\n      </div>\n    </c8y-li-body>\n\n    <c8y-li-action\n      (click)="deleteTrustedCertificate(trustedCertificate, i)"\n      icon="trash"\n      label="{{ \'Delete\' | translate }}"\n    >\n    </c8y-li-action>\n\n    <c8y-li-collapse [item]="trustedCertificate">\n      <div class="p-t-16 p-b-16">\n        <div class="row">\n          <div class="col-md-4">\n            <c8y-form-group>\n              <label class="control-label" translate>\n                Certificate name\n              </label>\n              <div class="input-group input-group-editable">\n                <input type="text" class="form-control" [(ngModel)]="trustedCertificate.name" />\n                <span></span>\n                <div class="input-group-btn">\n                  <button\n                    title="{{ \'Update certificate name\' | translate }}"\n                    (click)="\n                      updateCertificate(trustedCertificate, { name: trustedCertificate.name })\n                    "\n                    class="btn btn-primary"\n                  >\n                    {{ \'Save\' | translate }}\n                  </button>\n                </div>\n              </div>\n            </c8y-form-group>\n            <c8y-form-group>\n              <label class="c8y-checkbox">\n                <input\n                  type="checkbox"\n                  [(ngModel)]="trustedCertificate.autoRegistrationEnabled"\n                  (ngModelChange)="\n                    updateCertificate(trustedCertificate, { autoRegistrationEnabled: $event })\n                  "\n                />\n                <span></span>\n                <span translate> Auto registration</span>\n              </label>\n            </c8y-form-group>\n            <c8y-form-group>\n              <button\n                type="button"\n                class="btn"\n                name="certificateStatus"\n                [(ngModel)]="trustedCertificate.status"\n                btnCheckbox\n                btnCheckboxTrue="ENABLED"\n                btnCheckboxFalse="DISABLED"\n                (ngModelChange)="updateCertificate(trustedCertificate, { status: $event })"\n              >\n                <span\n                  title="{{ \'Disabled`trusted certificate status`\' | translate }}"\n                  [hidden]="trustedCertificate.status !== \'DISABLED\'"\n                >\n                  {{ \'Disabled`trusted certificate status`\' | translate }}\n                </span>\n                <span\n                  title="{{ \'Enabled`trusted certificate status`\' | translate }}"\n                  [hidden]="trustedCertificate.status !== \'ENABLED\'"\n                >\n                  {{ \'Enabled`trusted certificate status`\' | translate }}\n                </span>\n              </button>\n            </c8y-form-group>\n          </div>\n          <div class="col-md-4">\n            <c8y-form-group>\n              <label class="control-label" translate>\n                Certificate\n              </label>\n              <textarea\n                class="form-control no-resize"\n                name="name"\n                type="text"\n                rows="10"\n                readonly\n                [(ngModel)]="trustedCertificate.certInPemFormat"\n              >\n              </textarea>\n            </c8y-form-group>\n          </div>\n          <div class="col-md-4 p-r-24">\n            <label translate>Additional properties</label>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Algorithm</div>\n              <div class="col-8 small text-break-word">{{ trustedCertificate.algorithmName }}</div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Version</div>\n              <div class="col-8 small text-break-word">{{ trustedCertificate.version }}</div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Valid from</div>\n              <div class="col-8 small text-break-word">\n                {{ trustedCertificate.notBefore | date: \'medium\' }}\n              </div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Issuer</div>\n              <div class="col-8 small text-break-word">{{ trustedCertificate.issuer }}</div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Expiration date</div>\n              <div class="col-8 small text-break-word">\n                {{ trustedCertificate.notAfter | date: \'medium\' }}\n              </div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small" translate>Serial number</div>\n              <div class="col-8 small text-break-word">{{ trustedCertificate.serialNumber }}</div>\n            </div>\n            <div class="content-flex-30 separator-top p-t-4 p-b-4">\n              <div class="col-4 text-label-small">\n                {{ \'Subject`of a certificate`\' | translate }}\n              </div>\n              <div class="col-8 small text-break-word">{{ trustedCertificate.subject }}</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </c8y-li-collapse>\n  </c8y-li>\n</c8y-list-group>\n'})],t)}(),x=function(){function t(t){this.optionsService=t}return t.prototype.canActivate=function(t,e){return this.isFeatureEnabled()},t.prototype.isFeatureEnabled=function(){return h(this,void 0,void 0,(function(){var t;return m(this,(function(e){switch(e.label){case 0:return void 0!==this.isFeatureEnabledCache?[3,2]:(t=this,[4,this.optionsService.getTenantOption("oauth.internal.token","trusted-certificates.enabled",!1)]);case 1:t.isFeatureEnabledCache=e.sent(),e.label=2;case 2:return[2,this.isFeatureEnabledCache]}}))}))},t.ctorParameters=function(){return[{type:r.OptionsService}]},t=v([e.Injectable()],t)}(),C=function(){function t(t,e){this.tenantOptionsService=t,this.trustedCertificatesGuard=e,this.nav=[]}return t.prototype.get=function(){return h(this,void 0,void 0,(function(){return m(this,(function(t){switch(t.label){case 0:return[4,this.trustedCertificatesGuard.isFeatureEnabled()];case 1:return t.sent()&&0===this.nav.length&&this.nav.push(new r.NavigatorNode({label:r.gettext("Trusted certificates"),icon:"certificate",path:"/trusted-certificates",parent:r.gettext("Management"),priority:100})),[2,this.nav]}}))}))},t.ctorParameters=function(){return[{type:i.TenantOptionsService},{type:x}]},t=v([e.Injectable()],t)}(),S=[{path:"trusted-certificates",component:y,canActivate:[x]}],w=function(){function t(){}return t=v([e.NgModule({declarations:[y,g],exports:[],imports:[r.CoreModule,r.CommonModule,n.RouterModule.forRoot(S,{useHash:!0}),l.BsDropdownModule.forRoot(),d.TooltipModule,p.ReactiveFormsModule,f.ButtonsModule,u.PopoverModule],entryComponents:[y,g],providers:[{provide:r.HOOK_NAVIGATOR_NODES,useClass:C,multi:!0},x]})],t)}();t.TrustedCertificatesModule=w,t.ɵa=y,t.ɵb=g,t.ɵc=x,t.ɵd=C,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=c8y-ngx-components-trusted-certificates.umd.min.js.map