!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/router"),require("@c8y/ngx-components"),require("@c8y/ngx-components/upgrade"),require("@c8y/client"),require("lodash-es")):"function"==typeof define&&define.amd?define("@c8y/ngx-components/sms-gateway",["exports","@angular/core","@angular/router","@c8y/ngx-components","@c8y/ngx-components/upgrade","@c8y/client","lodash-es"],t):t(((e=e||self).c8y=e.c8y||{},e.c8y["ngx-components"]=e.c8y["ngx-components"]||{},e.c8y["ngx-components"]["sms-gateway"]={}),e.ng.core,e.ng.router,e.c8y["ngx-components"],e.c8y["ngx-components"].upgrade,e.client,e.lodashEs)}(this,(function(e,t,n,r,o,i,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function a(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function l(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(s,a)}l((r=r.apply(e,t||[])).next())}))}function c(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function u(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}var d=function(){function e(e,t){this.client=e,this.tenantOptionsService=t,this.category="messaging",this.basePath="service/register/messaging",this.providerTemplates={cepConfig:{"sms.senderAddress":"cumulocity","sms.senderName":"cumulocity"},openit:{provider:"openit","openit.baseUrl":"https://sms.plusserver.com/put.php"},sms77:{provider:"sms77","sms77.url":"https://gateway.sms77.io/api/sms"}}}return e.prototype.getProviderConfig=function(){return this.tenantOptionsService.detail({category:this.category,key:""})},e.prototype.saveProviderConfig=function(e){return l(this,void 0,void 0,(function(){var t,n,r;return c(this,(function(o){return t=this.providerTemplates[e.provider],n=this.providerTemplates.cepConfig,Object.assign(e,t,n),r={method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify(e)},[2,this.client.fetch(this.basePath,r)]}))}))},e.prototype.deleteProviderConfig=function(e){return l(this,void 0,void 0,(function(){var t;return c(this,(function(n){return t=this.providerTemplates[e.provider],Object.assign(e,t),[2,this.deleteProviderOptions(e)]}))}))},e.prototype.deleteProviderOptions=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,i,s;return c(this,(function(a){switch(a.label){case 0:a.trys.push([0,5,6,7]),t=u(Object.keys(e)),n=t.next(),a.label=1;case 1:return n.done?[3,4]:(r=n.value,[4,this.tenantOptionsService.delete({category:this.category,key:r})]);case 2:a.sent(),a.label=3;case 3:return n=t.next(),[3,1];case 4:return[3,7];case 5:return o=a.sent(),i={error:o},[3,7];case 6:try{n&&!n.done&&(s=t.return)&&s.call(t)}finally{if(i)throw i.error}return[7];case 7:return[2]}}))}))},e.ctorParameters=function(){return[{type:i.FetchClient},{type:i.TenantOptionsService}]},e=a([t.Injectable()],e)}(),p=function(){function e(e,t,n){this.modalService=e,this.alertService=t,this.smsGatewayService=n,this.smsProviders=[{id:"openit",name:"OpenIT"},{id:"sms77",name:"sms77"}],this.supportedConfigOptions=["provider","openit.username","credentials.openit.password","credentials.sms77.api.key"],this.pageTitle=r.gettext("SMS provider")}return e.prototype.ngOnInit=function(){return l(this,void 0,void 0,(function(){var e;return c(this,(function(t){switch(t.label){case 0:return this.smsConfig=this.getEmptyConfig(),this.oldConfig=this.getEmptyConfig(),[4,this.smsGatewayService.getProviderConfig()];case 1:return e=t.sent(),this.isSupportedProvider(e.data)&&(this.smsConfig=this.getConfigurableProperties(e.data),this.oldConfig=this.smsConfig),[2]}}))}))},e.prototype.getConfigurableProperties=function(e){return s.pick(e,this.supportedConfigOptions)},e.prototype.isSupportedProvider=function(e){return this.smsProviders.some((function(t){return t.id===e.provider}))},e.prototype.saveSMSGatewayConfiguration=function(e){return l(this,void 0,void 0,(function(){var t,n,o;return c(this,(function(i){switch(i.label){case 0:return[4,this.smsGatewayService.saveProviderConfig(this.smsConfig)];case 1:return(t=i.sent())&&200!==t.status?t.json?[4,t.json()]:[3,3]:[3,5];case 2:return o=i.sent(),[3,4];case 3:o=void 0,i.label=4;case 4:return n=o,this.alertService.addServerFailure({data:n,res:t}),[3,6];case 5:this.alertService.success(r.gettext("Credentials updated.")),Object.assign(this.oldConfig,this.smsConfig),e.pristine=!0,i.label=6;case 6:return[2]}}))}))},e.prototype.deleteSMSGatewayConfiguration=function(){return l(this,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this.modalService.confirm(r.gettext("Delete credentials"),r.gettext("You are about to delete SMS provider credentials. Deleting credentials will lock out any users with\n      SMS-based two-factor authentication and deactivate the SMS-based smart rules and device communication.\n      Do you want to proceed?"),r.Status.DANGER,{ok:r.gettext("Delete")})];case 1:return e.sent(),[4,this.smsGatewayService.deleteProviderConfig(this.oldConfig)];case 2:return e.sent(),this.alertService.success(r.gettext("Credentials deleted.")),this.smsConfig=this.getEmptyConfig(),this.oldConfig=this.getEmptyConfig(),[2]}}))}))},e.prototype.getEmptyConfig=function(){return{provider:void 0}},e.ctorParameters=function(){return[{type:r.ModalService},{type:r.AlertService},{type:d}]},e=a([t.Component({selector:"c8y-sms-gateway",template:'<c8y-title>{{ pageTitle | translate }}</c8y-title>\n<div class="row">\n  <div class="col-xs-12 col-sm-10 col-md-8 col-lg-6">\n    <form\n      class="card"\n      #smsGatewayForm="ngForm"\n      (ngSubmit)="smsGatewayForm.form.valid && saveSMSGatewayConfiguration(smsGatewayForm.form)"\n    >\n      <div class="card-header">\n        <h4 class="card-title" translate>Credentials</h4>\n      </div>\n      <div class="card-block">\n        <p class="bottom-m" translate>\n          Enter your credentials from your SMS provider. This enables platform features that utilize\n          SMS services (e.g. two-factor authentication and user notifications).\n        </p>\n        <label translate>SMS provider</label>\n        <div class="form-group">\n          <ul class="list-unstyled">\n            <li *ngFor="let provider of smsProviders">\n              <label class="c8y-radio">\n                <input\n                  class="form-control"\n                  type="radio"\n                  name="providerName"\n                  [(ngModel)]="smsConfig.provider"\n                  [value]="provider.id"\n                />\n                <span></span>\n                {{ provider.name | translate }}\n              </label>\n            </li>\n          </ul>\n        </div>\n        <div class="form-group" *ngIf="smsConfig.provider === \'openit\'">\n          <label translate for="userName">Username</label>\n          <input\n            id="userName"\n            class="form-control"\n            type="text"\n            autocomplete="off"\n            name="userName"\n            [(ngModel)]="smsConfig[\'openit.username\']"\n            placeholder="{{ \'e.g. joe`LOCALIZE`\' | translate }}"\n            required\n          />\n        </div>\n        <div class="form-group" *ngIf="smsConfig.provider === \'openit\'">\n          <label translate for="password">Password</label>\n          <input\n            id="password"\n            class="form-control"\n            type="password"\n            autocomplete="off"\n            name="password"\n            [(ngModel)]="smsConfig[\'credentials.openit.password\']"\n            placeholder="{{ \'e.g. my_password\' | translate }}"\n            required\n          />\n        </div>\n        <div class="form-group" *ngIf="smsConfig.provider === \'sms77\'">\n          <label translate for="apiKey">API key</label>\n          <input\n            id="apiKey"\n            class="form-control"\n            type="text"\n            autocomplete="off"\n            name="apiKey"\n            [(ngModel)]="smsConfig[\'credentials.sms77.api.key\']"\n            required\n          />\n        </div>\n      </div>\n      <div class="card-footer">\n        <button\n          type="button"\n          class="btn btn-default"\n          (click)="deleteSMSGatewayConfiguration()"\n          [disabled]="!(oldConfig && oldConfig.provider)"\n          title="{{ \'Delete\' | translate }}"\n          translate\n        >\n          Delete\n        </button>\n        <button\n          type="submit"\n          class="btn btn-primary"\n          [disabled]="!smsGatewayForm.form.valid || smsGatewayForm.form.pristine"\n          title="{{ \'Save\' | translate }}"\n          translate\n        >\n          Save\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n'})],e)}(),f=[{path:"smsgateway",component:p}],m=[new r.NavigatorNode({label:r.gettext("SMS provider"),path:"smsgateway",icon:"envelope-o",parent:r.gettext("Settings"),priority:1e3})],g={provide:r.HOOK_NAVIGATOR_NODES,useValue:m,multi:!0},v=function(){function e(){}return e=a([t.NgModule({declarations:[p],exports:[p],imports:[r.CoreModule,r.CommonModule,r.FormsModule,n.RouterModule.forRoot(f,{useHash:!0}),o.UpgradeModule],entryComponents:[p],providers:[d,g]})],e)}();e.SmsGatewayComponent=p,e.SmsGatewayModule=v,e.ɵ0=m,e.ɵa=d,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=c8y-ngx-components-sms-gateway.umd.min.js.map