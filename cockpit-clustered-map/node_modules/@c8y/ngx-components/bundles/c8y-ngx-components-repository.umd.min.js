!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@c8y/ngx-components"),require("rxjs"),require("rxjs/operators"),require("@c8y/client"),require("ngx-bootstrap/modal"),require("lodash"),require("ngx-bootstrap/tooltip")):"function"==typeof define&&define.amd?define("@c8y/ngx-components/repository",["exports","@angular/core","@c8y/ngx-components","rxjs","rxjs/operators","@c8y/client","ngx-bootstrap/modal","lodash","ngx-bootstrap/tooltip"],t):t(((n=n||self).c8y=n.c8y||{},n.c8y["ngx-components"]=n.c8y["ngx-components"]||{},n.c8y["ngx-components"].repository={}),n.ng.core,n.c8y["ngx-components"],n.rxjs,n.rxjs.operators,n.client,n.modal,n.lodash,n.tooltip)}(this,(function(n,t,e,i,r,o,a,s,c){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var l,u;function p(n,t,e,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(n,t,e,i);else for(var s=n.length-1;s>=0;s--)(r=n[s])&&(a=(o<3?r(a):o>3?r(t,e,a):r(t,e))||a);return o>3&&a&&Object.defineProperty(t,e,a),a}function f(n,t,e,i){return new(e||(e=Promise))((function(r,o){function a(n){try{c(i.next(n))}catch(n){o(n)}}function s(n){try{c(i.throw(n))}catch(n){o(n)}}function c(n){n.done?r(n.value):new e((function(t){t(n.value)})).then(a,s)}c((i=i.apply(n,t||[])).next())}))}function d(n,t){var e,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(n,a)}catch(n){o=[6,n],i=0}finally{e=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}!function(n){n.FIRMWARE="c8y_Firmware",n.SOFTWARE="c8y_Software",n.CONFIGURATION="c8y_ConfigurationDump"}(u||(u={}));(l={})[u.SOFTWARE]="c8y_SoftwareBinary",l[u.FIRMWARE]="c8y_FirmwareBinary",l[u.CONFIGURATION]="c8y_ConfigurationDumpBinary";var y=function(){function n(n,t){this.inventory=n,this.inventoryBinary=t}return n.prototype.listConfigurations=function(){return this.inventory.list({type:u.CONFIGURATION,withTotalPages:!0,pageSize:50})},n.prototype.delete=function(n){return this.inventory.delete(n)},n.prototype.save=function(n,t,e){return void 0===e&&(e={}),f(this,void 0,void 0,(function(){var i,r;return d(this,(function(o){switch(o.label){case 0:switch(t){case u.CONFIGURATION:Object.assign(e,{type:u.CONFIGURATION,configurationType:n.selected?n.selected.configurationType:void 0,name:n.versionOrName,description:n.description,deviceType:n.deviceType,c8y_Global:{}})}return i=e.url,n.binary.url?(e.url=n.binary.url,[3,3]):[3,1];case 1:return n.binary.file?[4,this.inventoryBinary.create(n.binary.file,{c8y_Global:{}})]:[3,3];case 2:r=o.sent(),e.url=r.data.self,o.label=3;case 3:return e.id?[2,this.updateEntry(e,i)]:[2,this.createEntry(e)]}}))}))},n.prototype.createEntry=function(n){return f(this,void 0,void 0,(function(){var t,e;return d(this,(function(i){switch(i.label){case 0:return[4,this.inventoryBinary.getIdFromUrl(n.url)];case 1:return t=i.sent(),[4,this.inventory.create(n)];case 2:return e=i.sent(),t?[4,this.inventory.childAdditionsAdd(t,e.data)]:[3,4];case 3:i.sent(),i.label=4;case 4:return[2,e]}}))}))},n.prototype.updateEntry=function(n,t){return f(this,void 0,void 0,(function(){var e,i,r;return d(this,(function(o){switch(o.label){case 0:return[4,this.inventoryBinary.getIdFromUrl(t)];case 1:return e=o.sent(),[4,this.inventoryBinary.getIdFromUrl(n.url)];case 2:return i=o.sent(),e&&e!==i?(r=this.inventoryBinary.getIdFromUrl(t),[4,this.inventoryBinary.delete(r)]):[3,4];case 3:o.sent(),o.label=4;case 4:return i?[4,this.inventory.childAdditionsAdd(i,n)]:[3,6];case 5:o.sent(),o.label=6;case 6:return[2,this.inventory.update(n)]}}))}))},n.ctorParameters=function(){return[{type:o.InventoryService},{type:o.InventoryBinaryService}]},n=p([t.Injectable()],n)}(),h=function(){function n(n,t,e){var i=this;this.repositoryService=n,this.bsModalRef=t,this.alert=e,this.binary={file:void 0,url:void 0},this.pattern="",this.mo={},this.isLoading=!1,this.result=new Promise((function(n,t){i._save=n,i._cancel=t}))}return n.prototype.ngOnInit=function(){return f(this,void 0,void 0,(function(){var n;return d(this,(function(t){switch(t.label){case 0:return n=this,[4,this.repositoryService.listConfigurations()];case 1:return n.configs=t.sent(),this.setPipe(""),[2]}}))}))},n.prototype.cancel=function(){this.bsModalRef.hide(),this._cancel()},n.prototype.setPipe=function(n){this.pattern=n,this.filterPipe=i.pipe(r.map((function(n){return s.uniqBy(n,"configurationType")})),r.map((function(t){return t.filter((function(t){return t.configurationType&&t.configurationType.toLowerCase().indexOf(n.toLowerCase())>-1}))})))},n.prototype.uploadFile=function(n,t){this.binary.file=n[0].file,this.binary.url=void 0,t.form.markAsDirty()},n.prototype.save=function(){return f(this,void 0,void 0,(function(){var n,t,i,r,o,a,s;return d(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,3,4]),this.isLoading=!0,t=(n=this).selected,i=n.versionOrName,r=n.description,o=n.binary,a=n.deviceType,[4,this.repositoryService.save({selected:t,versionOrName:i,description:r,binary:o,deviceType:a},u.CONFIGURATION,this.mo)];case 1:return c.sent(),this.alert.success(this.mo.id?e.gettext("Configuration updated."):e.gettext("Configuration created.")),this.bsModalRef.hide(),this._save(),[3,4];case 2:return s=c.sent(),this.alert.addServerFailure(s),this._cancel(),[3,4];case 3:return this.isLoading=!1,[7];case 4:return[2]}}))}))},n.ctorParameters=function(){return[{type:y},{type:a.BsModalRef},{type:e.AlertService}]},n=p([t.Component({selector:"c8y-configuration-new-modal",template:'<div class="modal-header bg-primary text-white text-center">\n  <h1 c8yIcon="cogs" style="font-size: 55px;"></h1>\n  <h4 class="p-t-16 text-uppercase" translate *ngIf="mo.id">Update configuration</h4>\n  <h4 class="p-t-16 text-uppercase" translate *ngIf="!mo.id">Add configuration</h4>\n</div>\n\n<form #configurationForm="ngForm" (ngSubmit)="configurationForm.form.valid && save()">\n  <div class="modal-body">\n    <c8y-form-group>\n      <label translate>Name</label>\n      <input\n        type="text"\n        class="form-control"\n        placeholder="e.g. hosts"\n        autocomplete="off"\n        required\n        maxlength="254"\n        [(ngModel)]="versionOrName"\n        name="versionOrName"\n      />\n    </c8y-form-group>\n\n    <c8y-form-group>\n      <label translate>Device type</label>\n      <input\n        type="text"\n        class="form-control"\n        placeholder="e.g. Posix"\n        maxlength="254"\n        autocomplete="off"\n        [(ngModel)]="deviceType"\n        name="deviceType"\n      />\n    </c8y-form-group>\n\n    <c8y-form-group>\n      <label translate>Description</label>\n      <input\n        type="text"\n        class="form-control"\n        placeholder="e.g. Host configuration Posix"\n        maxlength="254"\n        autocomplete="off"\n        [(ngModel)]="description"\n        name="description"\n      />\n    </c8y-form-group>\n\n    <c8y-form-group>\n      <label translate>Configuration type</label>\n      <c8y-typeahead\n        [(selected)]="selected"\n        placeholder="e.g. ssh"\n        (onSearch)="setPipe($event)"\n        displayProperty="configurationType"\n      >\n        <c8y-li\n          *c8yFor="let config of configs; pipe: filterPipe; notFound: notFoundTemplate"\n          class="p-l-8 p-r-8 c8y-list__item--link"\n          (click)="selected = config; setPipe(\'\')"\n          [active]="selected === config"\n        >\n          <c8y-highlight\n            [text]="config.configurationType || \'--\'"\n            [pattern]="pattern"\n          ></c8y-highlight>\n        </c8y-li>\n        <ng-template #notFoundTemplate>\n          <c8y-li class="bg-gray-lighter p-8" *ngIf="pattern.length > 0">\n            <span translate>No match found, add new`configuration`?</span>\n            <button type="button" class="btn btn-primary btn-xs m-l-16" translate>\n              Create new`configuration`\n            </button>\n          </c8y-li>\n        </ng-template>\n      </c8y-typeahead>\n    </c8y-form-group>\n\n    <c8y-drop-area\n      (dropped)="uploadFile($event, configurationForm)"\n      [loadingMessage]="\'Importing, please wait.\' | translate"\n      [title]="\'Add a configuration file\' | translate"\n      [loading]="isLoading"\n    >\n    </c8y-drop-area>\n  </div>\n\n  <div class="modal-footer">\n    <button (click)="cancel()" type="button" class="btn btn-default" [disabled]="isLoading">\n      <span translate>Cancel</span>\n    </button>\n    <button\n      type="button"\n      class="btn btn-primary"\n      type="submit"\n      [disabled]="!configurationForm.valid || configurationForm.pristine || isLoading"\n    >\n      <span translate *ngIf="!mo.id">Add configuration</span>\n      <span translate *ngIf="mo.id">Update configuration</span>\n    </button>\n  </div>\n</form>\n'})],n)}(),g=function(){function n(n,t,r){this.alert=n,this.repositoryService=t,this.modalService=r,this.filterChange$=new i.Subject,this.filterTerm="",this.CARRIAGE_RETURN_KEY=13,this.CARRIAGE_RETURN_CODE="Enter",this.DELETED_SUCCESS_MSG=e.gettext("Configuration deleted.")}return n.prototype.ngOnInit=function(){return f(this,void 0,void 0,(function(){var n=this;return d(this,(function(t){switch(t.label){case 0:return[4,this.reset()];case 1:return t.sent(),this.filterChange$.pipe(r.debounce((function(t){return t.code===n.CARRIAGE_RETURN_CODE||t.keyCode===n.CARRIAGE_RETURN_KEY?i.timer(10):i.timer(300)})),r.map((function(n){return n.target.value})),r.distinctUntilChanged()).subscribe((function(t){n.filterTerm=t,n.setPipe(t)})),[2]}}))}))},n.prototype.ngOnDestroy=function(){this.filterChange$.complete()},n.prototype.add=function(){return f(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,this.modalService.show(h,{class:"modal-sm",ignoreBackdropClick:!0}).content.result];case 1:return n.sent(),[4,this.reset()];case 2:return n.sent(),[3,4];case 3:return n.sent(),[3,4];case 4:return[2]}}))}))},n.prototype.edit=function(n){return f(this,void 0,void 0,(function(){var t;return d(this,(function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),(t=this.modalService.show(h,{class:"modal-sm",ignoreBackdropClick:!0,initialState:{selected:{id:n.id,configurationType:n.configurationType},versionOrName:n.name,deviceType:n.deviceType,description:n.description,binary:{url:n.url}}}).content).mo=n,[4,t.result];case 1:return e.sent(),[4,this.reset()];case 2:return e.sent(),[3,4];case 3:return e.sent(),[3,4];case 4:return[2]}}))}))},n.prototype.delete=function(n){return f(this,void 0,void 0,(function(){var t;return d(this,(function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,this.repositoryService.delete(n)];case 1:return e.sent(),this.alert.success(this.DELETED_SUCCESS_MSG),[4,this.reset()];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),this.alert.addServerFailure(t),[3,4];case 4:return[2]}}))}))},n.prototype.setPipe=function(n){var t=this;this.filterPipe=i.pipe(r.map((function(e){return 0===n.trim().length?e:e.filter((function(e){return t.filterContainString(e.name,n)||t.filterContainString(e.configurationType,n)}))})))},n.prototype.filterContainString=function(n,t){var e=t.toLowerCase().trim();return n&&n.toLowerCase().indexOf(e)>-1},n.prototype.reset=function(){return f(this,void 0,void 0,(function(){var n,t;return d(this,(function(e){switch(e.label){case 0:return this.filterTerm="",n=this,t=i.of,[4,this.repositoryService.listConfigurations()];case 1:return n.configurations$=t.apply(void 0,[e.sent()]),this.setPipe(""),[2]}}))}))},n.ctorParameters=function(){return[{type:e.AlertService},{type:y},{type:a.BsModalService}]},n=p([t.Component({selector:"c8y-configuration-list",template:'<c8y-title>\n  <span translate>Configuration snapshots repository</span>&nbsp;\n  <small *ngIf="(configurations$ | async)?.paging.totalPages === 1 && !filterTerm"\n    >{{ (configurations$ | async).data.length }} <span translate>snapshots</span></small\n  >\n  <small\n    *ngIf="(configurations$ | async)?.paging.totalPages > 1 && !filterTerm"\n    [tooltip]="\'More data available. Scroll to the bottom of the list to load it.\' | translate"\n    container="body"\n    >{{ (configurations$ | async).paging.pageSize }}+ <span translate>snapshots</span></small\n  >\n  <small *ngIf="filterTerm"\n    ><span translate>Search results for</span>&nbsp;"{{ this.filterTerm }}"</small\n  >\n</c8y-title>\n\n<c8y-action-bar-item itemClass="navbar-form">\n  <div class="input-group input-group-search">\n    <input\n      class="form-control"\n      placeholder="{{ \'Filter…\' | translate }}"\n      type="text"\n      [value]="filterTerm"\n      (keyup)="filterChange$.next($event)"\n    />\n    <span class="input-group-btn">\n      <button class="btn btn-clean" (click)="filterTerm = \'\'; setPipe(\'\')">\n        <i [c8yIcon]="filterTerm.length === 0 ? \'filter\' : \'close\'"></i>\n      </button>\n    </span>\n  </div>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]="\'right\'">\n  <button class="btn btn-link" (click)="add()">\n    <i c8yIcon="plus-square"></i> {{ \'Add configuration snapshot\' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div\n  class="c8y-empty-state text-center"\n  *ngIf="!filterTerm && (configurations$ | async)?.data.length === 0"\n>\n  <h1 c8yIcon="gears"></h1>\n  <h3 translate>There are no configuration snapshots defined</h3>\n  <p translate>Add a configuration snapshot first.</p>\n  <div>\n    <button (click)="add()" class="btn btn-primary" translate>\n      Add configuration snapshot\n    </button>\n  </div>\n  <p c8y-guide-docs>\n    <small translate\n      >Find out more in the\n      <a c8y-guide-href="users-guide/device-management/#configuration-repository"\n        >User guide`KEEP_ORIGINAL`</a\n      >.</small\n    >\n  </p>\n</div>\n\n<ng-template #notFound>\n  <c8y-li class="p-8 text-center">\n    <p>\n      <span translate>No more entries found for filter:</span>&nbsp;<strong>{{\n        filterTerm\n      }}</strong>\n    </p>\n    <button class="btn btn-primary btn-xs m-t-8" translate (click)="filterTerm = \'\'; setPipe(\'\')">\n      Reset filter\n    </button>\n  </c8y-li>\n</ng-template>\n<div class="p-b-32">\n  <c8y-list-group>\n    <c8y-li\n      *c8yFor="\n        let configuration of configurations$;\n        pipe: filterPipe;\n        notFound: this.filterTerm ? notFound : undefined\n      "\n    >\n      <c8y-li-icon icon="gears"></c8y-li-icon>\n      <div class="row flex-row">\n        <div class="col-xs-3">\n          <c8y-highlight\n            [text]="configuration.name || \'-\'"\n            elementClass="text-info"\n            [pattern]="filterTerm"\n          ></c8y-highlight>\n        </div>\n        <div class="col-xs-3">\n          <span class="text-muted text-truncate" [title]="configuration.description">{{\n            configuration.description\n          }}</span>\n        </div>\n        <div class="col-xs-3">\n          <small translate class="text-muted text-uppercase">Device type:</small>&nbsp;\n          {{ configuration.deviceType || \'-\' }}\n        </div>\n        <div class="col-xs-3 text-right">\n          <span class="label label-primary" *ngIf="configuration.configurationType">\n            <c8y-highlight\n              [text]="configuration.configurationType"\n              elementClass="text-info"\n              [pattern]="filterTerm"\n            ></c8y-highlight>\n          </span>\n        </div>\n      </div>\n      <c8y-li-action (click)="edit(configuration)" icon="pencil">\n        Edit\n      </c8y-li-action>\n      <c8y-li-action (click)="delete(configuration)" icon="trash-o">\n        Delete\n      </c8y-li-action>\n    </c8y-li>\n  </c8y-list-group>\n</div>\n'})],n)}(),m=function(){function n(n){this.optionsService=n,this.navs=[]}return n.prototype.get=function(){return f(this,void 0,void 0,(function(){return d(this,(function(n){return"all"===localStorage.getItem("c8y_beta_status")&&0===this.navs.length&&this.navs.push(new e.NavigatorNode({label:e.gettext("Configuration repository"),path:"configuration-new",icon:"gears",parent:e.gettext("Management"),priority:800})),[2,this.navs]}))}))},n.ctorParameters=function(){return[{type:e.OptionsService}]},n=p([t.Injectable()],n)}(),v=[{path:"configuration-new",component:g}],b=function(){function n(){}return n=p([t.NgModule({imports:[e.CoreModule,c.TooltipModule],exports:[],entryComponents:[g,h],declarations:[g,h],providers:[y,{provide:e.HOOK_NAVIGATOR_NODES,useClass:m,multi:!0},{provide:e.HOOK_ONCE_ROUTE,useValue:v,multi:!0}]})],n)}();n.RepositoryModule=b,n.ɵ0=v,n.ɵa=g,n.ɵb=y,n.ɵc=h,n.ɵd=m,Object.defineProperty(n,"__esModule",{value:!0})}));
//# sourceMappingURL=c8y-ngx-components-repository.umd.min.js.map